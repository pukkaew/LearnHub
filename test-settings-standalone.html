<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - Standalone Test (Mock API)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <meta name="csrf-token" content="test-csrf-token-12345">
    <style>
        body { font-family: 'Sarabun', sans-serif !important; }
        .test-status {
            position: fixed; top: 20px; right: 20px; background: white;
            border: 2px solid #e5e7eb; border-radius: 8px; padding: 15px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); z-index: 9999; max-width: 350px;
        }
        .test-status h3 { font-weight: 600; margin-bottom: 10px; color: #1f2937; }
        .test-status ul { list-style: none; padding: 0; margin: 0; }
        .test-status li { padding: 5px 0; font-size: 14px; }
        .test-status .pass { color: #10b981; }
        .test-status .fail { color: #ef4444; }
        .test-status .pending { color: #f59e0b; }
        .setting-item { padding-bottom: 1.5rem; border-bottom: 1px solid #e5e7eb; }
        .setting-item:last-child { border-bottom: none; padding-bottom: 0; }
        .api-mode {
            position: fixed; bottom: 20px; right: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; padding: 12px 20px; border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            font-weight: 600; z-index: 9999;
        }
        .mode-toggle {
            margin-left: 10px; padding: 4px 12px; background: white;
            color: #667eea; border-radius: 4px; cursor: pointer;
            font-size: 12px; transition: all 0.3s;
        }
        .mode-toggle:hover { transform: scale(1.05); }
    </style>
</head>
<body class="bg-gray-50">

<div class="test-status">
    <h3><i class="fas fa-flask mr-2 text-blue-600"></i>Test Results</h3>
    <ul id="testResults">
        <li class="pending"><i class="fas fa-spinner fa-spin mr-2"></i>Loading...</li>
    </ul>
</div>

<div class="api-mode">
    <i class="fas fa-plug mr-2"></i>
    <span id="apiModeText">Mock API Mode</span>
    <button class="mode-toggle" onclick="toggleApiMode()">
        <i class="fas fa-sync-alt mr-1"></i>Switch Mode
    </button>
</div>

<div id="settings-page" class="min-h-screen bg-gray-50 py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="mb-8">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">
                        <i class="fas fa-cog mr-2 text-blue-600"></i>
                        ‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö Settings - ‡∏û‡∏£‡πâ‡∏≠‡∏° Error Detection
                    </h1>
                    <p class="mt-2 text-sm text-gray-600">
                        ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ó‡∏±‡πâ‡∏á Mock API ‡πÅ‡∏•‡∏∞ Real API ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏™‡∏î‡∏á Error ‡πÅ‡∏ö‡∏ö‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
                    </p>
                </div>
                <div class="flex items-center space-x-3">
                    <button type="button" id="testValidationBtn" class="inline-flex items-center px-4 py-2 border border-orange-600 rounded-md shadow-sm text-sm font-medium text-orange-600 bg-white hover:bg-orange-50">
                        <i class="fas fa-check-circle mr-2"></i>
                        Test Validation
                    </button>
                    <button type="button" id="testErrorBtn" class="inline-flex items-center px-4 py-2 border border-red-600 rounded-md shadow-sm text-sm font-medium text-red-600 bg-white hover:bg-red-50">
                        <i class="fas fa-bug mr-2"></i>
                        Test Errors
                    </button>
                    <button type="button" id="saveAllBtn" class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700">
                        <i class="fas fa-save mr-2"></i>
                        ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                    </button>
                </div>
            </div>
        </div>

        <div id="alertContainer"></div>

        <div class="bg-white shadow rounded-lg">
            <div class="border-b border-gray-200">
                <nav class="-mb-px flex space-x-8 px-6" aria-label="Tabs">
                    <button data-tab="general" class="tab-button border-blue-500 text-blue-600 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                        <i class="fas fa-info-circle mr-2"></i><span>‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</span>
                    </button>
                    <button data-tab="security" class="tab-button border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                        <i class="fas fa-shield-alt mr-2"></i><span>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢</span>
                    </button>
                </nav>
            </div>

            <div class="p-6">
                <div id="tab-general" class="tab-content">
                    <div class="space-y-6">
                        <div class="setting-item">
                            <label class="block">
                                <span class="text-sm font-medium text-gray-700">‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏ö</span>
                                <p class="text-xs text-gray-500 mb-2">‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö</p>
                                <input type="text" id="site_name" value="Rukchai LearnHub"
                                    class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                                    data-setting-key="site_name" data-setting-type="string">
                            </label>
                        </div>
                        <div class="setting-item">
                            <label class="block">
                                <span class="text-sm font-medium text-gray-700">‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</span>
                                <p class="text-xs text-gray-500 mb-2">‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ (‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÉ‡∏™‡πà‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á)</p>
                                <input type="email" id="contact_email" value="admin@rukchai.com"
                                    class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                                    data-setting-key="contact_email" data-setting-type="email">
                            </label>
                        </div>
                    </div>
                </div>

                <div id="tab-security" class="tab-content hidden">
                    <div class="space-y-6">
                        <div class="setting-item">
                            <label class="block">
                                <span class="text-sm font-medium text-gray-700">Session Timeout (‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)</span>
                                <p class="text-xs text-gray-500 mb-2">‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á 300-86400 (‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÉ‡∏™‡πà‡∏Ñ‡πà‡∏≤‡∏ô‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á)</p>
                                <input type="number" id="session_timeout" value="3600" min="300" max="86400"
                                    class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                                    data-setting-key="session_timeout" data-setting-type="number">
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-8 bg-white shadow rounded-lg p-6">
            <h2 class="text-xl font-bold text-gray-900 mb-4">
                <i class="fas fa-terminal mr-2 text-green-600"></i>Test Console
            </h2>
            <div id="testConsole" class="bg-gray-900 text-green-400 p-4 rounded font-mono text-sm h-96 overflow-y-auto">
                <div>üîß Test Console Ready...</div>
            </div>
        </div>
    </div>
</div>

<script>
let useMockApi = true;
const testResults = [];

function toggleApiMode() {
    useMockApi = !useMockApi;
    const modeText = document.getElementById('apiModeText');
    modeText.textContent = useMockApi ? 'Mock API Mode' : 'Real API Mode';
    logToConsole(`üîÑ Switched to ${useMockApi ? 'Mock' : 'Real'} API Mode`, 'info');
}

function logToConsole(message, type = 'info') {
    const consoleEl = document.getElementById('testConsole');
    const timestamp = new Date().toLocaleTimeString();
    const icon = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
    const color = type === 'success' ? 'text-green-400' : type === 'error' ? 'text-red-400' : type === 'warning' ? 'text-yellow-400' : 'text-blue-400';
    const div = document.createElement('div');
    div.className = color;
    div.textContent = `[${timestamp}] ${icon} ${message}`;
    consoleEl.appendChild(div);
    consoleEl.scrollTop = consoleEl.scrollHeight;
}

function updateTestResults(testName, passed, details = '') {
    testResults.push({ name: testName, passed, details });
    renderTestResults();
}

function renderTestResults() {
    const resultsEl = document.getElementById('testResults');
    resultsEl.innerHTML = '';
    const passed = testResults.filter(t => t.passed).length;
    const total = testResults.length;
    const summary = document.createElement('li');
    summary.className = 'font-bold mb-2';
    summary.innerHTML = `<i class="fas fa-chart-bar mr-2"></i>${passed}/${total} passed`;
    resultsEl.appendChild(summary);
    testResults.forEach(result => {
        const li = document.createElement('li');
        li.className = result.passed ? 'pass' : 'fail';
        li.innerHTML = `<i class="fas ${result.passed ? 'fa-check' : 'fa-times'} mr-2"></i>${result.name}`;
        if (result.details) {
            const details = document.createElement('div');
            details.className = 'text-xs ml-6 text-gray-600';
            details.textContent = result.details;
            li.appendChild(details);
        }
        resultsEl.appendChild(li);
    });
}

function showAlert(type, message) {
    const alertColors = {
        success: 'bg-green-50 border-green-400 text-green-800',
        error: 'bg-red-50 border-red-400 text-red-800',
        warning: 'bg-yellow-50 border-yellow-400 text-yellow-800',
    };
    const alertIcons = {
        success: 'fa-check-circle',
        error: 'fa-exclamation-circle',
        warning: 'fa-exclamation-triangle',
    };
    const alert = document.createElement('div');
    alert.className = `${alertColors[type]} border-l-4 p-4 mb-4 rounded-r`;
    alert.innerHTML = `
        <div class="flex items-center justify-between">
            <div class="flex items-center">
                <i class="fas ${alertIcons[type]} mr-3"></i>
                <p class="text-sm font-medium">${message}</p>
            </div>
            <button onclick="this.parentElement.parentElement.remove()" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `;
    alertContainer.appendChild(alert);
    setTimeout(() => alert.remove(), 5000);
}

// Mock API that simulates various scenarios
async function mockApiCall(settings) {
    logToConsole('üé≠ Using Mock API (simulating server response)', 'info');

    // Simulate network delay
    await new Promise(resolve => setTimeout(resolve, 800));

    // Check for validation errors
    const errors = [];

    settings.forEach(setting => {
        // Simulate email validation
        if (setting.key === 'contact_email') {
            if (!setting.value.includes('@')) {
                errors.push({
                    key: setting.key,
                    errors: ['‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á']
                });
            }
        }

        // Simulate number range validation
        if (setting.key === 'session_timeout') {
            const val = parseInt(setting.value);
            if (val < 300 || val > 86400) {
                errors.push({
                    key: setting.key,
                    errors: [`‡∏Ñ‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á 300-86400 (‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö: ${val})`]
                });
            }
        }
    });

    if (errors.length > 0) {
        logToConsole(`‚ùå Mock API: Found ${errors.length} validation errors`, 'error');
        return {
            success: false,
            message: '‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á',
            errors: errors
        };
    }

    logToConsole('‚úÖ Mock API: All validations passed', 'success');
    return {
        success: true,
        message: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß'
    };
}

// Real API call
async function realApiCall(settings, csrfToken) {
    logToConsole('üåê Using Real API (calling server)', 'info');

    const response = await fetch('/settings/batch', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': csrfToken
        },
        body: JSON.stringify({ settings, _csrf: csrfToken })
    });

    logToConsole(`üì• Response status: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');
    return await response.json();
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    logToConsole('üöÄ Settings Test Page Initialized', 'success');

    // Tab switching
    document.querySelectorAll('.tab-button').forEach(button => {
        button.addEventListener('click', function() {
            const targetTab = this.getAttribute('data-tab');
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('border-blue-500', 'text-blue-600');
                btn.classList.add('border-transparent', 'text-gray-500');
            });
            this.classList.remove('border-transparent', 'text-gray-500');
            this.classList.add('border-blue-500', 'text-blue-600');
            document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
            document.getElementById(`tab-${targetTab}`).classList.remove('hidden');
        });
    });

    // Save All
    document.getElementById('saveAllBtn').addEventListener('click', async function() {
        logToConsole('üíæ Save All button clicked', 'info');

        const settings = [];
        document.querySelectorAll('[data-setting-key]').forEach(input => {
            settings.push({
                key: input.getAttribute('data-setting-key'),
                value: input.value
            });
        });

        logToConsole(`üì¶ Collected ${settings.length} settings`, 'info');
        settings.forEach(s => logToConsole(`  - ${s.key}: ${s.value}`, 'info'));

        const originalText = this.innerHTML;
        this.disabled = true;
        this.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';

        try {
            let result;

            if (useMockApi) {
                result = await mockApiCall(settings);
            } else {
                const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
                result = await realApiCall(settings, csrfToken);
            }

            logToConsole(`üì¶ Response: ${JSON.stringify(result, null, 2)}`, 'info');

            if (result.success) {
                logToConsole('‚úÖ Settings saved successfully', 'success');
                showAlert('success', result.message);
                updateTestResults('Save Settings', true, `Saved ${settings.length} settings`);
            } else {
                logToConsole(`‚ùå Save failed: ${result.message}`, 'error');
                showAlert('error', result.message);
                updateTestResults('Save Settings', false, result.message);

                if (result.errors) {
                    result.errors.forEach(error => {
                        const msg = `${error.key}: ${error.errors.join(', ')}`;
                        logToConsole(`  ‚ùå ${msg}`, 'error');
                        showAlert('error', msg);
                    });
                }
            }
        } catch (error) {
            logToConsole(`‚ùå Network error: ${error.message}`, 'error');
            showAlert('error', `‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`);
            updateTestResults('Save Settings', false, error.message);
        } finally {
            this.disabled = false;
            this.innerHTML = originalText;
        }
    });

    // Test Validation Button
    document.getElementById('testValidationBtn').addEventListener('click', function() {
        logToConsole('üß™ Testing validation...', 'info');
        document.getElementById('contact_email').value = 'invalid-email';
        document.getElementById('session_timeout').value = '100';
        showAlert('warning', '‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏ñ‡∏π‡∏Å‡πÉ‡∏™‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß - ‡∏•‡∏≠‡∏á‡∏Å‡∏î "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"');
    });

    // Test Error Button
    document.getElementById('testErrorBtn').addEventListener('click', function() {
        logToConsole('üêõ Simulating error scenario...', 'error');
        showAlert('error', '‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á Error Message');
        updateTestResults('Error Simulation', false, 'Simulated error for testing');
    });

    updateTestResults('Page Load', true, 'All components initialized');
});
</script>

</body>
</html>
