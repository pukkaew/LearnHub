const { sql, poolPromise } = require('./config/database');

async function testCourseCreation() {
    try {
        console.log('üß™ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£...\n');

        // ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        const pool = await poolPromise;
        console.log('‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à\n');

        // ‡∏•‡∏ö‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÄ‡∏Å‡πà‡∏≤ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
        await pool.request().query`DELETE FROM courses WHERE course_code = 'TEST-2025-001'`;
        console.log('üßπ ‡∏•‡∏ö‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÄ‡∏Å‡πà‡∏≤‡πÅ‡∏•‡πâ‡∏ß\n');

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö
        const testCourseData = {
            title: '‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö - ‡∏â‡∏ö‡∏±‡∏ö‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå',
            course_code: 'TEST-2025-001',
            category: 'Technology',
            difficulty_level: 'intermediate',
            course_type: 'mandatory',
            language: 'th',
            description: '‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏ô‡∏µ‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà ‡∏£‡∏ß‡∏°‡∏ñ‡∏∂‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ï‡πà‡∏≤‡∏á‡πÜ ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î',
            learning_objectives: JSON.stringify([
                '‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö',
                '‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á',
                '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'
            ]),
            target_audience: JSON.stringify({
                positions: ['developer', 'engineer'],
                departments: ['it', 'development']
            }),
            passing_score: 75,
            max_attempts: 3,
            certificate_validity: '365',
            max_students: 50,
            instructor_id: null,  // ‡πÉ‡∏ä‡πâ NULL ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö
            status: 'draft'
        };

        console.log('üìù ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á:');
        console.log(JSON.stringify(testCourseData, null, 2));
        console.log('');

        // INSERT ‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£
        const result = await pool.request().query`
            INSERT INTO courses (
                title, course_code, category, difficulty_level,
                course_type, language, description, learning_objectives,
                target_audience, passing_score, max_attempts,
                certificate_validity, max_students, instructor_id, status
            )
            OUTPUT inserted.course_id
            VALUES (
                ${testCourseData.title},
                ${testCourseData.course_code},
                ${testCourseData.category},
                ${testCourseData.difficulty_level},
                ${testCourseData.course_type},
                ${testCourseData.language},
                ${testCourseData.description},
                ${testCourseData.learning_objectives},
                ${testCourseData.target_audience},
                ${testCourseData.passing_score},
                ${testCourseData.max_attempts},
                ${testCourseData.certificate_validity},
                ${testCourseData.max_students},
                ${testCourseData.instructor_id},
                ${testCourseData.status}
            )
        `;

        const courseId = result.recordset[0].course_id;
        console.log(`‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ID = ${courseId}\n`);

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
        const checkResult = await pool.request().query`
            SELECT * FROM courses WHERE course_id = ${courseId}
        `;

        const savedCourse = checkResult.recordset[0];

        console.log('üìä ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å:\n');

        const checks = [
            { field: 'course_code', expected: 'TEST-2025-001', actual: savedCourse.course_code },
            { field: 'title', expected: testCourseData.title, actual: savedCourse.title },
            { field: 'category', expected: 'Technology', actual: savedCourse.category },
            { field: 'course_type', expected: 'mandatory', actual: savedCourse.course_type },
            { field: 'language', expected: 'th', actual: savedCourse.language },
            { field: 'learning_objectives', expected: 'array (3 items)', actual: savedCourse.learning_objectives ? JSON.parse(savedCourse.learning_objectives).length + ' items' : 'NULL' },
            { field: 'target_audience', expected: 'object', actual: savedCourse.target_audience ? 'exists' : 'NULL' },
            { field: 'passing_score', expected: 75, actual: savedCourse.passing_score },
            { field: 'max_attempts', expected: 3, actual: savedCourse.max_attempts },
            { field: 'certificate_validity', expected: '365', actual: savedCourse.certificate_validity },
            { field: 'max_students', expected: 50, actual: savedCourse.max_students }
        ];

        let allPassed = true;

        checks.forEach(check => {
            const passed = check.actual !== null && check.actual !== undefined;
            const icon = passed ? '‚úÖ' : '‚ùå';
            const status = passed ? 'OK' : 'NULL';

            console.log(`${icon} ${check.field}: ${check.actual || 'NULL'} (expected: ${check.expected}) - ${status}`);

            if (!passed) {
                allPassed = false;
            }
        });

        console.log('\n' + '='.repeat(60));
        if (allPassed) {
            console.log('‚úÖ ‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ú‡πà‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î! ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
        } else {
            console.log('‚ùå ‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô! ‡∏û‡∏ö‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô NULL');
        }
        console.log('='.repeat(60));

        process.exit(0);

    } catch (error) {
        console.error('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:', error.message);
        console.error(error);
        process.exit(1);
    }
}

testCourseCreation();
