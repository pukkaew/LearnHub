// Language translations for the application
const translations = {
    th: {
        // Navigation
        dashboard: 'à¹à¸”à¸Šà¸šà¸­à¸£à¹Œà¸”',
        courses: 'à¸„à¸­à¸£à¹Œà¸ªà¹€à¸£à¸µà¸¢à¸™',
        tests: 'à¹à¸šà¸šà¸—à¸”à¸ªà¸­à¸š',
        articles: 'à¸šà¸—à¸„à¸§à¸²à¸¡',
        users: 'à¸ˆà¸±à¸”à¸à¸²à¸£à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰',
        applicants: 'à¸œà¸¹à¹‰à¸ªà¸¡à¸±à¸„à¸£à¸‡à¸²à¸™',
        profile: 'à¹‚à¸›à¸£à¹„à¸Ÿà¸¥à¹Œ',
        settings: 'à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸²',
        userSettings: 'à¸à¸²à¸£à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸²à¸ªà¹ˆà¸§à¸™à¸•à¸±à¸§',
        systemSettings: 'à¸à¸²à¸£à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸²à¸£à¸°à¸šà¸š',
        logout: 'à¸­à¸­à¸à¸ˆà¸²à¸à¸£à¸°à¸šà¸š',
        login: 'à¹€à¸‚à¹‰à¸²à¸ªà¸¹à¹ˆà¸£à¸°à¸šà¸š',
        signIn: 'à¹€à¸‚à¹‰à¸²à¸ªà¸¹à¹ˆà¸£à¸°à¸šà¸š',
        employeeId: 'à¸£à¸«à¸±à¸ªà¸žà¸™à¸±à¸à¸‡à¸²à¸™',
        password: 'à¸£à¸«à¸±à¸ªà¸œà¹ˆà¸²à¸™',
        rememberMe: 'à¸ˆà¸”à¸ˆà¸³à¸à¸²à¸£à¹€à¸‚à¹‰à¸²à¸ªà¸¹à¹ˆà¸£à¸°à¸šà¸š',
        forgotPassword: 'à¸¥à¸·à¸¡à¸£à¸«à¸±à¸ªà¸œà¹ˆà¸²à¸™?',
        dontHaveAccount: 'à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µà¸šà¸±à¸à¸Šà¸µ?',
        createAccount: 'à¸ªà¸¡à¸±à¸„à¸£à¸ªà¸¡à¸²à¸Šà¸´à¸',

        // Dashboard
        welcome: 'à¸ªà¸§à¸±à¸ªà¸”à¸µ',
        welcomeToSystem: 'à¸¢à¸´à¸™à¸”à¸µà¸•à¹‰à¸­à¸™à¸£à¸±à¸šà¸ªà¸¹à¹ˆà¸£à¸°à¸šà¸š LearnHub',
        level: 'à¸£à¸°à¸”à¸±à¸š',
        totalPoints: 'à¸„à¸°à¹à¸™à¸™à¸ªà¸°à¸ªà¸¡',
        enrolledCourses: 'à¸„à¸­à¸£à¹Œà¸ªà¸—à¸µà¹ˆà¹€à¸£à¸µà¸¢à¸™',
        completed: 'à¹€à¸ªà¸£à¹‡à¸ˆà¹à¸¥à¹‰à¸§',
        completedCourses: 'à¹€à¸ªà¸£à¹‡à¸ˆà¹à¸¥à¹‰à¸§',
        testsCompleted: 'à¹à¸šà¸šà¸—à¸”à¸ªà¸­à¸š',
        averageScore: 'à¸„à¸°à¹à¸™à¸™à¹€à¸‰à¸¥à¸µà¹ˆà¸¢',
        publishedArticles: 'à¸šà¸—à¸„à¸§à¸²à¸¡',
        views: 'à¸à¸²à¸£à¸”à¸¹',
        badges: 'à¹€à¸«à¸£à¸µà¸¢à¸à¸£à¸²à¸‡à¸§à¸±à¸¥',
        received: 'à¹„à¸”à¹‰à¸£à¸±à¸š',

        // Sections
        recentCourses: 'à¸„à¸­à¸£à¹Œà¸ªà¸¥à¹ˆà¸²à¸ªà¸¸à¸”',
        learningProgress: 'à¸„à¸§à¸²à¸¡à¸„à¸·à¸šà¸«à¸™à¹‰à¸²à¸à¸²à¸£à¹€à¸£à¸µà¸¢à¸™',
        recentArticles: 'à¸šà¸—à¸„à¸§à¸²à¸¡à¹ƒà¸«à¸¡à¹ˆ',
        notifications: 'à¹à¸ˆà¹‰à¸‡à¹€à¸•à¸·à¸­à¸™',
        myBadges: 'à¹€à¸«à¸£à¸µà¸¢à¸à¸£à¸²à¸‡à¸§à¸±à¸¥à¸‚à¸­à¸‡à¸‰à¸±à¸™',
        leaderboard: 'à¸­à¸±à¸™à¸”à¸±à¸šà¸œà¸¹à¹‰à¹€à¸£à¸µà¸¢à¸™',
        quickActions: 'à¸à¸²à¸£à¸”à¸³à¹€à¸™à¸´à¸™à¸à¸²à¸£à¸”à¹ˆà¸§à¸™',

        // Quick Actions
        searchCourses: 'à¸„à¹‰à¸™à¸«à¸²à¸„à¸­à¸£à¹Œà¸ª',
        writeArticle: 'à¹€à¸‚à¸µà¸¢à¸™à¸šà¸—à¸„à¸§à¸²à¸¡',
        editProfile: 'à¹à¸à¹‰à¹„à¸‚à¹‚à¸›à¸£à¹„à¸Ÿà¸¥à¹Œ',
        manageApplicants: 'à¸ˆà¸±à¸”à¸à¸²à¸£à¸œà¸¹à¹‰à¸ªà¸¡à¸±à¸„à¸£',

        // Buttons
        viewAll: 'à¸”à¸¹à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”',
        markAllRead: 'à¸­à¹ˆà¸²à¸™à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”',

        // Status
        online: 'à¸­à¸­à¸™à¹„à¸¥à¸™à¹Œ',
        offline: 'à¸­à¸­à¸Ÿà¹„à¸¥à¸™à¹Œ',
        points: 'à¸„à¸°à¹à¸™à¸™',

        // Loading & Messages
        loading: 'à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥...',
        loadingShort: 'à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸”...',
        errorLoading: 'à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸žà¸¥à¸²à¸”à¹ƒà¸™à¸à¸²à¸£à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥',
        noTitle: 'à¹„à¸¡à¹ˆà¸¡à¸µà¸Šà¸·à¹ˆà¸­',
        instructor: 'à¸œà¸¹à¹‰à¸ªà¸­à¸™',
        noAuthor: 'à¹„à¸¡à¹ˆà¸£à¸°à¸šà¸¸à¸œà¸¹à¹‰à¹€à¸‚à¸µà¸¢à¸™',
        reports: 'à¸£à¸²à¸¢à¸‡à¸²à¸™',
        completionProgress: 'à¹€à¸ªà¸£à¹‡à¸ˆà¸ªà¸´à¹‰à¸™',

        // Empty States
        noCourses: 'à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µà¸„à¸­à¸£à¹Œà¸ªà¸—à¸µà¹ˆà¹€à¸£à¸µà¸¢à¸™',
        noProgress: 'à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µà¸„à¸§à¸²à¸¡à¸„à¸·à¸šà¸«à¸™à¹‰à¸²à¸à¸²à¸£à¹€à¸£à¸µà¸¢à¸™',
        noArticles: 'à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µà¸šà¸—à¸„à¸§à¸²à¸¡à¹ƒà¸«à¸¡à¹ˆ',
        noNotifications: 'à¹„à¸¡à¹ˆà¸¡à¸µà¸à¸²à¸£à¹à¸ˆà¹‰à¸‡à¹€à¸•à¸·à¸­à¸™',
        noBadges: 'à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µà¹€à¸«à¸£à¸µà¸¢à¸à¸£à¸²à¸‡à¸§à¸±à¸¥',
        noLeaderboard: 'à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸­à¸±à¸™à¸”à¸±à¸š',

        // Time
        minutesAgo: 'à¸™à¸²à¸—à¸µà¸—à¸µà¹ˆà¹à¸¥à¹‰à¸§',
        hoursAgo: 'à¸Šà¸±à¹ˆà¸§à¹‚à¸¡à¸‡à¸—à¸µà¹ˆà¹à¸¥à¹‰à¸§',
        daysAgo: 'à¸§à¸±à¸™à¸—à¸µà¹ˆà¹à¸¥à¹‰à¸§',
        justNow: 'à¹€à¸¡à¸·à¹ˆà¸­à¸ªà¸±à¸à¸„à¸£à¸¹à¹ˆ',

        // Department
        noDepartment: 'à¹„à¸¡à¹ˆà¸£à¸°à¸šà¸¸à¹à¸œà¸™à¸',

        // Footer & Contact
        contact: 'à¸•à¸´à¸”à¸•à¹ˆà¸­',
        menu: 'à¹€à¸¡à¸™à¸¹',
        company: 'à¹€à¸à¸µà¹ˆà¸¢à¸§à¸à¸±à¸šà¹€à¸£à¸²',
        quickLinks: 'à¸¥à¸´à¸‡à¸à¹Œà¸”à¹ˆà¸§à¸™',
        followUs: 'à¸•à¸´à¸”à¸•à¸²à¸¡à¹€à¸£à¸²',
        companyDescription: 'à¸£à¸°à¸šà¸šà¸ˆà¸±à¸”à¸à¸²à¸£à¸à¸²à¸£à¹€à¸£à¸µà¸¢à¸™à¸£à¸¹à¹‰à¸‚à¸­à¸‡ à¸šà¸£à¸´à¸©à¸±à¸— à¸£à¸±à¸à¸Šà¸±à¸¢à¸«à¹‰à¸­à¸‡à¹€à¸¢à¹‡à¸™ à¸ˆà¸³à¸à¸±à¸” à¹€à¸žà¸·à¹ˆà¸­à¸žà¸±à¸’à¸™à¸²à¸„à¸§à¸²à¸¡à¸£à¸¹à¹‰à¹à¸¥à¸°à¸—à¸±à¸à¸©à¸°à¸‚à¸­à¸‡à¸žà¸™à¸±à¸à¸‡à¸²à¸™à¸­à¸¢à¹ˆà¸²à¸‡à¸•à¹ˆà¸­à¹€à¸™à¸·à¹ˆà¸­à¸‡ à¹€à¸ªà¸£à¸´à¸¡à¸ªà¸£à¹‰à¸²à¸‡à¸‚à¸µà¸”à¸„à¸§à¸²à¸¡à¸ªà¸²à¸¡à¸²à¸£à¸–à¹ƒà¸™à¸à¸²à¸£à¹à¸‚à¹ˆà¸‡à¸‚à¸±à¸™à¹à¸¥à¸°à¸à¸²à¸£à¹€à¸•à¸´à¸šà¹‚à¸•à¸­à¸¢à¹ˆà¸²à¸‡à¸¢à¸±à¹ˆà¸‡à¸¢à¸·à¸™',
        address: 'à¸—à¸µà¹ˆà¸­à¸¢à¸¹à¹ˆ',
        phone: 'à¹‚à¸—à¸£à¸¨à¸±à¸žà¸—à¹Œ',
        email: 'à¸­à¸µà¹€à¸¡à¸¥',
        workingHours: 'à¹€à¸§à¸¥à¸²à¸—à¸³à¸à¸²à¸£',
        workingTime: 'à¸ˆà¸±à¸™à¸—à¸£à¹Œ - à¸¨à¸¸à¸à¸£à¹Œ 8:00 - 17:00 à¸™.',
        allRightsReserved: 'à¸ªà¸‡à¸§à¸™à¸¥à¸´à¸‚à¸ªà¸´à¸—à¸˜à¸´à¹Œ',
        privacyPolicy: 'à¸™à¹‚à¸¢à¸šà¸²à¸¢à¸„à¸§à¸²à¸¡à¹€à¸›à¹‡à¸™à¸ªà¹ˆà¸§à¸™à¸•à¸±à¸§',
        termsOfService: 'à¸‚à¹‰à¸­à¸à¸³à¸«à¸™à¸”à¸à¸²à¸£à¹ƒà¸Šà¹‰à¸‡à¸²à¸™',
        help: 'à¸Šà¹ˆà¸§à¸¢à¹€à¸«à¸¥à¸·à¸­',
        support: 'à¸à¹ˆà¸²à¸¢à¸ªà¸™à¸±à¸šà¸ªà¸™à¸¸à¸™',
        faq: 'à¸„à¸³à¸–à¸²à¸¡à¸—à¸µà¹ˆà¸žà¸šà¸šà¹ˆà¸­à¸¢',
        learningResources: 'à¹à¸«à¸¥à¹ˆà¸‡à¹€à¸£à¸µà¸¢à¸™à¸£à¸¹à¹‰',
        elearning: 'à¸£à¸°à¸šà¸šà¹€à¸£à¸µà¸¢à¸™à¸­à¸­à¸™à¹„à¸¥à¸™à¹Œ',
        careers: 'à¸£à¹ˆà¸§à¸¡à¸‡à¸²à¸™à¸à¸±à¸šà¹€à¸£à¸²'
    },
    en: {
        // Navigation
        dashboard: 'Dashboard',
        courses: 'Courses',
        tests: 'Tests',
        articles: 'Articles',
        users: 'Manage Users',
        applicants: 'Job Applicants',
        profile: 'Profile',
        settings: 'Settings',
        userSettings: 'User Settings',
        systemSettings: 'System Settings',
        logout: 'Logout',
        login: 'Login',
        signIn: 'Sign In',
        employeeId: 'Employee ID',
        password: 'Password',
        rememberMe: 'Remember me',
        forgotPassword: 'Forgot password?',
        dontHaveAccount: 'Don\'t have an account?',
        createAccount: 'Create account',

        // Dashboard
        welcome: 'Hello',
        welcomeToSystem: 'Welcome to LearnHub System',
        level: 'Level',
        totalPoints: 'Total Points',
        enrolledCourses: 'Enrolled Courses',
        completed: 'Completed',
        completedCourses: 'Completed',
        testsCompleted: 'Tests',
        averageScore: 'Average Score',
        publishedArticles: 'Articles',
        views: 'Views',
        badges: 'Badges',
        received: 'Received',

        // Sections
        recentCourses: 'Recent Courses',
        learningProgress: 'Learning Progress',
        recentArticles: 'Recent Articles',
        notifications: 'Notifications',
        myBadges: 'My Badges',
        leaderboard: 'Leaderboard',
        quickActions: 'Quick Actions',

        // Quick Actions
        searchCourses: 'Search Courses',
        writeArticle: 'Write Article',
        editProfile: 'Edit Profile',
        manageApplicants: 'Manage Applicants',

        // Buttons
        viewAll: 'View All',
        markAllRead: 'Mark All Read',

        // Status
        online: 'Online',
        offline: 'Offline',
        points: 'points',

        // Loading & Messages
        loading: 'Loading data...',
        loadingShort: 'Loading...',
        errorLoading: 'Error loading data',
        noTitle: 'No Title',
        instructor: 'Instructor',
        noAuthor: 'No Author',
        reports: 'Reports',
        completionProgress: 'Completed',

        // Empty States
        noCourses: 'No enrolled courses yet',
        noProgress: 'No learning progress yet',
        noArticles: 'No new articles',
        noNotifications: 'No notifications',
        noBadges: 'No badges yet',
        noLeaderboard: 'No leaderboard data',

        // Time
        minutesAgo: 'minutes ago',
        hoursAgo: 'hours ago',
        daysAgo: 'days ago',
        justNow: 'just now',

        // Department
        noDepartment: 'No Department',

        // Footer & Contact
        contact: 'Contact',
        menu: 'Menu',
        company: 'About Us',
        quickLinks: 'Quick Links',
        followUs: 'Follow Us',
        companyDescription: 'Learning Management System of Rukchai Hongyen Co., Ltd. to continuously develop employee knowledge and skills, enhance competitiveness and sustainable growth.',
        address: 'Address',
        phone: 'Phone',
        email: 'Email',
        workingHours: 'Working Hours',
        workingTime: 'Monday - Friday 8:00 AM - 5:00 PM',
        allRightsReserved: 'All rights reserved',
        privacyPolicy: 'Privacy Policy',
        termsOfService: 'Terms of Service',
        help: 'Help',
        support: 'Support',
        faq: 'FAQ',
        learningResources: 'Learning Resources',
        elearning: 'E-Learning Platform',
        careers: 'Careers'
    }
};

function getTranslation(lang, key) {
    const keys = key.split('.');
    let value = translations[lang] || translations.th;

    for (const k of keys) {
        value = value[k];
        if (!value) return key; // Return key if translation not found
    }

    return value;
}

function getCurrentLanguage(req) {
    // Debug logging
    console.log('ðŸ” Getting current language...');
    console.log('  Session language:', req.session?.language);
    console.log('  Cookies:', {
        ruxchai_language: req.cookies?.ruxchai_language,
        language: req.cookies?.language,
        preferred_language: req.cookies?.preferred_language
    });

    // Check session first
    if (req.session && req.session.language) {
        console.log('  âœ… Using session language:', req.session.language);
        return req.session.language;
    }

    // Check cookies (multiple possible names for backward compatibility)
    if (req.cookies) {
        if (req.cookies.ruxchai_language) {
            console.log('  âœ… Using ruxchai_language cookie:', req.cookies.ruxchai_language);
            // Save to session for this request
            if (req.session) {
                req.session.language = req.cookies.ruxchai_language;
            }
            return req.cookies.ruxchai_language;
        }
        if (req.cookies.language) {
            console.log('  âœ… Using language cookie:', req.cookies.language);
            // Save to session for this request
            if (req.session) {
                req.session.language = req.cookies.language;
            }
            return req.cookies.language;
        }
        if (req.cookies.preferred_language) {
            console.log('  âœ… Using preferred_language cookie:', req.cookies.preferred_language);
            // Save to session for this request
            if (req.session) {
                req.session.language = req.cookies.preferred_language;
            }
            return req.cookies.preferred_language;
        }
    }

    // Always default to Thai - no browser language detection
    console.log('  âš ï¸ No language found, defaulting to Thai');
    return 'th';
}

// Language middleware for Express
function languageMiddleware(req, res, next) {
    const currentLang = getCurrentLanguage(req);

    // Set language in request for easy access
    req.language = currentLang;

    // Set language in response locals for template access
    res.locals.language = currentLang;
    res.locals.currentLanguage = currentLang;

    // Add translation helper to response locals
    res.locals.t = (key, defaultValue = key) => {
        return getTranslation(currentLang, key) || defaultValue;
    };

    // Add language info to locals
    res.locals.languageInfo = {
        current: currentLang,
        name: currentLang === 'th' ? 'à¹„à¸—à¸¢' : 'English',
        flag: currentLang
    };

    // Override res.render to ensure translation function is always available
    const originalRender = res.render;
    res.render = function(view, options = {}, callback) {
        // Ensure translation function is always included
        options.t = options.t || res.locals.t;
        options.language = options.language || currentLang;
        options.currentLanguage = options.currentLanguage || currentLang;

        return originalRender.call(this, view, options, callback);
    };

    next();
}

module.exports = {
    translations,
    getTranslation,
    getCurrentLanguage,
    languageMiddleware
};