<style>
/* Featured Image - Default SVG handling */
#featuredImage.default-image {
    object-fit: contain !important;
    background: linear-gradient(135deg, #34d399 0%, #10b981 100%);
    padding: 2rem;
}

/* Article Content Styles */
#articleContent {
    overflow: hidden; /* Clearfix for floated elements */
}
#articleContent figure {
    margin: 1rem auto;
    max-width: 100% !important;
    display: block !important; /* Override display: table */
    width: auto !important; /* Override fixed width */
}
#articleContent figure img {
    max-width: 100% !important;
    width: auto !important;
    height: auto !important;
    border-radius: 8px;
    display: block;
    margin-left: auto !important;
    margin-right: auto !important;
}
/* Float left image */
#articleContent figure[style*="float: left"],
#articleContent figure[style*="float:left"] {
    float: left !important;
    margin: 0.5rem 1rem 0.5rem 0 !important;
    max-width: 50% !important;
    clear: left;
}
#articleContent figure[style*="float: left"] img,
#articleContent figure[style*="float:left"] img {
    margin-left: 0 !important;
    margin-right: 0 !important;
}
/* Float right image */
#articleContent figure[style*="float: right"],
#articleContent figure[style*="float:right"] {
    float: right !important;
    margin: 0.5rem 0 0.5rem 1rem !important;
    max-width: 50% !important;
    clear: right;
}
#articleContent figure[style*="float: right"] img,
#articleContent figure[style*="float:right"] img {
    margin-left: 0 !important;
    margin-right: 0 !important;
}
/* Center image (no float) */
#articleContent figure:not([style*="float"]) {
    margin-left: auto !important;
    margin-right: auto !important;
    text-align: center !important;
}
#articleContent figure figcaption {
    text-align: center;
    font-size: 0.875rem;
    color: #6b7280;
    margin-top: 0.5rem;
    font-style: italic;
}
/* Clear after content sections */
#articleContent p {
    clear: none;
}
#articleContent h1, #articleContent h2, #articleContent h3,
#articleContent h4, #articleContent h5, #articleContent h6 {
    clear: both;
}
/* Table styles */
#articleContent table {
    width: 100%;
    border-collapse: collapse;
    margin: 1rem 0;
    clear: both;
}
#articleContent table th,
#articleContent table td {
    border: 1px solid #d1d5db;
    padding: 0.5rem 1rem;
    text-align: left;
}
#articleContent table th {
    background-color: #f3f4f6;
    font-weight: 600;
}
/* Responsive */
@media (max-width: 768px) {
    #articleContent figure[style*="float: left"],
    #articleContent figure[style*="float:left"],
    #articleContent figure[style*="float: right"],
    #articleContent figure[style*="float:right"] {
        float: none !important;
        max-width: 100% !important;
        margin: 1rem auto !important;
    }
}


/* Facebook-style Comments */
.comment-item {
    position: relative;
}
.reply-item {
    position: relative;
    transition: all 0.2s ease;
}

/* Nested reply (reply to reply) - indent styling */
.reply-item.nested-reply {
    margin-left: 2.5rem;
    position: relative;
}
.reply-item.nested-reply::before {
    content: '‚Ü≥';
    position: absolute;
    left: -1.5rem;
    top: 0.5rem;
    color: #9ca3af;
    font-size: 0.875rem;
}

/* Reaction Popup - Facebook style */
.reaction-popup {
    animation: popIn 0.15s ease-out;
    box-shadow: 0 2px 12px rgba(0,0,0,0.15);
}
@keyframes popIn {
    0% { opacity: 0; transform: scale(0.8); }
    100% { opacity: 1; transform: scale(1); }
}
.group:hover .reaction-popup,
.reaction-popup:hover {
    display: flex !important;
}

/* Comment bubble hover effect */
.comment-item .bg-gray-100:hover,
.reply-item .bg-gray-100:hover {
    background-color: #e4e6eb;
}

/* Author badge - Facebook blue */
.bg-blue-500 {
    background: #1877f2 !important;
}

/* Reaction colors - Facebook style */
.text-blue-500 { color: #1877f2 !important; }
.text-blue-600 { color: #1877f2 !important; }
.text-red-500 { color: #f33e58 !important; }
.text-yellow-500 { color: #f7b928 !important; }
.text-orange-500 { color: #e9710f !important; }

/* Thread line for replies */
.border-l-2.border-gray-200 {
    border-color: #ccd0d5;
}

/* Smooth transitions */
.comment-item, .reply-item {
    transition: all 0.2s ease;
}

/* Action buttons */
.comment-item button, .reply-item button {
    transition: color 0.15s, transform 0.1s;
}
.comment-item button:active, .reply-item button:active {
    transform: scale(0.95);
}

/* Replies container animation */
#commentsList [id^="replies-container-"] {
    transition: all 0.3s ease;
}
#commentsList [id^="replies-container-"]:not(.hidden) {
    animation: slideDown 0.2s ease-out;
}
@keyframes slideDown {
    0% { opacity: 0; transform: translateY(-10px); }
    100% { opacity: 1; transform: translateY(0); }
}

/* @mention highlight */
.text-blue-600.font-semibold {
    background: linear-gradient(to bottom, transparent 60%, rgba(24, 119, 242, 0.1) 60%);
}
</style>

<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Back button -->
        <div class="mb-6">
            <a href="/articles" class="inline-flex items-center text-ruxchai-primary hover:text-ruxchai-primary/80 transition-colors">
                <i class="fas fa-arrow-left mr-2"></i><%= t('backToArticles') %>
            </a>
        </div>

        <!-- Article Header -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden mb-8">
            <div class="relative">
                <img id="featuredImage" src="/images/default-article.svg" alt="" class="w-full h-64 md:h-96 object-cover default-image">
                <div class="absolute inset-0 bg-gradient-to-t from-black/50 to-transparent"></div>
                <div class="absolute bottom-6 left-6 right-6 text-white">
                    <div class="flex flex-wrap gap-2 mb-4">
                        <span id="categoryBadge" class="px-3 py-1 bg-ruxchai-primary rounded-full text-sm"></span>
                        <span id="statusBadge" class="px-3 py-1 bg-white/20 rounded-full text-sm backdrop-blur-sm"></span>
                    </div>
                    <h1 id="articleTitle" class="text-3xl md:text-4xl font-bold mb-4"></h1>
                    <div class="flex items-center space-x-6 text-sm">
                        <div class="flex items-center space-x-2">
                            <img id="authorAvatar" src="/images/default-avatar.png" alt="" class="w-8 h-8 rounded-full">
                            <span id="authorName"></span>
                        </div>
                        <span id="publishDate"></span>
                        <span id="readTime"></span>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
            <!-- Main Content -->
            <div class="lg:col-span-3">
                <!-- Article Stats -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mb-8">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-6">
                            <div class="text-center">
                                <p id="viewCount" class="text-2xl font-bold text-gray-900">0</p>
                                <p class="text-sm text-gray-500"><%= t('views') %></p>
                            </div>
                            <div class="text-center">
                                <p id="likeCount" class="text-2xl font-bold text-gray-900">0</p>
                                <p class="text-sm text-gray-500"><%= t('likes') %></p>
                            </div>
                            <div class="text-center">
                                <p id="commentCount" class="text-2xl font-bold text-gray-900">0</p>
                                <p class="text-sm text-gray-500"><%= t('comments') %></p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-3">
                            <button id="likeBtn" class="flex items-center space-x-2 px-4 py-2 rounded-lg border border-gray-300 hover:bg-gray-50 transition-colors">
                                <i class="far fa-heart"></i>
                                <span><%= t('like') %></span>
                            </button>
                            <button id="shareBtn" class="flex items-center space-x-2 px-4 py-2 rounded-lg border border-gray-300 hover:bg-gray-50 transition-colors">
                                <i class="fas fa-share"></i>
                                <span><%= t('share') %></span>
                            </button>
                            <button id="saveBtn" class="flex items-center space-x-2 px-4 py-2 rounded-lg border border-gray-300 hover:bg-gray-50 transition-colors">
                                <i class="far fa-bookmark"></i>
                                <span><%= t('save') %></span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Article Content -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-8 mb-8">
                    <div id="articleSummary" class="text-lg text-gray-600 mb-8 p-4 bg-gray-50 rounded-lg border-l-4 border-ruxchai-primary"></div>
                    <div id="articleContent" class="prose prose-lg max-w-none"></div>
                </div>

                <!-- Tags -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mb-8">
                    <h3 class="text-lg font-bold text-gray-900 mb-4"><%= t('tags') %></h3>
                    <div id="articleTags" class="flex flex-wrap gap-2"></div>
                </div>

                <!-- Author Info -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mb-8">
                    <h3 class="text-lg font-bold text-gray-900 mb-4"><%= t('aboutAuthor') %></h3>
                    <div class="flex items-start space-x-4">
                        <img id="authorInfoAvatar" src="/images/default-avatar.png" alt="" class="w-16 h-16 rounded-full">
                        <div class="flex-1">
                            <h4 id="authorInfoName" class="text-xl font-bold text-gray-900 mb-2"></h4>
                            <p id="authorBio" class="text-gray-600 mb-4"></p>
                            <div class="flex items-center space-x-4 text-sm text-gray-500">
                                <span id="authorArticles"><%= t('articlesLabel') %>0</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Comments Section -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-lg font-bold text-gray-900"><%= t('comments') %></h3>
                        <div class="relative">
                            <button id="sortCommentsBtn" class="flex items-center gap-1 text-sm text-ruxchai-primary hover:text-ruxchai-primary/80">
                                <span id="sortLabel">‡πÉ‡∏´‡∏°‡πà‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</span>
                                <i class="fas fa-chevron-down text-xs"></i>
                            </button>
                            <div id="sortDropdown" class="hidden absolute right-0 top-full mt-1 bg-white border rounded-lg shadow-lg py-1 min-w-[140px] z-10">
                                <button onclick="sortComments('newest')" class="w-full text-left px-4 py-2 text-sm hover:bg-gray-100">‡πÉ‡∏´‡∏°‡πà‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</button>
                                <button onclick="sortComments('oldest')" class="w-full text-left px-4 py-2 text-sm hover:bg-gray-100">‡πÄ‡∏Å‡πà‡∏≤‡∏™‡∏∏‡∏î</button>
                                <button onclick="sortComments('popular')" class="w-full text-left px-4 py-2 text-sm hover:bg-gray-100">‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏°</button>
                            </div>
                        </div>
                    </div>

                    <!-- Comment Form -->
                    <div class="mb-8">
                        <textarea id="commentText" rows="3" placeholder="<%= t('addCommentPlaceholder') %>"
                                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-ruxchai-primary focus:border-transparent resize-none"></textarea>
                        <div class="flex justify-between items-center mt-3">
                            <div class="text-sm text-gray-500">
                                <span id="commentCharCount">0</span>/1000 <%= t('characters') %>
                            </div>
                            <button id="submitComment" class="px-6 py-2 bg-ruxchai-primary text-white rounded-lg hover:bg-ruxchai-primary/90 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                                <%= t('submitComment') %>
                            </button>
                        </div>
                    </div>

                    <!-- Comments List -->
                    <div id="commentsList" class="space-y-6">
                        <!-- Comments will be loaded here -->
                    </div>

                    <!-- Load More Comments -->
                    <div class="text-center mt-6">
                        <button id="loadMoreComments" class="px-6 py-2 text-ruxchai-primary border border-ruxchai-primary rounded-lg hover:bg-ruxchai-primary hover:text-white transition-colors hidden">
                            <%= t('loadMoreComments') %>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="lg:col-span-1">
                <!-- Table of Contents -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mb-6 sticky top-6">
                    <h3 class="text-lg font-bold text-gray-900 mb-4"><%= t('tableOfContents') %></h3>
                    <div id="tableOfContents" class="space-y-2 text-sm">
                        <!-- TOC will be generated here -->
                    </div>
                </div>

                <!-- Related Articles -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mb-6">
                    <h3 class="text-lg font-bold text-gray-900 mb-4"><%= t('relatedArticles') %></h3>
                    <div id="relatedArticles" class="space-y-4">
                        <!-- Related articles will be loaded here -->
                    </div>
                </div>

            </div>
        </div>
</div>

<!-- Share Modal -->
<div id="shareModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full">
            <div class="flex justify-between items-center p-6 border-b">
                <h3 class="text-xl font-bold text-gray-900"><%= t('shareArticle') %></h3>
                <button id="closeShareModal" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-6">
                <div class="space-y-4">
                    <button class="w-full flex items-center space-x-3 px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
                            onclick="shareToFacebook()">
                        <i class="fab fa-facebook-f"></i>
                        <span><%= t('shareToFacebook') %></span>
                    </button>
                    <button class="w-full flex items-center space-x-3 px-4 py-3 bg-blue-400 text-white rounded-lg hover:bg-blue-500 transition-colors"
                            onclick="shareToTwitter()">
                        <i class="fab fa-twitter"></i>
                        <span><%= t('shareToTwitter') %></span>
                    </button>
                    <button class="w-full flex items-center space-x-3 px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors"
                            onclick="shareToLine()">
                        <i class="fab fa-line"></i>
                        <span><%= t('shareToLine') %></span>
                    </button>
                    <div class="relative">
                        <input type="text" id="articleUrl" readonly
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-50">
                        <button onclick="copyUrl()" class="absolute right-2 top-1/2 transform -translate-y-1/2 px-3 py-1 bg-ruxchai-primary text-white text-sm rounded">
                            <%= t('copy') %>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Global variables
const SITE_NAME = '<%= typeof getSetting === "function" ? getSetting("site_name", "Rukchai Hongyen LearnHub") : "Rukchai Hongyen LearnHub" %>';
const currentLanguage = '<%= currentLanguage || "th" %>';
let articleId;
let currentUser;
let comments = [];
let commentsPage = 1;
let commentSort = 'newest'; // newest, oldest, popular
let currentReplyToUserId = null; // Track who we're replying to

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    articleId = window.location.pathname.split('/')[2];
    loadArticle();
    loadComments();
    loadRelatedArticles();
    setupEventListeners();
});

// Event listeners
function setupEventListeners() {
    // Like button
    document.getElementById('likeBtn').addEventListener('click', toggleLike);

    // Share button
    document.getElementById('shareBtn').addEventListener('click', () => {
        document.getElementById('articleUrl').value = window.location.href;
        document.getElementById('shareModal').classList.remove('hidden');
    });

    // Close share modal
    document.getElementById('closeShareModal').addEventListener('click', () => {
        document.getElementById('shareModal').classList.add('hidden');
    });

    // Save button
    document.getElementById('saveBtn').addEventListener('click', toggleSave);

    // Sort comments dropdown
    document.getElementById('sortCommentsBtn').addEventListener('click', (e) => {
        e.stopPropagation();
        document.getElementById('sortDropdown').classList.toggle('hidden');
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', () => {
        document.getElementById('sortDropdown').classList.add('hidden');
    });

    // Comment form
    document.getElementById('commentText').addEventListener('input', updateCharCount);
    document.getElementById('submitComment').addEventListener('click', submitComment);

    // Load more comments
    document.getElementById('loadMoreComments').addEventListener('click', loadMoreComments);
}

// Sort comments function
function sortComments(sortType) {
    commentSort = sortType;
    commentsPage = 1;

    // Update label
    const labels = { newest: '‡πÉ‡∏´‡∏°‡πà‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î', oldest: '‡πÄ‡∏Å‡πà‡∏≤‡∏™‡∏∏‡∏î', popular: '‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏°' };
    document.getElementById('sortLabel').textContent = labels[sortType];

    // Hide dropdown
    document.getElementById('sortDropdown').classList.add('hidden');

    // Reload comments
    loadComments();
}

// Load article
async function loadArticle() {
    try {
        const response = await fetch(`/articles/api/${articleId}`);
        const data = await response.json();

        if (data.success) {
            displayArticle(data.data);
            generateTableOfContents();
        } else {
            showMessage('<%= t ? t("articleNotFound") : "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°" %>', 'error');
        }
    } catch (error) {
        console.error('Error loading article:', error);
        showMessage('<%= t ? t("errorLoadingArticle") : "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°" %>', 'error');
    }
}

// Sanitize article content - clean up corrupted/legacy content
// Keep user's alignment settings (float, text-align, margin for centering)
function sanitizeArticleContent(html) {
    // Create a temporary div to parse HTML
    const temp = document.createElement('div');
    temp.innerHTML = html;

    // Remove resize handles and toolbar (if any leaked into saved content)
    temp.querySelectorAll('.resize-handle, .img-edit-toolbar, .img-resize-wrapper').forEach(el => el.remove());

    // Clean up figures - remove editor-specific attributes but KEEP alignment
    temp.querySelectorAll('figure').forEach(figure => {
        figure.removeAttribute('id');
        figure.removeAttribute('onclick');
        figure.removeAttribute('class');

        // Save user's alignment settings before cleaning
        const savedFloat = figure.style.float || figure.style.cssFloat;
        const savedTextAlign = figure.style.textAlign;
        const savedMarginLeft = figure.style.marginLeft;
        const savedMarginRight = figure.style.marginRight;

        // Remove ONLY problematic inline styles (display:table, fixed width, position)
        figure.style.display = '';
        figure.style.width = '';
        figure.style.maxWidth = '';
        figure.style.position = '';
        figure.style.cursor = '';
        figure.style.clear = '';

        // Restore user's alignment settings
        if (savedFloat && savedFloat !== 'none') {
            figure.style.float = savedFloat;
            // Keep margin for float
            if (savedFloat === 'left') {
                figure.style.marginRight = savedMarginRight || '1rem';
            } else if (savedFloat === 'right') {
                figure.style.marginLeft = savedMarginLeft || '1rem';
            }
        } else {
            // No float - check if centered
            if (savedTextAlign === 'center' ||
                (savedMarginLeft === 'auto' && savedMarginRight === 'auto') ||
                savedMarginLeft === '0px auto' || savedMarginRight === '0px auto') {
                figure.style.textAlign = 'center';
                figure.style.marginLeft = 'auto';
                figure.style.marginRight = 'auto';
            }
        }

        // Remove all data-* attributes
        Object.keys(figure.dataset).forEach(key => delete figure.dataset[key]);
    });

    // Clean up images - remove editor-specific styles but keep border-radius
    temp.querySelectorAll('img').forEach(img => {
        // Save border-radius if set
        const savedBorderRadius = img.style.borderRadius;

        img.style.border = '';
        img.style.boxSizing = '';
        img.style.position = '';
        img.style.width = '';
        img.style.height = '';
        img.style.maxWidth = '';
        img.style.display = '';
        img.style.margin = '';

        // Restore border-radius
        if (savedBorderRadius) {
            img.style.borderRadius = savedBorderRadius;
        }

        img.removeAttribute('data-original-border-radius');
        // Remove any data-* attributes
        Object.keys(img.dataset).forEach(key => delete img.dataset[key]);
    });

    // Fix nested <p> tags - unwrap inner <p> elements
    temp.querySelectorAll('p p').forEach(innerP => {
        const parent = innerP.parentElement;
        while (innerP.firstChild) {
            parent.insertBefore(innerP.firstChild, innerP);
        }
        innerP.remove();
    });

    // Remove empty paragraphs
    temp.querySelectorAll('p').forEach(p => {
        if (p.innerHTML.trim() === '' || p.innerHTML === '<br>') {
            p.remove();
        }
    });

    return temp.innerHTML;
}

// Display article
function displayArticle(article) {
    document.title = `${article.title} - ${SITE_NAME}`;

    const featuredImg = document.getElementById('featuredImage');
    const imgSrc = article.featured_image || '/images/default-article.svg';
    featuredImg.src = imgSrc;
    featuredImg.alt = article.title;

    // Add class for default image styling
    if (!article.featured_image || imgSrc.includes('default-article')) {
        featuredImg.classList.add('default-image');
    } else {
        featuredImg.classList.remove('default-image');
    }

    document.getElementById('categoryBadge').textContent = getCategoryName(article.category);
    document.getElementById('statusBadge').textContent = getStatusName(article.status);

    document.getElementById('articleTitle').textContent = article.title;
    // Support both field names from API
    document.getElementById('authorAvatar').src = article.author_image || article.author_avatar || '/images/default-avatar.png';
    document.getElementById('authorName').textContent = article.author_name;
    document.getElementById('publishDate').textContent = formatDate(article.created_at);
    document.getElementById('readTime').textContent = `${article.reading_time || article.read_time || 5} <%= t ? t("minutes") : "‡∏ô‡∏≤‡∏ó‡∏µ" %>`;

    // Support both field names: views/views_count, likes/likes_count
    document.getElementById('viewCount').textContent = article.views_count || article.views || 0;
    document.getElementById('likeCount').textContent = article.likes_count || article.likes || 0;
    document.getElementById('commentCount').textContent = article.comments_count || article.comments || 0;

    // Support both field names: summary/excerpt
    const summaryText = article.summary || article.excerpt;
    if (summaryText) {
        document.getElementById('articleSummary').textContent = summaryText;
    } else {
        document.getElementById('articleSummary').style.display = 'none';
    }

    // Sanitize content before displaying (handles corrupted/legacy content)
    document.getElementById('articleContent').innerHTML = sanitizeArticleContent(article.content);

    // Tags
    const tagsContainer = document.getElementById('articleTags');
    if (article.tags && article.tags.length > 0) {
        tagsContainer.innerHTML = article.tags.map(tag =>
            `<span class="px-3 py-1 bg-gray-100 text-gray-700 text-sm rounded-full hover:bg-gray-200 cursor-pointer">${tag}</span>`
        ).join('');
    } else {
        tagsContainer.innerHTML = '<span class="text-gray-500"><%= t('noTags') %></span>';
    }

    // Author info
    document.getElementById('authorInfoAvatar').src = article.author_avatar || '/images/default-avatar.png';
    document.getElementById('authorInfoName').textContent = article.author_name;
    document.getElementById('authorBio').textContent = article.author_bio || '<%= t('noBioYet') %>';
    document.getElementById('authorArticles').textContent = `<%= t('articlesLabel') %>${article.author_articles || 0}`;

    // Update button states
    updateLikeButton(article.is_liked);
    updateSaveButton(article.is_saved);

    // Increment view count
    incrementViewCount();
}

// Generate table of contents
function generateTableOfContents() {
    const content = document.getElementById('articleContent');
    const headings = content.querySelectorAll('h1, h2, h3, h4, h5, h6');
    const tocContainer = document.getElementById('tableOfContents');

    if (headings.length === 0) {
        tocContainer.innerHTML = '<p class="text-gray-500"><%= t('noHeadings') %></p>';
        return;
    }

    const tocItems = Array.from(headings).map((heading, index) => {
        const id = `heading-${index}`;
        heading.id = id;

        const level = parseInt(heading.tagName.substring(1));
        const indent = (level - 1) * 12;

        return `
            <a href="#${id}" class="block py-1 text-gray-600 hover:text-ruxchai-primary transition-colors truncate"
               style="padding-left: ${indent}px;">
                ${heading.textContent}
            </a>
        `;
    });

    tocContainer.innerHTML = tocItems.join('');
}

// Load comments
async function loadComments() {
    try {
        const response = await fetch(`/articles/api/${articleId}/comments?page=${commentsPage}&sort=${commentSort}`);
        const data = await response.json();

        if (data.success) {
            if (commentsPage === 1) {
                comments = data.comments;
            } else {
                comments.push(...data.comments);
            }
            displayComments();

            if (data.pagination.has_next) {
                document.getElementById('loadMoreComments').classList.remove('hidden');
            } else {
                document.getElementById('loadMoreComments').classList.add('hidden');
            }
        }
    } catch (error) {
        console.error('Error loading comments:', error);
    }
}

// Display comments
function displayComments() {
    const container = document.getElementById('commentsList');

    if (comments.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center py-8"><%= t('noCommentsYetBeFirst') %></p>';
        return;
    }

    container.innerHTML = comments.map(comment => createCommentItem(comment)).join('');
}

// Create comment item - Facebook-style with Reactions
function createCommentItem(comment) {
    const replyCount = comment.replies ? comment.replies.length : 0;
    const hasReplies = replyCount > 0;
    const reactions = comment.reactions || { total: 0, like: 0, love: 0, haha: 0, wow: 0, sad: 0, angry: 0 };
    const userReaction = comment.user_reaction;
    const reactionIcons = getReactionIcons(reactions);

    return `
        <div class="comment-item mb-4" data-comment-id="${comment.comment_id}">
            ${comment.is_pinned ? '<div class="flex items-center text-xs text-amber-600 mb-2 ml-12"><i class="fas fa-thumbtack mr-1"></i> ‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡πÇ‡∏î‡∏¢‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô</div>' : ''}
            <div class="flex items-start gap-2">
                <!-- Avatar -->
                <img src="${comment.user_avatar || '/images/default-avatar.png'}"
                     alt="${comment.user_name}"
                     class="w-10 h-10 rounded-full flex-shrink-0 mt-0.5">

                <div class="flex-1 min-w-0">
                    <!-- Comment Bubble -->
                    <div class="inline-block max-w-[85%]">
                        <div class="bg-gray-100 rounded-2xl px-3 py-2 relative ${comment.is_pinned ? 'ring-2 ring-amber-200' : ''}">
                            <!-- Author name + badge -->
                            <div class="flex items-center gap-1.5 flex-wrap">
                                <span class="font-semibold text-[13px] text-gray-900 hover:underline cursor-pointer">${comment.user_name}</span>
                                ${comment.is_author ? '<span class="bg-blue-500 text-white text-[10px] px-1.5 py-0.5 rounded font-medium">‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô</span>' : ''}
                            </div>
                            <!-- Comment text -->
                            <div id="comment-display-${comment.comment_id}">
                                <p id="comment-text-${comment.comment_id}" class="text-[15px] text-gray-900 whitespace-pre-wrap break-words">${comment.content}</p>
                            </div>
                            <!-- Edit mode -->
                            <div id="comment-edit-${comment.comment_id}" class="hidden">
                                <textarea id="comment-edit-textarea-${comment.comment_id}" class="w-full p-2 border rounded-lg text-sm resize-none" rows="2">${comment.content}</textarea>
                                <div class="flex gap-2 mt-2">
                                    <button onclick="cancelEditComment(${comment.comment_id})" class="px-3 py-1 text-sm text-gray-600 hover:bg-gray-200 rounded">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                                    <button onclick="saveEditComment(${comment.comment_id})" class="px-3 py-1 text-sm bg-blue-500 text-white rounded hover:bg-blue-600">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                                </div>
                            </div>
                            <!-- Reactions badge -->
                            ${reactions.total > 0 ? `
                                <div class="absolute -bottom-2.5 right-2 flex items-center bg-white rounded-full shadow px-1 py-0.5 border text-xs">
                                    ${reactionIcons}<span class="ml-0.5 text-gray-500">${reactions.total}</span>
                                </div>
                            ` : ''}
                        </div>
                    </div>

                    <!-- Actions: Like ¬∑ Reply ¬∑ Time ¬∑ More -->
                    <div id="comment-actions-${comment.comment_id}" class="flex items-center gap-1 mt-1 ml-3 text-xs">
                        <!-- Like with reaction popup -->
                        <div class="relative group">
                            <button onclick="toggleReaction(${comment.comment_id}, '${userReaction || 'like'}')"
                                    class="${userReaction ? getReactionColor(userReaction) : 'text-gray-500 hover:text-gray-700'} font-semibold">
                                ${userReaction ? getReactionText(userReaction) : '‡∏ñ‡∏π‡∏Å‡πÉ‡∏à'}
                            </button>
                            <div class="reaction-popup absolute bottom-full left-0 mb-2 hidden group-hover:flex bg-white rounded-full shadow-xl px-2 py-1.5 gap-1 border z-50">
                                <button onclick="event.stopPropagation(); toggleReaction(${comment.comment_id}, 'like')" class="text-xl hover:scale-125 transition-transform" title="‡∏ñ‡∏π‡∏Å‡πÉ‡∏à">üëç</button>
                                <button onclick="event.stopPropagation(); toggleReaction(${comment.comment_id}, 'love')" class="text-xl hover:scale-125 transition-transform" title="‡∏£‡∏±‡∏Å">‚ù§Ô∏è</button>
                                <button onclick="event.stopPropagation(); toggleReaction(${comment.comment_id}, 'haha')" class="text-xl hover:scale-125 transition-transform" title="‡∏Æ‡πà‡∏≤‡πÜ">üòÇ</button>
                                <button onclick="event.stopPropagation(); toggleReaction(${comment.comment_id}, 'wow')" class="text-xl hover:scale-125 transition-transform" title="‡∏ß‡πâ‡∏≤‡∏ß">üòÆ</button>
                                <button onclick="event.stopPropagation(); toggleReaction(${comment.comment_id}, 'sad')" class="text-xl hover:scale-125 transition-transform" title="‡πÄ‡∏®‡∏£‡πâ‡∏≤">üò¢</button>
                                <button onclick="event.stopPropagation(); toggleReaction(${comment.comment_id}, 'angry')" class="text-xl hover:scale-125 transition-transform" title="‡πÇ‡∏Å‡∏£‡∏ò">üò°</button>
                            </div>
                        </div>
                        <span class="text-gray-400">¬∑</span>
                        <button onclick="toggleReplyForm(${comment.comment_id}, '${comment.user_name}', ${comment.user_id})" class="text-gray-500 hover:text-gray-700 font-semibold">‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö</button>
                        <span class="text-gray-400">¬∑</span>
                        <span class="text-gray-400">${formatTimeAgo(comment.created_at)}</span>
                        ${comment.can_edit ? `<span class="text-gray-400">¬∑</span><button onclick="editComment(${comment.comment_id})" class="text-gray-500 hover:text-blue-500">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>` : ''}
                        ${comment.can_delete ? `<span class="text-gray-400">¬∑</span><button onclick="deleteComment(${comment.comment_id})" class="text-gray-500 hover:text-red-500">‡∏•‡∏ö</button>` : ''}
                        ${comment.can_pin ? `<span class="text-gray-400">¬∑</span><button onclick="pinComment(${comment.comment_id})" class="text-gray-500 hover:text-amber-500">${comment.is_pinned ? '‡πÄ‡∏•‡∏¥‡∏Å‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î' : '‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î'}</button>` : ''}
                    </div>

                    <!-- Reply Form -->
                    <div id="reply-form-${comment.comment_id}" class="hidden mt-3">
                        <div class="flex items-start gap-2">
                            <img src="<%= user?.profile_image || '/images/default-avatar.png' %>" class="w-8 h-8 rounded-full flex-shrink-0">
                            <div class="flex-1">
                                <div class="bg-gray-100 rounded-2xl px-3 py-2">
                                    <span id="reply-to-name-${comment.comment_id}" class="text-blue-500 font-medium text-sm"></span>
                                    <textarea id="reply-textarea-${comment.comment_id}"
                                              class="w-full bg-transparent text-sm resize-none outline-none"
                                              placeholder="‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö..." rows="1"
                                              oninput="this.style.height='auto';this.style.height=this.scrollHeight+'px'"></textarea>
                                </div>
                                <div class="flex justify-end gap-2 mt-1">
                                    <button onclick="cancelReply(${comment.comment_id})" class="px-3 py-1 text-xs text-gray-500 hover:bg-gray-100 rounded-full">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                                    <button onclick="submitReply(${comment.comment_id})" class="px-3 py-1 text-xs bg-blue-500 text-white rounded-full hover:bg-blue-600">‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Replies Section - with nested replies support -->
                    ${hasReplies ? `
                        <div class="mt-1">
                            <button onclick="toggleReplies(${comment.comment_id})" id="toggle-replies-btn-${comment.comment_id}"
                                    class="flex items-center gap-1.5 text-[13px] text-gray-500 hover:text-gray-700 font-medium ml-1 py-1">
                                <i class="fas fa-reply fa-flip-horizontal text-xs"></i>
                                <span id="toggle-replies-text-${comment.comment_id}">${replyCount} ‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö</span>
                                <i id="toggle-replies-icon-${comment.comment_id}" class="fas fa-chevron-down text-[10px] transition-transform duration-200"></i>
                            </button>
                            <div id="replies-container-${comment.comment_id}" class="hidden mt-2 space-y-2">
                                ${renderNestedReplies(comment.replies, comment)}
                            </div>
                        </div>
                    ` : ''}
                </div>
            </div>
        </div>
    `;
}

// Render replies with proper nesting based on reply_to_comment_id
function renderNestedReplies(replies, parentComment) {
    if (!replies || replies.length === 0) return '';

    let html = '';

    // Build a map of reply ID to reply object for quick lookup
    const replyMap = {};
    replies.forEach(r => {
        replyMap[r.comment_id] = r;
    });

    // Direct replies: no reply_to_comment_id OR reply_to_comment_id not found in replies
    const directReplies = replies.filter(r => {
        if (!r.reply_to_comment_id) return true;
        return !replyMap[r.reply_to_comment_id];
    });

    // Nested replies: reply_to_comment_id points to another reply in our list
    const nestedReplies = replies.filter(r => {
        return r.reply_to_comment_id && replyMap[r.reply_to_comment_id];
    });

    // Group nested replies by their parent reply ID
    const nestedByParent = {};
    nestedReplies.forEach(r => {
        const parentId = r.reply_to_comment_id;
        if (!nestedByParent[parentId]) {
            nestedByParent[parentId] = [];
        }
        nestedByParent[parentId].push(r);
    });

    // Sort direct replies by created_at
    directReplies.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));

    // Helper function to recursively collect all descendants of a reply
    function collectAllDescendants(replyId) {
        const descendants = [];
        const children = nestedByParent[replyId] || [];
        children.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
        children.forEach(child => {
            descendants.push(child);
            // Recursively get grandchildren, great-grandchildren, etc.
            descendants.push(...collectAllDescendants(child.comment_id));
        });
        return descendants;
    }

    // Render direct replies with ALL their nested descendants (any depth)
    directReplies.forEach(reply => {
        // Render the direct reply (level 1)
        html += createReplyItem(reply, parentComment, false);

        // Get all descendants of this direct reply and render them as nested
        const allDescendants = collectAllDescendants(reply.comment_id);
        allDescendants.forEach(descendant => {
            html += createReplyItem(descendant, parentComment, true);
        });
    });

    return html;
}

// Create reply item - with nested replies support (reply to reply shows indented)
function createReplyItem(reply, parentComment, isNested = false) {
    const replyId = reply.comment_id || reply.reply_id;
    const reactions = reply.reactions || { total: 0, like: 0, love: 0, haha: 0, wow: 0, sad: 0, angry: 0 };
    const userReaction = reply.user_reaction;
    const reactionIcons = getReactionIcons(reactions);

    // Show @mention if replying to someone specific (has reply_to_name)
    const showMention = reply.reply_to_name && reply.reply_to_name !== reply.user_name;

    // Nested reply styling
    const nestedClass = isNested ? 'nested-reply' : '';
    const avatarSize = 'w-8 h-8';

    return `
        <div class="reply-item flex items-start gap-2 ${nestedClass}" data-reply-id="${replyId}" data-nested="${isNested}">
            <img src="${reply.user_avatar || '/images/default-avatar.png'}"
                 alt="${reply.user_name}"
                 class="${avatarSize} rounded-full flex-shrink-0 mt-0.5 cursor-pointer hover:opacity-80">

            <div class="flex-1 min-w-0">
                <!-- Reply Bubble -->
                <div class="inline-block max-w-[90%]">
                    <div class="bg-gray-100 rounded-2xl px-3 py-2 relative hover:bg-gray-200/70 transition-colors">
                        <div class="flex items-center gap-1.5 flex-wrap">
                            <span class="font-semibold text-[13px] text-gray-900 hover:underline cursor-pointer">${reply.user_name}</span>
                            ${reply.is_author ? '<span class="bg-blue-500 text-white text-[10px] px-1.5 py-0.5 rounded font-medium">‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô</span>' : ''}
                        </div>
                        <!-- Reply Display -->
                        <div id="reply-display-${replyId}">
                            <p class="text-[15px] text-gray-900 break-words leading-snug">
                                ${showMention ? `<a href="#" class="text-blue-600 font-semibold hover:underline">@${reply.reply_to_name}</a> ` : ''}
                                <span class="whitespace-pre-wrap">${reply.content}</span>
                            </p>
                        </div>
                        <!-- Edit mode -->
                        <div id="reply-edit-${replyId}" class="hidden">
                            <textarea id="reply-edit-textarea-${replyId}" class="w-full p-2 border rounded-lg text-sm resize-none focus:ring-2 focus:ring-blue-500" rows="2">${reply.content}</textarea>
                            <div class="flex gap-2 mt-2 justify-end">
                                <button onclick="cancelEditReply(${replyId}, ${parentComment ? parentComment.comment_id : reply.parent_comment_id})" class="px-3 py-1 text-xs text-gray-600 hover:bg-gray-300 rounded-full transition-colors">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                                <button onclick="saveEditReply(${replyId}, ${parentComment ? parentComment.comment_id : reply.parent_comment_id})" class="px-3 py-1 text-xs bg-blue-500 text-white rounded-full hover:bg-blue-600 transition-colors">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                            </div>
                        </div>
                        <!-- Reactions badge -->
                        ${reactions.total > 0 ? `
                            <div class="absolute -bottom-2.5 right-2 flex items-center bg-white rounded-full shadow-md px-1.5 py-0.5 border text-[11px]">
                                ${reactionIcons}<span class="ml-0.5 text-gray-600 font-medium">${reactions.total}</span>
                            </div>
                        ` : ''}
                    </div>
                </div>

                <!-- Reply Actions - Facebook style -->
                <div class="flex items-center gap-1 mt-1 ml-3 text-xs" id="reply-actions-${replyId}">
                    <div class="relative group">
                        <button onclick="toggleReaction(${replyId}, '${userReaction || 'like'}')"
                                class="${userReaction ? getReactionColor(userReaction) : 'text-gray-500 hover:text-gray-700'} font-semibold hover:underline">
                            ${userReaction ? getReactionText(userReaction) : '‡∏ñ‡∏π‡∏Å‡πÉ‡∏à'}
                        </button>
                        <div class="reaction-popup absolute bottom-full left-0 mb-2 hidden group-hover:flex bg-white rounded-full shadow-xl px-2 py-1.5 gap-1 border z-50">
                            <button onclick="event.stopPropagation(); toggleReaction(${replyId}, 'like')" class="text-lg hover:scale-125 transition-transform" title="‡∏ñ‡∏π‡∏Å‡πÉ‡∏à">üëç</button>
                            <button onclick="event.stopPropagation(); toggleReaction(${replyId}, 'love')" class="text-lg hover:scale-125 transition-transform" title="‡∏£‡∏±‡∏Å">‚ù§Ô∏è</button>
                            <button onclick="event.stopPropagation(); toggleReaction(${replyId}, 'haha')" class="text-lg hover:scale-125 transition-transform" title="‡∏Æ‡πà‡∏≤‡πÜ">üòÇ</button>
                            <button onclick="event.stopPropagation(); toggleReaction(${replyId}, 'wow')" class="text-lg hover:scale-125 transition-transform" title="‡∏ß‡πâ‡∏≤‡∏ß">üòÆ</button>
                            <button onclick="event.stopPropagation(); toggleReaction(${replyId}, 'sad')" class="text-lg hover:scale-125 transition-transform" title="‡πÄ‡∏®‡∏£‡πâ‡∏≤">üò¢</button>
                            <button onclick="event.stopPropagation(); toggleReaction(${replyId}, 'angry')" class="text-lg hover:scale-125 transition-transform" title="‡πÇ‡∏Å‡∏£‡∏ò">üò°</button>
                        </div>
                    </div>
                    <span class="text-gray-400">¬∑</span>
                    <button onclick="toggleReplyForm(${parentComment ? parentComment.comment_id : reply.parent_comment_id}, '${reply.user_name}', ${reply.user_id}, ${replyId})"
                            class="text-gray-500 hover:text-gray-700 font-semibold hover:underline">‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö</button>
                    <span class="text-gray-400">¬∑</span>
                    <span class="text-gray-400">${formatTimeAgo(reply.created_at)}</span>
                    ${reply.can_edit ? `<span class="text-gray-400">¬∑</span><button onclick="editReply(${replyId}, ${parentComment ? parentComment.comment_id : reply.parent_comment_id})" class="text-gray-500 hover:text-blue-600 hover:underline">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>` : ''}
                    ${reply.can_delete ? `<span class="text-gray-400">¬∑</span><button onclick="deleteReply(${replyId}, ${parentComment ? parentComment.comment_id : reply.parent_comment_id})" class="text-gray-500 hover:text-red-500 hover:underline">‡∏•‡∏ö</button>` : ''}
                </div>
            </div>
        </div>
    `;
}

// Helper functions for reactions
function getReactionIcons(reactions) {
    const icons = [];
    if (reactions.like > 0) icons.push('<span class="text-sm">üëç</span>');
    if (reactions.love > 0) icons.push('<span class="text-sm">‚ù§Ô∏è</span>');
    if (reactions.haha > 0) icons.push('<span class="text-sm">üòÇ</span>');
    if (reactions.wow > 0) icons.push('<span class="text-sm">üòÆ</span>');
    if (reactions.sad > 0) icons.push('<span class="text-sm">üò¢</span>');
    if (reactions.angry > 0) icons.push('<span class="text-sm">üò°</span>');
    return icons.slice(0, 3).join(''); // Show max 3 icons
}

function getReactionColor(type) {
    const colors = {
        like: 'text-blue-500 font-bold',
        love: 'text-red-500 font-bold',
        haha: 'text-yellow-500 font-bold',
        wow: 'text-yellow-500 font-bold',
        sad: 'text-yellow-500 font-bold',
        angry: 'text-orange-500 font-bold'
    };
    return colors[type] || 'text-gray-500';
}

function getReactionText(type) {
    const texts = {
        like: 'üëç ‡∏ñ‡∏π‡∏Å‡πÉ‡∏à',
        love: '‚ù§Ô∏è ‡∏£‡∏±‡∏Å',
        haha: 'üòÇ ‡∏Æ‡πà‡∏≤‡πÜ',
        wow: 'üòÆ ‡∏ß‡πâ‡∏≤‡∏ß',
        sad: 'üò¢ ‡πÄ‡∏®‡∏£‡πâ‡∏≤',
        angry: 'üò° ‡πÇ‡∏Å‡∏£‡∏ò'
    };
    return texts[type] || '‡∏ñ‡∏π‡∏Å‡πÉ‡∏à';
}

// Toggle reaction API call
async function toggleReaction(commentId, reactionType) {
    try {
        const response = await fetch(`/articles/api/${articleId}/comments/${commentId}/react`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ reaction_type: reactionType })
        });

        const data = await response.json();
        if (data.success) {
            // Update local data and re-render
            const comment = comments.find(c => c.comment_id === commentId);
            if (comment) {
                comment.user_reaction = data.user_reaction;
                comment.reactions = data.reactions;
            }
            // Also check in replies
            for (const c of comments) {
                if (c.replies) {
                    const reply = c.replies.find(r => r.comment_id === commentId);
                    if (reply) {
                        reply.user_reaction = data.user_reaction;
                        reply.reactions = data.reactions;
                    }
                }
            }
            displayComments();
        }
    } catch (error) {
        console.error('Error toggling reaction:', error);
    }
}

// Pin comment API call
async function pinComment(commentId) {
    try {
        const response = await fetch(`/articles/api/${articleId}/comments/${commentId}/pin`, {
            method: 'POST'
        });

        const data = await response.json();
        if (data.success) {
            showMessage(data.message, 'success');
            commentsPage = 1;
            loadComments();
        } else {
            showMessage(data.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
        }
    } catch (error) {
        console.error('Error pinning comment:', error);
        showMessage('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
    }
}

// Duplicate removed - using the first createReplyItem function

// Toggle replies visibility - Facebook style
function toggleReplies(commentId) {
    const container = document.getElementById(`replies-container-${commentId}`);
    const text = document.getElementById(`toggle-replies-text-${commentId}`);
    const icon = document.getElementById(`toggle-replies-icon-${commentId}`);

    if (container.classList.contains('hidden')) {
        container.classList.remove('hidden');
        text.textContent = '‡∏ã‡πà‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö';
        icon.classList.add('rotate-180');
    } else {
        container.classList.add('hidden');
        const comment = comments.find(c => c.comment_id === commentId);
        const replyCount = comment && comment.replies ? comment.replies.length : 0;
        text.textContent = `‡∏î‡∏π‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö ${replyCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
        icon.classList.remove('rotate-180');
    }
}

// Format time ago - Facebook style (e.g., "2 ‡∏ä‡∏°.", "3 ‡∏ß‡∏±‡∏ô")
function formatTimeAgo(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const seconds = Math.floor((now - date) / 1000);

    if (seconds < 60) return '‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà';

    const minutes = Math.floor(seconds / 60);
    if (minutes < 60) return `${minutes} ‡∏ô‡∏≤‡∏ó‡∏µ`;

    const hours = Math.floor(minutes / 60);
    if (hours < 24) return `${hours} ‡∏ä‡∏°.`;

    const days = Math.floor(hours / 24);
    if (days < 7) return `${days} ‡∏ß‡∏±‡∏ô`;

    const weeks = Math.floor(days / 7);
    if (weeks < 4) return `${weeks} ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå`;

    const months = Math.floor(days / 30);
    if (months < 12) return `${months} ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô`;

    const years = Math.floor(days / 365);
    return `${years} ‡∏õ‡∏µ`;
}

// Auto resize textarea
function autoResizeTextarea(textarea) {
    textarea.style.height = 'auto';
    textarea.style.height = textarea.scrollHeight + 'px';
}

// Like reply function
async function likeReply(replyId) {
    try {
        const response = await fetch(`/articles/api/${articleId}/comments/${replyId}/like`, {
            method: 'POST'
        });

        const data = await response.json();

        if (data.success) {
            const btn = document.getElementById(`reply-like-btn-${replyId}`);
            if (data.is_liked) {
                btn.textContent = '‡∏ñ‡∏π‡∏Å‡πÉ‡∏à‡πÅ‡∏•‡πâ‡∏ß';
                btn.classList.add('text-red-500', 'font-bold');
                btn.classList.remove('text-gray-500');
            } else {
                btn.textContent = '‡∏ñ‡∏π‡∏Å‡πÉ‡∏à';
                btn.classList.remove('text-red-500', 'font-bold');
                btn.classList.add('text-gray-500');
            }
        }
    } catch (error) {
        console.error('Error liking reply:', error);
    }
}

// Load more comments
function loadMoreComments() {
    commentsPage++;
    loadComments();
}

// Update character count
function updateCharCount() {
    const textarea = document.getElementById('commentText');
    const charCount = document.getElementById('commentCharCount');
    const submitBtn = document.getElementById('submitComment');

    charCount.textContent = textarea.value.length;

    if (textarea.value.length > 1000) {
        charCount.classList.add('text-red-500');
        submitBtn.disabled = true;
    } else {
        charCount.classList.remove('text-red-500');
        submitBtn.disabled = textarea.value.trim().length === 0;
    }
}

// Submit comment
async function submitComment() {
    const content = document.getElementById('commentText').value.trim();
    if (!content) return;

    try {
        const response = await fetch(`/articles/api/${articleId}/comments`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ comment_text: content })
        });

        const data = await response.json();

        if (data.success) {
            document.getElementById('commentText').value = '';
            updateCharCount();
            commentsPage = 1;
            loadComments();
            showMessage('<%= t('commentAddedSuccessfully') %>', 'success');

            // Update comment count
            const currentCount = parseInt(document.getElementById('commentCount').textContent);
            document.getElementById('commentCount').textContent = currentCount + 1;
        } else {
            showMessage(data.message || '<%= t('errorOccurred') %>', 'error');
        }
    } catch (error) {
        console.error('Error submitting comment:', error);
        showMessage('<%= t('errorSubmittingComment') %>', 'error');
    }
}

// Edit comment
// Show inline edit form
function editComment(commentId) {
    const comment = comments.find(c => c.comment_id === commentId);
    if (!comment) return;

    // Hide display, show edit form
    document.getElementById(`comment-display-${commentId}`).classList.add('hidden');
    document.getElementById(`comment-edit-${commentId}`).classList.remove('hidden');
    document.getElementById(`comment-actions-${commentId}`).classList.add('hidden');
    
    // Focus on textarea
    const textarea = document.getElementById(`comment-edit-textarea-${commentId}`);
    textarea.focus();
    textarea.setSelectionRange(textarea.value.length, textarea.value.length);
}

// Cancel edit and restore display
function cancelEditComment(commentId) {
    const comment = comments.find(c => c.comment_id === commentId);
    if (!comment) return;

    // Restore original text
    document.getElementById(`comment-edit-textarea-${commentId}`).value = comment.content;
    
    // Show display, hide edit form
    document.getElementById(`comment-display-${commentId}`).classList.remove('hidden');
    document.getElementById(`comment-edit-${commentId}`).classList.add('hidden');
    document.getElementById(`comment-actions-${commentId}`).classList.remove('hidden');
}

// Save edited comment
async function saveEditComment(commentId) {
    const textarea = document.getElementById(`comment-edit-textarea-${commentId}`);
    const newText = textarea.value.trim();
    
    const comment = comments.find(c => c.comment_id === commentId);
    if (!comment || !newText || newText === comment.content) {
        cancelEditComment(commentId);
        return;
    }

    try {
        const response = await fetch(`/articles/api/${articleId}/comments/${commentId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ comment_text: newText })
        });

        const data = await response.json();

        if (data.success) {
            // Update local data
            comment.content = newText;
            
            // Update display text
            document.getElementById(`comment-text-${commentId}`).textContent = newText;
            
            // Switch back to display mode
            cancelEditComment(commentId);
            
            showMessage('<%= t("commentUpdatedSuccessfully") %>', 'success');
        } else {
            showMessage(data.message || '<%= t("errorOccurred") %>', 'error');
        }
    } catch (error) {
        console.error('Error editing comment:', error);
        showMessage('<%= t("errorEditingComment") %>', 'error');
    }
}

// Delete comment
async function deleteComment(commentId) {
    if (!confirm('<%= t("confirmDeleteComment") %>')) return;

    try {
        const response = await fetch(`/articles/api/${articleId}/comments/${commentId}`, {
            method: 'DELETE'
        });

        const data = await response.json();

        if (data.success) {
            commentsPage = 1;
            loadComments();
            showMessage('<%= t("commentDeletedSuccessfully") %>', 'success');

            // Update comment count
            const currentCount = parseInt(document.getElementById('commentCount').textContent);
            document.getElementById('commentCount').textContent = Math.max(0, currentCount - 1);
        } else {
            showMessage(data.message || '<%= t("errorOccurred") %>', 'error');
        }
    } catch (error) {
        console.error('Error deleting comment:', error);
        showMessage('<%= t("errorDeletingComment") %>', 'error');
    }
}

// ============ Reply Edit/Delete Functions (Facebook-style) ============

// Edit reply - show edit form
function editReply(replyId, parentCommentId) {
    // Hide display, show edit form
    document.getElementById(`reply-display-${replyId}`).classList.add('hidden');
    document.getElementById(`reply-edit-${replyId}`).classList.remove('hidden');
    document.getElementById(`reply-actions-${replyId}`).classList.add('hidden');

    // Focus on textarea
    const textarea = document.getElementById(`reply-edit-textarea-${replyId}`);
    if (textarea) {
        textarea.focus();
        textarea.setSelectionRange(textarea.value.length, textarea.value.length);
    }
}

// Cancel edit reply
function cancelEditReply(replyId, parentCommentId) {
    // Show display, hide edit form
    document.getElementById(`reply-display-${replyId}`).classList.remove('hidden');
    document.getElementById(`reply-edit-${replyId}`).classList.add('hidden');
    document.getElementById(`reply-actions-${replyId}`).classList.remove('hidden');

    // Reset textarea to original content
    const comment = comments.find(c => c.comment_id === parentCommentId);
    if (comment && comment.replies) {
        const reply = comment.replies.find(r => (r.comment_id || r.reply_id) == replyId);
        if (reply) {
            document.getElementById(`reply-edit-textarea-${replyId}`).value = reply.content;
        }
    }
}

// Save edited reply
async function saveEditReply(replyId, parentCommentId) {
    const textarea = document.getElementById(`reply-edit-textarea-${replyId}`);
    const newText = textarea.value.trim();

    if (!newText) {
        showMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô', 'error');
        return;
    }

    try {
        const response = await fetch(`/articles/api/${articleId}/comments/${replyId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ comment_text: newText })
        });

        const data = await response.json();

        if (data.success) {
            // Update in local array
            const comment = comments.find(c => c.comment_id === parentCommentId);
            if (comment && comment.replies) {
                const reply = comment.replies.find(r => (r.comment_id || r.reply_id) == replyId);
                if (reply) {
                    reply.content = newText;
                }
            }

            // Update display
            const textEl = document.getElementById(`reply-text-${replyId}`);
            if (textEl) {
                // Keep @mention if exists
                const mentionMatch = textEl.innerHTML.match(/<span class="text-ruxchai-primary font-medium">@[^<]+<\/span>\s*/);
                const mention = mentionMatch ? mentionMatch[0] : '';
                textEl.innerHTML = mention + `<span class="whitespace-pre-wrap">${newText}</span>`;
            }

            // Hide edit form
            cancelEditReply(replyId, parentCommentId);
            showMessage('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
        } else {
            showMessage(data.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
        }
    } catch (error) {
        console.error('Error editing reply:', error);
        showMessage('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç', 'error');
    }
}

// Delete reply
async function deleteReply(replyId, parentCommentId) {
    if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;

    try {
        const response = await fetch(`/articles/api/${articleId}/comments/${replyId}`, {
            method: 'DELETE'
        });

        const data = await response.json();

        if (data.success) {
            // Reload comments to refresh the list
            commentsPage = 1;
            loadComments();
            showMessage('‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');

            // Update comment count
            const currentCount = parseInt(document.getElementById('commentCount').textContent);
            document.getElementById('commentCount').textContent = Math.max(0, currentCount - 1);
        } else {
            showMessage(data.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
        }
    } catch (error) {
        console.error('Error deleting reply:', error);
        showMessage('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö', 'error');
    }
}


// Like comment
async function likeComment(commentId) {
    try {
        const response = await fetch(`/articles/api/${articleId}/comments/${commentId}/like`, {
            method: 'POST'
        });

        const data = await response.json();

        if (data.success) {
            // Update like count
            document.getElementById(`like-count-${commentId}`).textContent = data.like_count;
            
            // Update icon style
            const icon = document.getElementById(`like-icon-${commentId}`);
            const btn = document.getElementById(`like-btn-${commentId}`);
            // Update button style and text
            const likeText = document.getElementById(`like-text-${commentId}`);
            if (data.is_liked) {
                btn.classList.add('text-red-500', 'font-bold');
                btn.classList.remove('text-gray-500');
                if (likeText) likeText.textContent = '‡∏ñ‡∏π‡∏Å‡πÉ‡∏à‡πÅ‡∏•‡πâ‡∏ß';
            } else {
                btn.classList.remove('text-red-500', 'font-bold');
                btn.classList.add('text-gray-500');
                if (likeText) likeText.textContent = '‡∏ñ‡∏π‡∏Å‡πÉ‡∏à';
            }

            // Update like count display
            const likeCountEl = document.getElementById(`like-count-${commentId}`);
            if (likeCountEl) likeCountEl.textContent = data.like_count;
        } else {
            showMessage(data.message || '<%= t("errorOccurred") %>', 'error');
        }
    } catch (error) {
        console.error('Error liking comment:', error);
    }
}

// Follow comment - toggle follow/unfollow for notifications
async function followComment(commentId) {
    try {
        const response = await fetch(`/articles/api/${articleId}/comments/${commentId}/follow`, {
            method: 'POST'
        });

        const data = await response.json();

        if (data.success) {
            // Update icon style
            const icon = document.getElementById(`follow-icon-${commentId}`);
            const btn = document.getElementById(`follow-btn-${commentId}`);
            if (data.is_following) {
                icon.classList.remove('far');
                icon.classList.add('fas');
                btn.classList.add('text-blue-500');
            } else {
                icon.classList.remove('fas');
                icon.classList.add('far');
                btn.classList.remove('text-blue-500');
            }
            showMessage(data.is_following ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡∏ô‡∏µ‡πâ' : '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡πÅ‡∏•‡πâ‡∏ß', 'success');
        } else {
            showMessage(data.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
        }
    } catch (error) {
        console.error('Error following comment:', error);
        showMessage('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
    }
}

// Reply to comment
// Store current reply target info
let currentReplyToCommentId = null;

// Toggle reply form visibility - Updated for nested replies
function toggleReplyForm(commentId, replyToName = '', replyToUserId = null, replyToCommentId = null) {
    const form = document.getElementById(`reply-form-${commentId}`);
    const isHidden = form.classList.contains('hidden');

    // Hide all other reply forms first
    document.querySelectorAll('[id^="reply-form-"]').forEach(f => {
        f.classList.add('hidden');
    });

    // Reset reply target
    currentReplyToUserId = null;
    currentReplyToCommentId = null;

    if (isHidden) {
        form.classList.remove('hidden');
        const textarea = document.getElementById(`reply-textarea-${commentId}`);
        const replyToNameSpan = document.getElementById(`reply-to-name-${commentId}`);

        // Set @mention and user ID if replying to someone specific
        if (replyToName && replyToNameSpan) {
            replyToNameSpan.textContent = '@' + replyToName + ' ';
            currentReplyToUserId = replyToUserId;
            currentReplyToCommentId = replyToCommentId;  // Store reply ID for nested replies
        } else if (replyToNameSpan) {
            replyToNameSpan.textContent = '';
        }

        textarea.focus();
    }
}

// Cancel reply
function cancelReply(commentId) {
    const form = document.getElementById(`reply-form-${commentId}`);
    const textarea = document.getElementById(`reply-textarea-${commentId}`);
    textarea.value = '';
    form.classList.add('hidden');
}

// Submit reply
async function submitReply(commentId) {
    const textarea = document.getElementById(`reply-textarea-${commentId}`);
    const replyText = textarea.value.trim();
    
    if (!replyText) {
        showMessage('<%= t("pleaseEnterComment") || "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô" %>', 'error');
        return;
    }

    try {
        const response = await fetch(`/articles/api/${articleId}/comments/${commentId}/reply`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                comment_text: replyText,
                reply_to_user_id: currentReplyToUserId,
                reply_to_comment_id: currentReplyToCommentId  // For nested replies
            })
        });

        const data = await response.json();

        if (data.success) {
            // Clear and hide form
            textarea.value = '';
            document.getElementById(`reply-form-${commentId}`).classList.add('hidden');
            
            // Reload comments
            commentsPage = 1;
            loadComments();
            showMessage('<%= t("replyAddedSuccessfully") || "‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à" %>', 'success');

            // Update comment count
            const currentCount = parseInt(document.getElementById('commentCount').textContent);
            document.getElementById('commentCount').textContent = currentCount + 1;
        } else {
            showMessage(data.message || '<%= t("errorOccurred") %>', 'error');
        }
    } catch (error) {
        console.error('Error replying to comment:', error);
        showMessage('<%= t("errorAddingReply") || "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î" %>', 'error');
    }
}

// Toggle like
async function toggleLike() {
    try {
        const response = await fetch(`/articles/api/${articleId}/like`, {
            method: 'POST'
        });

        const data = await response.json();

        if (data.success) {
            updateLikeButton(data.is_liked);
            document.getElementById('likeCount').textContent = data.like_count;
            showMessage(data.is_liked ? '<%= t('addedToLiked') %>' : '<%= t('unliked') %>', 'success');
        }
    } catch (error) {
        console.error('Error toggling like:', error);
        showMessage('<%= t('errorOccurred') %>', 'error');
    }
}

// Toggle save
async function toggleSave() {
    try {
        const response = await fetch(`/articles/api/${articleId}/save`, {
            method: 'POST'
        });

        const data = await response.json();

        if (data.success) {
            updateSaveButton(data.is_saved);
            showMessage(data.is_saved ? '<%= t('articleSavedToBookmarks') %>' : '<%= t('articleUnsaved') %>', 'success');
        }
    } catch (error) {
        console.error('Error toggling save:', error);
        showMessage('<%= t('errorOccurred') %>', 'error');
    }
}

// Update button states
function updateLikeButton(isLiked) {
    const btn = document.getElementById('likeBtn');
    const icon = btn.querySelector('i');

    if (isLiked) {
        btn.classList.add('bg-red-50', 'border-red-300', 'text-red-600');
        btn.classList.remove('border-gray-300', 'hover:bg-gray-50');
        icon.classList.remove('far');
        icon.classList.add('fas');
    } else {
        btn.classList.remove('bg-red-50', 'border-red-300', 'text-red-600');
        btn.classList.add('border-gray-300', 'hover:bg-gray-50');
        icon.classList.remove('fas');
        icon.classList.add('far');
    }
}

function updateSaveButton(isSaved) {
    const btn = document.getElementById('saveBtn');
    const icon = btn.querySelector('i');

    if (isSaved) {
        btn.classList.add('bg-blue-50', 'border-blue-300', 'text-blue-600');
        btn.classList.remove('border-gray-300', 'hover:bg-gray-50');
        icon.classList.remove('far');
        icon.classList.add('fas');
    } else {
        btn.classList.remove('bg-blue-50', 'border-blue-300', 'text-blue-600');
        btn.classList.add('border-gray-300', 'hover:bg-gray-50');
        icon.classList.remove('fas');
        icon.classList.add('far');
    }
}

// Load related articles
async function loadRelatedArticles() {
    try {
        const response = await fetch(`/articles/api/${articleId}/related`);
        const data = await response.json();

        if (data.success && data.articles.length > 0) {
            const container = document.getElementById('relatedArticles');
            container.innerHTML = data.articles.map(article => `
                <div class="group">
                    <a href="/articles/${article.article_id}" class="block">
                        <div class="flex space-x-3">
                            <img src="${article.featured_image || '/images/default-article.svg'}"
                                 alt="${article.title}" class="w-16 h-16 object-cover rounded-lg flex-shrink-0">
                            <div class="flex-1 min-w-0">
                                <h4 class="font-medium text-gray-900 group-hover:text-ruxchai-primary transition-colors line-clamp-2 mb-1">
                                    ${article.title}
                                </h4>
                                <p class="text-sm text-gray-500">${formatDate(article.created_at)}</p>
                                <div class="flex items-center space-x-3 text-xs text-gray-400 mt-1">
                                    <span><i class="fas fa-eye mr-1"></i>${article.views || 0}</span>
                                    <span><i class="fas fa-heart mr-1"></i>${article.likes || 0}</span>
                                </div>
                            </div>
                        </div>
                    </a>
                </div>
            `).join('');
        } else {
            document.getElementById('relatedArticles').innerHTML = '<p class="text-gray-500"><%= t('noRelatedArticles') %></p>';
        }
    } catch (error) {
        console.error('Error loading related articles:', error);
    }
}

// Load popular tags

// Increment view count
async function incrementViewCount() {
    try {
        await fetch(`/articles/api/${articleId}/view`, { method: 'POST' });
    } catch (error) {
        console.error('Error incrementing view count:', error);
    }
}

// Sharing functions
function shareToFacebook() {
    const url = encodeURIComponent(window.location.href);
    window.open(`https://www.facebook.com/sharer/sharer.php?u=${url}`, '_blank');
}

function shareToTwitter() {
    const url = encodeURIComponent(window.location.href);
    const text = encodeURIComponent(document.getElementById('articleTitle').textContent);
    window.open(`https://twitter.com/intent/tweet?url=${url}&text=${text}`, '_blank');
}

function shareToLine() {
    const url = encodeURIComponent(window.location.href);
    const text = encodeURIComponent(document.getElementById('articleTitle').textContent);
    window.open(`https://social-plugins.line.me/lineit/share?url=${url}&text=${text}`, '_blank');
}

function copyUrl() {
    const urlInput = document.getElementById('articleUrl');
    urlInput.select();
    document.execCommand('copy');
    showMessage('<%= t('linkCopiedSuccessfully') %>', 'success');
}

// Utility functions
function getCategoryName(category) {
    const categories = {
        technology: '<%= t('technology') %>',
        business: '<%= t('business') %>',
        management: '<%= t('management') %>',
        development: '<%= t('development') %>',
        design: '<%= t('design') %>',
        marketing: '<%= t('marketing') %>',
        finance: '<%= t('finance') %>',
        other: '<%= t('other') %>'
    };
    return categories[category] || category;
}

function getStatusName(status) {
    const statuses = {
        published: '<%= t('publishedStatus') %>',
        draft: '<%= t('draft') %>',
        pending: '<%= t('pending') %>'
    };
    return statuses[status] || status;
}

function formatDate(dateString) {
    const locale = currentLanguage === 'en' ? 'en-US' : 'th-TH';
    const options = {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    };
    return new Date(dateString).toLocaleDateString(locale, options);
}

function showMessage(message, type = 'info') {
    const messageDiv = document.createElement('div');
    messageDiv.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-lg text-white ${
        type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500'
    }`;
    messageDiv.textContent = message;

    document.body.appendChild(messageDiv);

    setTimeout(() => {
        messageDiv.remove();
    }, 3000);
}

// Add CSS for line clamp
const style = document.createElement('style');
style.textContent = `
    .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    .prose h1, .prose h2, .prose h3, .prose h4, .prose h5, .prose h6 {
        scroll-margin-top: 6rem;
    }
`;
document.head.appendChild(style);
</script>

