<!DOCTYPE html>
<html lang="<%= typeof currentLanguage !== 'undefined' ? currentLanguage : 'th' %>">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <%
        const siteName = typeof getSetting === 'function' ? getSetting('site_name', 'Rukchai Hongyen LearnHub') : 'Rukchai Hongyen LearnHub';
        const primaryColor = typeof getSetting === 'function' ? getSetting('primary_color', '#0090D3') : '#0090D3';
        const secondaryColor = typeof getSetting === 'function' ? getSetting('secondary_color', '#3AAA35') : '#3AAA35';
        const logoUrl = typeof getSetting === 'function' ? getSetting('logo_url', '/images/logo.png') : '/images/logo.png';
    %>
    <title><%= t('forceChangePasswordTitle') %> - <%= siteName %></title>
    <link href="/css/tailwind.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;500;600;700&display=swap');

        :root {
            --primary-color: <%= primaryColor %>;
            --primary-color-dark: color-mix(in srgb, <%= primaryColor %> 80%, #000 20%);
            --primary-color-light: color-mix(in srgb, <%= primaryColor %> 90%, #fff 10%);
            --secondary-color: <%= secondaryColor %>;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans Thai', sans-serif;
            background: #f0f4f8;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .container {
            width: 100%;
            max-width: 450px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            animation: slideUp 0.5s ease-out;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .header {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .logo {
            max-width: 200px;
            margin: 0 auto 1rem;
        }

        .logo img {
            width: 100%;
            height: auto;
        }

        .title {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        .subtitle {
            color: #6b7280;
            font-size: 0.95rem;
        }

        .warning-box {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .warning-box i {
            color: #f59e0b;
            margin-right: 0.5rem;
        }

        .warning-box p {
            color: #92400e;
            font-size: 0.875rem;
        }

        .form-group {
            margin-bottom: 1.25rem;
        }

        .label {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.5rem;
        }

        .input {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 0.75rem;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        .input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary-color) 10%, transparent);
        }

        .requirements {
            background: #f9fafb;
            padding: 1rem;
            border-radius: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .requirements h4 {
            font-size: 0.875rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.75rem;
        }

        .requirements ul {
            list-style: none;
        }

        .requirements li {
            display: flex;
            align-items: center;
            font-size: 0.8125rem;
            color: #6b7280;
            margin-bottom: 0.5rem;
        }

        .requirements li i {
            margin-right: 0.5rem;
            font-size: 0.75rem;
        }

        .requirements li.valid i {
            color: #22c55e;
        }

        .requirements li.invalid i {
            color: #ef4444;
        }

        .submit-btn {
            width: 100%;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 0.75rem;
            padding: 1rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .submit-btn:hover:not(:disabled) {
            background: var(--primary-color-dark);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px color-mix(in srgb, var(--primary-color) 40%, transparent);
        }

        .submit-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }

        .logout-link {
            display: block;
            text-align: center;
            margin-top: 1rem;
            color: #6b7280;
            text-decoration: none;
            font-size: 0.875rem;
        }

        .logout-link:hover {
            color: #374151;
        }

        .alert {
            padding: 1rem;
            border-radius: 0.75rem;
            margin-bottom: 1rem;
            display: none;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }

        .alert.show {
            display: flex;
        }

        .alert-error {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
        }

        .alert-success {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            color: #16a34a;
        }

        .loading-spinner {
            width: 1rem;
            height: 1rem;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">
                <img src="<%= logoUrl %>" alt="<%= siteName %>">
            </div>
            <h1 class="title"><%= t('forceChangePasswordTitle') %></h1>
            <p class="subtitle"><%= t('forceChangePasswordSubtitle') %></p>
        </div>

        <% if (locals.expiryInfo) { %>
        <div class="warning-box">
            <p>
                <i class="fas fa-exclamation-triangle"></i>
                <%= t('passwordExpiredMessage').replace('{days}', expiryInfo.daysOld).replace('{maxDays}', expiryInfo.maxDays) %>
            </p>
        </div>
        <% } %>

        <div id="error-alert" class="alert alert-error">
            <i class="fas fa-exclamation-circle"></i>
            <span id="error-text"></span>
        </div>

        <div id="success-alert" class="alert alert-success">
            <i class="fas fa-check-circle"></i>
            <span id="success-text"></span>
        </div>

        <form id="change-password-form">
            <div class="form-group">
                <label for="current_password" class="label"><%= t('currentPassword') %></label>
                <input type="password" id="current_password" name="current_password" class="input"
                       placeholder="<%= t('enterCurrentPassword') %>" required>
            </div>

            <div class="form-group">
                <label for="new_password" class="label"><%= t('newPassword') %></label>
                <input type="password" id="new_password" name="new_password" class="input"
                       placeholder="<%= t('enterNewPassword') %>" required minlength="8">
            </div>

            <div class="form-group">
                <label for="confirm_password" class="label"><%= t('confirmNewPassword') %></label>
                <input type="password" id="confirm_password" name="confirm_password" class="input"
                       placeholder="<%= t('confirmNewPasswordPlaceholder') %>" required minlength="8">
            </div>

            <div class="requirements">
                <h4><%= t('passwordRequirements') %>:</h4>
                <ul>
                    <li id="length-check" class="invalid">
                        <i class="fas fa-times"></i>
                        <span><%= t('passwordMinLength') %></span>
                    </li>
                    <li id="uppercase-check" class="invalid">
                        <i class="fas fa-times"></i>
                        <span><%= t('passwordUppercase') %></span>
                    </li>
                    <li id="lowercase-check" class="invalid">
                        <i class="fas fa-times"></i>
                        <span><%= t('passwordLowercase') %></span>
                    </li>
                    <li id="number-check" class="invalid">
                        <i class="fas fa-times"></i>
                        <span><%= t('passwordNumber') %></span>
                    </li>
                    <li id="match-check" class="invalid">
                        <i class="fas fa-times"></i>
                        <span><%= t('passwordsMatch') %></span>
                    </li>
                </ul>
            </div>

            <button type="submit" id="submit-btn" class="submit-btn" disabled>
                <span id="btn-text"><i class="fas fa-key"></i> <%= t('changePassword') %></span>
                <span id="btn-loading" style="display: none;">
                    <div class="loading-spinner"></div>
                    <%= t('changingPassword') %>
                </span>
            </button>
        </form>

        <a href="/auth/logout" class="logout-link">
            <i class="fas fa-sign-out-alt"></i> <%= t('logout') %>
        </a>
    </div>

    <script>
        const newPassword = document.getElementById('new_password');
        const confirmPassword = document.getElementById('confirm_password');
        const form = document.getElementById('change-password-form');
        const submitBtn = document.getElementById('submit-btn');
        const btnText = document.getElementById('btn-text');
        const btnLoading = document.getElementById('btn-loading');
        const errorAlert = document.getElementById('error-alert');
        const errorText = document.getElementById('error-text');
        const successAlert = document.getElementById('success-alert');
        const successText = document.getElementById('success-text');

        // Password validation
        function validatePassword() {
            const pwd = newPassword.value;
            const confirmPwd = confirmPassword.value;

            const checks = {
                length: pwd.length >= 8,
                uppercase: /[A-Z]/.test(pwd),
                lowercase: /[a-z]/.test(pwd),
                number: /\d/.test(pwd),
                match: pwd && confirmPwd && pwd === confirmPwd
            };

            updateCheck('length-check', checks.length);
            updateCheck('uppercase-check', checks.uppercase);
            updateCheck('lowercase-check', checks.lowercase);
            updateCheck('number-check', checks.number);
            updateCheck('match-check', checks.match);

            const allValid = Object.values(checks).every(v => v);
            submitBtn.disabled = !allValid;

            return allValid;
        }

        function updateCheck(id, isValid) {
            const el = document.getElementById(id);
            const icon = el.querySelector('i');

            if (isValid) {
                el.classList.remove('invalid');
                el.classList.add('valid');
                icon.className = 'fas fa-check';
            } else {
                el.classList.remove('valid');
                el.classList.add('invalid');
                icon.className = 'fas fa-times';
            }
        }

        newPassword.addEventListener('input', validatePassword);
        confirmPassword.addEventListener('input', validatePassword);

        // Form submission
        form.addEventListener('submit', async function(e) {
            e.preventDefault();

            if (!validatePassword()) return;

            // Hide alerts
            errorAlert.classList.remove('show');
            successAlert.classList.remove('show');

            // Show loading
            submitBtn.disabled = true;
            btnText.style.display = 'none';
            btnLoading.style.display = 'flex';

            try {
                const response = await fetch('/auth/force-change-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        current_password: document.getElementById('current_password').value,
                        new_password: newPassword.value,
                        confirm_password: confirmPassword.value
                    })
                });

                const data = await response.json();

                if (data.success) {
                    successText.textContent = data.message || '<%= t("passwordChangeSuccess") %>';
                    successAlert.classList.add('show');
                    setTimeout(() => {
                        window.location.href = data.redirectTo || '/dashboard';
                    }, 1500);
                } else {
                    throw new Error(data.message || '<%= t("passwordChangeError") %>');
                }
            } catch (error) {
                errorText.textContent = error.message;
                errorAlert.classList.add('show');
                btnText.style.display = 'flex';
                btnLoading.style.display = 'none';
                submitBtn.disabled = false;
            }
        });

        // Auto focus first input
        document.getElementById('current_password').focus();
    </script>
</body>
</html>
