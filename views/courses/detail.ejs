

<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Main Content -->
        <div class="lg:col-span-2">
            <!-- Course Header -->
            <div class="bg-white rounded-lg shadow-sm p-6 mb-8">
                <div class="flex flex-col md:flex-row md:items-start space-y-4 md:space-y-0 md:space-x-6">
                    <div class="flex-shrink-0">
                        <img id="course-thumbnail" src="/images/course-default.svg"
                             alt="Course Thumbnail"
                             class="w-full md:w-48 h-32 md:h-32 object-cover rounded-lg">
                    </div>

                    <div class="flex-1">
                        <div class="flex items-center space-x-2 mb-2">
                            <span id="category-badge" class="badge-primary"><%= t('category') %></span>
                            <span id="difficulty-badge" class="badge-warning"><%= t('difficulty') %></span>
                        </div>

                        <h1 id="course-title" class="text-2xl font-bold text-gray-900 mb-2"><%= t('courseName') %></h1>
                        <p id="course-code" class="text-sm text-gray-500 mb-3"><%= t('courseCode') %>: -</p>

                        <p id="course-description" class="text-gray-600 mb-4"><%= t('courseDescription') %></p>

                        <div class="flex items-center space-x-6 text-sm text-gray-500 mb-4">
                            <div class="flex items-center">
                                <i class="fas fa-user mr-1"></i>
                                <span id="instructor-name"><%= t('instructor') %></span>
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-clock mr-1"></i>
                                <span id="course-duration">0 <%= t('hours') %></span>
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-users mr-1"></i>
                                <span id="enrolled-count">0 <%= t('people') %></span>
                            </div>
                            <div id="rating-display" class="flex items-center">
                                <div class="flex text-yellow-400">
                                    <i class="fas fa-star"></i>
                                    <i class="fas fa-star"></i>
                                    <i class="fas fa-star"></i>
                                    <i class="fas fa-star"></i>
                                    <i class="fas fa-star"></i>
                                </div>
                                <span id="rating-text" class="text-gray-600 ml-1">(0)</span>
                            </div>
                        </div>

                        <!-- Progress Bar (if enrolled) -->
                        <div id="progress-section" class="hidden mb-4">
                            <div class="flex justify-between text-sm text-gray-600 mb-1">
                                <span><%= t('learningProgress') %></span>
                                <span id="progress-percentage">0%</span>
                            </div>
                            <div class="progress-bar">
                                <div id="progress-fill" class="progress-fill" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Course Content Tabs -->
            <div class="bg-white rounded-lg shadow-sm mb-8">
                <div class="border-b border-gray-200">
                    <nav class="-mb-px flex space-x-8 px-6">
                        <button class="tab-btn active" data-tab="overview">
                            <i class="fas fa-info-circle mr-2"></i><%= t('overview') %>
                        </button>
                        <button class="tab-btn" data-tab="curriculum">
                            <i class="fas fa-list mr-2"></i><%= t('curriculum') %>
                        </button>
                        <button class="tab-btn" data-tab="materials">
                            <i class="fas fa-file-alt mr-2"></i><%= t('materials') %>
                        </button>
                        <button class="tab-btn" data-tab="discussions">
                            <i class="fas fa-comments mr-2"></i><%= t('discussions') %>
                        </button>
                        <button class="tab-btn" data-tab="reviews">
                            <i class="fas fa-star mr-2"></i><%= t('reviewsTab') %>
                        </button>
                    </nav>
                </div>

                <div class="p-6">
                    <!-- Overview Tab -->
                    <div id="tab-overview" class="tab-content">
                        <div class="prose max-w-none">
                            <!-- Intro Video -->
                            <div id="intro-video-section" class="mb-8" style="display: none;">
                                <h3 class="text-xl font-semibold mb-4"><%= t('introVideo') %></h3>
                                <div id="intro-video-player" class="w-full aspect-video bg-gray-100 rounded-xl shadow-lg overflow-hidden" style="max-width: 100%; min-height: 400px;">
                                    <!-- Video player will be loaded here -->
                                </div>
                            </div>

                            <h3><%= t('aboutCourse') %></h3>
                            <div id="course-full-description" class="mb-6">
                                <!-- Full description will be loaded here -->
                            </div>

                            <h3><%= t('learningObjectives') %></h3>
                            <ol id="learning-objectives" class="mb-6 list-decimal list-inside space-y-2">
                                <!-- Learning objectives will be loaded here -->
                            </ol>

                            <h3><%= t('targetAudience') %></h3>
                            <div id="target-audience" class="mb-6">
                                <!-- Target audience will be loaded here -->
                            </div>

                            <h3><%= t('prerequisites') %></h3>
                            <div id="prerequisites" class="mb-6">
                                <!-- Prerequisites will be loaded here -->
                            </div>
                        </div>
                    </div>

                    <!-- Curriculum Tab -->
                    <div id="tab-curriculum" class="tab-content hidden">
                        <div id="course-curriculum">
                            <!-- Curriculum will be loaded here -->
                        </div>
                    </div>

                    <!-- Materials Tab -->
                    <div id="tab-materials" class="tab-content hidden">
                        <div id="course-materials">
                            <!-- Materials will be loaded here -->
                        </div>
                    </div>

                    <!-- Discussions Tab -->
                    <div id="tab-discussions" class="tab-content hidden">
                        <div id="course-discussions">
                            <!-- Discussions will be loaded here -->
                        </div>
                    </div>

                    <!-- Reviews Tab -->
                    <div id="tab-reviews" class="tab-content hidden">
                        <div id="course-reviews">
                            <!-- Reviews will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="space-y-6">
            <!-- Enrollment Card -->
            <div class="bg-white rounded-lg shadow-sm p-6">
                <div id="enrollment-status" class="text-center">
                    <!-- Enrollment status will be loaded here -->
                </div>
            </div>

            <!-- Course Info -->
            <div class="bg-white rounded-lg shadow-sm p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4"><%= t('courseInfo') %></h3>
                <div class="space-y-3">
                    <div class="flex justify-between">
                        <span class="text-gray-600"><%= t('difficultyLevel') %></span>
                        <span id="sidebar-difficulty" class="font-medium">-</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600"><%= t('duration') %>:</span>
                        <span id="sidebar-duration" class="font-medium">-</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600"><%= t('languageLabel') %></span>
                        <span id="sidebar-language" class="font-medium">-</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600"><%= t('courseType') %></span>
                        <span id="sidebar-course-type" class="font-medium">-</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600"><%= t('maxStudents') %></span>
                        <span id="sidebar-max-students" class="font-medium">-</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600"><%= t('passingScore') %></span>
                        <span id="sidebar-passing-score" class="font-medium">-</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600"><%= t('maxAttempts') %></span>
                        <span id="sidebar-max-attempts" class="font-medium">-</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600"><%= t('certificate') %></span>
                        <span id="sidebar-certificate" class="font-medium text-gray-500">-</span>
                    </div>
                    <div class="border-t border-gray-200 my-3"></div>
                    <div class="bg-green-50 rounded-lg p-3 mb-2">
                        <div class="flex items-start">
                            <i class="fas fa-calendar-check text-green-600 mt-1 mr-2"></i>
                            <div class="flex-1">
                                <div class="text-xs text-gray-600 mb-1"><%= t('enrollmentOpen') %></div>
                                <div id="sidebar-start-date" class="text-sm font-medium text-green-700">-</div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-red-50 rounded-lg p-3">
                        <div class="flex items-start">
                            <i class="fas fa-calendar-times text-red-600 mt-1 mr-2"></i>
                            <div class="flex-1">
                                <div class="text-xs text-gray-600 mb-1"><%= t('enrollmentClose') %></div>
                                <div id="sidebar-end-date" class="text-sm font-medium text-red-700">-</div>
                            </div>
                        </div>
                    </div>
                    <div class="border-t border-gray-200 my-3"></div>
                    <div class="flex justify-between">
                        <span class="text-gray-600"><%= t('publishDate') %></span>
                        <span id="publish-date" class="font-medium">-</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600"><%= t('lastUpdate') %></span>
                        <span id="update-date" class="font-medium">-</span>
                    </div>
                </div>
            </div>

            <!-- Instructor Info -->
            <div class="bg-white rounded-lg shadow-sm p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4"><%= t('instructorInfo') %></h3>
                <div id="instructor-info">
                    <!-- Instructor info will be loaded here -->
                </div>
            </div>

            <!-- Related Courses -->
            <div class="bg-white rounded-lg shadow-sm p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4"><%= t('relatedCourses') %></h3>
                <div id="related-courses" class="space-y-3">
                    <!-- Related courses will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Enrollment Modal -->
<div id="enrollment-modal" class="hidden fixed inset-0 z-50 overflow-y-auto">
    <div class="flex items-center justify-center min-h-screen px-4">
        <div class="modal-overlay"></div>
        <div class="modal-content max-w-md w-full p-6">
            <div class="text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 mb-4">
                    <i class="fas fa-graduation-cap text-blue-600"></i>
                </div>
                <h3 class="text-lg font-medium text-gray-900 mb-2"><%= t('enrollmentTitle') %></h3>
                <p class="text-sm text-gray-500 mb-6"><%= t('enrollmentConfirm') %></p>

                <!-- Prerequisites Check -->
                <div id="prerequisites-check" class="hidden mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded">
                    <p class="text-sm text-yellow-800 mb-2"><%= t('coursePrerequisites') %></p>
                    <ul id="prerequisite-list" class="text-sm text-yellow-700">
                        <!-- Prerequisites will be listed here -->
                    </ul>
                </div>

                <div class="flex space-x-3">
                    <button id="confirm-enrollment" class="flex-1 btn-ruxchai-primary"><%= t('confirmEnrollment') %></button>
                    <button id="cancel-enrollment" class="flex-1 btn-ruxchai-outline"><%= t('cancelEnrollment') %></button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Rating Modal -->
<div id="rating-modal" class="hidden fixed inset-0 z-50 overflow-y-auto">
    <div class="flex items-center justify-center min-h-screen px-4">
        <div class="modal-overlay"></div>
        <div class="modal-content max-w-lg w-full p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4"><%= t('ratingModalTitle') %></h3>

            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2"><%= t('ratingLabel') %></label>
                <div class="flex space-x-1">
                    <button class="star-rating text-2xl text-gray-300 hover:text-yellow-400" data-rating="1">
                        <i class="fas fa-star"></i>
                    </button>
                    <button class="star-rating text-2xl text-gray-300 hover:text-yellow-400" data-rating="2">
                        <i class="fas fa-star"></i>
                    </button>
                    <button class="star-rating text-2xl text-gray-300 hover:text-yellow-400" data-rating="3">
                        <i class="fas fa-star"></i>
                    </button>
                    <button class="star-rating text-2xl text-gray-300 hover:text-yellow-400" data-rating="4">
                        <i class="fas fa-star"></i>
                    </button>
                    <button class="star-rating text-2xl text-gray-300 hover:text-yellow-400" data-rating="5">
                        <i class="fas fa-star"></i>
                    </button>
                </div>
            </div>

            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2"><%= t('reviewLabel') %></label>
                <textarea id="review-text" rows="4"
                          class="form-input-ruxchai"
                          placeholder="<%= t('reviewPlaceholder') %>"></textarea>
            </div>

            <div class="flex space-x-3">
                <button id="submit-rating" class="flex-1 btn-ruxchai-primary"><%= t('submitRating') %></button>
                <button id="cancel-rating" class="flex-1 btn-ruxchai-outline"><%= t('cancelRating') %></button>
            </div>
        </div>
    </div>
</div>

<script>
let courseId = '<%= locals.courseId || "" %>';
let currentRating = 0;
let courseData = null;
let positionsMapping = {};
let departmentsMapping = {};
let listenersSetup = false; // Prevent duplicate event listeners

// Get current language from EJS
const currentLang = '<%= currentLang || "th" %>';

// Translation object for JavaScript
const translations = {
    th: {
        hours: 'ชั่วโมง',
        people: 'คน',
        times: 'ครั้ง',
        minutes: 'นาที',
        lessons: 'บท',
        notSpecified: 'ไม่ระบุ',
        unlimited: 'ไม่จำกัด',
        yes: 'มี',
        no: 'ไม่มี',
        general: 'ทั่วไป',
        languageThai: 'ภาษาไทย',
        languageEnglish: 'ภาษาอังกฤษ',
        languageThaiEnglish: 'ไทย-อังกฤษ',
        typeMandatory: 'บังคับ',
        typeElective: 'เลือก',
        typeRecommended: 'แนะนำ',
        difficultyBeginner: 'เริ่มต้น',
        difficultyIntermediate: 'ปานกลาง',
        difficultyAdvanced: 'ขั้นสูง',
        // Loading states
        loadingCourseData: 'กำลังโหลดข้อมูลคอร์ส...',
        loadingCurriculum: 'กำลังโหลดหลักสูตร...',
        loadingMaterials: 'กำลังโหลดเอกสาร...',
        loadingDiscussions: 'กำลังโหลดการอภิปราย...',
        loadingReviews: 'กำลังโหลดรีวิว...',
        loadingRelatedCourses: 'กำลังโหลด...',
        // Error states
        noCourseId: 'ไม่สามารถโหลดข้อมูลคอร์สได้ เนื่องจากไม่พบรหัสคอร์ส',
        courseNotFound: 'ไม่พบข้อมูลคอร์ส',
        errorLoadingCourse: 'เกิดข้อผิดพลาดในการโหลดข้อมูลคอร์ส',
        errorLoadingCurriculum: 'เกิดข้อผิดพลาดในการโหลดหลักสูตร',
        errorLoadingMaterials: 'เกิดข้อผิดพลาดในการโหลดเอกสาร',
        errorLoadingDiscussions: 'เกิดข้อผิดพลาดในการโหลดการอภิปราย',
        errorLoadingReviews: 'เกิดข้อผิดพลาดในการโหลดรีวิว',
        errorLoadingRelatedCourses: 'ไม่สามารถโหลดคอร์สที่เกี่ยวข้องได้',
        cannotLoadCurriculum: 'ไม่สามารถโหลดหลักสูตรได้',
        cannotLoadMaterials: 'ไม่สามารถโหลดเอกสารได้',
        cannotLoadDiscussions: 'ไม่สามารถโหลดการอภิปรายได้',
        cannotLoadReviews: 'ไม่สามารถโหลดรีวิวได้',
        errorLoadingVideo: 'เกิดข้อผิดพลาดในการโหลดวิดีโอ',
        cannotLoadVideo: 'ไม่สามารถโหลดวิดีโอได้: URL ไม่ถูกต้อง',
        // Empty states
        noDescription: 'ไม่มีคำอธิบาย',
        noObjectives: 'ไม่ได้ระบุวัตถุประสงค์',
        noPrerequisites: 'ไม่มีความต้องการพื้นฐานพิเศษ',
        noLessons: 'ยังไม่มีบทเรียนที่กำหนด',
        noMaterials: 'ยังไม่มีเอกสารประกอบการเรียน',
        noDiscussions: 'ยังไม่มีการอภิปราย',
        noReviewsYet: 'ยังไม่มีรีวิว',
        noRelatedCourses: 'ไม่มีคอร์สที่เกี่ยวข้อง',
        noBio: 'ไม่มีข้อมูลประวัติ',
        // Content
        courseCode: 'รหัสหลักสูตร',
        allLessons: 'บทเรียนทั้งหมด',
        viewVideo: 'ดูวิดีโอ',
        download: 'ดาวน์โหลด',
        reply: 'ตอบกลับ',
        replies: 'ตอบกลับ',
        instructor: 'ผู้สอน',
        // Enrollment
        alreadyEnrolled: 'คุณได้ลงทะเบียนเรียนแล้ว',
        startLearning: 'เริ่มเรียนคอร์สนี้',
        enrollInCourse: 'ลงทะเบียนเรียน',
        confirmEnrollment: 'ยืนยันการลงทะเบียน',
        enrolling: 'กำลังลงทะเบียน...',
        enrollSuccess: 'ลงทะเบียนเรียนสำเร็จ',
        enrollError: 'เกิดข้อผิดพลาดในการลงทะเบียน',
        completed: 'เรียนจบแล้ว',
        courseCertificate: 'ดาวน์โหลดใบประกาศนียบัตร',
        editCourse: 'แก้ไขคอร์ส',
        startCourse: 'เข้าเรียน',
        rateThisCourse: 'ให้คะแนนคอร์ส',
        // Rating
        pleaseRate: 'กรุณาให้คะแนน',
        submittingRating: 'กำลังส่ง...',
        ratingSuccess: 'ส่งคะแนนสำเร็จ',
        ratingError: 'เกิดข้อผิดพลาดในการส่งคะแนน',
        // Target audience
        targetGroup: 'กลุ่มเป้าหมาย:',
        positions: 'ตำแหน่ง:',
        unitDepartment: 'หน่วยงาน:',
        allDepartmentsInOrg: '(ทั้งหมด)',
        conditionPositionOrDepartment: '<strong>เงื่อนไข:</strong> คุณสามารถเข้าเรียนได้หากอยู่ใน<strong>ตำแหน่ง</strong>ที่ระบุ <strong>หรือ</strong> อยู่ใน<strong>หน่วยงาน</strong>ที่ระบุ',
        onlyForPositions: 'เฉพาะผู้ที่ดำรงตำแหน่งที่ระบุข้างต้น (ทุกหน่วยงาน)',
        onlyForDepartments: 'เฉพาะผู้ที่อยู่ในหน่วยงานที่ระบุข้างต้น (ทุกตำแหน่ง)',
        openForEveryone: 'เปิดกว้างสำหรับทุกคน',
        noPositionOrDepartmentLimit: 'ไม่จำกัดตำแหน่งหรือหน่วยงาน',
        startDiscussion: 'เริ่มการอภิปราย'
    },
    en: {
        hours: 'hours',
        people: 'people',
        times: 'times',
        minutes: 'minutes',
        lessons: 'lessons',
        notSpecified: 'Not specified',
        unlimited: 'Unlimited',
        yes: 'Yes',
        no: 'No',
        general: 'General',
        languageThai: 'Thai',
        languageEnglish: 'English',
        languageThaiEnglish: 'Thai-English',
        typeMandatory: 'Mandatory',
        typeElective: 'Elective',
        typeRecommended: 'Recommended',
        difficultyBeginner: 'Beginner',
        difficultyIntermediate: 'Intermediate',
        difficultyAdvanced: 'Advanced',
        // Loading states
        loadingCourseData: 'Loading course data...',
        loadingCurriculum: 'Loading curriculum...',
        loadingMaterials: 'Loading materials...',
        loadingDiscussions: 'Loading discussions...',
        loadingReviews: 'Loading reviews...',
        loadingRelatedCourses: 'Loading...',
        // Error states
        noCourseId: 'Cannot load course data: Course ID not found',
        courseNotFound: 'Course not found',
        errorLoadingCourse: 'Error loading course data',
        errorLoadingCurriculum: 'Error loading curriculum',
        errorLoadingMaterials: 'Error loading materials',
        errorLoadingDiscussions: 'Error loading discussions',
        errorLoadingReviews: 'Error loading reviews',
        errorLoadingRelatedCourses: 'Cannot load related courses',
        cannotLoadCurriculum: 'Cannot load curriculum',
        cannotLoadMaterials: 'Cannot load materials',
        cannotLoadDiscussions: 'Cannot load discussions',
        cannotLoadReviews: 'Cannot load reviews',
        errorLoadingVideo: 'Error loading video',
        cannotLoadVideo: 'Cannot load video: Invalid URL',
        // Empty states
        noDescription: 'No description',
        noObjectives: 'No objectives specified',
        noPrerequisites: 'No special prerequisites',
        noLessons: 'No lessons yet',
        noMaterials: 'No course materials yet',
        noDiscussions: 'No discussions yet',
        noReviewsYet: 'No reviews yet',
        noRelatedCourses: 'No related courses',
        noBio: 'No bio available',
        // Content
        courseCode: 'Course Code',
        allLessons: 'All Lessons',
        viewVideo: 'View Video',
        download: 'Download',
        reply: 'Reply',
        replies: 'Replies',
        instructor: 'Instructor',
        // Enrollment
        alreadyEnrolled: 'You are already enrolled',
        startLearning: 'Start this course',
        enrollInCourse: 'Enroll Now',
        confirmEnrollment: 'Confirm Enrollment',
        enrolling: 'Enrolling...',
        enrollSuccess: 'Successfully enrolled',
        enrollError: 'Error enrolling in course',
        completed: 'Completed',
        courseCertificate: 'Download Certificate',
        editCourse: 'Edit Course',
        startCourse: 'Start Learning',
        rateThisCourse: 'Rate Course',
        // Rating
        pleaseRate: 'Please provide a rating',
        submittingRating: 'Submitting...',
        ratingSuccess: 'Rating submitted successfully',
        ratingError: 'Error submitting rating',
        // Target audience
        targetGroup: 'Target Audience:',
        positions: 'Position:',
        unitDepartment: 'Department:',
        allDepartmentsInOrg: '(All)',
        conditionPositionOrDepartment: '<strong>Condition:</strong> You can enroll if you are in the specified <strong>position</strong> <strong>or</strong> in the specified <strong>department</strong>',
        onlyForPositions: 'Only for specified positions (all departments)',
        onlyForDepartments: 'Only for specified departments (all positions)',
        openForEveryone: 'Open for Everyone',
        noPositionOrDepartmentLimit: 'No position or department restrictions',
        startDiscussion: 'Start Discussion'
    }
};

// Helper function to get translation
function t(key) {
    return translations[currentLang][key] || key;
}

document.addEventListener('DOMContentLoaded', async function() {
    // Load positions and departments mapping first
    await Promise.all([
        loadPositionsMapping(),
        loadDepartmentsMapping()
    ]);

    if (courseId && courseId !== "") {
        loadCourseDetail();
    } else {
        console.error('courseId is missing!');
        showError('ไม่สามารถโหลดข้อมูลคอร์สได้ เนื่องจากไม่พบรหัสคอร์ส');
    }
    setupEventListeners();
});

async function loadPositionsMapping() {
    try {
        const response = await fetch('/courses/api/target-positions');
        const data = await response.json();
        if (data.success && data.data) {
            // Create mapping from position_id to position_name
            data.data.forEach(pos => {
                // Map by ID (as number and as string)
                positionsMapping[pos.position_id] = pos.position_name;
                positionsMapping[String(pos.position_id)] = pos.position_name;
                // Also map by name for backward compatibility
                positionsMapping[pos.position_name.toLowerCase()] = pos.position_name;
            });
        }
    } catch (error) {
        console.error('Error loading positions mapping:', error);
    }
}

async function loadDepartmentsMapping() {
    try {
        const response = await fetch('/courses/api/target-departments');
        const data = await response.json();
        if (data.success && data.data) {
            // Create mapping from unit_id to department object with name and level_id
            data.data.forEach(dept => {
                const thName = dept.unit_name_th;
                const enName = dept.unit_name_en;
                const deptInfo = {
                    name: thName,
                    level_id: dept.level_id
                };
                // Map by ID (as number and as string)
                departmentsMapping[dept.unit_id] = deptInfo;
                departmentsMapping[String(dept.unit_id)] = deptInfo;
                // Also map by name for backward compatibility (return object)
                departmentsMapping[thName.toLowerCase()] = deptInfo;
                if (enName) {
                    departmentsMapping[enName.toLowerCase()] = deptInfo;
                }
            });
        }
    } catch (error) {
        console.error('Error loading departments mapping:', error);
    }
}

function setupEventListeners() {
    // Prevent duplicate listeners
    if (listenersSetup) return;
    listenersSetup = true;

    // Tab switching
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            switchTab(this.dataset.tab);
        });
    });

    // Modal events
    document.getElementById('confirm-enrollment').addEventListener('click', enrollInCourse);
    document.getElementById('cancel-enrollment').addEventListener('click', closeEnrollmentModal);

    // Rating events
    document.querySelectorAll('.star-rating').forEach(star => {
        star.addEventListener('click', function() {
            currentRating = parseInt(this.dataset.rating);
            updateStarDisplay();
        });
    });

    document.getElementById('submit-rating').addEventListener('click', submitRating);
    document.getElementById('cancel-rating').addEventListener('click', closeRatingModal);
}

async function loadCourseDetail() {
    try {
        // Show loading indicator
        showLoading('กำลังโหลดข้อมูลคอร์ส...');

        const response = await fetch(`/courses/api/${courseId}`);

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();

        if (data.success) {
            courseData = data.data;
            updateCourseDisplay(courseData);

            // Load additional data
            await Promise.all([
                loadCurriculum(),
                loadMaterials(),
                loadDiscussions(),
                loadReviews(),
                loadRelatedCourses()
            ]);

            hideLoading();
        } else {
            hideLoading();
            showError(data.message || 'ไม่พบข้อมูลคอร์ส');
        }
    } catch (error) {
        console.error('Error loading course detail:', error);
        hideLoading();
        showError('เกิดข้อผิดพลาดในการโหลดข้อมูลคอร์ส');
    }
}

function updateCourseDisplay(course) {
    // Safety check - ensure course object exists
    if (!course) {
        showError('ไม่พบข้อมูลคอร์ส');
        return;
    }

    // Header
    document.getElementById('course-thumbnail').src = course.thumbnail || '/images/course-default.svg';

    // Add error handler for broken images
    document.getElementById('course-thumbnail').onerror = function() {
        this.src = '/images/course-default.svg';
        this.onerror = null; // Prevent infinite loop
    };
    document.getElementById('course-title').textContent = course.title || course.course_name;
    document.getElementById('course-code').textContent = course.course_code ? `รหัสหลักสูตร: ${course.course_code}` : '';

    // Use innerHTML for description to render HTML properly
    const descriptionElement = document.getElementById('course-description');
    if (course.description) {
        // Remove HTML tags for short description, or keep plain text
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = course.description;
        descriptionElement.textContent = tempDiv.textContent || tempDiv.innerText || course.description;
    } else {
        descriptionElement.textContent = 'ไม่มีคำอธิบาย';
    }

    document.getElementById('instructor-name').textContent = course.instructor_name || 'ไม่ระบุ';
    document.getElementById('course-duration').textContent = `${course.duration_hours || 0} ชั่วโมง`;
    document.getElementById('enrolled-count').textContent = `${course.enrolled_count || 0} คน`;

    // Badges
    document.getElementById('category-badge').textContent = course.category_name || 'ทั่วไป';
    document.getElementById('difficulty-badge').textContent = getDifficultyText(course.difficulty_level);
    document.getElementById('difficulty-badge').className = `badge-${getDifficultyColor(course.difficulty_level)}`;

    // Rating
    updateRatingDisplay(course.rating, course.rating_count);

    // Progress (if enrolled)
    if (course.enrollment_status === 'active' && course.progress_percentage && course.progress_percentage > 0) {
        document.getElementById('progress-section').classList.remove('hidden');
        document.getElementById('progress-percentage').textContent = `${course.progress_percentage}%`;
        document.getElementById('progress-fill').style.width = `${course.progress_percentage}%`;
    }

    // Sidebar info
    document.getElementById('sidebar-difficulty').textContent = getDifficultyText(course.difficulty_level);
    document.getElementById('sidebar-duration').textContent = `${course.duration_hours || 0} ${t('hours')}`;

    // Language display (support both old and new values)
    const languageMap = {
        'th': t('languageThai'),
        'en': t('languageEnglish'),
        'th-en': t('languageThaiEnglish'),
        // Support old values for backward compatibility
        'Thai': t('languageThai'),
        'ภาษาไทย': t('languageThai'),
        'English': t('languageEnglish'),
        'ภาษาอังกฤษ': t('languageEnglish')
    };
    document.getElementById('sidebar-language').textContent = languageMap[course.language] || course.language || t('notSpecified');

    // Course type (support both old and new values)
    const courseTypeMap = {
        'mandatory': t('typeMandatory'),
        'elective': t('typeElective'),
        'recommended': t('typeRecommended'),
        // Support old values for backward compatibility
        'Required': t('typeMandatory'),
        'บังคับ': t('typeMandatory'),
        'Optional': t('typeElective'),
        'เลือก': t('typeElective'),
        'Recommended': t('typeRecommended'),
        'แนะนำ': t('typeRecommended')
    };
    document.getElementById('sidebar-course-type').textContent = courseTypeMap[course.course_type] || course.course_type || t('notSpecified');

    // Max students
    document.getElementById('sidebar-max-students').textContent = course.max_students ? `${course.max_students} ${t('people')}` : t('unlimited');

    // Passing score
    document.getElementById('sidebar-passing-score').textContent =
        (course.passing_score !== null && course.passing_score !== undefined)
            ? `${course.passing_score}%`
            : t('notSpecified');

    // Max attempts
    document.getElementById('sidebar-max-attempts').textContent =
        (course.max_attempts !== null && course.max_attempts !== undefined)
            ? `${course.max_attempts} ${t('times')}`
            : t('notSpecified');

    // Certificate
    const certElement = document.getElementById('sidebar-certificate');
    if (course.certificate_validity) {
        certElement.innerHTML = `<i class="fas fa-check mr-1"></i>${t('yes')} (${course.certificate_validity})`;
        certElement.className = 'font-medium text-green-600';
    } else {
        certElement.innerHTML = `<i class="fas fa-times mr-1"></i>${t('no')}`;
        certElement.className = 'font-medium text-gray-500';
    }

    document.getElementById('publish-date').textContent = course.created_at ? formatDate(course.created_at) : '-';
    document.getElementById('update-date').textContent = course.updated_at ? formatDate(course.updated_at) : '-';

    // Start and End dates (with time)
    document.getElementById('sidebar-start-date').textContent = course.start_date ? formatDateTime(course.start_date) : t('notSpecified');
    document.getElementById('sidebar-end-date').textContent = course.end_date ? formatDateTime(course.end_date) : t('notSpecified');

    // Intro Video
    if (course.intro_video_url) {
        const introVideoSection = document.getElementById('intro-video-section');
        const introVideoPlayer = document.getElementById('intro-video-player');
        introVideoSection.style.display = 'block';

        try {
            // Check if it's a YouTube URL
            if (course.intro_video_url.includes('youtube.com') || course.intro_video_url.includes('youtu.be')) {
                let videoId = '';

                // Extract video ID from various YouTube URL formats
                if (course.intro_video_url.includes('youtube.com/watch')) {
                    // https://www.youtube.com/watch?v=VIDEO_ID
                    const urlParams = new URLSearchParams(new URL(course.intro_video_url).search);
                    videoId = urlParams.get('v');
                } else if (course.intro_video_url.includes('youtube.com/embed/')) {
                    // https://www.youtube.com/embed/VIDEO_ID
                    videoId = course.intro_video_url.split('youtube.com/embed/')[1].split('?')[0];
                } else if (course.intro_video_url.includes('youtu.be/')) {
                    // https://youtu.be/VIDEO_ID
                    videoId = course.intro_video_url.split('youtu.be/')[1].split('?')[0];
                }

                if (videoId) {
                    // Embed YouTube video using iframe (CSP now allows YouTube)
                    introVideoPlayer.innerHTML = `
                        <iframe
                            style="width: 100%; height: 100%; min-height: 400px; border-radius: 0.5rem;"
                            src="https://www.youtube-nocookie.com/embed/${videoId}?rel=0"
                            frameborder="0"
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                            allowfullscreen
                            referrerpolicy="strict-origin-when-cross-origin"
                        ></iframe>`;
                } else {
                    introVideoPlayer.innerHTML = `<div class="flex items-center justify-center h-full text-gray-500"><p>${t('cannotLoadVideo')}</p></div>`;
                }
            } else if (course.intro_video_url.includes('vimeo.com')) {
                // Extract Vimeo ID
                let vimeoId = '';
                if (course.intro_video_url.includes('vimeo.com/')) {
                    vimeoId = course.intro_video_url.split('vimeo.com/')[1].split('?')[0].split('/')[0];
                }

                if (vimeoId) {
                    // Embed Vimeo video using iframe (CSP now allows Vimeo)
                    introVideoPlayer.innerHTML = `
                        <iframe
                            style="width: 100%; height: 100%; min-height: 400px; border-radius: 0.5rem;"
                            src="https://player.vimeo.com/video/${vimeoId}"
                            frameborder="0"
                            allow="autoplay; fullscreen; picture-in-picture"
                            allowfullscreen
                        ></iframe>`;
                } else {
                    introVideoPlayer.innerHTML = `<div class="flex items-center justify-center h-full text-gray-500"><p>${t('cannotLoadVideo')}</p></div>`;
                }
            } else {
                // Direct video file or other sources
                introVideoPlayer.innerHTML = `
                    <video class="w-full h-full rounded-lg" controls>
                        <source src="${course.intro_video_url}" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>`;
            }
        } catch (error) {
            console.error('Error loading intro video:', error);
            introVideoPlayer.innerHTML = `<div class="flex items-center justify-center h-full text-red-500"><p>เกิดข้อผิดพลาดในการโหลดวิดีโอ</p></div>`;
        }
    }

    // Overview content
    document.getElementById('course-full-description').innerHTML = course.description || 'ไม่มีคำอธิบาย';

    // Learning objectives (already parsed by backend, no need to parse again)
    const objectives = Array.isArray(course.learning_objectives)
        ? course.learning_objectives
        : [];

    if (objectives && objectives.length > 0) {
        document.getElementById('learning-objectives').innerHTML = objectives.map(obj =>
            `<li class="text-gray-700">${obj}</li>`
        ).join('');
    } else {
        document.getElementById('learning-objectives').innerHTML = '<li class="text-gray-500 list-none">ไม่ได้ระบุวัตถุประสงค์</li>';
    }

    // Target Audience - Use mapping from database (already parsed by backend)
    const targetAudienceElement = document.getElementById('target-audience');
    const targetAudience = course.target_audience || { positions: [], departments: [] };

    const hasPositions = targetAudience.positions && targetAudience.positions.length > 0;
    const hasDepartments = targetAudience.departments && targetAudience.departments.length > 0;

    if (hasPositions || hasDepartments) {
        let targetHTML = '<div class="space-y-4">';

        // Summary badge at top
        const posCount = hasPositions ? targetAudience.positions.length : 0;
        const deptCount = hasDepartments ? targetAudience.departments.length : 0;
        targetHTML += `
            <div class="flex items-center gap-2 text-sm text-gray-600 mb-2">
                <i class="fas fa-bullseye text-ruxchai-primary"></i>
                <span class="font-semibold">กลุ่มเป้าหมาย:</span>
                ${posCount > 0 ? `<span class="px-2 py-0.5 bg-blue-50 text-blue-700 rounded">${posCount} ตำแหน่ง</span>` : ''}
                ${deptCount > 0 ? `<span class="px-2 py-0.5 bg-green-50 text-green-700 rounded">${deptCount} หน่วยงาน</span>` : ''}
            </div>`;

        if (hasPositions) {
            targetHTML += '<div>';
            targetHTML += '<div class="flex items-center mb-2">';
            targetHTML += '<i class="fas fa-user-tie text-blue-600 mr-2"></i>';
            targetHTML += '<span class="text-sm font-semibold text-gray-700">ตำแหน่ง:</span>';
            targetHTML += '</div>';
            targetHTML += '<div class="flex flex-wrap gap-2">';

            // Map positions
            targetAudience.positions.forEach(p => {
                const mappedPosition = positionsMapping[p] ||
                                      positionsMapping[String(p)] ||
                                      (typeof p === 'string' ? positionsMapping[p.toLowerCase()] : null);
                const positionName = mappedPosition || p;
                targetHTML += `
                    <span class="inline-flex items-center px-3 py-1.5 rounded-full text-sm font-medium bg-blue-100 text-blue-800 border border-blue-200">
                        <i class="fas fa-briefcase mr-1.5 text-xs"></i>
                        ${positionName}
                    </span>`;
            });

            targetHTML += '</div></div>';
        }

        if (hasDepartments) {
            targetHTML += '<div>';
            targetHTML += '<div class="flex items-center mb-2">';
            targetHTML += '<i class="fas fa-building text-green-600 mr-2"></i>';
            targetHTML += '<span class="text-sm font-semibold text-gray-700">หน่วยงาน:</span>';
            targetHTML += '</div>';
            targetHTML += '<div class="flex flex-wrap gap-2">';

            // Map departments and detect hierarchy
            const deptInfos = targetAudience.departments.map(d => {
                const mappedDepartment = departmentsMapping[d] ||
                                        departmentsMapping[String(d)] ||
                                        (typeof d === 'string' ? departmentsMapping[d.toLowerCase()] : null);

                if (mappedDepartment && typeof mappedDepartment === 'object') {
                    return { ...mappedDepartment, id: d };
                } else {
                    return { name: mappedDepartment || d, level_id: 999, id: d };
                }
            });

            // Sort by level_id (parent first)
            deptInfos.sort((a, b) => a.level_id - b.level_id);

            // Smart hierarchy collapse: detect if all children of a parent are selected
            const deptIds = new Set(targetAudience.departments.map(d => parseInt(d) || d));
            const collapsedDepts = [];
            const usedIds = new Set();

            deptInfos.forEach(dept => {
                if (usedIds.has(dept.id)) return;

                // Check if this is a parent with all children selected
                const children = deptInfos.filter(d => d.level_id > dept.level_id);
                const isParentWithAllChildren = children.length > 0 &&
                    children.every(child => deptIds.has(child.id));

                if (isParentWithAllChildren && dept.level_id < 4) {
                    // Show parent with "ทั้งหมด" indicator
                    dept.isCollapsed = true;
                    dept.childCount = children.length;
                    children.forEach(c => usedIds.add(c.id));
                }

                collapsedDepts.push(dept);
                usedIds.add(dept.id);
            });

            // Display departments
            collapsedDepts.forEach((dept, index) => {
                let colorClass = 'bg-green-100 text-green-800 border-green-200';
                let icon = 'fa-sitemap';

                if (dept.level_id === 1) {
                    colorClass = 'bg-blue-50 text-blue-700 border-blue-200';
                    icon = 'fa-building';
                } else if (dept.level_id === 2) {
                    colorClass = 'bg-cyan-50 text-cyan-700 border-cyan-200';
                    icon = 'fa-city';
                } else if (dept.level_id >= 4) {
                    colorClass = 'bg-green-100 text-green-800 border-green-200';
                    icon = 'fa-sitemap';
                }

                const collapseIndicator = dept.isCollapsed ?
                    `<span class="ml-1 text-xs opacity-75">(ทั้งหมด)</span>` : '';

                targetHTML += `
                    <span class="inline-flex items-center px-3 py-1.5 rounded-full text-sm font-medium ${colorClass} border">
                        <i class="fas ${icon} mr-1.5 text-xs"></i>
                        ${dept.name}${collapseIndicator}
                    </span>`;
            });

            targetHTML += '</div></div>';
        }

        // Smart message based on selection
        if (hasPositions && hasDepartments) {
            targetHTML += `
                <div class="flex items-start gap-2 p-3 bg-blue-50 rounded-lg border border-blue-100 text-sm">
                    <i class="fas fa-info-circle text-blue-600 mt-0.5"></i>
                    <span class="text-blue-800">
                        <strong>เงื่อนไข:</strong> คุณสามารถเข้าเรียนได้หากอยู่ใน<strong>ตำแหน่ง</strong>ที่ระบุ <strong>หรือ</strong> อยู่ใน<strong>หน่วยงาน</strong>ที่ระบุ
                    </span>
                </div>`;
        } else if (hasPositions) {
            targetHTML += `
                <div class="flex items-start gap-2 p-3 bg-blue-50 rounded-lg border border-blue-100 text-sm">
                    <i class="fas fa-info-circle text-blue-600 mt-0.5"></i>
                    <span class="text-blue-800">
                        เฉพาะผู้ที่ดำรงตำแหน่งที่ระบุข้างต้น (ทุกหน่วยงาน)
                    </span>
                </div>`;
        } else if (hasDepartments) {
            targetHTML += `
                <div class="flex items-start gap-2 p-3 bg-green-50 rounded-lg border border-green-100 text-sm">
                    <i class="fas fa-info-circle text-green-600 mt-0.5"></i>
                    <span class="text-green-800">
                        เฉพาะผู้ที่อยู่ในหน่วยงานที่ระบุข้างต้น (ทุกตำแหน่ง)
                    </span>
                </div>`;
        }

        targetHTML += '</div>';
        targetAudienceElement.innerHTML = targetHTML;
    } else {
        targetAudienceElement.innerHTML = `
            <div class="flex items-center p-4 bg-gradient-to-r from-purple-50 to-pink-50 rounded-lg border-2 border-purple-200">
                <i class="fas fa-users text-purple-600 mr-3 text-2xl"></i>
                <div>
                    <div class="text-purple-900 font-semibold">เปิดกว้างสำหรับทุกคน</div>
                    <div class="text-purple-700 text-sm">ไม่จำกัดตำแหน่งหรือหน่วยงาน</div>
                </div>
            </div>`;
    }

    // Prerequisites
    const prerequisites = course.prerequisite_knowledge || 'ไม่มีความต้องการพื้นฐานพิเศษ';
    document.getElementById('prerequisites').innerHTML = `<p class="text-gray-600">${prerequisites}</p>`;

    // Display curriculum immediately if available
    if (course.lessons && course.lessons.length > 0) {
        updateCurriculumDisplay(course.lessons);
    }

    // Enrollment status
    updateEnrollmentStatus(course);

    // Instructor info
    updateInstructorInfo(course);
}

function updateRatingDisplay(rating, count) {
    const ratingDisplay = document.getElementById('rating-display');
    const ratingText = document.getElementById('rating-text');

    if (rating && count && count > 0) {
        const stars = ratingDisplay.querySelectorAll('.fas.fa-star');
        const fullStars = Math.floor(rating);
        const hasHalfStar = rating % 1 >= 0.5;

        stars.forEach((star, index) => {
            star.className = 'fas fa-star';
            if (index < fullStars) {
                star.classList.add('text-yellow-400');
            } else if (index === fullStars && hasHalfStar) {
                star.classList.add('text-yellow-400');
            } else {
                star.classList.add('text-gray-300');
            }
        });

        ratingText.textContent = `${rating.toFixed(1)} (${count} รีวิว)`;
    } else {
        ratingText.textContent = 'ยังไม่มีรีวิว';
    }
}

function updateEnrollmentStatus(course) {
    const container = document.getElementById('enrollment-status');
    const userRole = '<%= userRole || "" %>';
    const canEdit = userRole && ['Admin', 'Instructor', 'HR'].includes(userRole);

    if (course.enrollment_status === 'active') {
        container.innerHTML = `
            <div class="space-y-4">
                <div class="text-center">
                    <i class="fas fa-graduation-cap text-green-500 text-3xl mb-2"></i>
                    <p class="text-green-600 font-semibold">คุณได้ลงทะเบียนเรียนแล้ว</p>
                </div>
                <a href="/courses/${course.course_id}/content" class="btn-ruxchai-primary w-full text-center block">
                    <i class="fas fa-play mr-2"></i>เข้าเรียน
                </a>
                ${course.progress_percentage === 100 ? `
                    <button onclick="showRatingModal()" class="btn-ruxchai-outline w-full">
                        <i class="fas fa-star mr-2"></i>ให้คะแนนคอร์ส
                    </button>
                ` : ''}
                ${canEdit ? `
                    <a href="/courses/${course.course_id}/edit" class="btn-ruxchai-outline w-full text-center block">
                        <i class="fas fa-edit mr-2"></i>แก้ไขคอร์ส
                    </a>
                ` : ''}
            </div>
        `;
    } else if (course.enrollment_status === 'completed') {
        container.innerHTML = `
            <div class="space-y-4">
                <div class="text-center">
                    <i class="fas fa-trophy text-yellow-500 text-3xl mb-2"></i>
                    <p class="text-yellow-600 font-semibold">เรียนจบแล้ว</p>
                </div>
                <a href="/courses/${course.course_id}/certificate" class="btn-ruxchai-primary w-full text-center block">
                    <i class="fas fa-certificate mr-2"></i>ดาวน์โหลดใบประกาศนียบัตร
                </a>
                <button onclick="showRatingModal()" class="btn-ruxchai-outline w-full">
                    <i class="fas fa-star mr-2"></i>ให้คะแนนคอร์ส
                </button>
                ${canEdit ? `
                    <a href="/courses/${course.course_id}/edit" class="btn-ruxchai-outline w-full text-center block">
                        <i class="fas fa-edit mr-2"></i>แก้ไขคอร์ส
                    </a>
                ` : ''}
            </div>
        `;
    } else {
        container.innerHTML = `
            <div class="space-y-4">
                <div class="text-center">
                    <i class="fas fa-book text-ruxchai-primary text-3xl mb-2"></i>
                    <p class="text-gray-600">เริ่มเรียนคอร์สนี้</p>
                </div>
                <button onclick="showEnrollmentModal()" class="btn-ruxchai-primary w-full">
                    <i class="fas fa-user-plus mr-2"></i>ลงทะเบียนเรียน
                </button>
                ${canEdit ? `
                    <a href="/courses/${course.course_id}/edit" class="btn-ruxchai-outline w-full text-center block">
                        <i class="fas fa-edit mr-2"></i>แก้ไขคอร์ส
                    </a>
                ` : ''}
            </div>
        `;
    }
}

function updateInstructorInfo(course) {
    if (!course) return;

    const container = document.getElementById('instructor-info');
    container.innerHTML = `
        <div class="flex items-start space-x-3">
            <img src="${course.instructor_avatar || '/images/default-avatar.png'}"
                 alt="${course.instructor_name || 'ผู้สอน'}"
                 class="w-12 h-12 rounded-full">
            <div>
                <h4 class="font-semibold text-gray-900">${course.instructor_name || 'ไม่ระบุ'}</h4>
                <p class="text-sm text-gray-600">${course.instructor_title || 'ผู้สอน'}</p>
                <p class="text-sm text-gray-500 mt-1">${course.instructor_bio || 'ไม่มีข้อมูลประวัติ'}</p>
            </div>
        </div>
    `;
}

async function loadCurriculum() {
    try {
        const container = document.getElementById('course-curriculum');
        container.innerHTML = '<div class="text-center py-4"><i class="fas fa-spinner fa-spin text-gray-400 mr-2"></i>กำลังโหลดหลักสูตร...</div>';

        const response = await fetch(`/courses/api/${courseId}/curriculum`);

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();

        if (data.success) {
            updateCurriculumDisplay(data.data);
        } else {
            container.innerHTML = '<p class="text-gray-500">ไม่สามารถโหลดหลักสูตรได้</p>';
        }
    } catch (error) {
        console.error('Error loading curriculum:', error);
        const container = document.getElementById('course-curriculum');
        container.innerHTML = '<p class="text-red-500">เกิดข้อผิดพลาดในการโหลดหลักสูตร</p>';
    }
}

function updateCurriculumDisplay(curriculum) {
    const container = document.getElementById('course-curriculum');

    // Check if curriculum is from course.lessons (flat array)
    if (!curriculum || curriculum.length === 0) {
        // Try to get lessons from courseData
        if (courseData && courseData.lessons && courseData.lessons.length > 0) {
            curriculum = courseData.lessons;
        } else {
            container.innerHTML = '<p class="text-gray-500">ยังไม่มีบทเรียนที่กำหนด</p>';
            return;
        }
    }

    // Check if first item has 'lessons' property (section format) or is a lesson itself
    if (curriculum[0] && curriculum[0].lessons) {
        // Section format with lessons inside
        container.innerHTML = curriculum.map((section, index) => `
            <div class="border rounded-lg mb-4">
                <div class="bg-gray-50 px-4 py-3 border-b">
                    <h4 class="font-semibold text-gray-900">
                        ${index + 1}. ${section.title}
                    </h4>
                    <p class="text-sm text-gray-600">${section.description || ''}</p>
                </div>
                <div class="p-4">
                    ${section.lessons.map((lesson, lessonIndex) => `
                        <div class="flex items-center justify-between py-2 ${lessonIndex > 0 ? 'border-t border-gray-100' : ''}">
                            <div class="flex items-center space-x-3">
                                <i class="fas ${lesson.type === 'video' || lesson.video_url ? 'fa-play-circle' : 'fa-book'} text-gray-400"></i>
                                <div>
                                    <div>${lesson.title}</div>
                                    ${lesson.description ? `<p class="text-sm text-gray-500">${lesson.description}</p>` : ''}
                                </div>
                            </div>
                            <div class="flex items-center space-x-2 text-sm text-gray-500">
                                <span>${lesson.duration || lesson.duration_minutes || '0'} นาที</span>
                                ${lesson.completed ? '<i class="fas fa-check-circle text-green-500"></i>' : ''}
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `).join('');
    } else {
        // Flat lessons format
        container.innerHTML = `
            <div class="border rounded-lg">
                <div class="bg-gray-50 px-4 py-3 border-b">
                    <h4 class="font-semibold text-gray-900">บทเรียนทั้งหมด (${curriculum.length} บท)</h4>
                </div>
                <div class="p-4">
                    ${curriculum.map((lesson, index) => `
                        <div class="py-3 ${index > 0 ? 'border-t border-gray-100' : ''}">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-3 flex-1">
                                    <div class="flex-shrink-0 w-8 h-8 bg-ruxchai-primary text-white rounded-full flex items-center justify-center text-sm font-semibold">
                                        ${index + 1}
                                    </div>
                                    <div class="flex-1">
                                        <div class="font-medium text-gray-900">${lesson.title}</div>
                                        ${lesson.content || lesson.description ? `<p class="text-sm text-gray-600 mt-1">${lesson.content || lesson.description}</p>` : ''}
                                    </div>
                                </div>
                                <div class="flex items-center space-x-4 text-sm text-gray-500">
                                    <div class="flex items-center">
                                        <i class="far fa-clock mr-1"></i>
                                        <span>${lesson.duration_minutes || lesson.duration || '0'} นาที</span>
                                    </div>
                                    ${lesson.video_url ? `
                                        <a href="${lesson.video_url}" target="_blank" class="flex items-center text-ruxchai-primary hover:text-ruxchai-secondary">
                                            <i class="fas fa-play-circle mr-1"></i>
                                            <span class="text-xs">ดูวิดีโอ</span>
                                        </a>
                                    ` : ''}
                                    ${lesson.completed ? '<i class="fas fa-check-circle text-green-500"></i>' : ''}
                                </div>
                            </div>
                            ${lesson.video_url ? `
                                <div class="mt-3 ml-11">
                                    <div class="bg-gray-50 rounded-lg p-3 text-sm">
                                        <i class="fas fa-link text-gray-400 mr-2"></i>
                                        <a href="${lesson.video_url}" target="_blank" class="text-blue-600 hover:text-blue-800 break-all">
                                            ${lesson.video_url}
                                        </a>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }
}

async function loadMaterials() {
    try {
        const container = document.getElementById('course-materials');
        container.innerHTML = '<div class="text-center py-4"><i class="fas fa-spinner fa-spin text-gray-400 mr-2"></i>กำลังโหลดเอกสาร...</div>';

        const response = await fetch(`/courses/api/${courseId}/materials`);

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();

        if (data.success) {
            updateMaterialsDisplay(data.data);
        } else {
            container.innerHTML = '<p class="text-gray-500">ไม่สามารถโหลดเอกสารได้</p>';
        }
    } catch (error) {
        console.error('Error loading materials:', error);
        const container = document.getElementById('course-materials');
        container.innerHTML = '<p class="text-red-500">เกิดข้อผิดพลาดในการโหลดเอกสาร</p>';
    }
}

function updateMaterialsDisplay(materials) {
    const container = document.getElementById('course-materials');

    if (!materials || materials.length === 0) {
        container.innerHTML = '<p class="text-gray-500">ยังไม่มีเอกสารประกอบการเรียน</p>';
        return;
    }

    container.innerHTML = materials.map(material => `
        <div class="flex items-center justify-between p-4 border rounded-lg mb-3">
            <div class="flex items-center space-x-3">
                <i class="fas ${getFileIcon(material.file_type)} text-ruxchai-primary"></i>
                <div>
                    <h5 class="font-medium text-gray-900">${material.title}</h5>
                    <p class="text-sm text-gray-500">${material.description || ''}</p>
                </div>
            </div>
            <div class="flex items-center space-x-2">
                <span class="text-sm text-gray-500">${formatFileSize(material.file_size)}</span>
                <a href="${material.file_url}" target="_blank" class="btn-ruxchai-outline text-sm">
                    <i class="fas fa-download mr-1"></i>ดาวน์โหลด
                </a>
            </div>
        </div>
    `).join('');
}

async function loadDiscussions() {
    try {
        const container = document.getElementById('course-discussions');
        container.innerHTML = '<div class="text-center py-4"><i class="fas fa-spinner fa-spin text-gray-400 mr-2"></i>กำลังโหลดการอภิปราย...</div>';

        const response = await fetch(`/courses/api/${courseId}/discussions`);

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();

        if (data.success) {
            updateDiscussionsDisplay(data.data);
        } else {
            container.innerHTML = '<p class="text-gray-500">ไม่สามารถโหลดการอภิปรายได้</p>';
        }
    } catch (error) {
        console.error('Error loading discussions:', error);
        const container = document.getElementById('course-discussions');
        container.innerHTML = '<p class="text-red-500">เกิดข้อผิดพลาดในการโหลดการอภิปราย</p>';
    }
}

function updateDiscussionsDisplay(discussions) {
    const container = document.getElementById('course-discussions');

    if (!discussions || discussions.length === 0) {
        container.innerHTML = `
            <div class="text-center py-8">
                <i class="fas fa-comments text-gray-300 text-4xl mb-4"></i>
                <p class="text-gray-500 mb-4">ยังไม่มีการอภิปราย</p>
                <button class="btn-ruxchai-primary">เริ่มการอภิปราย</button>
            </div>
        `;
        return;
    }

    container.innerHTML = discussions.map(discussion => `
        <div class="border-b border-gray-200 pb-4 mb-4">
            <div class="flex items-start space-x-3">
                <img src="${discussion.author_avatar || '/images/default-avatar.png'}"
                     alt="${discussion.author_name}"
                     class="w-10 h-10 rounded-full">
                <div class="flex-1">
                    <div class="flex items-center space-x-2 mb-1">
                        <h5 class="font-medium text-gray-900">${discussion.author_name}</h5>
                        <span class="text-sm text-gray-500">${timeAgo(discussion.created_at)}</span>
                    </div>
                    <p class="text-gray-700 mb-2">${discussion.content}</p>
                    <div class="flex items-center space-x-4 text-sm text-gray-500">
                        <button class="hover:text-ruxchai-primary">
                            <i class="fas fa-reply mr-1"></i>ตอบกลับ
                        </button>
                        <span><i class="fas fa-heart mr-1"></i>${discussion.likes || 0}</span>
                        <span>${discussion.replies || 0} ตอบกลับ</span>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
}

async function loadReviews() {
    try {
        const container = document.getElementById('course-reviews');
        container.innerHTML = '<div class="text-center py-4"><i class="fas fa-spinner fa-spin text-gray-400 mr-2"></i>กำลังโหลดรีวิว...</div>';

        const response = await fetch(`/courses/api/${courseId}/reviews`);

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();

        if (data.success) {
            updateReviewsDisplay(data.data);
        } else {
            container.innerHTML = '<p class="text-gray-500">ไม่สามารถโหลดรีวิวได้</p>';
        }
    } catch (error) {
        console.error('Error loading reviews:', error);
        const container = document.getElementById('course-reviews');
        container.innerHTML = '<p class="text-red-500">เกิดข้อผิดพลาดในการโหลดรีวิว</p>';
    }
}

function updateReviewsDisplay(reviews) {
    const container = document.getElementById('course-reviews');

    if (!reviews || reviews.length === 0) {
        container.innerHTML = '<p class="text-gray-500">ยังไม่มีรีวิว</p>';
        return;
    }

    container.innerHTML = reviews.map(review => `
        <div class="border-b border-gray-200 pb-4 mb-4">
            <div class="flex items-start space-x-3">
                <img src="${review.user_avatar || '/images/default-avatar.png'}"
                     alt="${review.user_name}"
                     class="w-10 h-10 rounded-full">
                <div class="flex-1">
                    <div class="flex items-center justify-between mb-2">
                        <div>
                            <h5 class="font-medium text-gray-900">${review.user_name}</h5>
                            <div class="flex items-center space-x-2">
                                <div class="flex text-yellow-400">
                                    ${generateStars(review.rating)}
                                </div>
                                <span class="text-sm text-gray-500">${timeAgo(review.created_at)}</span>
                            </div>
                        </div>
                    </div>
                    ${review.review_text ? `<p class="text-gray-700">${review.review_text}</p>` : ''}
                </div>
            </div>
        </div>
    `).join('');
}

async function loadRelatedCourses() {
    try {
        const container = document.getElementById('related-courses');
        container.innerHTML = '<div class="text-center py-4 text-sm"><i class="fas fa-spinner fa-spin text-gray-400 mr-2"></i>กำลังโหลด...</div>';

        const response = await fetch(`/courses/api/${courseId}/related`);

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();

        if (data.success) {
            updateRelatedCoursesDisplay(data.data);
        } else {
            container.innerHTML = '<p class="text-gray-500 text-sm">ไม่สามารถโหลดคอร์สที่เกี่ยวข้องได้</p>';
        }
    } catch (error) {
        console.error('Error loading related courses:', error);
        const container = document.getElementById('related-courses');
        container.innerHTML = '<p class="text-gray-500 text-sm">ไม่สามารถโหลดคอร์สที่เกี่ยวข้องได้</p>';
    }
}

function updateRelatedCoursesDisplay(courses) {
    const container = document.getElementById('related-courses');

    if (!courses || courses.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-sm">ไม่มีคอร์สที่เกี่ยวข้อง</p>';
        return;
    }

    container.innerHTML = courses.map(course => `
        <div class="flex space-x-3 p-3 hover:bg-gray-50 rounded-lg transition-colors">
            <img src="${course.thumbnail || '/images/course-default.jpg'}"
                 alt="${course.title}"
                 class="w-16 h-12 object-cover rounded">
            <div class="flex-1 min-w-0">
                <h5 class="font-medium text-sm text-gray-900 line-clamp-2">
                    <a href="/courses/${course.course_id}" class="hover:text-ruxchai-primary">
                        ${course.title}
                    </a>
                </h5>
                <p class="text-xs text-gray-500 mt-1">${course.instructor_name}</p>
                <div class="flex items-center space-x-2 mt-1 text-xs text-gray-500">
                    <span>${course.duration_hours}h</span>
                    ${course.rating ? `<span><i class="fas fa-star text-yellow-400"></i> ${course.rating}</span>` : ''}
                </div>
            </div>
        </div>
    `).join('');
}

function switchTab(tabName) {
    // Update tab buttons
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

    // Update tab content
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.add('hidden');
    });
    document.getElementById(`tab-${tabName}`).classList.remove('hidden');
}

function showEnrollmentModal() {
    document.getElementById('enrollment-modal').classList.remove('hidden');
}

function closeEnrollmentModal() {
    document.getElementById('enrollment-modal').classList.add('hidden');
}

async function enrollInCourse() {
    try {
        const confirmBtn = document.getElementById('confirm-enrollment');
        const originalText = confirmBtn.innerHTML;
        confirmBtn.disabled = true;
        confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>กำลังลงทะเบียน...';

        const response = await fetch(`/courses/api/${courseId}/enroll`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();

        if (data.success) {
            showSuccess('ลงทะเบียนเรียนสำเร็จ');
            closeEnrollmentModal();
            // Reload course data
            loadCourseDetail();
        } else {
            showError(data.message || 'เกิดข้อผิดพลาดในการลงทะเบียน');
        }

        confirmBtn.disabled = false;
        confirmBtn.innerHTML = originalText;
    } catch (error) {
        console.error('Error enrolling in course:', error);
        showError('เกิดข้อผิดพลาดในการลงทะเบียน');

        const confirmBtn = document.getElementById('confirm-enrollment');
        confirmBtn.disabled = false;
        confirmBtn.innerHTML = 'ยืนยันการลงทะเบียน';
    }
}

function showRatingModal() {
    document.getElementById('rating-modal').classList.remove('hidden');
}

function closeRatingModal() {
    document.getElementById('rating-modal').classList.add('hidden');
    currentRating = 0;
    updateStarDisplay();
    document.getElementById('review-text').value = '';
}

function updateStarDisplay() {
    document.querySelectorAll('.star-rating').forEach((star, index) => {
        if (index < currentRating) {
            star.classList.remove('text-gray-300');
            star.classList.add('text-yellow-400');
        } else {
            star.classList.remove('text-yellow-400');
            star.classList.add('text-gray-300');
        }
    });
}

async function submitRating() {
    if (currentRating === 0) {
        showError('กรุณาให้คะแนน');
        return;
    }

    try {
        const submitBtn = document.getElementById('submit-rating');
        const originalText = submitBtn.innerHTML;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>กำลังส่ง...';

        const response = await fetch(`/courses/api/${courseId}/rate`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                rating: currentRating,
                review: document.getElementById('review-text').value
            })
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();

        if (data.success) {
            showSuccess('ส่งคะแนนสำเร็จ');
            closeRatingModal();
            // Reload reviews
            loadReviews();
            loadCourseDetail();
        } else {
            showError(data.message || 'เกิดข้อผิดพลาดในการส่งคะแนน');
        }

        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    } catch (error) {
        console.error('Error submitting rating:', error);
        showError('เกิดข้อผิดพลาดในการส่งคะแนน');

        const submitBtn = document.getElementById('submit-rating');
        submitBtn.disabled = false;
        submitBtn.innerHTML = 'ส่งคะแนน';
    }
}

// Utility functions
function getDifficultyText(level) {
    if (!level) return t('notSpecified');
    const texts = {
        'beginner': t('difficultyBeginner'),
        'intermediate': t('difficultyIntermediate'),
        'advanced': t('difficultyAdvanced')
    };
    // Make case-insensitive
    const normalizedLevel = level.toLowerCase();
    return texts[normalizedLevel] || level;
}

function getDifficultyColor(level) {
    if (!level) return 'primary';
    const colors = {
        'beginner': 'success',
        'intermediate': 'warning',
        'advanced': 'danger'
    };
    // Make case-insensitive
    const normalizedLevel = level.toLowerCase();
    return colors[normalizedLevel] || 'primary';
}

function formatDate(dateString) {
    if (!dateString) return '-';
    return new Date(dateString).toLocaleDateString('th-TH');
}

function formatDateTime(dateString) {
    if (!dateString) return '-';
    const date = new Date(dateString);
    const dateStr = date.toLocaleDateString('th-TH', {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
    });
    const timeStr = date.toLocaleTimeString('th-TH', {
        hour: '2-digit',
        minute: '2-digit'
    });
    return `${dateStr} ${timeStr}`;
}

function formatFileSize(bytes) {
    if (!bytes || bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function getFileIcon(fileType) {
    const icons = {
        'pdf': 'fa-file-pdf',
        'doc': 'fa-file-word',
        'docx': 'fa-file-word',
        'xls': 'fa-file-excel',
        'xlsx': 'fa-file-excel',
        'ppt': 'fa-file-powerpoint',
        'pptx': 'fa-file-powerpoint',
        'image': 'fa-file-image',
        'video': 'fa-file-video',
        'audio': 'fa-file-audio'
    };
    return icons[fileType] || 'fa-file';
}

function generateStars(rating) {
    let stars = '';
    for (let i = 1; i <= 5; i++) {
        if (i <= rating) {
            stars += '<i class="fas fa-star"></i>';
        } else {
            stars += '<i class="far fa-star"></i>';
        }
    }
    return stars;
}

function timeAgo(dateString) {
    if (!dateString) return '-';
    const date = new Date(dateString);
    const now = new Date();
    const diffInSeconds = Math.floor((now - date) / 1000);

    if (diffInSeconds < 60) return 'เมื่อสักครู่';
    if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)} นาทีที่แล้ว`;
    if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)} ชั่วโมงที่แล้ว`;
    return `${Math.floor(diffInSeconds / 86400)} วันที่แล้ว`;
}

function showSuccess(message) {
    const alert = document.createElement('div');
    alert.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 animate-fade-in';
    alert.innerHTML = `<i class="fas fa-check-circle mr-2"></i>${message}`;
    document.body.appendChild(alert);
    setTimeout(() => alert.remove(), 3000);
}

function showError(message) {
    const alert = document.createElement('div');
    alert.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 animate-fade-in';
    alert.innerHTML = `<i class="fas fa-exclamation-circle mr-2"></i>${message}`;
    document.body.appendChild(alert);
    setTimeout(() => alert.remove(), 3000);
}

function showLoading(message = 'กำลังโหลด...') {
    // Remove existing loading overlay if any
    hideLoading();

    const overlay = document.createElement('div');
    overlay.id = 'loading-overlay';
    overlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    overlay.innerHTML = `
        <div class="bg-white rounded-lg px-8 py-6 flex items-center space-x-4 shadow-xl">
            <i class="fas fa-spinner fa-spin text-ruxchai-primary text-2xl"></i>
            <span class="text-gray-700 font-medium">${message}</span>
        </div>
    `;
    document.body.appendChild(overlay);
}

function hideLoading() {
    const overlay = document.getElementById('loading-overlay');
    if (overlay) {
        overlay.remove();
    }
}
</script>

<style>
.tab-btn {
    border-bottom: 2px solid transparent;
    padding: 0.75rem 1rem;
    font-weight: 500;
    color: #6b7280;
    transition: all 0.2s;
}

.tab-btn:hover {
    color: #1e40af;
}

.tab-btn.active {
    color: #1e40af;
    border-bottom-color: #1e40af;
}

.line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.prose {
    max-width: none;
}

.prose h3 {
    font-size: 1.125rem;
    font-weight: 600;
    margin-top: 1.5rem;
    margin-bottom: 0.5rem;
    color: #111827;
}

.prose ul {
    margin-top: 0.5rem;
    margin-bottom: 1rem;
    padding-left: 1.5rem;
}

.prose li {
    margin-bottom: 0.25rem;
}
</style>