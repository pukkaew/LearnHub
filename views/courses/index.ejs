

<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Page Header -->
    <div class="rounded-2xl p-6 mb-8 text-white shadow-lg" style="background: linear-gradient(to right, <%= systemSettings.primary_color || '#3b82f6' %>, <%= systemSettings.secondary_color || '#10b981' %>);">
        <div class="flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold text-white"><%= t('coursesTitle') %></h1>
                <p class="text-white/80 mt-1"><%= t('findInterestingCourses') %></p>
            </div>
            <% if (['Admin', 'Instructor'].includes(user.role_name)) { %>
            <a href="/courses/create" class="bg-white/20 hover:bg-white/30 text-white font-medium py-2 px-4 rounded-lg transition-all duration-200 flex items-center">
                <i class="fas fa-plus mr-2"></i><%= t('createCourse') %>
            </a>
            <% } %>
        </div>
    </div>

    <!-- Search and Filters -->
    <div class="bg-white rounded-lg shadow-sm p-6 mb-8">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2"><%= t('search') %></label>
                <input type="text" id="search" placeholder="<%= t('searchPlaceholder') %>"
                       data-testid="course-search"
                       maxlength="200"
                       autocomplete="off"
                       class="form-input-ruxchai">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2"><%= t('category') %></label>
                <select id="category" class="form-select-ruxchai">
                    <option value=""><%= t('allCategories') %></option>
                    <!-- Categories will be loaded here -->
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2"><%= t('difficulty') %></label>
                <select id="difficulty" class="form-select-ruxchai">
                    <option value=""><%= t('allLevels') %></option>
                    <option value="beginner"><%= t('beginner') %></option>
                    <option value="intermediate"><%= t('intermediate') %></option>
                    <option value="advanced"><%= t('advanced') %></option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2"><%= t('status') %></label>
                <select id="status" class="form-select-ruxchai">
                    <option value=""><%= t('allStatuses') %></option>
                    <option value="not_enrolled"><%= t('notEnrolled') %></option>
                    <option value="in_progress"><%= t('inProgress') %></option>
                    <option value="completed"><%= t('completedStatus') %></option>
                </select>
            </div>
        </div>
        <div class="mt-4 flex justify-between items-center">
            <button id="clear-filters" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times mr-1"></i><%= t('clearFilters') %>
            </button>
            <div class="flex items-center space-x-4">
                <!-- View Mode Toggle -->
                <div class="flex-shrink-0 flex items-center border border-gray-300 rounded-md overflow-hidden">
                    <button id="view-list" class="view-mode-btn active px-3 py-1.5 text-sm" title="List View">
                        <i class="fas fa-list"></i>
                    </button>
                    <button id="view-grid" class="view-mode-btn px-3 py-1.5 text-sm" title="Grid View">
                        <i class="fas fa-th-large"></i>
                    </button>
                </div>
                <span class="text-sm text-gray-500"><%= t('sortBy') %>:</span>
                <select id="sort" class="form-select-ruxchai text-sm">
                    <option value="created_at"><%= t('latest') %></option>
                    <option value="title"><%= t('courseTitle') %></option>
                    <option value="popularity"><%= t('popularity') %></option>
                    <option value="rating"><%= t('rating') %></option>
                </select>
            </div>
        </div>
    </div>

    <!-- My Courses Section -->
    <% if (locals.user) { %>
    <div class="mb-8">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-semibold text-gray-900"><%= t('myCourses') %></h2>
            <a href="/courses/my-courses" class="text-ruxchai-primary hover:text-ruxchai-blue-700 text-sm font-medium">
                <%= t('viewAll') %> <i class="fas fa-arrow-right ml-1"></i>
            </a>
        </div>
        <div id="my-courses" class="space-y-4">
            <!-- My courses will be loaded here -->
        </div>
    </div>
    <% } %>

    <!-- Recommended Courses -->
    <div class="mb-8">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-semibold text-gray-900"><%= t('recommendedCourses') %></h2>
        </div>
        <div id="recommended-courses" class="space-y-4">
            <!-- Recommended courses will be loaded here -->
        </div>
    </div>

    <!-- All Courses -->
    <div>
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-semibold text-gray-900"><%= t('allCourses') %></h2>
            <div class="text-sm text-gray-500">
                <%= t('found') %> <span id="total-courses">0</span> <%= t('coursesCount') %>
            </div>
        </div>

        <!-- Course Container (single container - class changes based on view mode) -->
        <div id="all-courses" class="space-y-4">
            <!-- Courses will be loaded here -->
        </div>

        <!-- Load More Button -->
        <div class="text-center mt-8">
            <button id="load-more" class="btn-ruxchai-outline hidden">
                <i class="fas fa-plus mr-2"></i><%= t('loadMore') %>
            </button>
        </div>

        <!-- Pagination -->
        <div id="pagination" class="flex justify-center mt-8">
            <!-- Pagination will be loaded here -->
        </div>
    </div>
</div>

<!-- Loading overlay -->
<div id="loading-overlay" class="fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 flex items-center space-x-3">
        <i class="fas fa-spinner fa-spin text-ruxchai-primary text-xl"></i>
        <span class="text-gray-700"><%= t('loadingCourses') %></span>
    </div>
</div>

<!-- Course Enrollment Modal -->
<div id="enrollment-modal" class="hidden fixed inset-0 z-50 overflow-y-auto">
    <div class="flex items-center justify-center min-h-screen px-4">
        <div class="modal-overlay"></div>
        <div class="modal-content max-w-md w-full p-6">
            <div class="text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 mb-4">
                    <i class="fas fa-graduation-cap text-blue-600"></i>
                </div>
                <h3 class="text-lg font-medium text-gray-900 mb-2" id="enrollment-title"><%= t('enrollmentTitle') %></h3>
                <p class="text-sm text-gray-500 mb-6" id="enrollment-message"><%= t('enrollmentConfirm') %></p>
                <div class="flex space-x-3">
                    <button id="confirm-enrollment" class="flex-1 btn-ruxchai-primary"><%= t('confirm') %></button>
                    <button id="cancel-enrollment" class="flex-1 btn-ruxchai-outline"><%= t('cancel') %></button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let currentPage = 1;
let currentFilters = {};
let selectedCourseId = null;
let viewMode = localStorage.getItem('courseViewMode') || 'list'; // Default to list view

// Get translations from server-side
const translations = <%- JSON.stringify({
    allCategories: t('allCategories'),
    errorLoadingData: t('errorLoadingData'),
    errorLoadingCourses: t('errorLoadingCourses'),
    noRecommendedCourses: t('noRecommendedCourses'),
    noCoursesFound: t('noCoursesFound'),
    clearFilters: t('clearFilters'),
    notEnrolledYet: t('notEnrolledYet'),
    viewRecommended: t('viewRecommended'),
    hours: t('hours'),
    general: t('general'),
    notSpecified: t('notSpecified'),
    progress: t('progress'),
    enrolling: t('enrolling'),
    inProgress: t('inProgress'),
    enterCourse: t('enterCourse'),
    completed: t('completed'),
    retake: t('retake'),
    enroll: t('enroll'),
    beginner: t('beginner'),
    intermediate: t('intermediate'),
    advanced: t('advanced'),
    enrollmentTitle: t('enrollmentTitle'),
    enrollmentConfirm: t('enrollmentConfirm'),
    confirm: t('confirm'),
    cancel: t('cancel'),
    enrollSuccess: t('enrollSuccess'),
    enrollError: t('enrollError'),
    mandatory: t('mandatory'),
    startLearning: t('startLearning')
}) %>;

// Helper function to get translation
function t(key) {
    return translations[key] || key;
}

document.addEventListener('DOMContentLoaded', function() {
    initializeCoursePage();
});

async function initializeCoursePage() {
    try {
        // Initialize view mode from localStorage
        initViewMode();

        // Load initial data
        await Promise.all([
            loadCategories(),
            loadMyCourses(),
            loadRecommendedCourses(),
            loadCourses()
        ]);

        setupEventListeners();
    } catch (error) {
        console.error('Error initializing course page:', error);
        showError(t('errorLoadingData'));
    } finally {
        document.getElementById('loading-overlay').style.display = 'none';
    }
}

function initViewMode() {
    // Set active button based on saved view mode
    document.querySelectorAll('.view-mode-btn').forEach(btn => btn.classList.remove('active'));
    document.getElementById(`view-${viewMode}`).classList.add('active');

    // Set container classes based on view mode
    updateAllContainerClasses();
}

function updateAllContainerClasses() {
    const containers = ['all-courses', 'my-courses', 'recommended-courses'];
    containers.forEach(containerId => {
        const container = document.getElementById(containerId);
        if (container) {
            container.className = viewMode === 'grid'
                ? 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6'
                : 'space-y-4';
        }
    });
}

function setupEventListeners() {
    // Search and filters
    document.getElementById('search').addEventListener('input', debounce(handleFilterChange, 300));
    document.getElementById('category').addEventListener('change', handleFilterChange);
    document.getElementById('difficulty').addEventListener('change', handleFilterChange);
    document.getElementById('status').addEventListener('change', handleFilterChange);
    document.getElementById('sort').addEventListener('change', handleFilterChange);

    // View mode toggle
    document.getElementById('view-list').addEventListener('click', () => setViewMode('list'));
    document.getElementById('view-grid').addEventListener('click', () => setViewMode('grid'));

    // Clear filters
    document.getElementById('clear-filters').addEventListener('click', clearFilters);

    // Load more
    document.getElementById('load-more').addEventListener('click', loadMoreCourses);

    // Modal events
    document.getElementById('confirm-enrollment').addEventListener('click', enrollInCourse);
    document.getElementById('cancel-enrollment').addEventListener('click', closeEnrollmentModal);
}

async function loadCategories() {
    try {
        const response = await fetch('/courses/api/categories');
        const data = await response.json();

        if (data.success) {
            const select = document.getElementById('category');
            select.innerHTML = `<option value="">${t('allCategories')}</option>`;

            data.data.forEach(category => {
                const option = document.createElement('option');
                option.value = category.category_id;
                option.textContent = category.category_name;
                select.appendChild(option);
            });
        }
    } catch (error) {
        console.error('Error loading categories:', error);
    }
}

async function loadMyCourses() {
    try {
        const response = await fetch('/courses/api/my-courses?limit=3');
        const data = await response.json();

        if (data.success) {
            updateMyCourses(data.data);
        }
    } catch (error) {
        console.error('Error loading my courses:', error);
    }
}

async function loadRecommendedCourses() {
    const container = document.getElementById('recommended-courses');
    try {
        const response = await fetch('/courses/api/recommended?limit=4');
        const data = await response.json();

        if (data.success) {
            updateRecommendedCourses(data.data);
        } else {
            // API returned success: false
            container.innerHTML = `
                <div class="col-span-full text-center py-8">
                    <p class="text-gray-500">${t('noRecommendedCourses')}</p>
                </div>
            `;
        }
    } catch (error) {
        console.error('Error loading recommended courses:', error);
        // Show user-friendly error message
        container.innerHTML = `
            <div class="col-span-full text-center py-8">
                <i class="fas fa-exclamation-triangle text-yellow-500 text-2xl mb-2"></i>
                <p class="text-gray-500">${t('errorLoadingRecommendedCourses')}</p>
            </div>
        `;
    }
}

async function loadCourses(page = 1) {
    try {
        const params = new URLSearchParams({
            page: page,
            limit: 12,
            ...currentFilters
        });

        const response = await fetch(`/courses/api/list?${params}`);
        const data = await response.json();

        if (data.success) {
            if (page === 1) {
                updateCourses(data.data);
            } else {
                appendCourses(data.data);
            }
            updatePagination(data.pagination);
            document.getElementById('total-courses').textContent = data.pagination.total;
        }
    } catch (error) {
        console.error('Error loading courses:', error);
        showError(t('errorLoadingCourses'));
    }
}

function updateMyCourses(courses) {
    const container = document.getElementById('my-courses');

    if (!courses || courses.length === 0) {
        container.innerHTML = `
            <div class="col-span-full text-center py-8">
                <i class="fas fa-graduation-cap text-gray-300 text-4xl mb-4"></i>
                <p class="text-gray-500">${t('notEnrolledYet')}</p>
                <a href="#recommended-courses" class="text-ruxchai-primary hover:text-ruxchai-blue-700 mt-2 inline-block">
                    ${t('viewRecommended')}
                </a>
            </div>
        `;
        return;
    }

    // Use appropriate template based on view mode
    if (viewMode === 'grid') {
        container.innerHTML = courses.map(course => createCourseCard(course, true)).join('');
    } else {
        container.innerHTML = courses.map(course => createCourseListItem(course)).join('');
    }
}

function updateRecommendedCourses(courses) {
    const container = document.getElementById('recommended-courses');

    if (!courses || courses.length === 0) {
        container.innerHTML = `
            <div class="col-span-full text-center py-8">
                <p class="text-gray-500">${t('noRecommendedCourses')}</p>
            </div>
        `;
        return;
    }

    // Use appropriate template based on view mode
    if (viewMode === 'grid') {
        container.innerHTML = courses.map(course => createCourseCard(course)).join('');
    } else {
        container.innerHTML = courses.map(course => createCourseListItem(course)).join('');
    }
}

function updateCourses(courses) {
    const container = document.getElementById('all-courses');

    // Set container class based on view mode
    container.className = viewMode === 'grid'
        ? 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6'
        : 'space-y-4';

    if (!courses || courses.length === 0) {
        container.innerHTML = `
            <div class="col-span-full text-center py-12">
                <i class="fas fa-search text-gray-300 text-4xl mb-4"></i>
                <p class="text-gray-500">${t('noCoursesFound')}</p>
                <button onclick="clearFilters()" class="text-ruxchai-primary hover:text-ruxchai-blue-700 mt-2">
                    ${t('clearFilters')}
                </button>
            </div>
        `;
        return;
    }

    // Use appropriate template based on view mode
    container.innerHTML = viewMode === 'grid'
        ? courses.map(course => createCourseCard(course)).join('')
        : courses.map(course => createCourseListItem(course)).join('');
}

function appendCourses(courses) {
    const container = document.getElementById('all-courses');

    // Use appropriate template based on view mode
    if (viewMode === 'grid') {
        container.innerHTML += courses.map(course => createCourseCard(course)).join('');
    } else {
        container.innerHTML += courses.map(course => createCourseListItem(course)).join('');
    }
}

function createCourseCard(course, showProgress = false) {
    const enrollmentStatus = getEnrollmentStatus(course);
    const progressPercentage = course.progress_percentage || 0;

    // Use thumbnail or default course image
    const thumbnailUrl = course.thumbnail || '/images/course-default.svg';

    return `
        <div class="bg-white rounded-lg shadow-sm hover:shadow-md transition-shadow duration-200 ruxchai-card">
            <div class="relative">
                <img src="${thumbnailUrl}"
                     alt="${course.title || 'Course'}"
                     class="w-full h-48 object-cover rounded-t-lg"
                     onerror="this.src='/images/course-default.svg'">
                <div class="absolute top-3 left-3 flex flex-col gap-1">
                    <span class="badge-${getDifficultyColor(course.difficulty_level)}">
                        ${getDifficultyText(course.difficulty_level)}
                    </span>
                    ${course.course_type === 'mandatory' ? `
                        <span class="px-2 py-1 text-xs font-semibold bg-red-600 text-white rounded-full">
                            <i class="fas fa-exclamation-circle mr-1"></i>${t('mandatory')}
                        </span>
                    ` : ''}
                </div>
                <div class="absolute top-3 right-3">
                    ${enrollmentStatus.badge}
                </div>
            </div>

            <div class="p-6">
                <div class="flex items-center text-sm text-gray-500 mb-2">
                    <i class="fas fa-folder mr-1"></i>
                    <span>${course.category_name || t('general')}</span>
                    <span class="mx-2">•</span>
                    <i class="fas fa-clock mr-1"></i>
                    <span>${course.duration_hours || 0} ${t('hours')}</span>
                </div>

                <h3 class="font-semibold text-gray-900 mb-2 line-clamp-2">
                    <a href="/courses/${course.course_id}" class="hover:text-ruxchai-primary">
                        ${course.title}
                    </a>
                </h3>

                <p class="text-gray-600 text-sm mb-4 line-clamp-2">
                    ${course.description || ''}
                </p>

                ${showProgress && progressPercentage > 0 ? `
                    <div class="mb-4">
                        <div class="flex justify-between text-sm text-gray-600 mb-1">
                            <span>${t('progress')}</span>
                            <span>${progressPercentage}%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progressPercentage}%"></div>
                        </div>
                    </div>
                ` : ''}

                <div class="flex items-center justify-between">
                    <div class="flex items-center text-sm text-gray-500">
                        <i class="fas fa-user mr-1"></i>
                        <span>${course.instructor_name || t('notSpecified')}</span>
                    </div>

                    <div class="flex items-center space-x-2">
                        ${course.rating ? `
                            <div class="flex items-center text-yellow-400">
                                <i class="fas fa-star text-xs"></i>
                                <span class="text-sm text-gray-600 ml-1">${course.rating}</span>
                            </div>
                        ` : ''}

                        ${enrollmentStatus.button}
                    </div>
                </div>
            </div>
        </div>
    `;
}

function createCourseListItem(course) {
    const enrollmentStatus = getEnrollmentStatus(course);
    const progressPercentage = course.progress_percentage || 0;

    // Use thumbnail or default course image
    const thumbnailUrl = course.thumbnail || '/images/course-default.svg';

    return `
        <div class="bg-white rounded-lg shadow-sm p-6 ruxchai-card">
            <div class="flex space-x-6">
                <div class="flex-shrink-0">
                    <img src="${thumbnailUrl}"
                         alt="${course.title || 'Course'}"
                         class="w-24 h-24 object-cover rounded-lg"
                         onerror="this.src='/images/course-default.svg'">
                </div>

                <div class="flex-1 min-w-0">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <h3 class="text-lg font-semibold text-gray-900 mb-2">
                                <a href="/courses/${course.course_id}" class="hover:text-ruxchai-primary">
                                    ${course.title}
                                </a>
                            </h3>

                            <p class="text-gray-600 mb-3 line-clamp-2">
                                ${course.description || ''}
                            </p>

                            <div class="flex items-center space-x-4 text-sm text-gray-500 mb-3">
                                <span><i class="fas fa-folder mr-1"></i>${course.category_name || t('general')}</span>
                                <span><i class="fas fa-clock mr-1"></i>${course.duration_hours || 0} ${t('hours')}</span>
                                <span><i class="fas fa-user mr-1"></i>${course.instructor_name || t('notSpecified')}</span>
                                ${course.rating ? `<span><i class="fas fa-star text-yellow-400 mr-1"></i>${course.rating}</span>` : ''}
                            </div>

                            ${progressPercentage > 0 ? `
                                <div class="mb-3">
                                    <div class="flex justify-between text-sm text-gray-600 mb-1">
                                        <span>${t('progress')}</span>
                                        <span>${progressPercentage}%</span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: ${progressPercentage}%"></div>
                                    </div>
                                </div>
                            ` : ''}
                        </div>

                        <div class="flex flex-col items-end space-y-2">
                            <div class="flex space-x-2">
                                <span class="badge-${getDifficultyColor(course.difficulty_level)}">
                                    ${getDifficultyText(course.difficulty_level)}
                                </span>
                                ${enrollmentStatus.badge}
                            </div>
                            ${enrollmentStatus.button}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function getEnrollmentStatus(course) {
    // ตรวจสอบสถานะการลงทะเบียน
    if (course.enrollment_status === 'active') {
        // ลงทะเบียนแล้วและกำลังเรียนอยู่
        return {
            badge: `<span class="badge-success">${t('inProgress')}</span>`,
            button: `<a href="/courses/${course.course_id}/content" class="btn-ruxchai-primary text-sm">${t('enterCourse')}</a>`
        };
    } else if (course.enrollment_status === 'completed') {
        // เรียนจบแล้ว
        return {
            badge: `<span class="badge-primary">${t('completed')}</span>`,
            button: `<a href="/courses/${course.course_id}/content" class="btn-ruxchai-outline text-sm">${t('retake')}</a>`
        };
    } else if (course.course_type === 'mandatory') {
        // หลักสูตรบังคับ: แสดงปุ่มลงทะเบียน (ระบบจะ auto-enroll เมื่อกดเข้าเรียน)
        return {
            badge: `<span class="px-2 py-1 text-xs font-semibold bg-red-100 text-red-600 rounded-full">${t('mandatory')}</span>`,
            button: `<button onclick="showEnrollmentModal('${course.course_id}')" class="btn-ruxchai-primary text-sm">${t('enroll')}</button>`
        };
    } else {
        // ยังไม่ลงทะเบียน: แสดงปุ่มลงทะเบียน
        return {
            badge: '',
            button: `<button onclick="showEnrollmentModal('${course.course_id}')" class="btn-ruxchai-outline text-sm">${t('enroll')}</button>`
        };
    }
}

function getDifficultyColor(level) {
    if (!level) return 'primary';
    const colors = {
        'beginner': 'success',
        'intermediate': 'warning',
        'advanced': 'danger'
    };
    return colors[level.toLowerCase()] || 'primary';
}

function getDifficultyText(level) {
    if (!level) return t('notSpecified');
    const texts = {
        'beginner': t('beginner'),
        'intermediate': t('intermediate'),
        'advanced': t('advanced')
    };
    return texts[level.toLowerCase()] || t('notSpecified');
}

function handleFilterChange() {
    // Sanitize search input - remove potentially dangerous characters
    let searchValue = document.getElementById('search').value;
    // Strip HTML tags and limit length
    searchValue = searchValue.replace(/<[^>]*>/g, '').trim().substring(0, 200);

    currentFilters = {
        search: searchValue,
        category: document.getElementById('category').value,
        difficulty: document.getElementById('difficulty').value,
        status: document.getElementById('status').value,
        sort: document.getElementById('sort').value
    };

    currentPage = 1;
    loadCourses(1);
}

function clearFilters() {
    document.getElementById('search').value = '';
    document.getElementById('category').value = '';
    document.getElementById('difficulty').value = '';
    document.getElementById('status').value = '';
    document.getElementById('sort').value = 'created_at';

    currentFilters = {};
    currentPage = 1;
    loadCourses(1);
}

function setViewMode(mode) {
    viewMode = mode;
    localStorage.setItem('courseViewMode', mode);

    // Update button states
    document.querySelectorAll('.view-mode-btn').forEach(btn => btn.classList.remove('active'));
    document.getElementById(`view-${mode}`).classList.add('active');

    // Update container classes and reload courses
    updateAllContainerClasses();
    loadMyCourses();
    loadRecommendedCourses();
    loadCourses(1);
}

async function loadMoreCourses() {
    currentPage++;
    await loadCourses(currentPage);
}

function updatePagination(pagination) {
    const loadMoreBtn = document.getElementById('load-more');

    if (pagination.page < pagination.totalPages) {
        loadMoreBtn.classList.remove('hidden');
    } else {
        loadMoreBtn.classList.add('hidden');
    }
}

function showEnrollmentModal(courseId) {
    selectedCourseId = courseId;
    document.getElementById('enrollment-modal').classList.remove('hidden');
}

function closeEnrollmentModal() {
    selectedCourseId = null;
    document.getElementById('enrollment-modal').classList.add('hidden');
}

async function enrollInCourse() {
    if (!selectedCourseId) return;

    try {
        const response = await fetch(`/courses/api/${selectedCourseId}/enroll`, {
            method: 'POST'
        });

        const data = await response.json();

        if (data.success) {
            showSuccess(t('enrollSuccess'));
            closeEnrollmentModal();
            // Reload courses to update status
            loadCourses(currentPage);
            loadMyCourses();
        } else {
            showError(data.message || t('enrollError'));
        }
    } catch (error) {
        console.error('Error enrolling in course:', error);
        showError(t('enrollError'));
    }
}

// Utility functions
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

function showSuccess(message) {
    // Implementation for success message
    const alert = document.createElement('div');
    alert.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 animate-fade-in';
    alert.innerHTML = `<i class="fas fa-check-circle mr-2"></i>${message}`;
    document.body.appendChild(alert);
    setTimeout(() => alert.remove(), 3000);
}

function showError(message) {
    // Implementation for error message
    const alert = document.createElement('div');
    alert.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 animate-fade-in';
    alert.innerHTML = `<i class="fas fa-exclamation-circle mr-2"></i>${message}`;
    document.body.appendChild(alert);
    setTimeout(() => alert.remove(), 3000);
}
</script>

<style>
.line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

/* View Mode Toggle Buttons */
.view-mode-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 36px;
    min-height: 32px;
    background-color: #f9fafb;
    color: #6b7280;
    transition: all 0.2s;
}

.view-mode-btn:hover {
    background-color: #e5e7eb;
    color: #374151;
}

.view-mode-btn.active {
    background-color: #1e40af;
    color: white;
}

.view-mode-btn.active:hover {
    background-color: #1e3a8a;
}

.view-mode-btn i {
    margin-right: 0 !important;
}
</style>