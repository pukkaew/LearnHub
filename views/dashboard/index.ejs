<%
const greeting = (() => {
    const hour = new Date().getHours();
    if (hour < 12) return t('goodMorning') || 'Good Morning';
    if (hour < 17) return t('goodAfternoon') || 'Good Afternoon';
    return t('goodEvening') || 'Good Evening';
})();

const isAdmin = ['Admin', 'HR'].includes(user.role_name);
const isInstructor = user.role_name === 'Instructor';
%>

<style>
/* Base Transitions */
.stat-card { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
.stat-card:hover { transform: translateY(-4px); box-shadow: 0 20px 40px -12px rgba(0,0,0,0.15); }

/* Skeleton Loading */
.skeleton { background: linear-gradient(90deg, #f0f0f0 25%, #e8e8e8 50%, #f0f0f0 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; }
@keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

/* Icon Box & Action Cards */
.icon-box { width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; }
.action-card:hover .action-icon { transform: scale(1.1) rotate(6deg); }
.action-icon { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }

/* Custom Scrollbar */
.custom-scrollbar::-webkit-scrollbar { width: 6px; }
.custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
.custom-scrollbar::-webkit-scrollbar-thumb { background: linear-gradient(to bottom, #e0e0e0, #c0c0c0); border-radius: 10px; }
.custom-scrollbar::-webkit-scrollbar-thumb:hover { background: linear-gradient(to bottom, #d0d0d0, #a0a0a0); }

/* RESPONSIVE STYLES FOR LARGE SCREENS - 16:10 aspect ratio and above */
@media (min-width: 1440px) {
    .stat-card { padding: 1.75rem; border-radius: 1rem; }
    .stat-card p.text-3xl { font-size: 2.25rem; }
    .icon-box { width: 56px; height: 56px; border-radius: 14px; }
    .icon-box svg { width: 1.75rem; height: 1.75rem; }
    .rounded-2xl { border-radius: 1.25rem; }
    .rounded-xl { border-radius: 1rem; }
    .text-2xl { font-size: 1.75rem; }
    .gap-6 { gap: 1.75rem; }
    .p-6 { padding: 1.75rem; }
    .mb-8 { margin-bottom: 2.5rem; }
}

@media (min-width: 1920px) {
    .stat-card { padding: 2rem; border-radius: 1.25rem; }
    .stat-card p.text-3xl { font-size: 2.5rem; }
    .stat-card p.text-sm { font-size: 0.95rem; }
    .stat-card p.text-xs { font-size: 0.85rem; }
    .icon-box { width: 64px; height: 64px; border-radius: 16px; }
    .icon-box svg { width: 2rem; height: 2rem; }
    .rounded-2xl { border-radius: 1.5rem; }
    .rounded-xl { border-radius: 1.25rem; }
    .text-2xl { font-size: 2rem; }
    .text-lg { font-size: 1.25rem; }
    .gap-6 { gap: 2rem; }
    .p-6 { padding: 2rem; }
    .px-4 { padding-left: 1.5rem; padding-right: 1.5rem; }
    .py-8 { padding-top: 2.5rem; padding-bottom: 2.5rem; }
    .mb-8 { margin-bottom: 3rem; }
    .action-card { padding: 1.5rem; }
}

@media (min-width: 2560px) {
    .stat-card { padding: 2.5rem; border-radius: 1.5rem; }
    .stat-card p.text-3xl { font-size: 3rem; }
    .stat-card p.text-sm { font-size: 1rem; }
    .stat-card p.text-xs { font-size: 0.9rem; }
    .icon-box { width: 72px; height: 72px; border-radius: 18px; }
    .icon-box svg { width: 2.25rem; height: 2.25rem; }
    .rounded-2xl { border-radius: 1.75rem; }
    .rounded-xl { border-radius: 1.5rem; }
    .text-2xl { font-size: 2.25rem; }
    .text-lg { font-size: 1.375rem; }
    .text-base { font-size: 1.125rem; }
    .gap-6 { gap: 2.5rem; }
    .p-6 { padding: 2.5rem; }
    .px-4 { padding-left: 2rem; padding-right: 2rem; }
    .py-8 { padding-top: 3rem; padding-bottom: 3rem; }
    .mb-8 { margin-bottom: 3.5rem; }
    .action-card { padding: 2rem; }
}
</style>

<div class="min-h-screen bg-gray-50">
    <% if (isAdmin) { %>
    <!-- ADMIN DASHBOARD -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

        <!-- Header -->
        <div class="rounded-2xl p-6 mb-8 text-white" style="background: linear-gradient(to right, <%= systemSettings.primary_color || '#2563eb' %>, <%= systemSettings.secondary_color || '#0891b2' %>);">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between">
                <div>
                    <p class="text-blue-100 text-sm mb-1 flex items-center gap-2">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M2.166 4.999A11.954 11.954 0 0010 1.944 11.954 11.954 0 0017.834 5c.11.65.166 1.32.166 2.001 0 5.225-3.34 9.67-8 11.317C5.34 16.67 2 12.225 2 7c0-.682.057-1.35.166-2.001zm11.541 3.708a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>
                        <%= greeting %>
                    </p>
                    <h1 class="text-2xl font-bold"><%= user.first_name %> <%= user.last_name %></h1>
                    <p class="text-blue-100 mt-1" id="admin-date"></p>
                </div>
                <div class="mt-4 md:mt-0 flex items-center gap-4">
                    <div class="text-center px-4">
                        <div class="w-14 h-14 bg-white/20 rounded-full flex items-center justify-center mb-1">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M2.166 4.999A11.954 11.954 0 0010 1.944 11.954 11.954 0 0017.834 5c.11.65.166 1.32.166 2.001 0 5.225-3.34 9.67-8 11.317C5.34 16.67 2 12.225 2 7c0-.682.057-1.35.166-2.001zm11.541 3.708a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>
                        </div>
                        <p class="text-xs text-blue-100"><%= user.role_name %></p>
                    </div>
                    <div class="text-center px-4 border-l border-white/20">
                        <div class="w-14 h-14 bg-white/20 rounded-full flex items-center justify-center mb-1">
                            <span class="w-3 h-3 bg-green-400 rounded-full animate-pulse"></span>
                        </div>
                        <p class="text-xs text-blue-100"><%= t('systemOnline') || 'Online' %></p>
                    </div>
                    <button onclick="refreshDashboard()" class="ml-2 flex items-center gap-2 px-4 py-2 bg-white/20 rounded-lg hover:bg-white/30 transition">
                        <svg class="w-4 h-4" id="refresh-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                        <span class="text-sm"><%= t('refresh') || 'Refresh' %></span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- Total Users -->
            <div class="stat-card bg-white rounded-xl border border-gray-200 p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-500 mb-1"><%= t('totalUsers') || 'Total Users' %></p>
                        <p class="text-3xl font-bold text-gray-900" id="stat-users"><span class="skeleton inline-block w-16 h-8 rounded"></span></p>
                        <p class="text-xs text-green-600 mt-2 flex items-center" id="stat-users-new">
                            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"/></svg>
                            <span>+0</span> <span class="ml-1"><%= t('thisWeek') || 'this week' %></span>
                        </p>
                    </div>
                    <div class="icon-box bg-blue-100">
                        <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
                    </div>
                </div>
            </div>

            <!-- Active Courses -->
            <div class="stat-card bg-white rounded-xl border border-gray-200 p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-500 mb-1"><%= t('activeCourses') || 'Active Courses' %></p>
                        <p class="text-3xl font-bold text-gray-900" id="stat-courses"><span class="skeleton inline-block w-12 h-8 rounded"></span></p>
                        <p class="text-xs text-gray-500 mt-2 flex items-center">
                            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/></svg>
                            <%= t('active') || 'Active' %>
                        </p>
                    </div>
                    <div class="icon-box bg-purple-100">
                        <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 14l9-5-9-5-9 5 9 5z"/><path d="M12 14l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055a11.952 11.952 0 00-6.824-2.998 12.078 12.078 0 01.665-6.479L12 14z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14l9-5-9-5-9 5 9 5zm0 0l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055a11.952 11.952 0 00-6.824-2.998 12.078 12.078 0 01.665-6.479L12 14zm-4 6v-7.5l4-2.222"/></svg>
                    </div>
                </div>
            </div>

            <!-- Total Enrollments -->
            <div class="stat-card bg-white rounded-xl border border-gray-200 p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-500 mb-1"><%= t('totalEnrollments') || 'Enrollments' %></p>
                        <p class="text-3xl font-bold text-gray-900" id="stat-enrollments"><span class="skeleton inline-block w-16 h-8 rounded"></span></p>
                        <p class="text-xs text-green-600 mt-2 flex items-center" id="stat-enrollments-new">
                            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"/></svg>
                            <span>+0</span> <span class="ml-1"><%= t('thisMonth') || 'this month' %></span>
                        </p>
                    </div>
                    <div class="icon-box bg-green-100">
                        <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                    </div>
                </div>
            </div>

            <!-- Completion Rate -->
            <div class="stat-card bg-white rounded-xl border border-gray-200 p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-500 mb-1"><%= t('completionRate') || 'Completion Rate' %></p>
                        <p class="text-3xl font-bold text-gray-900" id="stat-completion"><span class="skeleton inline-block w-12 h-8 rounded"></span></p>
                        <div class="mt-2">
                            <div class="w-full h-2 bg-gray-100 rounded-full overflow-hidden">
                                <div class="h-full bg-amber-500 rounded-full transition-all duration-500" id="completion-bar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                    <div class="icon-box bg-amber-100">
                        <svg class="w-6 h-6 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"/></svg>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Left Column (2/3) -->
            <div class="lg:col-span-2 space-y-6">

                <!-- Quick Actions -->
                <div class="bg-white rounded-xl border border-gray-200 p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5 text-amber-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" clip-rule="evenodd"/></svg>
                        <%= t('quickActions') || 'Quick Actions' %>
                    </h2>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <a href="/users/create" class="action-card flex flex-col items-center p-4 bg-blue-50 hover:bg-blue-100 rounded-xl transition">
                            <div class="action-icon w-12 h-12 bg-blue-500 rounded-xl flex items-center justify-center mb-3">
                                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/></svg>
                            </div>
                            <span class="text-sm font-medium text-gray-700"><%= t('addUser') || 'Add User' %></span>
                        </a>
                        <a href="/courses/create" class="action-card flex flex-col items-center p-4 bg-purple-50 hover:bg-purple-100 rounded-xl transition">
                            <div class="action-icon w-12 h-12 rounded-xl flex items-center justify-center mb-3" style="background-color: <%= systemSettings.primary_color || '#8b5cf6' %>;">
                                <svg class="w-6 h-6" fill="none" stroke="#ffffff" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M4.26 10.147a60.436 60.436 0 00-.491 6.347A48.627 48.627 0 0112 20.904a48.627 48.627 0 018.232-4.41 60.46 60.46 0 00-.491-6.347m-15.482 0a50.57 50.57 0 00-2.658-.813A59.905 59.905 0 0112 3.493a59.902 59.902 0 0110.399 5.84c-.896.248-1.783.52-2.658.814m-15.482 0A50.697 50.697 0 0112 13.489a50.702 50.702 0 017.74-3.342M6.75 15a.75.75 0 100-1.5.75.75 0 000 1.5zm0 0v-3.675A55.378 55.378 0 0112 8.443m-7.007 11.55A5.981 5.981 0 006.75 15.75v-1.5"/></svg>
                            </div>
                            <span class="text-sm font-medium text-gray-700"><%= t('createCourse') || 'Create Course' %></span>
                        </a>
                        <a href="/reports" class="action-card flex flex-col items-center p-4 bg-green-50 hover:bg-green-100 rounded-xl transition">
                            <div class="action-icon w-12 h-12 bg-green-500 rounded-xl flex items-center justify-center mb-3">
                                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
                            </div>
                            <span class="text-sm font-medium text-gray-700"><%= t('reports') || 'Reports' %></span>
                        </a>
                        <a href="/settings" class="action-card flex flex-col items-center p-4 bg-gray-100 hover:bg-gray-200 rounded-xl transition">
                            <div class="action-icon w-12 h-12 bg-gray-500 rounded-xl flex items-center justify-center mb-3">
                                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                            </div>
                            <span class="text-sm font-medium text-gray-700"><%= t('settings') || 'Settings' %></span>
                        </a>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="bg-white rounded-xl border border-gray-200">
                    <div class="px-6 py-4 border-b border-gray-100 flex items-center justify-between">
                        <h2 class="text-lg font-semibold text-gray-900 flex items-center gap-2">
                            <svg class="w-5 h-5 text-cyan-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                            <%= t('recentActivity') || 'Recent Activity' %>
                        </h2>
                        <a href="/activity-logs" class="text-sm text-blue-600 hover:underline flex items-center gap-1">
                            <%= t('viewAll') || 'View All' %>
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                        </a>
                    </div>
                    <div class="divide-y divide-gray-50" id="activity-list">
                        <div class="p-6 text-center text-gray-400">
                            <svg class="w-6 h-6 animate-spin mx-auto mb-2" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"/></svg>
                            <%= t('loading') || 'Loading...' %>
                        </div>
                    </div>
                </div>

                <!-- Top Courses -->
                <div class="bg-white rounded-xl border border-gray-200">
                    <div class="px-6 py-4 border-b border-gray-100 flex items-center justify-between">
                        <h2 class="text-lg font-semibold text-gray-900 flex items-center gap-2">
                            <svg class="w-5 h-5 text-amber-500" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>
                            <%= t('topCourses') || 'Top Courses' %>
                        </h2>
                        <a href="/courses" class="text-sm text-blue-600 hover:underline flex items-center gap-1">
                            <%= t('viewAll') || 'View All' %>
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                        </a>
                    </div>
                    <div class="p-4" id="top-courses-list">
                        <div class="text-center text-gray-400 py-4">
                            <svg class="w-6 h-6 animate-spin mx-auto mb-2" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"/></svg>
                            <%= t('loading') || 'Loading...' %>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column (1/3) -->
            <div class="space-y-6">
                <!-- System Status -->
                <div class="bg-white rounded-xl border border-gray-200 p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01"/></svg>
                        <%= t('systemAlerts') || 'System Status' %>
                    </h2>
                    <div class="flex items-center justify-center py-6">
                        <div class="text-center">
                            <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                <svg class="w-8 h-8 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                            </div>
                            <p class="text-sm font-medium text-gray-700"><%= t('noAlerts') || 'All systems operational' %></p>
                            <p class="text-xs text-gray-400 mt-1"><%= t('noAlertsDesc') || 'No alerts at this time' %></p>
                        </div>
                    </div>
                </div>

                <!-- New Users -->
                <div class="bg-white rounded-xl border border-gray-200">
                    <div class="px-6 py-4 border-b border-gray-100 flex items-center justify-between">
                        <h2 class="text-lg font-semibold text-gray-900 flex items-center gap-2">
                            <svg class="w-5 h-5 text-violet-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/></svg>
                            <%= t('recentRegistrations') || 'New Users' %>
                        </h2>
                        <a href="/users" class="text-sm text-blue-600 hover:underline flex items-center gap-1">
                            <%= t('viewAll') || 'View All' %>
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                        </a>
                    </div>
                    <div class="divide-y divide-gray-50" id="new-users-list">
                        <div class="p-6 text-center text-gray-400">
                            <svg class="w-6 h-6 animate-spin mx-auto mb-2" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"/></svg>
                            <%= t('loading') || 'Loading...' %>
                        </div>
                    </div>
                </div>

                <!-- Notifications -->
                <div class="bg-white rounded-xl border border-gray-200">
                    <div class="px-6 py-4 border-b border-gray-100 flex items-center justify-between">
                        <h2 class="text-lg font-semibold text-gray-900 flex items-center gap-2">
                            <svg class="w-5 h-5 text-pink-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/></svg>
                            <%= t('notifications') || 'Notifications' %>
                            <span class="hidden px-2 py-0.5 bg-red-500 text-white text-xs rounded-full" id="notif-badge">0</span>
                        </h2>
                        <button onclick="markAllRead()" class="text-xs text-gray-500 hover:text-blue-600"><%= t('markAllRead') || 'Mark all read' %></button>
                    </div>
                    <div class="divide-y divide-gray-50 max-h-64 overflow-y-auto" id="notifications-list">
                        <div class="p-6 text-center text-gray-400">
                            <svg class="w-6 h-6 animate-spin mx-auto mb-2" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"/></svg>
                            <%= t('loading') || 'Loading...' %>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <% } else { %>
    <!-- USER DASHBOARD -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

        <!-- Header -->
        <div class="rounded-2xl p-6 mb-8 text-white" style="background: linear-gradient(to right, <%= systemSettings.primary_color || '#2563eb' %>, <%= systemSettings.secondary_color || '#0891b2' %>);">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between">
                <div>
                    <p class="text-blue-100 text-sm mb-1 flex items-center gap-2">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" clip-rule="evenodd"/></svg>
                        <%= greeting %>
                    </p>
                    <h1 class="text-2xl font-bold"><%= user.first_name %> <%= user.last_name %></h1>
                    <p class="text-blue-100 mt-1" id="user-date"></p>
                </div>
                <div class="mt-4 md:mt-0 flex items-center gap-4">
                    <div class="text-center px-4">
                        <div class="w-14 h-14 bg-white/20 rounded-full flex items-center justify-center mb-1">
                            <span class="text-xl font-bold" id="user-level">1</span>
                        </div>
                        <p class="text-xs text-blue-100"><%= t('level') || 'Level' %></p>
                    </div>
                    <div class="text-center px-4 border-l border-white/20">
                        <div class="w-14 h-14 bg-white/20 rounded-full flex items-center justify-center mb-1">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>
                        </div>
                        <p class="text-xs text-blue-100"><span id="user-points">0</span> <%= t('pts') || 'pts' %></p>
                    </div>
                    <button onclick="refreshDashboard()" class="ml-2 flex items-center gap-2 px-4 py-2 bg-white/20 rounded-lg hover:bg-white/30 transition">
                        <svg class="w-4 h-4" id="refresh-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                        <span class="text-sm"><%= t('refresh') || 'Refresh' %></span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- Enrolled Courses -->
            <div class="stat-card bg-white rounded-xl border border-gray-200 p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-500 mb-1"><%= t('enrolledCourses') || 'Enrolled Courses' %></p>
                        <p class="text-3xl font-bold text-gray-900" id="user-enrolled"><span class="skeleton inline-block w-12 h-8 rounded"></span></p>
                        <p class="text-xs text-blue-600 mt-2 flex items-center">
                            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg>
                            <span id="user-in-progress-count">0</span> <span class="ml-1"><%= t('inProgress') || 'in progress' %></span>
                        </p>
                    </div>
                    <div class="icon-box bg-purple-100">
                        <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/></svg>
                    </div>
                </div>
            </div>

            <!-- Completed Courses -->
            <div class="stat-card bg-white rounded-xl border border-gray-200 p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-500 mb-1"><%= t('completedCourses') || 'Completed' %></p>
                        <p class="text-3xl font-bold text-gray-900" id="user-completed"><span class="skeleton inline-block w-12 h-8 rounded"></span></p>
                        <p class="text-xs text-green-600 mt-2 flex items-center">
                            <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>
                            <span id="user-certificates">0</span> <span class="ml-1"><%= t('certificates') || 'certificates' %></span>
                        </p>
                    </div>
                    <div class="icon-box bg-green-100">
                        <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                    </div>
                </div>
            </div>

            <!-- Tests Taken -->
            <div class="stat-card bg-white rounded-xl border border-gray-200 p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-500 mb-1"><%= t('testsTaken') || 'Tests Taken' %></p>
                        <p class="text-3xl font-bold text-gray-900" id="user-tests"><span class="skeleton inline-block w-12 h-8 rounded"></span></p>
                        <p class="text-xs text-blue-600 mt-2 flex items-center">
                            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
                            <span><%= t('avgScore') || 'Avg' %> <span id="user-avg-score">0</span>%</span>
                        </p>
                    </div>
                    <div class="icon-box bg-blue-100">
                        <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/></svg>
                    </div>
                </div>
            </div>

            <!-- Learning Time -->
            <div class="stat-card bg-white rounded-xl border border-gray-200 p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-500 mb-1"><%= t('learningTime') || 'Learning Time' %></p>
                        <p class="text-3xl font-bold text-gray-900"><span id="user-learning-time">0</span> <span class="text-lg text-gray-500"><%= t('hrs') || 'hrs' %></span></p>
                        <div class="mt-2">
                            <div class="w-full h-2 bg-gray-100 rounded-full overflow-hidden">
                                <div class="h-full bg-amber-500 rounded-full transition-all duration-500" id="learning-progress-bar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                    <div class="icon-box bg-amber-100">
                        <svg class="w-6 h-6 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Left Column (2/3) -->
            <div class="lg:col-span-2 space-y-6">

                <!-- Quick Actions -->
                <div class="bg-white rounded-xl border border-gray-200 p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5 text-amber-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" clip-rule="evenodd"/></svg>
                        <%= t('quickActions') || 'Quick Actions' %>
                    </h2>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <a href="/courses" class="action-card flex flex-col items-center p-4 bg-blue-50 hover:bg-blue-100 rounded-xl transition">
                            <div class="action-icon w-12 h-12 bg-blue-500 rounded-xl flex items-center justify-center mb-3">
                                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                            </div>
                            <span class="text-sm font-medium text-gray-700"><%= t('browseCourses') || 'Browse Courses' %></span>
                        </a>
                        <a href="/courses/my" class="action-card flex flex-col items-center p-4 bg-purple-50 hover:bg-purple-100 rounded-xl transition">
                            <div class="action-icon w-12 h-12 rounded-xl flex items-center justify-center mb-3" style="background-color: <%= systemSettings.primary_color || '#8b5cf6' %>;">
                                <svg class="w-6 h-6" fill="none" stroke="#ffffff" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/></svg>
                            </div>
                            <span class="text-sm font-medium text-gray-700"><%= t('myCourses') || 'My Courses' %></span>
                        </a>
                        <a href="/certificates" class="action-card flex flex-col items-center p-4 bg-green-50 hover:bg-green-100 rounded-xl transition">
                            <div class="action-icon w-12 h-12 bg-green-500 rounded-xl flex items-center justify-center mb-3">
                                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"/></svg>
                            </div>
                            <span class="text-sm font-medium text-gray-700"><%= t('certificates') || 'Certificates' %></span>
                        </a>
                        <a href="/users/profile" class="action-card flex flex-col items-center p-4 bg-gray-100 hover:bg-gray-200 rounded-xl transition">
                            <div class="action-icon w-12 h-12 bg-gray-500 rounded-xl flex items-center justify-center mb-3">
                                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
                            </div>
                            <span class="text-sm font-medium text-gray-700"><%= t('myProfile') || 'My Profile' %></span>
                        </a>
                    </div>
                </div>

                <!-- Continue Learning -->
                <div class="bg-white rounded-xl border border-gray-200">
                    <div class="px-6 py-4 border-b border-gray-100 flex items-center justify-between">
                        <h2 class="text-lg font-semibold text-gray-900 flex items-center gap-2">
                            <svg class="w-5 h-5 text-blue-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"/></svg>
                            <%= t('continueLearning') || 'Continue Learning' %>
                        </h2>
                        <a href="/courses/my" class="text-sm text-blue-600 hover:underline flex items-center gap-1">
                            <%= t('viewAll') || 'View All' %>
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                        </a>
                    </div>
                    <div id="continue-learning">
                        <div class="text-center text-gray-400 py-6">
                            <svg class="w-6 h-6 animate-spin mx-auto mb-2" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"/></svg>
                            <%= t('loading') || 'Loading...' %>
                        </div>
                    </div>
                </div>

                <!-- Learning Progress -->
                <div class="bg-white rounded-xl border border-gray-200">
                    <div class="px-6 py-4 border-b border-gray-100">
                        <h2 class="text-lg font-semibold text-gray-900 flex items-center gap-2">
                            <svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg>
                            <%= t('learningProgress') || 'Learning Progress' %>
                        </h2>
                    </div>
                    <div class="p-4" id="learning-progress">
                        <div class="text-center text-gray-400 py-4">
                            <svg class="w-6 h-6 animate-spin mx-auto mb-2" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"/></svg>
                            <%= t('loading') || 'Loading...' %>
                        </div>
                    </div>
                </div>

                <!-- Recent Articles -->
                <div class="bg-white rounded-xl border border-gray-200">
                    <div class="px-6 py-4 border-b border-gray-100 flex items-center justify-between">
                        <h2 class="text-lg font-semibold text-gray-900 flex items-center gap-2">
                            <svg class="w-5 h-5 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"/></svg>
                            <%= t('recentArticles') || 'Recent Articles' %>
                        </h2>
                        <a href="/articles" class="text-sm text-blue-600 hover:underline flex items-center gap-1">
                            <%= t('viewAll') || 'View All' %>
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                        </a>
                    </div>
                    <div id="recent-articles">
                        <div class="text-center text-gray-400 py-6">
                            <svg class="w-6 h-6 animate-spin mx-auto mb-2" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"/></svg>
                            <%= t('loading') || 'Loading...' %>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column (1/3) -->
            <div class="space-y-6">
                <!-- My Badges -->
                <div class="bg-white rounded-xl border border-gray-200">
                    <div class="px-6 py-4 border-b border-gray-100">
                        <h2 class="text-lg font-semibold text-gray-900 flex items-center gap-2">
                            <svg class="w-5 h-5 text-amber-500" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>
                            <%= t('myBadges') || 'My Badges' %>
                        </h2>
                    </div>
                    <div class="p-4" id="my-badges">
                        <div class="text-center text-gray-400 py-4">
                            <svg class="w-6 h-6 animate-spin mx-auto mb-2" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"/></svg>
                            <%= t('loading') || 'Loading...' %>
                        </div>
                    </div>
                </div>

                <!-- Notifications -->
                <div class="bg-white rounded-xl border border-gray-200">
                    <div class="px-6 py-4 border-b border-gray-100 flex items-center justify-between">
                        <h2 class="text-lg font-semibold text-gray-900 flex items-center gap-2">
                            <svg class="w-5 h-5 text-pink-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/></svg>
                            <%= t('notifications') || 'Notifications' %>
                            <span class="hidden px-2 py-0.5 bg-red-500 text-white text-xs rounded-full" id="notif-badge-user">0</span>
                        </h2>
                    </div>
                    <div class="divide-y divide-gray-50 max-h-64 overflow-y-auto" id="user-notifications">
                        <div class="p-6 text-center text-gray-400">
                            <svg class="w-6 h-6 animate-spin mx-auto mb-2" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"/></svg>
                            <%= t('loading') || 'Loading...' %>
                        </div>
                    </div>
                </div>

                <!-- Leaderboard -->
                <div class="bg-white rounded-xl border border-gray-200">
                    <div class="px-6 py-4 border-b border-gray-100 flex items-center justify-between">
                        <h2 class="text-lg font-semibold text-gray-900 flex items-center gap-2">
                            <svg class="w-5 h-5 text-orange-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5 2a2 2 0 00-2 2v14l3.5-2 3.5 2 3.5-2 3.5 2V4a2 2 0 00-2-2H5zm2.5 3a1.5 1.5 0 100 3 1.5 1.5 0 000-3zm6.207.293a1 1 0 00-1.414 0l-6 6a1 1 0 101.414 1.414l6-6a1 1 0 000-1.414zM12.5 10a1.5 1.5 0 100 3 1.5 1.5 0 000-3z" clip-rule="evenodd"/></svg>
                            <%= t('leaderboard') || 'Leaderboard' %>
                        </h2>
                        <a href="/leaderboard" class="text-sm text-blue-600 hover:underline flex items-center gap-1">
                            <%= t('viewAll') || 'View All' %>
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                        </a>
                    </div>
                    <div class="p-4" id="leaderboard">
                        <div class="text-center text-gray-400 py-4">
                            <svg class="w-6 h-6 animate-spin mx-auto mb-2" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"/></svg>
                            <%= t('loading') || 'Loading...' %>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <% } %>
</div>

<script>
const T = {
    noCourses: '<%= t("noCourses") || "No courses enrolled yet" %>',
    noProgress: '<%= t("noProgress") || "No progress yet" %>',
    noArticles: '<%= t("noArticles") || "No articles available" %>',
    noNotifications: '<%= t("noNotifications") || "No notifications" %>',
    noBadges: '<%= t("noBadges") || "No badges earned yet" %>',
    noActivity: '<%= t("noActivity") || "No recent activity" %>',
    noUsers: '<%= t("noRecentUsers") || "No recent registrations" %>',
    noTopCourses: '<%= t("noCourses") || "No courses available" %>',
    continue: '<%= t("continue") || "Continue" %>',
    start: '<%= t("start") || "Start" %>',
    justNow: '<%= t("justNow") || "Just now" %>',
    minutesAgo: '<%= t("minutesAgo") || "min ago" %>',
    hoursAgo: '<%= t("hoursAgo") || "hr ago" %>',
    daysAgo: '<%= t("daysAgo") || "days ago" %>',
    enrollments: '<%= t("totalEnrolled") || "enrollments" %>',
    browse: '<%= t("browseCourses") || "Browse Courses" %>',
    today: '<%= t("today") || "Today" %>',
    yesterday: '<%= t("yesterday") || "Yesterday" %>',
    weeksAgo: '<%= t("weeksAgo") || "weeks ago" %>',
    viewAllArticles: '<%= t("viewAllArticles") || "View All Articles" %>',
    notEnrolledYet: '<%= t("notEnrolledYet") || "Not enrolled in any course yet" %>',
    chooseInterestingCourse: '<%= t("chooseInterestingCourse") || "Choose an interesting course to start learning" %>',
    by: '<%= t("by") || "by" %>',
    enrollToTrackProgress: '<%= t("enrollToTrackProgress") || "Enroll in a course to track your progress" %>',
    startLearningCourse: '<%= t("startLearningCourse") || "Start Learning" %>',
    statusCompleted: '<%= t("statusCompleted") || "Completed" %>',
    statusInProgress: '<%= t("statusInProgress") || "In Progress" %>',
    statusStarted: '<%= t("statusStarted") || "Started" %>',
    statusNotStarted: '<%= t("statusNotStarted") || "Not Started" %>',
    unknown: '<%= t("unknown") || "Unknown" %>',
    untitled: '<%= t("untitled") || "Untitled" %>',
    badge: '<%= t("badge") || "Badge" %>',
    user: '<%= t("user") || "User" %>',
    views: '<%= t("views") || "views" %>',
    noData: '<%= t("noData") || "No data" %>'
};
const lang = '<%= language %>';
const isAdmin = <%= isAdmin %>;

function timeAgo(date) {
    if (!date) return '';
    const diff = Math.floor((Date.now() - new Date(date)) / 1000);
    if (diff < 60) return T.justNow;
    if (diff < 3600) return Math.floor(diff / 60) + ' ' + T.minutesAgo;
    if (diff < 86400) return Math.floor(diff / 3600) + ' ' + T.hoursAgo;
    return Math.floor(diff / 86400) + ' ' + T.daysAgo;
}

function updateDateTime() {
    const now = new Date();
    const opts = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    const dateStr = now.toLocaleDateString(lang === 'th' ? 'th-TH' : 'en-US', opts);
    const el1 = document.getElementById('current-datetime');
    const el2 = document.getElementById('user-date');
    const el3 = document.getElementById('admin-date');
    if (el1) el1.textContent = dateStr;
    if (el2) el2.textContent = dateStr;
    if (el3) el3.textContent = dateStr;
}

document.addEventListener('DOMContentLoaded', () => {
    updateDateTime();
    isAdmin ? loadAdminDashboard() : loadUserDashboard();
});

function refreshDashboard() {
    const icon = document.getElementById('refresh-icon');
    if (icon) icon.classList.add('animate-spin');
    (isAdmin ? loadAdminDashboard() : loadUserDashboard()).then(() => {
        setTimeout(() => icon?.classList.remove('animate-spin'), 500);
    });
}

// ========== ADMIN ==========
async function loadAdminDashboard() {
    await Promise.all([loadAdminStats(), loadActivity(), loadTopCourses(), loadNewUsers(), loadNotifications('notifications-list', 'notif-badge')]);
}

async function loadAdminStats() {
    try {
        const res = await fetch('/dashboard/api/stats');
        const data = await res.json();
        if (data.success) {
            const d = data.data;
            animateValue('stat-users', d.active_users || 0);
            animateValue('stat-courses', d.active_courses || 0);
            animateValue('stat-enrollments', d.active_enrollments || 0);
            animateValue('stat-completion', d.completion_rate || 0, '%');
            setTimeout(() => { const bar = document.getElementById('completion-bar'); if (bar) bar.style.width = (d.completion_rate || 0) + '%'; }, 300);
        }
    } catch (e) { console.error('Stats error:', e); }
}

async function loadActivity() {
    try {
        const res = await fetch('/dashboard/api/activities?limit=5');
        const data = await res.json();
        const el = document.getElementById('activity-list');
        if (!data.success || !data.data?.length) {
            el.innerHTML = `<div class="p-6 text-center text-gray-400"><svg class="w-8 h-8 mx-auto mb-2 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"/></svg><p>${T.noActivity}</p></div>`;
            return;
        }
        el.innerHTML = data.data.map(a => `
            <div class="px-6 py-3 hover:bg-gray-50 flex items-center gap-3">
                <div class="w-8 h-8 bg-gray-100 rounded-lg flex items-center justify-center">
                    <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                </div>
                <div class="flex-1 min-w-0">
                    <p class="text-sm text-gray-700 truncate">${a.description || a.action}</p>
                    <p class="text-xs text-gray-400">${timeAgo(a.created_at)}</p>
                </div>
            </div>
        `).join('');
    } catch (e) { console.error('Activity error:', e); }
}

async function loadTopCourses() {
    try {
        const res = await fetch('/dashboard/api/top-courses');
        const data = await res.json();
        const el = document.getElementById('top-courses-list');
        if (!data.success || !data.data?.length) {
            el.innerHTML = `<div class="text-center text-gray-400 py-6"><svg class="w-8 h-8 mx-auto mb-2 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/></svg><p>${T.noTopCourses}</p></div>`;
            return;
        }
        el.innerHTML = data.data.slice(0, 5).map((c, i) => `
            <a href="/courses/${c.course_id}" class="flex items-center gap-3 p-3 hover:bg-gray-50 rounded-lg transition">
                <div class="w-8 h-8 ${i === 0 ? 'bg-amber-100 text-amber-600' : i === 1 ? 'bg-gray-100 text-gray-600' : i === 2 ? 'bg-orange-100 text-orange-600' : 'bg-blue-50 text-blue-600'} rounded-lg flex items-center justify-center font-bold text-sm">${i + 1}</div>
                <div class="flex-1 min-w-0">
                    <p class="text-sm font-medium text-gray-900 truncate">${c.title}</p>
                    <p class="text-xs text-gray-500">${c.enrollments || 0} ${T.enrollments}</p>
                </div>
                <span class="text-xs font-medium ${c.completion_rate >= 80 ? 'text-green-600' : c.completion_rate >= 50 ? 'text-amber-600' : 'text-gray-500'}">${c.completion_rate || 0}%</span>
            </a>
        `).join('');
    } catch (e) { console.error('Top courses error:', e); }
}

async function loadNewUsers() {
    try {
        const res = await fetch('/dashboard/api/recent-registrations');
        const data = await res.json();
        const el = document.getElementById('new-users-list');
        if (!data.success || !data.data?.length) {
            el.innerHTML = `<div class="p-6 text-center text-gray-400"><svg class="w-8 h-8 mx-auto mb-2 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/></svg><p>${T.noUsers}</p></div>`;
            return;
        }
        el.innerHTML = data.data.slice(0, 5).map(u => `
            <a href="/users/${u.user_id}" class="block px-4 py-3 hover:bg-gray-50">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-full flex items-center justify-center text-white font-medium">
                        ${u.profile_image ? `<img src="${u.profile_image}" class="w-full h-full rounded-full object-cover">` : (u.name?.charAt(0).toUpperCase() || 'U')}
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-medium text-gray-900 truncate">${u.name || T.unknown}</p>
                        <p class="text-xs text-gray-500">${u.role_name || ''} &bull; ${timeAgo(u.registered)}</p>
                    </div>
                </div>
            </a>
        `).join('');
    } catch (e) { console.error('New users error:', e); }
}

// ========== USER ==========
async function loadUserDashboard() {
    await Promise.all([loadUserStats(), loadContinueLearning(), loadLearningProgress(), loadRecentArticles(), loadBadges(), loadNotifications('user-notifications', 'notif-badge-user'), loadLeaderboard()]);
}

async function loadUserStats() {
    try {
        const res = await fetch('/dashboard/api/stats');
        const data = await res.json();
        if (data.success) {
            const d = data.data;
            // Header stats
            animateValue('user-level', d.user_level || 1);
            animateValue('user-points', d.total_points || 0);
            // Card stats -  Admin 4 
            animateValue('user-enrolled', d.enrolled_courses || 0);
            animateValue('user-completed', d.completed_courses || 0);
            animateValue('user-tests', d.total_tests || 0);
            animateValue('user-avg-score', d.avg_test_score || 0);
            animateValue('user-certificates', d.certificates_earned || 0);
            // In progress count
            const inProgressEl = document.getElementById('user-in-progress-count');
            if (inProgressEl) inProgressEl.textContent = d.enrolled_courses || 0;
            // Convert seconds to hours
            const learningHours = Math.round((d.total_learning_time || 0) / 3600 * 10) / 10;
            const learningTimeEl = document.getElementById('user-learning-time');
            if (learningTimeEl) learningTimeEl.textContent = learningHours;
            // Learning progress bar (assume 100 hours = 100%)
            const progressBar = document.getElementById('learning-progress-bar');
            if (progressBar) {
                const progressPercent = Math.min(learningHours, 100);
                setTimeout(() => { progressBar.style.width = progressPercent + '%'; }, 300);
            }
        }
    } catch (e) { console.error('User stats error:', e); }
}

async function loadContinueLearning() {
    try {
        const res = await fetch('/dashboard/api/recent-courses');
        const data = await res.json();
        const el = document.getElementById('continue-learning');
        if (!data.success || !data.data?.length) {
            // Show recommended courses instead
            loadRecommendedCourses(el);
            return;
        }
        el.innerHTML = `<div class="divide-y divide-gray-50">${data.data.slice(0, 3).map(c => `
            <a href="/courses/${c.course_id}/content" class="flex items-center gap-4 p-4 hover:bg-gray-50 transition">
                <div class="w-16 h-12 rounded-lg overflow-hidden flex-shrink-0 bg-blue-100">
                    ${c.thumbnail ? `<img src="${c.thumbnail}" class="w-full h-full object-cover">` : `
                    <div class="w-full h-full flex items-center justify-center">
                        <svg class="w-6 h-6 text-blue-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"/></svg>
                    </div>`}
                </div>
                <div class="flex-1 min-w-0">
                    <p class="text-sm font-medium text-gray-900 truncate">${c.title || T.untitled}</p>
                    <div class="flex items-center gap-2 mt-1">
                        <div class="flex-1 h-1.5 bg-gray-100 rounded-full overflow-hidden">
                            <div class="h-full ${c.progress_percentage >= 80 ? 'bg-green-500' : c.progress_percentage >= 50 ? 'bg-blue-500' : 'bg-amber-500'} rounded-full" style="width: ${c.progress_percentage || 0}%"></div>
                        </div>
                        <span class="text-xs font-medium ${c.progress_percentage >= 80 ? 'text-green-600' : c.progress_percentage >= 50 ? 'text-blue-600' : 'text-amber-600'}">${c.progress_percentage || 0}%</span>
                    </div>
                </div>
                <svg class="w-5 h-5 text-gray-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
            </a>
        `).join('')}</div>`;
    } catch (e) { console.error('Continue learning error:', e); }
}

async function loadRecommendedCourses(container) {
    try {
        const res = await fetch('/courses/api/list?limit=3&status=active');
        const data = await res.json();
        if (!data.success || !data.data?.length) {
            container.innerHTML = `<div class="text-center py-6">
                <svg class="w-10 h-10 mx-auto mb-2 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/></svg>
                <p class="text-sm text-gray-500 mb-3">${T.noCourses}</p>
                <a href="/courses" class="inline-flex items-center gap-2 px-4 py-2 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700 transition">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>${T.browse}
                </a>
            </div>`;
            return;
        }
        container.innerHTML = `
            <div class="bg-blue-50 rounded-lg p-3 mb-3">
                <p class="text-sm text-blue-800 font-medium">${T.notEnrolledYet}</p>
                <p class="text-xs text-blue-600 mt-0.5">${T.chooseInterestingCourse}</p>
            </div>
            <div class="divide-y divide-gray-50">${data.data.slice(0, 3).map(c => `
                <a href="/courses/${c.course_id}" class="flex items-center gap-4 p-4 hover:bg-gray-50 transition">
                    <div class="w-16 h-12 rounded-lg overflow-hidden flex-shrink-0 bg-purple-100">
                        ${c.thumbnail ? `<img src="${c.thumbnail}" class="w-full h-full object-cover">` : `
                        <div class="w-full h-full flex items-center justify-center">
                            <svg class="w-6 h-6 text-purple-500" fill="currentColor" viewBox="0 0 20 20"><path d="M10.394 2.08a1 1 0 00-.788 0l-7 3a1 1 0 000 1.84L5.25 8.051a.999.999 0 01.356-.257l4-1.714a1 1 0 11.788 1.838L7.667 9.088l1.94.831a1 1 0 00.787 0l7-3a1 1 0 000-1.838l-7-3zM3.31 9.397L5 10.12v4.102a8.969 8.969 0 00-1.05-.174 1 1 0 01-.89-.89 11.115 11.115 0 01.25-3.762z"/></svg>
                        </div>`}
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-medium text-gray-900 truncate">${c.title || T.untitled}</p>
                        <p class="text-xs text-gray-500 mt-0.5">${c.instructor_name ? T.by + ' ' + c.instructor_name : ''}</p>
                    </div>
                    <svg class="w-5 h-5 text-gray-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                </a>
            `).join('')}</div>`;
    } catch (e) {
        console.error('Recommended courses error:', e);
        container.innerHTML = `<div class="text-center py-6">
            <svg class="w-10 h-10 mx-auto mb-2 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/></svg>
            <p class="text-sm text-gray-500 mb-3">${T.noCourses}</p>
            <a href="/courses" class="inline-flex items-center gap-2 px-4 py-2 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700 transition">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>${T.browse}
            </a>
        </div>`;
    }
}

async function loadLearningProgress() {
    try {
        const res = await fetch('/dashboard/api/progress');
        const data = await res.json();
        const el = document.getElementById('learning-progress');
        if (!data.success || !data.data?.length) {
            el.innerHTML = `<div class="text-center py-6">
                <svg class="w-10 h-10 mx-auto mb-2 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg>
                <p class="text-sm text-gray-500">${T.noProgress}</p>
                <p class="text-xs text-gray-400 mt-1">${T.enrollToTrackProgress}</p>
                <a href="/courses" class="inline-flex items-center gap-2 mt-3 px-4 py-2 bg-green-600 text-white text-sm rounded-lg hover:bg-green-700 transition">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/></svg>
                    ${T.startLearningCourse}
                </a>
            </div>`;
            return;
        }
        const getStatusInfo = (p) => {
            if (p.status === 'completed' || p.progress_percentage >= 100) return { color: 'bg-green-100 text-green-700', text: T.statusCompleted, barColor: 'bg-green-500' };
            if (p.progress_percentage >= 50) return { color: 'bg-blue-100 text-blue-700', text: T.statusInProgress, barColor: 'bg-blue-500' };
            if (p.progress_percentage > 0) return { color: 'bg-amber-100 text-amber-700', text: T.statusStarted, barColor: 'bg-amber-500' };
            return { color: 'bg-gray-100 text-gray-600', text: T.statusNotStarted, barColor: 'bg-gray-400' };
        };
        el.innerHTML = `<div class="divide-y divide-gray-50">${data.data.slice(0, 4).map(p => {
            const status = getStatusInfo(p);
            return `
            <a href="/courses/${p.course_id}/content" class="block p-4 hover:bg-gray-50 transition">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm font-medium text-gray-900 truncate max-w-[60%]">${p.title}</span>
                    <span class="text-xs px-2 py-0.5 rounded-full ${status.color}">${status.text}</span>
                </div>
                <div class="flex items-center gap-3">
                    <div class="flex-1 h-2 bg-gray-100 rounded-full overflow-hidden">
                        <div class="h-full ${status.barColor} rounded-full transition-all" style="width: ${p.progress_percentage}%"></div>
                    </div>
                    <span class="text-sm font-semibold text-gray-700 w-12 text-right">${p.progress_percentage}%</span>
                </div>
            </a>`;
        }).join('')}</div>`;
    } catch (e) { console.error('Progress error:', e); }
}

async function loadRecentArticles() {
    try {
        const res = await fetch('/dashboard/api/recent-articles');
        const data = await res.json();
        const el = document.getElementById('recent-articles');
        if (!data.success || !data.data?.length) {
            el.innerHTML = `<div class="text-center py-6">
                <svg class="w-10 h-10 mx-auto mb-2 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"/></svg>
                <p class="text-sm text-gray-500">${T.noArticles}</p>
                <a href="/articles" class="inline-flex items-center gap-2 mt-3 px-4 py-2 bg-purple-600 text-white text-sm rounded-lg hover:bg-purple-700 transition">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"/></svg>
                    ${T.viewAllArticles}
                </a>
            </div>`;
            return;
        }
        const formatDate = (dateStr) => {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            const now = new Date();
            const diffMs = now - date;
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            if (diffDays === 0) return T.today;
            if (diffDays === 1) return T.yesterday;
            if (diffDays < 7) return diffDays + ' ' + T.daysAgo;
            if (diffDays < 30) return Math.floor(diffDays / 7) + ' ' + T.weeksAgo;
            return date.toLocaleDateString(lang === 'th' ? 'th-TH' : 'en-US', { day: 'numeric', month: 'short' });
        };
        el.innerHTML = `<div class="divide-y divide-gray-100">${data.data.slice(0, 4).map(a => `
            <a href="/articles/${a.article_id}" class="block px-5 py-4 hover:bg-gray-50 transition group">
                <div class="flex items-start gap-5">
                    <div class="w-24 h-16 rounded-xl overflow-hidden flex-shrink-0 bg-gradient-to-br from-purple-100 to-purple-50 shadow-sm">
                        ${a.thumbnail ? `<img src="${a.thumbnail}" class="w-full h-full object-cover group-hover:scale-105 transition duration-300">` : `
                        <div class="w-full h-full flex items-center justify-center">
                            <svg class="w-8 h-8 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"/></svg>
                        </div>`}
                    </div>
                    <div class="flex-1 min-w-0 py-1">
                        <h4 class="text-base font-semibold text-gray-800 line-clamp-2 group-hover:text-purple-600 transition leading-snug">${a.title}</h4>
                        <div class="flex flex-wrap items-center gap-x-4 gap-y-2 mt-3 text-sm text-gray-500">
                            <span class="flex items-center gap-1.5">
                                <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
                                <span>${a.author_name || T.unknown}</span>
                            </span>
                            <span class="flex items-center gap-1.5">
                                <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                                <span>${formatDate(a.published_at)}</span>
                            </span>
                            <span class="flex items-center gap-1.5">
                                <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
                                <span>${(a.view_count || 0).toLocaleString()}</span>
                            </span>
                        </div>
                    </div>
                </div>
            </a>
        `).join('')}</div>`;
    } catch (e) { console.error('Articles error:', e); }
}

async function loadBadges() {
    try {
        const res = await fetch('/dashboard/api/my-badges');
        const data = await res.json();
        const el = document.getElementById('my-badges');
        if (!data.success || !data.data?.length) {
            el.innerHTML = `<div class="text-center py-4"><svg class="w-10 h-10 mx-auto mb-2 text-gray-300" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg><p class="text-sm text-gray-400">${T.noBadges}</p></div>`;
            return;
        }
        const colors = ['bg-amber-500', 'bg-blue-500', 'bg-green-500', 'bg-purple-500', 'bg-pink-500', 'bg-cyan-500'];
        el.innerHTML = `<div class="flex flex-wrap justify-center gap-3">${data.data.slice(0, 6).map((b, i) => `
            <div class="w-12 h-12 ${colors[i % colors.length]} rounded-xl flex items-center justify-center cursor-pointer hover:scale-110 transition" title="${b.name || T.badge}">
                <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>
            </div>
        `).join('')}</div>`;
    } catch (e) { console.error('Badges error:', e); }
}

async function loadLeaderboard() {
    try {
        const res = await fetch('/dashboard/api/leaderboard?limit=5');
        const data = await res.json();
        const el = document.getElementById('leaderboard');
        if (!data.success || !data.data?.length) {
            el.innerHTML = `<div class="text-center text-gray-400 py-4"><svg class="w-8 h-8 mx-auto mb-2 text-gray-300" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5 2a2 2 0 00-2 2v14l3.5-2 3.5 2 3.5-2 3.5 2V4a2 2 0 00-2-2H5z" clip-rule="evenodd"/></svg><p>${T.noData}</p></div>`;
            return;
        }
        el.innerHTML = data.data.map((u, i) => `
            <div class="flex items-center gap-3 py-2 ${i > 0 ? 'border-t border-gray-50' : ''}">
                <div class="w-6 h-6 ${i === 0 ? 'bg-amber-400' : i === 1 ? 'bg-gray-300' : i === 2 ? 'bg-orange-400' : 'bg-gray-100'} rounded-full flex items-center justify-center">
                    <span class="text-xs font-bold ${i < 3 ? 'text-white' : 'text-gray-600'}">${i + 1}</span>
                </div>
                <div class="flex-1 min-w-0">
                    <p class="text-sm font-medium text-gray-900 truncate">${u.firstName || T.user} ${u.lastName?.charAt(0) || ''}.</p>
                </div>
                <span class="text-sm font-semibold text-blue-600">${(u.totalPoints || 0).toLocaleString()}</span>
            </div>
        `).join('');
    } catch (e) { console.error('Leaderboard error:', e); }
}

async function loadNotifications(elId, badgeId) {
    try {
        const res = await fetch('/dashboard/api/notifications?limit=5');
        const data = await res.json();
        const el = document.getElementById(elId);
        const badge = document.getElementById(badgeId);
        if (!data.success || !data.data?.length) {
            el.innerHTML = `<div class="p-6 text-center text-gray-400"><svg class="w-8 h-8 mx-auto mb-2 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/></svg><p>${T.noNotifications}</p></div>`;
            if (badge) badge.classList.add('hidden');
            return;
        }
        const unread = data.data.filter(n => !n.is_read).length;
        if (badge) { if (unread > 0) { badge.textContent = unread > 9 ? '9+' : unread; badge.classList.remove('hidden'); } else { badge.classList.add('hidden'); } }
        el.innerHTML = data.data.map(n => `
            <div class="px-4 py-3 ${!n.is_read ? 'bg-blue-50' : 'hover:bg-gray-50'}">
                <div class="flex items-start gap-3">
                    <div class="w-8 h-8 ${!n.is_read ? 'bg-blue-500' : 'bg-gray-200'} rounded-full flex items-center justify-center">
                        <svg class="w-4 h-4 ${!n.is_read ? 'text-white' : 'text-gray-500'}" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6z"/></svg>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-medium text-gray-900">${n.title}</p>
                        <p class="text-xs text-gray-500 mt-0.5 truncate">${n.message || ''}</p>
                        <p class="text-xs text-gray-400 mt-1">${timeAgo(n.created_at)}</p>
                    </div>
                    ${!n.is_read ? '<span class="w-2 h-2 bg-blue-500 rounded-full"></span>' : ''}
                </div>
            </div>
        `).join('');
    } catch (e) { console.error('Notifications error:', e); }
}

async function markAllRead() {
    try {
        await fetch('/dashboard/api/notifications/mark-all-read', { method: 'PUT' });
        loadNotifications('notifications-list', 'notif-badge');
        loadNotifications('user-notifications', 'notif-badge-user');
    } catch (e) { console.error('Mark read error:', e); }
}

function animateValue(elId, target, suffix = '') {
    const el = document.getElementById(elId);
    if (!el) return;
    const duration = 800, start = 0, startTime = performance.now();
    function update(time) {
        const elapsed = time - startTime, progress = Math.min(elapsed / duration, 1);
        el.textContent = Math.floor(start + (target - start) * progress).toLocaleString() + suffix;
        if (progress < 1) requestAnimationFrame(update);
    }
    requestAnimationFrame(update);
}
</script>
