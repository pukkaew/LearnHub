<%- contentFor('body') %>

<div class="container mx-auto px-4 py-8">
    <!-- Header Section -->
    <div class="flex justify-between items-center mb-8">
        <div>
            <h1 class="text-3xl font-bold text-gray-900"><%= t('questionBank') || 'Question Bank' %></h1>
            <p class="text-gray-600 mt-2"><%= t('manageQuestions') || 'Manage and organize your questions' %></p>
        </div>
        <div class="flex gap-3">
            <a href="/courses/<%= courseId %>" class="px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors flex items-center gap-2">
                <i class="fas fa-arrow-left"></i>
                <span><%= t('backToCourse') || 'Back to Course' %></span>
            </a>
            <a href="/courses/<%= courseId %>/questions/create" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2">
                <i class="fas fa-plus"></i>
                <span><%= t('createQuestion') || 'Create Question' %></span>
            </a>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <div class="bg-white rounded-lg shadow-sm p-6 border border-gray-200">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-600"><%= t('totalQuestions') || 'Total Questions' %></p>
                    <p class="text-3xl font-bold text-gray-900 mt-2"><%= stats?.total || 0 %></p>
                </div>
                <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-question-circle text-blue-600 text-xl"></i>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-sm p-6 border border-gray-200">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-600"><%= t('verified') || 'Verified' %></p>
                    <p class="text-3xl font-bold text-green-600 mt-2"><%= stats?.verified || 0 %></p>
                </div>
                <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-check-circle text-green-600 text-xl"></i>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-sm p-6 border border-gray-200">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-600"><%= t('active') || 'Active' %></p>
                    <p class="text-3xl font-bold text-blue-600 mt-2"><%= stats?.active || 0 %></p>
                </div>
                <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-toggle-on text-blue-600 text-xl"></i>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-sm p-6 border border-gray-200">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-600"><%= t('avgSuccessRate') || 'Avg Success Rate' %></p>
                    <p class="text-3xl font-bold text-purple-600 mt-2"><%= (stats?.avgSuccessRate || 0).toFixed(1) %>%</p>
                </div>
                <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-chart-line text-purple-600 text-xl"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters Section -->
    <div class="bg-white rounded-lg shadow-sm p-6 mb-8 border border-gray-200">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold text-gray-900"><%= t('filters') || 'Filters' %></h2>
            <button id="clearFilters" class="text-sm text-blue-600 hover:text-blue-700">
                <%= t('clearAll') || 'Clear All' %>
            </button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
            <!-- Search -->
            <div class="md:col-span-2">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    <%= t('search') || 'Search' %>
                </label>
                <input type="text" id="searchInput"
                    placeholder="<%= t('searchPlaceholder') || 'Search questions...' %>"
                    value="<%= filters.search || '' %>"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>

            <!-- Question Type -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    <%= t('questionType') || 'Question Type' %>
                </label>
                <select id="typeFilter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    <option value=""><%= t('all') || 'All' %></option>
                    <option value="multiple-choice" <%= filters.type === 'multiple-choice' ? 'selected' : '' %>>Multiple Choice</option>
                    <option value="true-false" <%= filters.type === 'true-false' ? 'selected' : '' %>>True/False</option>
                    <option value="short-answer" <%= filters.type === 'short-answer' ? 'selected' : '' %>>Short Answer</option>
                    <option value="essay" <%= filters.type === 'essay' ? 'selected' : '' %>>Essay</option>
                    <option value="matching" <%= filters.type === 'matching' ? 'selected' : '' %>>Matching</option>
                    <option value="fill-in-blank" <%= filters.type === 'fill-in-blank' ? 'selected' : '' %>>Fill in Blank</option>
                </select>
            </div>

            <!-- Difficulty -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    <%= t('difficulty') || 'Difficulty' %>
                </label>
                <select id="difficultyFilter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    <option value=""><%= t('all') || 'All' %></option>
                    <option value="easy" <%= filters.difficulty === 'easy' ? 'selected' : '' %>>Easy</option>
                    <option value="medium" <%= filters.difficulty === 'medium' ? 'selected' : '' %>>Medium</option>
                    <option value="hard" <%= filters.difficulty === 'hard' ? 'selected' : '' %>>Hard</option>
                    <option value="expert" <%= filters.difficulty === 'expert' ? 'selected' : '' %>>Expert</option>
                </select>
            </div>

            <!-- Status -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    <%= t('status') || 'Status' %>
                </label>
                <select id="statusFilter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    <option value=""><%= t('all') || 'All' %></option>
                    <option value="verified" <%= filters.verified === 'true' ? 'selected' : '' %>><%= t('verified') || 'Verified' %></option>
                    <option value="unverified" <%= filters.verified === 'false' ? 'selected' : '' %>><%= t('unverified') || 'Unverified' %></option>
                </select>
            </div>
        </div>
    </div>

    <!-- Questions List -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200">
        <div class="p-6">
            <div id="questionsList" class="space-y-4">
                <% if (questions && questions.length > 0) { %>
                    <% questions.forEach(question => { %>
                        <div class="border border-gray-200 rounded-lg p-6 hover:shadow-md transition-shadow">
                            <div class="flex justify-between items-start mb-4">
                                <div class="flex-1">
                                    <div class="flex items-center gap-3 mb-2">
                                        <!-- Question Type Badge -->
                                        <span class="px-3 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">
                                            <%= question.question_type %>
                                        </span>

                                        <!-- Difficulty Badge -->
                                        <span class="px-3 py-1 text-xs font-semibold rounded-full
                                            <%= question.difficulty_level === 'easy' ? 'bg-green-100 text-green-800' : '' %>
                                            <%= question.difficulty_level === 'medium' ? 'bg-yellow-100 text-yellow-800' : '' %>
                                            <%= question.difficulty_level === 'hard' ? 'bg-orange-100 text-orange-800' : '' %>
                                            <%= question.difficulty_level === 'expert' ? 'bg-red-100 text-red-800' : '' %>">
                                            <%= question.difficulty_level %>
                                        </span>

                                        <!-- Verified Badge -->
                                        <% if (question.is_verified) { %>
                                            <span class="px-3 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800 flex items-center gap-1">
                                                <i class="fas fa-check-circle"></i>
                                                <%= t('verified') || 'Verified' %>
                                            </span>
                                        <% } %>

                                        <!-- Points -->
                                        <span class="text-sm text-gray-600">
                                            <%= question.default_points %> <%= t('points') || 'pts' %>
                                        </span>
                                    </div>

                                    <h3 class="text-lg font-semibold text-gray-900 mb-2">
                                        <%- question.question_text.substring(0, 150) %><% if (question.question_text.length > 150) { %>...<% } %>
                                    </h3>

                                    <!-- Statistics -->
                                    <div class="flex items-center gap-6 text-sm text-gray-600">
                                        <span><i class="fas fa-eye mr-1"></i> Used <%= question.usage_count || 0 %> times</span>
                                        <% if (question.success_rate !== null) { %>
                                            <span><i class="fas fa-chart-bar mr-1"></i> <%= (question.success_rate || 0).toFixed(1) %>% success</span>
                                        <% } %>
                                        <span><i class="fas fa-clock mr-1"></i> <%= new Date(question.created_at).toLocaleDateString() %></span>
                                    </div>
                                </div>

                                <!-- Actions -->
                                <div class="flex gap-2 ml-4">
                                    <a href="/courses/<%= courseId %>/questions/<%= question.question_id %>"
                                        class="px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors"
                                        title="<%= t('view') || 'View' %>">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <a href="/courses/<%= courseId %>/questions/<%= question.question_id %>/edit"
                                        class="px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors"
                                        title="<%= t('edit') || 'Edit' %>">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <button onclick="duplicateQuestion(<%= question.question_id %>)"
                                        class="px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors"
                                        title="<%= t('duplicate') || 'Duplicate' %>">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                    <button onclick="deleteQuestion(<%= question.question_id %>)"
                                        class="px-4 py-2 text-red-600 bg-white border border-red-300 rounded-lg hover:bg-red-50 transition-colors"
                                        title="<%= t('delete') || 'Delete' %>">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    <% }) %>
                <% } else { %>
                    <div class="text-center py-12">
                        <i class="fas fa-question-circle text-gray-400 text-5xl mb-4"></i>
                        <h3 class="text-xl font-semibold text-gray-900 mb-2">
                            <%= t('noQuestions') || 'No questions found' %>
                        </h3>
                        <p class="text-gray-600 mb-4">
                            <%= t('noQuestionsDescription') || 'Start building your question bank by creating your first question.' %>
                        </p>
                        <a href="/courses/<%= courseId %>/questions/create"
                            class="inline-flex items-center gap-2 px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                            <i class="fas fa-plus"></i>
                            <span><%= t('createQuestion') || 'Create Question' %></span>
                        </a>
                    </div>
                <% } %>
            </div>

            <!-- Pagination -->
            <% if (pagination && pagination.totalPages > 1) { %>
                <div class="flex justify-center items-center gap-2 mt-8 pt-6 border-t border-gray-200">
                    <% if (pagination.currentPage > 1) { %>
                        <a href="?page=<%= pagination.currentPage - 1 %>"
                            class="px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50">
                            <%= t('previous') || 'Previous' %>
                        </a>
                    <% } %>

                    <% for (let i = 1; i <= pagination.totalPages; i++) { %>
                        <a href="?page=<%= i %>"
                            class="px-4 py-2 <%= pagination.currentPage === i ? 'bg-blue-600 text-white' : 'text-gray-700 bg-white border border-gray-300' %> rounded-lg hover:bg-blue-700 hover:text-white transition-colors">
                            <%= i %>
                        </a>
                    <% } %>

                    <% if (pagination.currentPage < pagination.totalPages) { %>
                        <a href="?page=<%= pagination.currentPage + 1 %>"
                            class="px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50">
                            <%= t('next') || 'Next' %>
                        </a>
                    <% } %>
                </div>
            <% } %>
        </div>
    </div>
</div>

<script>
// Filter handling
const searchInput = document.getElementById('searchInput');
const typeFilter = document.getElementById('typeFilter');
const difficultyFilter = document.getElementById('difficultyFilter');
const statusFilter = document.getElementById('statusFilter');
const clearFiltersBtn = document.getElementById('clearFilters');

function applyFilters() {
    const params = new URLSearchParams();

    if (searchInput.value) params.set('search', searchInput.value);
    if (typeFilter.value) params.set('type', typeFilter.value);
    if (difficultyFilter.value) params.set('difficulty', difficultyFilter.value);
    if (statusFilter.value) params.set('verified', statusFilter.value === 'verified' ? 'true' : 'false');

    window.location.href = `?${params.toString()}`;
}

// Debounce search
let searchTimeout;
searchInput.addEventListener('input', () => {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(applyFilters, 500);
});

typeFilter.addEventListener('change', applyFilters);
difficultyFilter.addEventListener('change', applyFilters);
statusFilter.addEventListener('change', applyFilters);

clearFiltersBtn.addEventListener('click', () => {
    window.location.href = window.location.pathname;
});

// Actions
async function duplicateQuestion(questionId) {
    if (!confirm('<%= t("confirmDuplicate") || "Are you sure you want to duplicate this question?" %>')) return;

    try {
        const response = await fetch(`/api/questions/${questionId}/duplicate`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        const data = await response.json();

        if (data.success) {
            alert('<%= t("questionDuplicated") || "Question duplicated successfully" %>');
            window.location.reload();
        } else {
            alert(data.message || '<%= t("error") || "An error occurred" %>');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('<%= t("error") || "An error occurred" %>');
    }
}

async function deleteQuestion(questionId) {
    if (!confirm('<%= t("confirmDelete") || "Are you sure you want to delete this question?" %>')) return;

    try {
        const response = await fetch(`/api/questions/${questionId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        const data = await response.json();

        if (data.success) {
            alert('<%= t("questionDeleted") || "Question deleted successfully" %>');
            window.location.reload();
        } else {
            alert(data.message || '<%= t("error") || "An error occurred" %>');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('<%= t("error") || "An error occurred" %>');
    }
}
</script>
