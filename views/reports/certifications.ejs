<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Header - Gradient Style -->
    <div class="rounded-2xl p-6 mb-8 text-white shadow-lg" style="background: linear-gradient(to right, <%= systemSettings.primary_color || '#3b82f6' %>, <%= systemSettings.secondary_color || '#10b981' %>);">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
            <div>
                <h1 class="text-3xl font-bold text-white">
                    <i class="fas fa-certificate mr-3"></i><%= t('certificationsReport') %>
                </h1>
                <p class="text-white/80 mt-1"><%= t('certificationsReportDesc') %></p>
            </div>
            <div class="flex flex-wrap gap-3 mt-4 md:mt-0">
                <select id="date-range" class="bg-white/20 backdrop-blur-sm text-white border-0 rounded-lg px-4 py-2 focus:ring-2 focus:ring-white/50">
                    <option value="30" class="text-gray-900"><%= t('last30Days') %></option>
                    <option value="90" selected class="text-gray-900"><%= t('last90Days') %></option>
                    <option value="180" class="text-gray-900"><%= t('last6Months') %></option>
                    <option value="365" class="text-gray-900"><%= t('lastYear') %></option>
                    <option value="all" class="text-gray-900"><%= t('allTime') %></option>
                </select>
                <button onclick="bulkValidateCertificates()" class="bg-white/20 hover:bg-white/30 backdrop-blur-sm text-white font-medium py-2 px-4 rounded-lg transition-all duration-200 flex items-center">
                    <i class="fas fa-shield-alt mr-2"></i><%= t('bulkValidate') %>
                </button>
                <button onclick="exportCertifications()" class="bg-white/20 hover:bg-white/30 backdrop-blur-sm text-white font-medium py-2 px-4 rounded-lg transition-all duration-200 flex items-center">
                    <i class="fas fa-download mr-2"></i><%= t('export') %>
                </button>
            </div>
        </div>
    </div>

    <!-- Overview Cards -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-6 mb-6">
        <div class="stat-card bg-white rounded-xl border border-gray-200 p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-500 mb-1"><%= t('totalCertificates') %></p>
                    <p class="text-3xl font-bold text-gray-900" id="total-certificates">0</p>
                    <p class="text-xs text-green-600 mt-2">
                        <i class="fas fa-arrow-up"></i>
                        <span id="certificates-trend">+24</span> <%= t('thisMonth') %>
                    </p>
                </div>
                <div class="icon-box bg-blue-100">
                    <i class="fas fa-certificate text-xl text-blue-600"></i>
                </div>
            </div>
        </div>

        <div class="stat-card bg-white rounded-xl border border-gray-200 p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-500 mb-1"><%= t('validatedCertificates') %></p>
                    <p class="text-3xl font-bold text-gray-900" id="validated-certificates">0</p>
                    <p class="text-xs text-green-600 mt-2">
                        <i class="fas fa-check-circle"></i>
                        <span id="validated-trend">98.5%</span> <%= t('validationRate') %>
                    </p>
                </div>
                <div class="icon-box bg-green-100">
                    <i class="fas fa-check-circle text-xl text-green-600"></i>
                </div>
            </div>
        </div>

        <div class="stat-card bg-white rounded-xl border border-gray-200 p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-500 mb-1"><%= t('pendingValidation') %></p>
                    <p class="text-3xl font-bold text-gray-900" id="pending-certificates">0</p>
                    <p class="text-xs text-yellow-600 mt-2">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span id="pending-trend"><%= t('requiresAttention') %></span>
                    </p>
                </div>
                <div class="icon-box bg-yellow-100">
                    <i class="fas fa-clock text-xl text-yellow-600"></i>
                </div>
            </div>
        </div>

        <div class="stat-card bg-white rounded-xl border border-gray-200 p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-500 mb-1"><%= t('avgCompletionTime') %></p>
                    <p class="text-3xl font-bold text-gray-900" id="avg-completion-time">0<%= t('days') %></p>
                    <p class="text-xs text-green-600 mt-2">
                        <i class="fas fa-arrow-down"></i>
                        <span id="completion-trend">-2</span> <%= t('vsLastPeriod') %>
                    </p>
                </div>
                <div class="icon-box bg-purple-100">
                    <i class="fas fa-calendar-check text-xl text-purple-600"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="bg-white rounded-xl border border-gray-200 p-6 mb-6">
        <h3 class="text-sm font-semibold text-gray-900 mb-4">
            <i class="fas fa-filter mr-2 text-gray-400"></i><%= t('filtersAndActions') %>
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
            <div>
                <label class="block text-xs font-medium text-gray-700 mb-1"><%= t('course') %></label>
                <select id="course-filter" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500">
                    <option value=""><%= t('allCourses') %></option>
                </select>
            </div>
            <div>
                <label class="block text-xs font-medium text-gray-700 mb-1"><%= t('status') %></label>
                <select id="status-filter" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500">
                    <option value=""><%= t('allStatus') %></option>
                    <option value="issued"><%= t('issued') %></option>
                    <option value="validated"><%= t('validated') %></option>
                    <option value="pending"><%= t('pendingValidation') %></option>
                    <option value="revoked"><%= t('revoked') %></option>
                    <option value="expired"><%= t('expired') %></option>
                </select>
            </div>
            <div>
                <label class="block text-xs font-medium text-gray-700 mb-1"><%= t('department') %></label>
                <select id="department-filter" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500">
                    <option value=""><%= t('allDepartments') %></option>
                </select>
            </div>
            <div>
                <label class="block text-xs font-medium text-gray-700 mb-1"><%= t('type') %></label>
                <select id="certificate-type" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500">
                    <option value=""><%= t('allTypes') %></option>
                    <option value="course_completion"><%= t('courseCompletion') %></option>
                    <option value="skill_mastery"><%= t('skillMastery') %></option>
                    <option value="professional"><%= t('professional') %></option>
                    <option value="compliance"><%= t('compliance') %></option>
                </select>
            </div>
            <div>
                <label class="block text-xs font-medium text-gray-700 mb-1"><%= t('search') %></label>
                <div class="relative">
                    <input type="text" id="search-certificates" placeholder="<%= t('searchUserOrCertificate') %>"
                           class="w-full pl-9 pr-4 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500">
                    <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 text-sm"></i>
                </div>
            </div>
        </div>
        <div class="flex justify-end mt-4 space-x-3">
            <button onclick="clearAllFilters()" class="px-4 py-2 border border-gray-300 rounded-lg text-sm text-gray-700 hover:bg-gray-50">
                <%= t('clearAll') %>
            </button>
            <button onclick="applyFilters()" class="px-4 py-2 rounded-lg text-sm text-white" style="background: <%= systemSettings.primary_color || '#3b82f6' %>;">
                <%= t('applyFilters') %>
            </button>
        </div>
    </div>

    <!-- Charts -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <div class="bg-white rounded-xl border border-gray-200">
            <div class="px-6 py-4 border-b border-gray-100">
                <h3 class="text-lg font-semibold text-gray-900">
                    <i class="fas fa-chart-line mr-2" style="color: <%= systemSettings.primary_color || '#3b82f6' %>;"></i><%= t('certificationTrends') %>
                </h3>
            </div>
            <div class="p-6" style="height: 280px;">
                <canvas id="trendsChart"></canvas>
            </div>
        </div>

        <div class="bg-white rounded-xl border border-gray-200">
            <div class="px-6 py-4 border-b border-gray-100">
                <h3 class="text-lg font-semibold text-gray-900">
                    <i class="fas fa-chart-pie mr-2" style="color: <%= systemSettings.secondary_color || '#10b981' %>;"></i><%= t('certificatesByType') %>
                </h3>
            </div>
            <div class="p-6" style="height: 280px;">
                <canvas id="typeChart"></canvas>
            </div>
        </div>

        <div class="bg-white rounded-xl border border-gray-200">
            <div class="px-6 py-4 border-b border-gray-100">
                <h3 class="text-lg font-semibold text-gray-900">
                    <i class="fas fa-building mr-2" style="color: <%= systemSettings.primary_color || '#3b82f6' %>;"></i><%= t('departmentPerformance') %>
                </h3>
            </div>
            <div class="p-6" style="height: 280px;">
                <canvas id="departmentChart"></canvas>
            </div>
        </div>

        <div class="bg-white rounded-xl border border-gray-200">
            <div class="px-6 py-4 border-b border-gray-100">
                <h3 class="text-lg font-semibold text-gray-900">
                    <i class="fas fa-shield-alt mr-2" style="color: <%= systemSettings.secondary_color || '#10b981' %>;"></i><%= t('validationStatusOverview') %>
                </h3>
            </div>
            <div class="p-6" style="height: 280px;">
                <canvas id="validationChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Top Performers & Popular -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <!-- Top Earners -->
        <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-100">
                <h3 class="text-lg font-semibold text-gray-900">
                    <i class="fas fa-trophy text-yellow-500 mr-2"></i><%= t('topCertificateEarners') %>
                </h3>
                <p class="text-sm text-gray-500 mt-1"><%= t('usersWithMostCertificates') %></p>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase"><%= t('rank') %></th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase"><%= t('user') %></th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase"><%= t('certificates') %></th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase"><%= t('latest') %></th>
                        </tr>
                    </thead>
                    <tbody id="top-earners-table" class="bg-white divide-y divide-gray-100"></tbody>
                </table>
            </div>
        </div>

        <!-- Popular Certifications -->
        <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-100">
                <h3 class="text-lg font-semibold text-gray-900">
                    <i class="fas fa-star text-yellow-500 mr-2"></i><%= t('popularCertifications') %>
                </h3>
                <p class="text-sm text-gray-500 mt-1"><%= t('highestEnrollmentCertificates') %></p>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase"><%= t('certificate') %></th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase"><%= t('earned') %></th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase"><%= t('inProgress') %></th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase"><%= t('successRate') %></th>
                        </tr>
                    </thead>
                    <tbody id="popular-certificates-table" class="bg-white divide-y divide-gray-100"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Certificate Registry -->
    <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-100">
            <div class="flex justify-between items-center">
                <div>
                    <h3 class="text-lg font-semibold text-gray-900">
                        <i class="fas fa-list-alt mr-2" style="color: <%= systemSettings.primary_color || '#3b82f6' %>;"></i><%= t('certificateRegistry') %>
                    </h3>
                    <p class="text-sm text-gray-500 mt-1"><%= t('certificateRegistryDesc') %></p>
                </div>
                <div class="flex space-x-2 text-sm">
                    <button onclick="selectAll()" class="text-blue-600 hover:text-blue-800"><%= t('selectAll') %></button>
                    <span class="text-gray-300">|</span>
                    <button onclick="deselectAll()" class="text-blue-600 hover:text-blue-800"><%= t('deselectAll') %></button>
                </div>
            </div>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left"><input type="checkbox" id="select-all-checkbox" class="rounded border-gray-300"></th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase cursor-pointer" onclick="sortCertificates('user')"><%= t('user') %> <i class="fas fa-sort ml-1"></i></th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase cursor-pointer" onclick="sortCertificates('course')"><%= t('certificate') %> <i class="fas fa-sort ml-1"></i></th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase cursor-pointer" onclick="sortCertificates('type')"><%= t('type') %> <i class="fas fa-sort ml-1"></i></th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase cursor-pointer" onclick="sortCertificates('issued_date')"><%= t('issuedDate') %> <i class="fas fa-sort ml-1"></i></th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase cursor-pointer" onclick="sortCertificates('expiry_date')"><%= t('expiryDate') %> <i class="fas fa-sort ml-1"></i></th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase cursor-pointer" onclick="sortCertificates('status')"><%= t('status') %> <i class="fas fa-sort ml-1"></i></th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase"><%= t('actions') %></th>
                    </tr>
                </thead>
                <tbody id="certificates-table" class="bg-white divide-y divide-gray-100"></tbody>
            </table>
        </div>
        <div class="px-6 py-4 border-t border-gray-100 bg-gray-50">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="flex items-center space-x-4">
                    <span class="text-sm text-gray-600">
                        <%= t('showing') %> <span id="showing-from" class="font-semibold">1</span> <%= t('to') %> <span id="showing-to" class="font-semibold">20</span> <%= t('of') %> <span id="total-certificates-count" class="font-semibold">0</span> <%= t('certificates') %>
                    </span>
                    <span class="text-sm text-gray-500"><%= t('selected') %>: <span class="font-medium text-blue-600" id="selected-count">0</span></span>
                </div>
                <div class="flex items-center space-x-2">
                    <button onclick="previousPage()" class="px-3 py-1.5 border rounded-lg text-sm bg-white hover:bg-gray-50 text-gray-700" id="prev-btn" disabled>
                        <i class="fas fa-chevron-left mr-1"></i><%= t('previous') %>
                    </button>
                    <span class="px-4 py-1.5 rounded-lg text-sm font-medium text-white" style="background: <%= systemSettings.primary_color || '#3b82f6' %>;">
                        <span id="current-page">1</span> / <span id="total-pages">1</span>
                    </span>
                    <button onclick="nextPage()" class="px-3 py-1.5 border rounded-lg text-sm bg-white hover:bg-gray-50 text-gray-700" id="next-btn">
                        <%= t('next') %> <i class="fas fa-chevron-right ml-1"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Validation Modal -->
<div id="validation-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-lg font-semibold text-gray-900"><%= t('certificateValidation') %></h3>
                <button onclick="closeValidationModal()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6" id="validation-content"></div>
        </div>
    </div>
</div>

<!-- Preview Modal -->
<div id="preview-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-lg font-semibold text-gray-900"><%= t('certificatePreview') %></h3>
                <div class="flex space-x-2">
                    <button onclick="downloadCertificate()" class="px-4 py-2 rounded-lg text-sm text-white" style="background: <%= systemSettings.primary_color || '#3b82f6' %>;">
                        <i class="fas fa-download mr-2"></i><%= t('download') %>
                    </button>
                    <button onclick="closeCertificatePreview()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
                </div>
            </div>
            <div class="p-6" id="certificate-preview-content"></div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-xl p-6 flex items-center space-x-4">
        <div class="animate-spin rounded-full h-10 w-10 border-4 border-t-transparent" style="border-color: <%= systemSettings.primary_color || '#3b82f6' %>; border-top-color: transparent;"></div>
        <span class="text-gray-700 font-medium"><%= t('loadingData') %></span>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const i18n = {
    noDataAvailable: '<%= t("noDataAvailable") %>',
    exportSuccess: '<%= t("exportSuccess") %>',
    exportFailed: '<%= t("exportFailed") %>',
    errorLoadingData: '<%= t("errorLoadingData") %>',
    selectCertificatesToValidate: '<%= t("selectCertificatesToValidate") %>',
    certificatesValidated: '<%= t("certificatesValidated") %>',
    certificateDownloaded: '<%= t("certificateDownloaded") %>',
    confirmRevoke: '<%= t("confirmRevoke") %>',
    certificateRevoked: '<%= t("certificateRevoked") %>',
    noExpiry: '<%= t("noExpiry") %>',
    validationSubmitted: '<%= t("validationSubmitted") %>',
    verified: '<%= t("verified") %>'
};

const primaryColor = '<%= systemSettings.primary_color || "#3b82f6" %>';
const secondaryColor = '<%= systemSettings.secondary_color || "#10b981" %>';

let certificationsData = {};
let charts = {};
let currentPage = 1;
let itemsPerPage = 20;
let sortField = 'issued_date';
let sortDirection = 'desc';
let currentFilters = {};
let selectedCertificates = new Set();
let currentCertificateId = null;

document.addEventListener('DOMContentLoaded', function() {
    loadCertificationsData();
    document.getElementById('date-range').addEventListener('change', loadCertificationsData);
    document.getElementById('search-certificates').addEventListener('input', debounce(applyFilters, 500));
    document.getElementById('select-all-checkbox').addEventListener('change', handleSelectAll);
});

async function loadCertificationsData() {
    showLoading(true);
    try {
        const dateRange = document.getElementById('date-range').value;
        const params = new URLSearchParams({ dateRange, ...currentFilters });
        const response = await fetch(`/reports/api/certifications?${params}`);
        const data = await response.json();

        if (data.success) {
            certificationsData = data.data;
            updateOverviewCards();
            initializeCharts();
            loadTopEarners();
            loadPopularCertifications();
            loadCertificatesTable();
            loadFilterOptions();
        } else {
            showToast(i18n.errorLoadingData, 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        showToast(i18n.errorLoadingData, 'error');
    } finally {
        showLoading(false);
    }
}

function updateOverviewCards() {
    const overview = certificationsData.overview || {};
    document.getElementById('total-certificates').textContent = overview.totalCertificates || 0;
    document.getElementById('validated-certificates').textContent = overview.validatedCertificates || 0;
    document.getElementById('pending-certificates').textContent = overview.pendingCertificates || 0;
    document.getElementById('avg-completion-time').textContent = (overview.avgCompletionTime || 0) + 'd';
    document.getElementById('certificates-trend').textContent = '+' + (overview.certificatesTrend || 0);
    document.getElementById('validated-trend').textContent = (overview.validationRate || 0) + '%';
}

function initializeCharts() {
    Object.values(charts).forEach(chart => chart.destroy());
    charts = {};

    // Trends Chart
    const trendsCtx = document.getElementById('trendsChart').getContext('2d');
    charts.trends = new Chart(trendsCtx, {
        type: 'line',
        data: {
            labels: certificationsData.trends?.labels || [],
            datasets: [{
                label: '<%= t("certificatesIssued") %>',
                data: certificationsData.trends?.issued || [],
                borderColor: primaryColor,
                backgroundColor: primaryColor + '20',
                tension: 0.4,
                fill: true
            }, {
                label: '<%= t("certificatesValidated") %>',
                data: certificationsData.trends?.validated || [],
                borderColor: secondaryColor,
                backgroundColor: secondaryColor + '20',
                tension: 0.4,
                fill: true
            }]
        },
        options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
    });

    // Type Chart
    const typeCtx = document.getElementById('typeChart').getContext('2d');
    charts.type = new Chart(typeCtx, {
        type: 'doughnut',
        data: {
            labels: (certificationsData.types || []).map(t => t.name),
            datasets: [{ data: (certificationsData.types || []).map(t => t.count), backgroundColor: [primaryColor, secondaryColor, '#F59E0B', '#EF4444', '#8B5CF6'] }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
    });

    // Department Chart
    const deptCtx = document.getElementById('departmentChart').getContext('2d');
    charts.department = new Chart(deptCtx, {
        type: 'bar',
        data: {
            labels: (certificationsData.departments || []).map(d => d.name),
            datasets: [{ label: '<%= t("certificatesEarned") %>', data: (certificationsData.departments || []).map(d => d.count), backgroundColor: '#6366F1' }]
        },
        options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
    });

    // Validation Chart
    const validationCtx = document.getElementById('validationChart').getContext('2d');
    charts.validation = new Chart(validationCtx, {
        type: 'pie',
        data: {
            labels: ['<%= t("validated") %>', '<%= t("pending") %>', '<%= t("rejected") %>', '<%= t("expired") %>'],
            datasets: [{ data: [certificationsData.validation?.validated || 0, certificationsData.validation?.pending || 0, certificationsData.validation?.rejected || 0, certificationsData.validation?.expired || 0], backgroundColor: ['#10B981', '#F59E0B', '#EF4444', '#6B7280'] }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
    });
}

function loadTopEarners() {
    const tbody = document.getElementById('top-earners-table');
    tbody.innerHTML = '';
    const topEarners = certificationsData.topEarners || [];

    topEarners.forEach((earner, index) => {
        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-50';
        row.innerHTML = `
            <td class="px-4 py-3 text-sm font-medium text-gray-900">${index + 1} ${index === 0 ? '<i class="fas fa-crown text-yellow-500 ml-2"></i>' : ''}</td>
            <td class="px-4 py-3">
                <div class="flex items-center">
                    <img class="h-8 w-8 rounded-full" src="${earner.avatar || '/images/default-avatar.png'}" alt="" onerror="this.src='/images/default-avatar.png'">
                    <div class="ml-3">
                        <p class="text-sm font-medium text-gray-900">${earner.name}</p>
                        <p class="text-xs text-gray-500">${earner.department}</p>
                    </div>
                </div>
            </td>
            <td class="px-4 py-3 text-sm font-medium text-blue-600">${earner.certificateCount}</td>
            <td class="px-4 py-3 text-sm text-gray-500">${earner.latestCertificate ? formatDate(earner.latestCertificate) : '-'}</td>
        `;
        tbody.appendChild(row);
    });

    if (topEarners.length === 0) {
        tbody.innerHTML = `<tr><td colspan="4" class="px-4 py-8 text-center text-gray-500">${i18n.noDataAvailable}</td></tr>`;
    }
}

function loadPopularCertifications() {
    const tbody = document.getElementById('popular-certificates-table');
    tbody.innerHTML = '';
    const popular = certificationsData.popularCertifications || [];

    popular.forEach(cert => {
        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-50';
        row.innerHTML = `
            <td class="px-4 py-3">
                <p class="text-sm font-medium text-gray-900">${cert.title}</p>
                <p class="text-xs text-gray-500">${cert.course}</p>
            </td>
            <td class="px-4 py-3 text-sm font-medium text-green-600">${cert.earned}</td>
            <td class="px-4 py-3 text-sm text-gray-900">${cert.inProgress}</td>
            <td class="px-4 py-3 text-sm font-medium ${cert.successRate >= 75 ? 'text-green-600' : cert.successRate >= 50 ? 'text-yellow-600' : 'text-red-600'}">${cert.successRate}%</td>
        `;
        tbody.appendChild(row);
    });

    if (popular.length === 0) {
        tbody.innerHTML = `<tr><td colspan="4" class="px-4 py-8 text-center text-gray-500">${i18n.noDataAvailable}</td></tr>`;
    }
}

function loadCertificatesTable() {
    const tbody = document.getElementById('certificates-table');
    tbody.innerHTML = '';
    const certificates = certificationsData.certificates || [];
    const start = (currentPage - 1) * itemsPerPage;
    const paginated = certificates.slice(start, start + itemsPerPage);

    paginated.forEach(cert => {
        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-50';
        row.innerHTML = `
            <td class="px-4 py-3"><input type="checkbox" class="certificate-checkbox rounded border-gray-300" value="${cert.certificate_id}"></td>
            <td class="px-4 py-3">
                <div class="flex items-center">
                    <img class="h-8 w-8 rounded-full" src="${cert.user?.avatar || '/images/default-avatar.png'}" alt="" onerror="this.src='/images/default-avatar.png'">
                    <div class="ml-3">
                        <p class="text-sm font-medium text-gray-900">${cert.user?.name || '-'}</p>
                        <p class="text-xs text-gray-500">${cert.user?.department || '-'}</p>
                    </div>
                </div>
            </td>
            <td class="px-4 py-3">
                <p class="text-sm font-medium text-gray-900">${cert.title}</p>
                <p class="text-xs text-gray-500">${cert.course}</p>
            </td>
            <td class="px-4 py-3"><span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${getTypeBadge(cert.type)}">${cert.type}</span></td>
            <td class="px-4 py-3 text-sm text-gray-900">${formatDate(cert.issued_date)}</td>
            <td class="px-4 py-3 text-sm text-gray-900">${cert.expiry_date ? formatDate(cert.expiry_date) : i18n.noExpiry}</td>
            <td class="px-4 py-3"><span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${getStatusBadge(cert.status)}">${cert.status}</span></td>
            <td class="px-4 py-3 text-sm font-medium">
                <div class="flex space-x-2">
                    <button onclick="previewCertificate('${cert.certificate_id}')" class="text-blue-600 hover:text-blue-900"><i class="fas fa-eye"></i></button>
                    <button onclick="downloadCertificatePDF('${cert.certificate_id}')" class="text-green-600 hover:text-green-900"><i class="fas fa-download"></i></button>
                    ${cert.status === 'pending' ? `<button onclick="validateCertificate('${cert.certificate_id}')" class="text-purple-600 hover:text-purple-900"><i class="fas fa-shield-alt"></i></button>` : ''}
                    <button onclick="revokeCertificate('${cert.certificate_id}')" class="text-red-600 hover:text-red-900"><i class="fas fa-ban"></i></button>
                </div>
            </td>
        `;
        tbody.appendChild(row);
    });

    document.querySelectorAll('.certificate-checkbox').forEach(cb => cb.addEventListener('change', handleCheckboxChange));

    if (paginated.length === 0) {
        tbody.innerHTML = `<tr><td colspan="8" class="px-4 py-8 text-center text-gray-500">${i18n.noDataAvailable}</td></tr>`;
    }
    updatePagination(certificates.length);
    updateSelectedCount();
}

function getTypeBadge(type) {
    const badges = { 'course_completion': 'bg-blue-100 text-blue-800', 'skill_mastery': 'bg-green-100 text-green-800', 'professional': 'bg-purple-100 text-purple-800', 'compliance': 'bg-orange-100 text-orange-800' };
    return badges[type] || 'bg-gray-100 text-gray-800';
}

function getStatusBadge(status) {
    const badges = { 'issued': 'bg-blue-100 text-blue-800', 'validated': 'bg-green-100 text-green-800', 'pending': 'bg-yellow-100 text-yellow-800', 'revoked': 'bg-red-100 text-red-800', 'expired': 'bg-gray-100 text-gray-800' };
    return badges[status] || 'bg-gray-100 text-gray-800';
}

function loadFilterOptions() {
    const courseSelect = document.getElementById('course-filter');
    const courses = [...new Set((certificationsData.certificates || []).map(c => c.course))];
    courseSelect.innerHTML = '<option value=""><%= t("allCourses") %></option>';
    courses.forEach(course => { courseSelect.innerHTML += `<option value="${course}">${course}</option>`; });

    const deptSelect = document.getElementById('department-filter');
    const depts = [...new Set((certificationsData.certificates || []).map(c => c.user?.department).filter(Boolean))];
    deptSelect.innerHTML = '<option value=""><%= t("allDepartments") %></option>';
    depts.forEach(dept => { deptSelect.innerHTML += `<option value="${dept}">${dept}</option>`; });
}

function applyFilters() {
    currentFilters = {
        course: document.getElementById('course-filter').value,
        status: document.getElementById('status-filter').value,
        department: document.getElementById('department-filter').value,
        type: document.getElementById('certificate-type').value,
        search: document.getElementById('search-certificates').value
    };
    Object.keys(currentFilters).forEach(key => { if (!currentFilters[key]) delete currentFilters[key]; });
    currentPage = 1;
    selectedCertificates.clear();
    loadCertificationsData();
}

function clearAllFilters() {
    currentFilters = {};
    document.getElementById('course-filter').value = '';
    document.getElementById('status-filter').value = '';
    document.getElementById('department-filter').value = '';
    document.getElementById('certificate-type').value = '';
    document.getElementById('search-certificates').value = '';
    selectedCertificates.clear();
    loadCertificationsData();
}

function sortCertificates(field) {
    if (sortField === field) sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
    else { sortField = field; sortDirection = 'desc'; }

    certificationsData.certificates.sort((a, b) => {
        let aVal = field === 'user' ? a.user?.name?.toLowerCase() : a[field];
        let bVal = field === 'user' ? b.user?.name?.toLowerCase() : b[field];
        if (field.includes('date')) { aVal = new Date(aVal).getTime(); bVal = new Date(bVal).getTime(); }
        else if (typeof aVal === 'string') { aVal = aVal.toLowerCase(); bVal = bVal.toLowerCase(); }
        return sortDirection === 'asc' ? (aVal > bVal ? 1 : -1) : (aVal < bVal ? 1 : -1);
    });
    loadCertificatesTable();
}

function updatePagination(totalItems) {
    const totalPages = Math.ceil(totalItems / itemsPerPage);
    document.getElementById('showing-from').textContent = totalItems === 0 ? 0 : (currentPage - 1) * itemsPerPage + 1;
    document.getElementById('showing-to').textContent = Math.min(currentPage * itemsPerPage, totalItems);
    document.getElementById('total-certificates-count').textContent = totalItems;
    document.getElementById('current-page').textContent = currentPage;
    document.getElementById('total-pages').textContent = totalPages || 1;
    document.getElementById('prev-btn').disabled = currentPage <= 1;
    document.getElementById('next-btn').disabled = currentPage >= totalPages;
}

function handleSelectAll() {
    const selectAll = document.getElementById('select-all-checkbox');
    document.querySelectorAll('.certificate-checkbox').forEach(cb => {
        cb.checked = selectAll.checked;
        selectAll.checked ? selectedCertificates.add(cb.value) : selectedCertificates.delete(cb.value);
    });
    updateSelectedCount();
}

function handleCheckboxChange(e) {
    e.target.checked ? selectedCertificates.add(e.target.value) : selectedCertificates.delete(e.target.value);
    updateSelectedCount();
    const allCbs = document.querySelectorAll('.certificate-checkbox');
    const checkedCbs = document.querySelectorAll('.certificate-checkbox:checked');
    const selectAll = document.getElementById('select-all-checkbox');
    selectAll.checked = checkedCbs.length === allCbs.length;
    selectAll.indeterminate = checkedCbs.length > 0 && checkedCbs.length < allCbs.length;
}

function updateSelectedCount() { document.getElementById('selected-count').textContent = selectedCertificates.size; }
function selectAll() { document.getElementById('select-all-checkbox').checked = true; handleSelectAll(); }
function deselectAll() { document.getElementById('select-all-checkbox').checked = false; handleSelectAll(); }
function previousPage() { if (currentPage > 1) { currentPage--; loadCertificatesTable(); } }
function nextPage() {
    const totalPages = Math.ceil((certificationsData.certificates || []).length / itemsPerPage);
    if (currentPage < totalPages) { currentPage++; loadCertificatesTable(); }
}

async function previewCertificate(certificateId) {
    currentCertificateId = certificateId;
    try {
        const response = await fetch(`/certificates/api/${certificateId}/preview`);
        const data = await response.json();
        if (data.success) {
            document.getElementById('certificate-preview-content').innerHTML = `
                <div class="bg-gradient-to-br from-blue-50 to-indigo-50 p-8 rounded-lg border-2 border-blue-200 text-center">
                    <div class="mx-auto w-20 h-20 rounded-full flex items-center justify-center mb-6" style="background: ${primaryColor};">
                        <i class="fas fa-certificate text-white text-3xl"></i>
                    </div>
                    <h1 class="text-3xl font-bold text-gray-900 mb-2"><%= t("certificateOfAchievement") %></h1>
                    <div class="w-24 h-1 mx-auto mb-6" style="background: ${primaryColor};"></div>
                    <p class="text-lg text-gray-700 mb-4"><%= t("thisIsToCertify") %></p>
                    <h2 class="text-4xl font-bold mb-6" style="color: ${primaryColor};">${data.certificate.user?.name || '-'}</h2>
                    <p class="text-lg text-gray-700 mb-2"><%= t("hasSuccessfullyCompleted") %></p>
                    <h3 class="text-2xl font-bold text-gray-900 mb-6">${data.certificate.course}</h3>
                    <div class="flex justify-between items-end mt-12">
                        <div class="text-left">
                            <p class="text-sm text-gray-600"><%= t("dateOfCompletion") %></p>
                            <p class="text-lg font-semibold">${formatDate(data.certificate.issued_date)}</p>
                        </div>
                        <div class="text-center">
                            <div class="w-32 h-16 bg-blue-100 rounded flex items-center justify-center mb-2">
                                <span class="font-bold" style="color: ${primaryColor};">${i18n.verified}</span>
                            </div>
                            <p class="text-xs text-gray-500">ID: ${data.certificate.certificate_id}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-sm text-gray-600"><%= t("instructor") %></p>
                            <p class="text-lg font-semibold">${data.certificate.instructor || 'LearnHub'}</p>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('preview-modal').classList.remove('hidden');
        }
    } catch (error) {
        showToast(i18n.errorLoadingData, 'error');
    }
}

function closeCertificatePreview() { document.getElementById('preview-modal').classList.add('hidden'); currentCertificateId = null; }
function closeValidationModal() { document.getElementById('validation-modal').classList.add('hidden'); }

async function downloadCertificate() {
    if (!currentCertificateId) return;
    try {
        const response = await fetch(`/certificates/api/${currentCertificateId}/download`);
        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `certificate-${currentCertificateId}.pdf`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            a.remove();
            showToast(i18n.certificateDownloaded);
        }
    } catch (error) {
        showToast(i18n.exportFailed, 'error');
    }
}

async function downloadCertificatePDF(certificateId) {
    try {
        const response = await fetch(`/certificates/api/${certificateId}/download`);
        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `certificate-${certificateId}.pdf`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            a.remove();
            showToast(i18n.certificateDownloaded);
        }
    } catch (error) {
        showToast(i18n.exportFailed, 'error');
    }
}

async function validateCertificate(certificateId) {
    try {
        const response = await fetch(`/certificates/api/${certificateId}`);
        const data = await response.json();
        if (data.success) {
            document.getElementById('validation-content').innerHTML = `
                <form onsubmit="submitValidation(event, '${certificateId}')">
                    <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                        <h4 class="font-semibold mb-2"><%= t("certificateInfo") %></h4>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div><span class="font-medium"><%= t("user") %>:</span> ${data.certificate.user?.name || '-'}</div>
                            <div><span class="font-medium"><%= t("course") %>:</span> ${data.certificate.course}</div>
                            <div><span class="font-medium"><%= t("issued") %>:</span> ${formatDate(data.certificate.issued_date)}</div>
                            <div><span class="font-medium"><%= t("score") %>:</span> ${data.certificate.score || '-'}%</div>
                        </div>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2"><%= t("validationStatus") %></label>
                        <select id="validation-status" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500">
                            <option value="validated"><%= t("approveAndValidate") %></option>
                            <option value="rejected"><%= t("reject") %></option>
                            <option value="pending"><%= t("keepPending") %></option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2"><%= t("validationNotes") %></label>
                        <textarea id="validation-notes" rows="3" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500" placeholder="<%= t("addNotes") %>..."></textarea>
                    </div>
                    <div class="mb-6">
                        <label class="flex items-center">
                            <input type="checkbox" id="notify-user" checked class="mr-2">
                            <span class="text-sm"><%= t("notifyUserEmail") %></span>
                        </label>
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button type="button" onclick="closeValidationModal()" class="px-4 py-2 border border-gray-300 rounded-lg text-sm text-gray-700 hover:bg-gray-50"><%= t("cancel") %></button>
                        <button type="submit" class="px-4 py-2 rounded-lg text-sm text-white" style="background: ${primaryColor};"><%= t("submitValidation") %></button>
                    </div>
                </form>
            `;
            document.getElementById('validation-modal').classList.remove('hidden');
        }
    } catch (error) {
        showToast(i18n.errorLoadingData, 'error');
    }
}

async function submitValidation(event, certificateId) {
    event.preventDefault();
    try {
        const response = await fetch(`/certificates/api/${certificateId}/validate`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                status: document.getElementById('validation-status').value,
                notes: document.getElementById('validation-notes').value,
                notifyUser: document.getElementById('notify-user').checked
            })
        });
        const data = await response.json();
        if (data.success) {
            showToast(i18n.validationSubmitted);
            closeValidationModal();
            loadCertificationsData();
        } else {
            showToast(data.message || i18n.errorLoadingData, 'error');
        }
    } catch (error) {
        showToast(i18n.errorLoadingData, 'error');
    }
}

async function revokeCertificate(certificateId) {
    if (!confirm(i18n.confirmRevoke)) return;
    try {
        const response = await fetch(`/certificates/api/${certificateId}/revoke`, { method: 'POST' });
        const data = await response.json();
        if (data.success) {
            showToast(i18n.certificateRevoked);
            loadCertificationsData();
        } else {
            showToast(data.message || i18n.errorLoadingData, 'error');
        }
    } catch (error) {
        showToast(i18n.errorLoadingData, 'error');
    }
}

async function bulkValidateCertificates() {
    if (selectedCertificates.size === 0) {
        showToast(i18n.selectCertificatesToValidate, 'error');
        return;
    }
    if (!confirm(`<%= t("confirmBulkValidate") %> ${selectedCertificates.size} <%= t("certificates") %>?`)) return;
    showLoading(true);
    try {
        const response = await fetch('/certificates/api/bulk-validate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ certificateIds: Array.from(selectedCertificates), status: 'validated', notes: 'Bulk validation' })
        });
        const data = await response.json();
        if (data.success) {
            showToast(`${data.validatedCount} ${i18n.certificatesValidated}`);
            selectedCertificates.clear();
            loadCertificationsData();
        } else {
            showToast(data.message || i18n.errorLoadingData, 'error');
        }
    } catch (error) {
        showToast(i18n.errorLoadingData, 'error');
    } finally {
        showLoading(false);
    }
}

async function exportCertifications() {
    showLoading(true);
    try {
        const dateRange = document.getElementById('date-range').value;
        const params = new URLSearchParams({ dateRange, ...currentFilters });
        const response = await fetch(`/reports/api/certifications/export?${params}`);
        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `certifications-report-${new Date().toISOString().split('T')[0]}.xlsx`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            a.remove();
            showToast(i18n.exportSuccess);
        } else {
            showToast(i18n.exportFailed, 'error');
        }
    } catch (error) {
        showToast(i18n.exportFailed, 'error');
    } finally {
        showLoading(false);
    }
}

function formatDate(dateString) {
    if (!dateString) return '-';
    const lang = '<%= language || "th" %>';
    return new Date(dateString).toLocaleDateString(lang === 'th' ? 'th-TH' : 'en-US', { day: '2-digit', month: 'short', year: 'numeric' });
}

function showLoading(show) { document.getElementById('loading-overlay').classList.toggle('hidden', !show); }

function showToast(message, type = 'success') {
    const toast = document.createElement('div');
    toast.className = `fixed top-4 right-4 ${type === 'error' ? 'bg-red-500' : 'bg-green-500'} text-white px-6 py-3 rounded-lg shadow-lg z-50`;
    toast.innerHTML = `<i class="fas fa-${type === 'error' ? 'exclamation-circle' : 'check-circle'} mr-2"></i>${message}`;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}

function debounce(func, wait) {
    let timeout;
    return function(...args) { clearTimeout(timeout); timeout = setTimeout(() => func(...args), wait); };
}
</script>
