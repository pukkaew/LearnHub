<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Header - Gradient Style -->
    <div class="rounded-2xl p-6 mb-8 text-white shadow-lg" style="background: linear-gradient(to right, <%= systemSettings.primary_color || '#3b82f6' %>, <%= systemSettings.secondary_color || '#10b981' %>);">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
            <div>
                <h1 class="text-3xl font-bold text-white">
                    <i class="fas fa-chart-line mr-3"></i><%= t('courseAnalyticsReport') %>
                </h1>
                <p class="text-white/80 mt-1"><%= t('courseAnalyticsDescription') %></p>
            </div>
            <div class="flex flex-wrap gap-3 mt-4 md:mt-0">
                <select id="time-period" class="bg-white/20 backdrop-blur-sm text-white border-0 rounded-lg px-4 py-2 focus:ring-2 focus:ring-white/50">
                    <option value="7" class="text-gray-900"><%= t('last7Days') %></option>
                    <option value="30" selected class="text-gray-900"><%= t('last30Days') %></option>
                    <option value="90" class="text-gray-900"><%= t('last90Days') %></option>
                    <option value="365" class="text-gray-900"><%= t('lastYear') %></option>
                </select>
                <button onclick="exportAnalytics()" class="bg-white/20 hover:bg-white/30 backdrop-blur-sm text-white font-medium py-2 px-4 rounded-lg transition-all duration-200 flex items-center">
                    <i class="fas fa-download mr-2"></i><%= t('export') %>
                </button>
                <button onclick="refreshAnalytics()" class="bg-white/20 hover:bg-white/30 backdrop-blur-sm text-white font-medium py-2 px-4 rounded-lg transition-all duration-200 flex items-center">
                    <i class="fas fa-sync-alt mr-2"></i><%= t('refresh') %>
                </button>
            </div>
        </div>
    </div>

    <!-- Overview Cards -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-6 mb-6">
        <div class="stat-card bg-white rounded-xl border border-gray-200 p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-500 mb-1"><%= t('totalCourses') %></p>
                    <p class="text-3xl font-bold text-gray-900" id="total-courses">0</p>
                    <p class="text-xs text-green-600 mt-2" id="courses-trend-container">
                        <i class="fas fa-arrow-up"></i>
                        <span id="courses-trend">+5</span> <%= t('newThisMonth') %>
                    </p>
                </div>
                <div class="icon-box bg-blue-100">
                    <i class="fas fa-book text-xl text-blue-600"></i>
                </div>
            </div>
        </div>

        <div class="stat-card bg-white rounded-xl border border-gray-200 p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-500 mb-1"><%= t('totalEnrollments') %></p>
                    <p class="text-3xl font-bold text-gray-900" id="total-enrollments">0</p>
                    <p class="text-xs text-green-600 mt-2" id="enrollments-trend-container">
                        <i class="fas fa-arrow-up"></i>
                        <span id="enrollments-trend">+12.5%</span> <%= t('fromLastMonth') %>
                    </p>
                </div>
                <div class="icon-box bg-green-100">
                    <i class="fas fa-users text-xl text-green-600"></i>
                </div>
            </div>
        </div>

        <div class="stat-card bg-white rounded-xl border border-gray-200 p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-500 mb-1"><%= t('completionRate') %></p>
                    <p class="text-3xl font-bold text-gray-900" id="completion-rate">0%</p>
                    <p class="text-xs text-green-600 mt-2" id="completion-trend-container">
                        <i class="fas fa-arrow-up"></i>
                        <span id="completion-trend">+3.2%</span> <%= t('fromLastMonth') %>
                    </p>
                </div>
                <div class="icon-box bg-yellow-100">
                    <i class="fas fa-graduation-cap text-xl text-yellow-600"></i>
                </div>
            </div>
        </div>

        <div class="stat-card bg-white rounded-xl border border-gray-200 p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-500 mb-1"><%= t('averageRating') %></p>
                    <p class="text-3xl font-bold text-gray-900" id="average-rating">0.0</p>
                    <p class="text-xs text-green-600 mt-2" id="rating-trend-container">
                        <i class="fas fa-arrow-up"></i>
                        <span id="rating-trend">+0.2</span> <%= t('fromLastMonth') %>
                    </p>
                </div>
                <div class="icon-box bg-purple-100">
                    <i class="fas fa-star text-xl text-purple-600"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row 1 -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <!-- Enrollment Trends -->
        <div class="bg-white rounded-xl border border-gray-200">
            <div class="px-6 py-4 border-b border-gray-100">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg font-semibold text-gray-900">
                        <i class="fas fa-chart-area mr-2" style="color: <%= systemSettings.primary_color || '#3b82f6' %>;"></i><%= t('enrollmentTrends') %>
                    </h3>
                    <div class="flex space-x-2">
                        <button onclick="changeEnrollmentView('daily')" class="trend-btn active" data-view="daily"><%= t('daily') %></button>
                        <button onclick="changeEnrollmentView('weekly')" class="trend-btn" data-view="weekly"><%= t('weekly') %></button>
                        <button onclick="changeEnrollmentView('monthly')" class="trend-btn" data-view="monthly"><%= t('monthly') %></button>
                    </div>
                </div>
            </div>
            <div class="p-6" style="position: relative; height: 280px;">
                <canvas id="enrollmentChart"></canvas>
            </div>
        </div>

        <!-- Completion Rates -->
        <div class="bg-white rounded-xl border border-gray-200">
            <div class="px-6 py-4 border-b border-gray-100">
                <h3 class="text-lg font-semibold text-gray-900">
                    <i class="fas fa-chart-pie mr-2" style="color: <%= systemSettings.secondary_color || '#10b981' %>;"></i><%= t('completionByCategory') %>
                </h3>
            </div>
            <div class="p-6" style="position: relative; height: 280px;">
                <canvas id="completionChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Charts Row 2 -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <!-- Course Engagement -->
        <div class="bg-white rounded-xl border border-gray-200">
            <div class="px-6 py-4 border-b border-gray-100">
                <h3 class="text-lg font-semibold text-gray-900">
                    <i class="fas fa-bullseye mr-2" style="color: <%= systemSettings.primary_color || '#3b82f6' %>;"></i><%= t('engagementMetrics') %>
                </h3>
            </div>
            <div class="p-6" style="position: relative; height: 280px;">
                <canvas id="engagementChart"></canvas>
            </div>
        </div>

        <!-- Learning Progress Distribution -->
        <div class="bg-white rounded-xl border border-gray-200">
            <div class="px-6 py-4 border-b border-gray-100">
                <h3 class="text-lg font-semibold text-gray-900">
                    <i class="fas fa-tasks mr-2" style="color: <%= systemSettings.secondary_color || '#10b981' %>;"></i><%= t('progressDistribution') %>
                </h3>
            </div>
            <div class="p-6" style="position: relative; height: 280px;">
                <canvas id="progressChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Performance Tables -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <!-- Top Performing Courses -->
        <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-100">
                <h3 class="text-lg font-semibold text-gray-900">
                    <i class="fas fa-trophy text-yellow-500 mr-2"></i><%= t('topPerformingCourses') %>
                </h3>
                <p class="text-sm text-gray-500 mt-1"><%= t('basedOnCompletionAndRating') %></p>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase"><%= t('rank') %></th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase"><%= t('course') %></th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase"><%= t('completion') %></th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase"><%= t('rating') %></th>
                        </tr>
                    </thead>
                    <tbody id="top-courses-table" class="bg-white divide-y divide-gray-100">
                        <!-- Dynamic content -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Courses Needing Attention -->
        <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-100">
                <h3 class="text-lg font-semibold text-gray-900">
                    <i class="fas fa-exclamation-triangle text-orange-500 mr-2"></i><%= t('coursesNeedingAttention') %>
                </h3>
                <p class="text-sm text-gray-500 mt-1"><%= t('lowCompletionOrRating') %></p>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase"><%= t('course') %></th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase"><%= t('issue') %></th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase"><%= t('value') %></th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase"><%= t('action') %></th>
                        </tr>
                    </thead>
                    <tbody id="attention-courses-table" class="bg-white divide-y divide-gray-100">
                        <!-- Dynamic content -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Instructor Performance -->
    <div class="bg-white rounded-xl border border-gray-200 overflow-hidden mb-6">
        <div class="px-6 py-4 border-b border-gray-100">
            <h3 class="text-lg font-semibold text-gray-900">
                <i class="fas fa-chalkboard-teacher mr-2" style="color: <%= systemSettings.primary_color || '#3b82f6' %>;"></i><%= t('instructorPerformance') %>
            </h3>
            <p class="text-sm text-gray-500 mt-1"><%= t('instructorPerformanceDesc') %></p>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase cursor-pointer" onclick="sortInstructors('name')">
                            <%= t('instructor') %> <i class="fas fa-sort ml-1"></i>
                        </th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase cursor-pointer" onclick="sortInstructors('courses')">
                            <%= t('coursesCreated') %> <i class="fas fa-sort ml-1"></i>
                        </th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase cursor-pointer" onclick="sortInstructors('enrollments')">
                            <%= t('totalEnrollments') %> <i class="fas fa-sort ml-1"></i>
                        </th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase cursor-pointer" onclick="sortInstructors('completion')">
                            <%= t('avgCompletion') %> <i class="fas fa-sort ml-1"></i>
                        </th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase cursor-pointer" onclick="sortInstructors('rating')">
                            <%= t('avgRating') %> <i class="fas fa-sort ml-1"></i>
                        </th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase"><%= t('actions') %></th>
                    </tr>
                </thead>
                <tbody id="instructors-table" class="bg-white divide-y divide-gray-100">
                    <!-- Dynamic content -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Detailed Course Analysis -->
    <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-100">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                <div>
                    <h3 class="text-lg font-semibold text-gray-900">
                        <i class="fas fa-table mr-2" style="color: <%= systemSettings.secondary_color || '#10b981' %>;"></i><%= t('detailedCourseAnalysis') %>
                    </h3>
                    <p class="text-sm text-gray-500 mt-1"><%= t('completeCourseMetrics') %></p>
                </div>
                <div class="flex flex-wrap gap-3">
                    <select id="course-category-filter" class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500">
                        <option value=""><%= t('allCategories') %></option>
                    </select>
                    <select id="instructor-filter" class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500">
                        <option value=""><%= t('allInstructors') %></option>
                    </select>
                    <div class="relative">
                        <input type="text" id="search-courses" placeholder="<%= t('searchCourses') %>"
                               class="pl-9 pr-4 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 w-48">
                        <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 text-sm"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase cursor-pointer" onclick="sortCourses('title')">
                            <%= t('course') %> <i class="fas fa-sort ml-1"></i>
                        </th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase cursor-pointer" onclick="sortCourses('instructor')">
                            <%= t('instructor') %> <i class="fas fa-sort ml-1"></i>
                        </th>
                        <th class="px-4 py-3 text-center text-xs font-semibold text-gray-500 uppercase cursor-pointer" onclick="sortCourses('enrollments')">
                            <%= t('enrollments') %> <i class="fas fa-sort ml-1"></i>
                        </th>
                        <th class="px-4 py-3 text-center text-xs font-semibold text-gray-500 uppercase cursor-pointer" onclick="sortCourses('active')">
                            <%= t('activeStudents') %> <i class="fas fa-sort ml-1"></i>
                        </th>
                        <th class="px-4 py-3 text-center text-xs font-semibold text-gray-500 uppercase cursor-pointer" onclick="sortCourses('completion')">
                            <%= t('completionRate') %> <i class="fas fa-sort ml-1"></i>
                        </th>
                        <th class="px-4 py-3 text-center text-xs font-semibold text-gray-500 uppercase cursor-pointer" onclick="sortCourses('rating')">
                            <%= t('rating') %> <i class="fas fa-sort ml-1"></i>
                        </th>
                        <th class="px-4 py-3 text-center text-xs font-semibold text-gray-500 uppercase"><%= t('actions') %></th>
                    </tr>
                </thead>
                <tbody id="courses-analysis-table" class="bg-white divide-y divide-gray-100">
                    <!-- Dynamic content -->
                </tbody>
            </table>
        </div>
        <div class="px-6 py-4 border-t border-gray-100 bg-gray-50">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                <span class="text-sm text-gray-600">
                    <%= t('showing') %> <span id="showing-from" class="font-semibold">1</span> <%= t('to') %> <span id="showing-to" class="font-semibold">10</span> <%= t('of') %> <span id="total-courses-count" class="font-semibold">0</span> <%= t('courses') %>
                </span>
                <div class="flex items-center space-x-2">
                    <button onclick="previousPage()" class="px-3 py-1.5 border rounded-lg text-sm bg-white hover:bg-gray-50 text-gray-700" id="prev-btn" disabled>
                        <i class="fas fa-chevron-left mr-1"></i><%= t('previous') %>
                    </button>
                    <span class="px-4 py-1.5 rounded-lg text-sm font-medium text-white" style="background: <%= systemSettings.primary_color || '#3b82f6' %>;">
                        <span id="current-page">1</span> / <span id="total-pages">1</span>
                    </span>
                    <button onclick="nextPage()" class="px-3 py-1.5 border rounded-lg text-sm bg-white hover:bg-gray-50 text-gray-700" id="next-btn">
                        <%= t('next') %> <i class="fas fa-chevron-right ml-1"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-xl p-6 flex items-center space-x-4">
        <div class="animate-spin rounded-full h-10 w-10 border-4 border-t-transparent" style="border-color: <%= systemSettings.primary_color || '#3b82f6' %>; border-top-color: transparent;"></div>
        <span class="text-gray-700 font-medium"><%= t('loadingData') %></span>
    </div>
</div>

<style>
.trend-btn {
    padding: 4px 12px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    background: white;
    color: #6b7280;
    font-size: 0.75rem;
    cursor: pointer;
    transition: all 0.2s;
}
.trend-btn.active {
    background: <%= systemSettings.primary_color || '#3b82f6' %>;
    color: white;
    border-color: <%= systemSettings.primary_color || '#3b82f6' %>;
}
.trend-btn:hover:not(.active) {
    background: #f9fafb;
}
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// i18n strings
const i18n = {
    noDataAvailable: '<%= t("noDataAvailable") %>',
    allCoursesPerformingWell: '<%= t("allCoursesPerformingWell") %>',
    newEnrollments: '<%= t("newEnrollments") %>',
    numberOfStudents: '<%= t("numberOfStudents") %>',
    lowCompletion: '<%= t("lowCompletion") %>',
    lowRating: '<%= t("lowRating") %>',
    lowEngagement: '<%= t("lowEngagement") %>',
    view: '<%= t("view") %>',
    feedback: '<%= t("feedback") %>',
    details: '<%= t("details") %>',
    analyze: '<%= t("analyze") %>',
    exportSuccess: '<%= t("exportSuccess") %>',
    exportFailed: '<%= t("exportFailed") %>',
    errorLoadingData: '<%= t("errorLoadingData") %>',
    noChange: '<%= t("noChange") %>',
    free: '<%= t("free") %>'
};

const primaryColor = '<%= systemSettings.primary_color || "#3b82f6" %>';
const secondaryColor = '<%= systemSettings.secondary_color || "#10b981" %>';

let analyticsData = {};
let charts = {};
let currentPage = 1;
let itemsPerPage = 10;
let sortField = '';
let sortDirection = 'asc';
let enrollmentView = 'daily';

document.addEventListener('DOMContentLoaded', function() {
    loadAnalytics();
    document.getElementById('time-period').addEventListener('change', loadAnalytics);
    document.getElementById('search-courses').addEventListener('input', debounce(filterCourses, 500));
    document.getElementById('course-category-filter').addEventListener('change', filterCourses);
    document.getElementById('instructor-filter').addEventListener('change', filterCourses);
});

async function loadAnalytics() {
    showLoading(true);
    try {
        const timePeriod = document.getElementById('time-period').value;
        const response = await fetch(`/reports/api/course-analytics?timePeriod=${timePeriod}`);
        const data = await response.json();

        if (data.success) {
            analyticsData = data.data;
            updateOverviewCards();
            initializeCharts();
            loadTopCourses();
            loadAttentionCourses();
            loadInstructorPerformance();
            loadCourseAnalysis();
            loadFilterOptions();
        } else {
            showToast(i18n.errorLoadingData, 'error');
        }
    } catch (error) {
        console.error('Error loading analytics:', error);
        showToast(i18n.errorLoadingData, 'error');
    } finally {
        showLoading(false);
    }
}

function updateOverviewCards() {
    document.getElementById('total-courses').textContent = analyticsData.overview?.totalCourses || 0;
    document.getElementById('total-enrollments').textContent = analyticsData.overview?.totalEnrollments || 0;
    document.getElementById('completion-rate').textContent = (analyticsData.overview?.completionRate || 0) + '%';
    document.getElementById('average-rating').textContent = (analyticsData.overview?.averageRating || 0).toFixed(1);
}

function initializeCharts() {
    Object.values(charts).forEach(chart => chart.destroy());
    charts = {};

    // Enrollment Trends Chart
    const enrollmentCtx = document.getElementById('enrollmentChart').getContext('2d');
    charts.enrollment = new Chart(enrollmentCtx, {
        type: 'line',
        data: {
            labels: analyticsData.enrollment?.[enrollmentView]?.labels || [],
            datasets: [{
                label: i18n.newEnrollments,
                data: analyticsData.enrollment?.[enrollmentView]?.data || [],
                borderColor: primaryColor,
                backgroundColor: primaryColor + '20',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { y: { beginAtZero: true } },
            plugins: { legend: { display: false } }
        }
    });

    // Completion Rates Chart
    const completionCtx = document.getElementById('completionChart').getContext('2d');
    charts.completion = new Chart(completionCtx, {
        type: 'doughnut',
        data: {
            labels: analyticsData.completion?.categories || [],
            datasets: [{
                data: analyticsData.completion?.rates || [],
                backgroundColor: [primaryColor, secondaryColor, '#F59E0B', '#EF4444', '#8B5CF6', '#06B6D4', '#84CC16', '#F97316']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'bottom' } }
        }
    });

    // Engagement Chart
    const engagementCtx = document.getElementById('engagementChart').getContext('2d');
    charts.engagement = new Chart(engagementCtx, {
        type: 'radar',
        data: {
            labels: ['Video Views', 'Quiz Attempts', 'Downloads', 'Forum Posts', 'Time Spent', 'Assignments'],
            datasets: [{
                label: 'Engagement',
                data: analyticsData.engagement?.scores || [0, 0, 0, 0, 0, 0],
                borderColor: secondaryColor,
                backgroundColor: secondaryColor + '30',
                pointBackgroundColor: secondaryColor
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { r: { beginAtZero: true, max: 100 } }
        }
    });

    // Progress Distribution Chart
    const progressCtx = document.getElementById('progressChart').getContext('2d');
    charts.progress = new Chart(progressCtx, {
        type: 'bar',
        data: {
            labels: ['0-25%', '26-50%', '51-75%', '76-99%', '100%'],
            datasets: [{
                label: i18n.numberOfStudents,
                data: analyticsData.progressDistribution || [0, 0, 0, 0, 0],
                backgroundColor: ['#EF4444', '#F97316', '#EAB308', '#22C55E', secondaryColor]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { y: { beginAtZero: true } },
            plugins: { legend: { display: false } }
        }
    });
}

function changeEnrollmentView(view) {
    enrollmentView = view;
    document.querySelectorAll('.trend-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelector(`[data-view="${view}"]`).classList.add('active');

    if (charts.enrollment) {
        charts.enrollment.data.labels = analyticsData.enrollment?.[view]?.labels || [];
        charts.enrollment.data.datasets[0].data = analyticsData.enrollment?.[view]?.data || [];
        charts.enrollment.update();
    }
}

function loadTopCourses() {
    const tbody = document.getElementById('top-courses-table');
    tbody.innerHTML = '';
    const topCourses = analyticsData.topCourses || [];

    topCourses.forEach((course, index) => {
        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-50';
        row.innerHTML = `
            <td class="px-4 py-3 text-sm font-medium text-gray-900">
                ${index + 1} ${index === 0 ? '<i class="fas fa-crown text-yellow-500 ml-2"></i>' : ''}
            </td>
            <td class="px-4 py-3">
                <p class="text-sm font-medium text-gray-900">${course.title}</p>
                <p class="text-xs text-gray-500">${course.category}</p>
            </td>
            <td class="px-4 py-3 text-sm font-medium text-green-600">${course.completionRate}%</td>
            <td class="px-4 py-3 text-sm text-gray-900">
                <span class="mr-1">${course.rating.toFixed(1)}</span>
                <span class="text-yellow-400">${generateStarRating(course.rating)}</span>
            </td>
        `;
        tbody.appendChild(row);
    });

    if (topCourses.length === 0) {
        tbody.innerHTML = `<tr><td colspan="4" class="px-4 py-8 text-center text-gray-500">${i18n.noDataAvailable}</td></tr>`;
    }
}

function loadAttentionCourses() {
    const tbody = document.getElementById('attention-courses-table');
    tbody.innerHTML = '';
    const attentionCourses = analyticsData.attentionCourses || [];

    attentionCourses.forEach(course => {
        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-50';
        row.innerHTML = `
            <td class="px-4 py-3">
                <p class="text-sm font-medium text-gray-900">${course.title}</p>
                <p class="text-xs text-gray-500">${course.instructor}</p>
            </td>
            <td class="px-4 py-3">
                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${getIssueColor(course.issue)}">
                    ${course.issue}
                </span>
            </td>
            <td class="px-4 py-3 text-sm font-medium text-red-600">${course.value}</td>
            <td class="px-4 py-3 text-sm font-medium">
                <button onclick="analyzeCourse('${course.course_id}')" class="text-blue-600 hover:text-blue-900">${i18n.analyze}</button>
            </td>
        `;
        tbody.appendChild(row);
    });

    if (attentionCourses.length === 0) {
        tbody.innerHTML = `<tr><td colspan="4" class="px-4 py-8 text-center text-gray-500">${i18n.allCoursesPerformingWell}</td></tr>`;
    }
}

function getIssueColor(issue) {
    switch (issue.toLowerCase()) {
        case 'low completion': return 'bg-red-100 text-red-800';
        case 'low rating': return 'bg-orange-100 text-orange-800';
        case 'low engagement': return 'bg-yellow-100 text-yellow-800';
        default: return 'bg-gray-100 text-gray-800';
    }
}

function loadInstructorPerformance() {
    const tbody = document.getElementById('instructors-table');
    tbody.innerHTML = '';
    const instructors = analyticsData.instructors || [];

    instructors.forEach(instructor => {
        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-50';
        row.innerHTML = `
            <td class="px-4 py-3">
                <div class="flex items-center">
                    <img class="h-8 w-8 rounded-full object-cover" src="${instructor.avatar || '/images/default-avatar.png'}" alt="" onerror="this.src='/images/default-avatar.png'">
                    <div class="ml-3">
                        <p class="text-sm font-medium text-gray-900">${instructor.name}</p>
                        <p class="text-xs text-gray-500">${instructor.department || '-'}</p>
                    </div>
                </div>
            </td>
            <td class="px-4 py-3 text-sm text-gray-900">${instructor.coursesCount}</td>
            <td class="px-4 py-3 text-sm text-gray-900">${instructor.totalEnrollments}</td>
            <td class="px-4 py-3 text-sm font-medium ${instructor.avgCompletion >= 70 ? 'text-green-600' : instructor.avgCompletion >= 50 ? 'text-yellow-600' : 'text-red-600'}">
                ${instructor.avgCompletion.toFixed(1)}%
            </td>
            <td class="px-4 py-3 text-sm text-gray-900">
                ${instructor.avgRating.toFixed(1)} <span class="text-yellow-400">${generateStarRating(instructor.avgRating)}</span>
            </td>
            <td class="px-4 py-3 text-sm font-medium">
                <button onclick="viewInstructorDetails('${instructor.user_id}')" class="text-blue-600 hover:text-blue-900 mr-2">${i18n.view}</button>
            </td>
        `;
        tbody.appendChild(row);
    });

    if (instructors.length === 0) {
        tbody.innerHTML = `<tr><td colspan="6" class="px-4 py-8 text-center text-gray-500">${i18n.noDataAvailable}</td></tr>`;
    }
}

function loadCourseAnalysis() {
    const tbody = document.getElementById('courses-analysis-table');
    tbody.innerHTML = '';
    const courses = analyticsData.coursesDetailed || [];
    const start = (currentPage - 1) * itemsPerPage;
    const end = start + itemsPerPage;
    const paginatedCourses = courses.slice(start, end);

    paginatedCourses.forEach(course => {
        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-50';
        row.innerHTML = `
            <td class="px-4 py-3">
                <p class="text-sm font-medium text-gray-900">${course.title}</p>
                <p class="text-xs text-gray-500">${course.category}</p>
            </td>
            <td class="px-4 py-3 text-sm text-gray-500">${course.instructor}</td>
            <td class="px-4 py-3 text-sm text-center text-gray-900">${course.enrollments}</td>
            <td class="px-4 py-3 text-sm text-center text-gray-900">${course.activeStudents}</td>
            <td class="px-4 py-3 text-sm text-center font-medium ${course.completionRate >= 70 ? 'text-green-600' : course.completionRate >= 50 ? 'text-yellow-600' : 'text-red-600'}">
                ${course.completionRate}%
            </td>
            <td class="px-4 py-3 text-sm text-center text-gray-900">
                ${course.rating.toFixed(1)} <span class="text-yellow-400 text-xs">${generateStarRating(course.rating)}</span>
            </td>
            <td class="px-4 py-3 text-sm text-center font-medium">
                <button onclick="viewCourseDetails('${course.course_id}')" class="text-blue-600 hover:text-blue-900">${i18n.details}</button>
            </td>
        `;
        tbody.appendChild(row);
    });

    if (paginatedCourses.length === 0) {
        tbody.innerHTML = `<tr><td colspan="7" class="px-4 py-8 text-center text-gray-500">${i18n.noDataAvailable}</td></tr>`;
    }

    updatePagination(courses.length);
}

function loadFilterOptions() {
    const categorySelect = document.getElementById('course-category-filter');
    const categories = [...new Set((analyticsData.coursesDetailed || []).map(c => c.category))];
    categorySelect.innerHTML = '<option value=""><%= t("allCategories") %></option>';
    categories.forEach(category => {
        categorySelect.innerHTML += `<option value="${category}">${category}</option>`;
    });

    const instructorSelect = document.getElementById('instructor-filter');
    const instructors = [...new Set((analyticsData.coursesDetailed || []).map(c => c.instructor))];
    instructorSelect.innerHTML = '<option value=""><%= t("allInstructors") %></option>';
    instructors.forEach(instructor => {
        instructorSelect.innerHTML += `<option value="${instructor}">${instructor}</option>`;
    });
}

function generateStarRating(rating) {
    const fullStars = Math.floor(rating);
    const hasHalfStar = rating % 1 >= 0.5;
    let html = '';
    for (let i = 0; i < fullStars; i++) html += '<i class="fas fa-star"></i>';
    if (hasHalfStar) html += '<i class="fas fa-star-half-alt"></i>';
    const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);
    for (let i = 0; i < emptyStars; i++) html += '<i class="far fa-star"></i>';
    return html;
}

function updatePagination(totalItems) {
    const totalPages = Math.ceil(totalItems / itemsPerPage);
    document.getElementById('showing-from').textContent = totalItems === 0 ? 0 : (currentPage - 1) * itemsPerPage + 1;
    document.getElementById('showing-to').textContent = Math.min(currentPage * itemsPerPage, totalItems);
    document.getElementById('total-courses-count').textContent = totalItems;
    document.getElementById('current-page').textContent = currentPage;
    document.getElementById('total-pages').textContent = totalPages || 1;
    document.getElementById('prev-btn').disabled = currentPage <= 1;
    document.getElementById('next-btn').disabled = currentPage >= totalPages;
}

function sortCourses(field) {
    if (sortField === field) sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
    else { sortField = field; sortDirection = 'asc'; }

    analyticsData.coursesDetailed.sort((a, b) => {
        let aVal = a[field], bVal = b[field];
        if (typeof aVal === 'string') { aVal = aVal.toLowerCase(); bVal = bVal.toLowerCase(); }
        return sortDirection === 'asc' ? (aVal > bVal ? 1 : -1) : (aVal < bVal ? 1 : -1);
    });
    loadCourseAnalysis();
}

function sortInstructors(field) {
    analyticsData.instructors.sort((a, b) => {
        let aVal = a[field], bVal = b[field];
        if (typeof aVal === 'string') { aVal = aVal.toLowerCase(); bVal = bVal.toLowerCase(); }
        return aVal > bVal ? 1 : -1;
    });
    loadInstructorPerformance();
}

function filterCourses() {
    const searchTerm = document.getElementById('search-courses').value.toLowerCase();
    const categoryFilter = document.getElementById('course-category-filter').value;
    const instructorFilter = document.getElementById('instructor-filter').value;

    let filtered = analyticsData.coursesDetailed || [];
    if (searchTerm) filtered = filtered.filter(c => c.title.toLowerCase().includes(searchTerm) || c.instructor.toLowerCase().includes(searchTerm));
    if (categoryFilter) filtered = filtered.filter(c => c.category === categoryFilter);
    if (instructorFilter) filtered = filtered.filter(c => c.instructor === instructorFilter);

    analyticsData.coursesDetailed = filtered;
    currentPage = 1;
    loadCourseAnalysis();
}

function previousPage() { if (currentPage > 1) { currentPage--; loadCourseAnalysis(); } }
function nextPage() {
    const totalPages = Math.ceil((analyticsData.coursesDetailed || []).length / itemsPerPage);
    if (currentPage < totalPages) { currentPage++; loadCourseAnalysis(); }
}

function refreshAnalytics() { loadAnalytics(); }

async function exportAnalytics() {
    showLoading(true);
    try {
        const timePeriod = document.getElementById('time-period').value;
        const response = await fetch(`/reports/api/course-analytics/export?timePeriod=${timePeriod}`);
        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `course-analytics-${new Date().toISOString().split('T')[0]}.xlsx`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            a.remove();
            showToast(i18n.exportSuccess);
        } else {
            showToast(i18n.exportFailed, 'error');
        }
    } catch (error) {
        showToast(i18n.exportFailed, 'error');
    } finally {
        showLoading(false);
    }
}

function viewCourseDetails(courseId) { window.open(`/courses/${courseId}`, '_blank'); }
function analyzeCourse(courseId) { window.location.href = `/reports/course-analysis/${courseId}`; }
function viewInstructorDetails(instructorId) { window.open(`/users/${instructorId}`, '_blank'); }

function showLoading(show) { document.getElementById('loading-overlay').classList.toggle('hidden', !show); }

function showToast(message, type = 'success') {
    const toast = document.createElement('div');
    toast.className = `fixed top-4 right-4 ${type === 'error' ? 'bg-red-500' : 'bg-green-500'} text-white px-6 py-3 rounded-lg shadow-lg z-50`;
    toast.innerHTML = `<i class="fas fa-${type === 'error' ? 'exclamation-circle' : 'check-circle'} mr-2"></i>${message}`;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}

function debounce(func, wait) {
    let timeout;
    return function(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func(...args), wait);
    };
}
</script>
