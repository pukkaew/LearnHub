<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Header -->
    <div id="mainHeader" class="rounded-2xl p-6 mb-8 text-white shadow-lg" style="background: linear-gradient(to right, <%= systemSettings.primary_color || '#3b82f6' %>, <%= systemSettings.secondary_color || '#10b981' %>);">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
            <div>
                <h1 class="text-3xl font-bold text-white">
                    <i class="fas fa-clipboard-list mr-3"></i>รายงานการลงทะเบียนหลักสูตร
                </h1>
                <p class="text-white/80 mt-1">ติดตามการลงทะเบียนและความก้าวหน้าของผู้เรียนในแต่ละหลักสูตร</p>
            </div>
            <div class="flex space-x-3 mt-4 md:mt-0">
                <button onclick="exportReport()" class="bg-white/20 hover:bg-white/30 backdrop-blur-sm text-white font-medium py-2 px-4 rounded-lg transition-all duration-200 flex items-center">
                    <i class="fas fa-file-excel mr-2"></i>Export Excel
                </button>
                <button onclick="refreshData()" class="bg-white/20 hover:bg-white/30 backdrop-blur-sm text-white font-medium py-2 px-4 rounded-lg transition-all duration-200 flex items-center">
                    <i class="fas fa-sync-alt mr-2"></i>รีเฟรช
                </button>
            </div>
        </div>
    </div>

    <!-- Selected Course Hero Section (Hidden by default) -->
    <div id="selectedCourseHero" class="hidden mb-8">
        <div class="rounded-2xl shadow-2xl overflow-hidden" style="background: linear-gradient(135deg, <%= systemSettings.primary_color || '#3b82f6' %>, <%= systemSettings.secondary_color || '#10b981' %>);">
            <!-- Back Button & Course Badge -->
            <div class="px-6 pt-4 flex justify-between items-center">
                <button onclick="clearFilters()" class="flex items-center text-white/80 hover:text-white transition-colors">
                    <i class="fas fa-arrow-left mr-2"></i>
                    <span>กลับไปดูทุกหลักสูตร</span>
                </button>
                <span id="heroBadge" class="px-3 py-1 bg-white/20 rounded-full text-white text-sm font-medium"></span>
            </div>

            <!-- Course Info -->
            <div class="p-6 md:p-8">
                <div class="flex flex-col lg:flex-row gap-6">
                    <!-- Course Thumbnail -->
                    <div class="flex-shrink-0">
                        <div class="w-full lg:w-64 h-40 lg:h-36 rounded-xl overflow-hidden bg-white/10 backdrop-blur">
                            <img id="heroThumbnail" src="/images/course-default.svg" alt="Course" class="w-full h-full object-cover" onerror="this.onerror=null; this.src='/images/course-default.svg'">
                        </div>
                    </div>

                    <!-- Course Details -->
                    <div class="flex-1 text-white">
                        <h2 id="heroTitle" class="text-2xl md:text-3xl font-bold mb-2"></h2>
                        <div class="flex flex-wrap gap-4 text-white/80 text-sm mb-4">
                            <span id="heroInstructor"><i class="fas fa-user-tie mr-1"></i></span>
                            <span id="heroDuration"><i class="fas fa-clock mr-1"></i></span>
                            <span id="heroLevel"><i class="fas fa-signal mr-1"></i></span>
                        </div>

                        <!-- Progress Overview -->
                        <div class="bg-white/10 backdrop-blur rounded-xl p-4 mb-4">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-white/80">ความก้าวหน้าเฉลี่ยของผู้เรียน</span>
                                <span id="heroProgress" class="text-2xl font-bold">0%</span>
                            </div>
                            <div class="h-3 bg-white/20 rounded-full overflow-hidden">
                                <div id="heroProgressBar" class="h-full bg-gradient-to-r from-green-400 to-emerald-500 rounded-full transition-all duration-500" style="width: 0%"></div>
                            </div>
                        </div>

                        <!-- Quick Stats Grid -->
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                            <div class="bg-white/10 backdrop-blur rounded-lg p-3 text-center">
                                <p id="heroEnrollments" class="text-2xl font-bold">0</p>
                                <p class="text-xs text-white/70">ลงทะเบียนทั้งหมด</p>
                            </div>
                            <div class="bg-white/10 backdrop-blur rounded-lg p-3 text-center">
                                <p id="heroInProgress" class="text-2xl font-bold text-yellow-300">0</p>
                                <p class="text-xs text-white/70">กำลังเรียน</p>
                            </div>
                            <div class="bg-white/10 backdrop-blur rounded-lg p-3 text-center">
                                <p id="heroCompleted" class="text-2xl font-bold text-green-300">0</p>
                                <p class="text-xs text-white/70">เรียนจบแล้ว</p>
                            </div>
                            <div class="bg-white/10 backdrop-blur rounded-lg p-3 text-center">
                                <p id="heroCompletionRate" class="text-2xl font-bold text-blue-300">0%</p>
                                <p class="text-xs text-white/70">อัตราสำเร็จ</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Overview Cards (Show when no course selected) -->
    <div id="overviewCards" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-8">
        <div class="bg-white rounded-xl shadow-sm p-5 border-l-4 border-blue-500">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs font-medium text-gray-500 uppercase tracking-wider">หลักสูตรทั้งหมด</p>
                    <p class="text-2xl font-bold text-gray-900 mt-1" id="totalCourses">0</p>
                </div>
                <div class="p-3 bg-blue-100 rounded-full">
                    <i class="fas fa-book text-blue-600"></i>
                </div>
            </div>
        </div>
        <div class="bg-white rounded-xl shadow-sm p-5 border-l-4 border-green-500">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs font-medium text-gray-500 uppercase tracking-wider">ลงทะเบียนทั้งหมด</p>
                    <p class="text-2xl font-bold text-gray-900 mt-1" id="totalEnrollments">0</p>
                </div>
                <div class="p-3 bg-green-100 rounded-full">
                    <i class="fas fa-user-plus text-green-600"></i>
                </div>
            </div>
        </div>
        <div class="bg-white rounded-xl shadow-sm p-5 border-l-4 border-yellow-500">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs font-medium text-gray-500 uppercase tracking-wider">กำลังเรียน</p>
                    <p class="text-2xl font-bold text-gray-900 mt-1" id="activeEnrollments">0</p>
                </div>
                <div class="p-3 bg-yellow-100 rounded-full">
                    <i class="fas fa-spinner text-yellow-600"></i>
                </div>
            </div>
        </div>
        <div class="bg-white rounded-xl shadow-sm p-5 border-l-4 border-emerald-500">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs font-medium text-gray-500 uppercase tracking-wider">เรียนจบแล้ว</p>
                    <p class="text-2xl font-bold text-gray-900 mt-1" id="completedEnrollments">0</p>
                </div>
                <div class="p-3 bg-emerald-100 rounded-full">
                    <i class="fas fa-check-circle text-emerald-600"></i>
                </div>
            </div>
        </div>
        <div class="bg-white rounded-xl shadow-sm p-5 border-l-4 border-purple-500">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs font-medium text-gray-500 uppercase tracking-wider">ความก้าวหน้าเฉลี่ย</p>
                    <p class="text-2xl font-bold text-gray-900 mt-1" id="avgProgress">0%</p>
                </div>
                <div class="p-3 bg-purple-100 rounded-full">
                    <i class="fas fa-chart-line text-purple-600"></i>
                </div>
            </div>
        </div>
        <div class="bg-white rounded-xl shadow-sm p-5 border-l-4 border-indigo-500">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs font-medium text-gray-500 uppercase tracking-wider">อัตราสำเร็จ</p>
                    <p class="text-2xl font-bold text-gray-900 mt-1" id="completionRate">0%</p>
                </div>
                <div class="p-3 bg-indigo-100 rounded-full">
                    <i class="fas fa-trophy text-indigo-600"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="bg-white rounded-xl shadow-sm p-6 mb-8">
        <h3 class="text-lg font-semibold text-gray-900 mb-4"><i class="fas fa-filter mr-2 text-gray-400"></i>ตัวกรองข้อมูล</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">หลักสูตร</label>
                <select id="filterCourse" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="">ทุกหลักสูตร</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">แผนก</label>
                <select id="filterDepartment" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="">ทุกแผนก</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">สถานะ</label>
                <select id="filterStatus" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="">ทุกสถานะ</option>
                    <option value="Active">กำลังเรียน</option>
                    <option value="In Progress">กำลังดำเนินการ</option>
                    <option value="Completed">เสร็จสิ้น</option>
                    <option value="Dropped">ยกเลิก</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">วันที่เริ่มต้น</label>
                <input type="date" id="filterDateFrom" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">วันที่สิ้นสุด</label>
                <input type="date" id="filterDateTo" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
            </div>
        </div>
        <div class="mt-4 flex justify-between items-center">
            <div class="flex-1 max-w-md">
                <div class="relative">
                    <input type="text" id="searchInput" placeholder="ค้นหาชื่อ, รหัสพนักงาน หรืออีเมล..."
                           class="w-full border border-gray-300 rounded-lg pl-10 pr-4 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                    <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                </div>
            </div>
            <div class="flex space-x-3">
                <button onclick="applyFilters()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-4 rounded-lg transition-all duration-200">
                    <i class="fas fa-search mr-2"></i>กรองข้อมูล
                </button>
                <button onclick="clearFilters()" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-2 px-4 rounded-lg transition-all duration-200">
                    <i class="fas fa-times mr-2"></i>ล้างตัวกรอง
                </button>
            </div>
        </div>
    </div>

    <!-- Charts Section (Show when course selected) -->
    <div id="courseDetailCharts" class="hidden grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <!-- Enrollment Timeline Chart -->
        <div class="bg-white rounded-xl shadow-sm p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4"><i class="fas fa-chart-line mr-2 text-blue-500"></i>การลงทะเบียนรายเดือน</h3>
            <div style="position: relative; height: 280px;">
                <canvas id="enrollmentTimelineChart"></canvas>
            </div>
        </div>

        <!-- Progress Distribution for Selected Course -->
        <div class="bg-white rounded-xl shadow-sm p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4"><i class="fas fa-chart-pie mr-2 text-purple-500"></i>การกระจายความก้าวหน้า</h3>
            <div style="position: relative; height: 280px;">
                <canvas id="courseProgressChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Charts Section (Show when no course selected) -->
    <div id="overviewCharts" class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <!-- Progress Distribution Chart -->
        <div class="bg-white rounded-xl shadow-sm p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4"><i class="fas fa-chart-pie mr-2 text-indigo-500"></i>การกระจายความก้าวหน้า</h3>
            <div style="position: relative; height: 280px;">
                <canvas id="progressChart"></canvas>
            </div>
        </div>

        <!-- Department Enrollments Chart -->
        <div class="bg-white rounded-xl shadow-sm p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4"><i class="fas fa-building mr-2 text-green-500"></i>การลงทะเบียนตามแผนก</h3>
            <div style="position: relative; height: 280px;">
                <canvas id="departmentChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Learner Progress Leaderboard (Show when course selected) -->
    <div id="learnerLeaderboard" class="hidden bg-white rounded-xl shadow-sm p-6 mb-8">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-lg font-semibold text-gray-900"><i class="fas fa-medal mr-2 text-yellow-500"></i>อันดับผู้เรียน</h3>
            <div class="flex space-x-2">
                <button onclick="sortLeaderboard('progress')" class="leaderboard-sort-btn active px-3 py-1 rounded-lg text-sm" data-sort="progress">
                    ความก้าวหน้า
                </button>
                <button onclick="sortLeaderboard('recent')" class="leaderboard-sort-btn px-3 py-1 rounded-lg text-sm" data-sort="recent">
                    ล่าสุด
                </button>
            </div>
        </div>
        <div id="leaderboardContainer" class="space-y-3">
            <!-- Leaderboard items will be loaded here -->
        </div>
    </div>

    <!-- Course Summary Cards (Show when no course selected) -->
    <div id="courseSummarySection" class="bg-white rounded-xl shadow-sm p-6 mb-8">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-lg font-semibold text-gray-900"><i class="fas fa-book-open mr-2 text-blue-500"></i>สรุปรายหลักสูตร</h3>
            <div class="flex items-center space-x-2">
                <span class="text-sm text-gray-500">เรียงตาม:</span>
                <select id="courseSortBy" class="border border-gray-300 rounded-lg px-3 py-1 text-sm focus:ring-2 focus:ring-indigo-500" onchange="sortCourses()">
                    <option value="enrollments">จำนวนลงทะเบียน</option>
                    <option value="completion">อัตราสำเร็จ</option>
                    <option value="progress">ความก้าวหน้า</option>
                    <option value="name">ชื่อหลักสูตร</option>
                </select>
            </div>
        </div>
        <div id="courseSummaryContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <!-- Course cards will be loaded here -->
        </div>
    </div>

    <!-- Enrollment Timeline (Show when course selected) -->
    <div id="enrollmentTimeline" class="hidden bg-white rounded-xl shadow-sm p-6 mb-8">
        <h3 class="text-lg font-semibold text-gray-900 mb-6"><i class="fas fa-history mr-2 text-indigo-500"></i>ประวัติการลงทะเบียน</h3>
        <div id="timelineContainer" class="relative">
            <!-- Timeline items will be loaded here -->
        </div>
    </div>

    <!-- Detailed Enrollments Table -->
    <div class="bg-white rounded-xl shadow-sm overflow-hidden">
        <div class="p-6 border-b border-gray-200">
            <div class="flex justify-between items-center">
                <div>
                    <h3 id="tableTitle" class="text-lg font-semibold text-gray-900"><i class="fas fa-users mr-2 text-purple-500"></i>รายละเอียดผู้ลงทะเบียน</h3>
                    <p class="text-sm text-gray-500 mt-1">แสดง <span id="showingCount">0</span> รายการ</p>
                </div>
                <div class="flex items-center space-x-2">
                    <button onclick="toggleView('table')" id="viewTable" class="view-btn active px-3 py-2 rounded-lg text-sm">
                        <i class="fas fa-list"></i>
                    </button>
                    <button onclick="toggleView('cards')" id="viewCards" class="view-btn px-3 py-2 rounded-lg text-sm">
                        <i class="fas fa-th-large"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Table View -->
        <div id="tableView" class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider w-12">
                            #
                        </th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortTable('employee_id')">
                            พนักงาน <i class="fas fa-sort ml-1 text-gray-400"></i>
                        </th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortTable('division')">
                            ฝ่าย <i class="fas fa-sort ml-1 text-gray-400"></i>
                        </th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortTable('department')">
                            แผนก <i class="fas fa-sort ml-1 text-gray-400"></i>
                        </th>
                        <th id="courseColumn" class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortTable('course')">
                            หลักสูตร <i class="fas fa-sort ml-1 text-gray-400"></i>
                        </th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortTable('enrollment_date')">
                            ลงทะเบียน <i class="fas fa-sort ml-1 text-gray-400"></i>
                        </th>
                        <th class="px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider cursor-pointer hover:bg-gray-100 w-32" onclick="sortTable('progress')">
                            ความก้าวหน้า <i class="fas fa-sort ml-1 text-gray-400"></i>
                        </th>
                        <th class="px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortTable('status')">
                            สถานะ <i class="fas fa-sort ml-1 text-gray-400"></i>
                        </th>
                        <th class="px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider w-24">
                            ดู
                        </th>
                    </tr>
                </thead>
                <tbody id="enrollmentsTableBody" class="bg-white divide-y divide-gray-200">
                    <!-- Data will be loaded here -->
                </tbody>
            </table>
        </div>

        <!-- Cards View (Hidden by default) -->
        <div id="cardsView" class="hidden p-6">
            <div id="enrollmentsCardsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Cards will be loaded here -->
            </div>
        </div>

        <!-- Pagination -->
        <div class="px-6 py-4 border-t border-gray-200 bg-gray-50">
            <div class="flex justify-between items-center">
                <div class="text-sm text-gray-700">
                    แสดง <span id="paginationFrom">0</span> - <span id="paginationTo">0</span> จาก <span id="paginationTotal">0</span> รายการ
                </div>
                <div class="flex items-center space-x-2">
                    <button onclick="previousPage()" id="prevBtn" disabled class="px-3 py-1 border border-gray-300 rounded-lg text-sm hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="fas fa-chevron-left mr-1"></i>ก่อนหน้า
                    </button>
                    <span class="px-3 py-1 text-sm">หน้า <span id="currentPage">1</span> / <span id="totalPages">1</span></span>
                    <button onclick="nextPage()" id="nextBtn" class="px-3 py-1 border border-gray-300 rounded-lg text-sm hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed">
                        ถัดไป<i class="fas fa-chevron-right ml-1"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- User Detail Modal -->
<div id="userDetailModal" class="hidden fixed inset-0 z-50 overflow-y-auto">
    <div class="flex items-center justify-center min-h-screen px-4">
        <div class="fixed inset-0 bg-black bg-opacity-50 transition-opacity" onclick="closeUserModal()"></div>
        <div class="relative bg-white rounded-2xl max-w-2xl w-full p-6 shadow-xl">
            <button onclick="closeUserModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <i class="fas fa-times text-xl"></i>
            </button>
            <div id="userDetailContent">
                <!-- User details will be loaded here -->
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-xl p-6 flex items-center space-x-4">
        <div class="animate-spin rounded-full h-10 w-10 border-4 border-indigo-600 border-t-transparent"></div>
        <span class="text-gray-700 font-medium">กำลังโหลดข้อมูล...</span>
    </div>
</div>

<style>
.view-btn {
    background: #f3f4f6;
    color: #6b7280;
    transition: all 0.2s;
}
.view-btn:hover {
    background: #e5e7eb;
}
.view-btn.active {
    background: #4f46e5;
    color: white;
}

.leaderboard-sort-btn {
    background: #f3f4f6;
    color: #6b7280;
    transition: all 0.2s;
}
.leaderboard-sort-btn:hover {
    background: #e5e7eb;
}
.leaderboard-sort-btn.active {
    background: #4f46e5;
    color: white;
}

.progress-bar-container {
    width: 100%;
    height: 8px;
    background: #e5e7eb;
    border-radius: 4px;
    overflow: hidden;
}
.progress-bar-fill {
    height: 100%;
    border-radius: 4px;
    transition: width 0.3s ease;
}

.status-badge {
    padding: 4px 12px;
    border-radius: 9999px;
    font-size: 12px;
    font-weight: 600;
}
.status-active { background: #fef3c7; color: #d97706; }
.status-in-progress { background: #dbeafe; color: #2563eb; }
.status-completed { background: #d1fae5; color: #059669; }
.status-dropped { background: #fee2e2; color: #dc2626; }

.course-card {
    transition: all 0.2s;
    border: 1px solid #e5e7eb;
}
.course-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
}

/* Timeline styles */
.timeline-item {
    position: relative;
    padding-left: 40px;
    padding-bottom: 24px;
}
.timeline-item:last-child {
    padding-bottom: 0;
}
.timeline-item::before {
    content: '';
    position: absolute;
    left: 15px;
    top: 24px;
    bottom: 0;
    width: 2px;
    background: #e5e7eb;
}
.timeline-item:last-child::before {
    display: none;
}
.timeline-dot {
    position: absolute;
    left: 8px;
    top: 4px;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    border: 3px solid;
}

/* Leaderboard item styles */
.leaderboard-item {
    transition: all 0.2s;
}
.leaderboard-item:hover {
    transform: translateX(4px);
}
.rank-badge {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 14px;
}
.rank-1 { background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); color: white; }
.rank-2 { background: linear-gradient(135deg, #9ca3af 0%, #6b7280 100%); color: white; }
.rank-3 { background: linear-gradient(135deg, #d97706 0%, #b45309 100%); color: white; }
.rank-default { background: #f3f4f6; color: #6b7280; }
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let reportData = null;
let charts = {};
let currentPage = 1;
let itemsPerPage = 15;
let sortField = 'enrollment_date';
let sortDirection = 'desc';
let currentFilters = {};
let selectedCourseId = null;

document.addEventListener('DOMContentLoaded', function() {
    loadReportData();

    // Enter key to search
    document.getElementById('searchInput').addEventListener('keyup', function(e) {
        if (e.key === 'Enter') applyFilters();
    });

    // Course filter change
    document.getElementById('filterCourse').addEventListener('change', function() {
        applyFilters();
    });
});

async function loadReportData() {
    showLoading(true);

    try {
        const params = new URLSearchParams(currentFilters);
        const response = await fetch(`/reports/api/course-enrollments?${params}`);
        const result = await response.json();

        if (result.success) {
            reportData = result.data;
            selectedCourseId = currentFilters.course_id || null;

            updateOverview();
            updateFilters();
            initializeCharts();
            renderCourseSummary();
            renderEnrollmentsTable();

            if (selectedCourseId) {
                renderLeaderboard();
                renderEnrollmentTimeline();
            }

            // Call after table is rendered so course-column elements exist
            updateUIForCourseSelection();
        } else {
            showError('ไม่สามารถโหลดข้อมูลได้');
        }
    } catch (error) {
        console.error('Error loading report data:', error);
        showError('เกิดข้อผิดพลาดในการโหลดข้อมูล');
    } finally {
        showLoading(false);
    }
}

function updateUIForCourseSelection() {
    const isSpecificCourse = selectedCourseId && reportData.courseSummary.length === 1;

    // Toggle UI sections
    document.getElementById('mainHeader').classList.toggle('hidden', isSpecificCourse);
    document.getElementById('selectedCourseHero').classList.toggle('hidden', !isSpecificCourse);
    document.getElementById('overviewCards').classList.toggle('hidden', isSpecificCourse);
    document.getElementById('overviewCharts').classList.toggle('hidden', isSpecificCourse);
    document.getElementById('courseDetailCharts').classList.toggle('hidden', !isSpecificCourse);
    document.getElementById('courseSummarySection').classList.toggle('hidden', isSpecificCourse);
    document.getElementById('learnerLeaderboard').classList.toggle('hidden', !isSpecificCourse);
    document.getElementById('enrollmentTimeline').classList.toggle('hidden', !isSpecificCourse);

    // Toggle course column in header
    document.getElementById('courseColumn').classList.toggle('hidden', isSpecificCourse);

    // Toggle course column in table body
    document.querySelectorAll('.course-column').forEach(td => {
        td.classList.toggle('hidden', isSpecificCourse);
    });

    // Update table title
    if (isSpecificCourse) {
        const course = reportData.courseSummary[0];
        document.getElementById('tableTitle').innerHTML = `<i class="fas fa-users mr-2 text-purple-500"></i>ผู้เรียนในหลักสูตร: ${course.course_title}`;

        // Update hero section
        updateCourseHero(course);
    } else {
        document.getElementById('tableTitle').innerHTML = '<i class="fas fa-users mr-2 text-purple-500"></i>รายละเอียดผู้ลงทะเบียน';
    }
}

function updateCourseHero(course) {
    document.getElementById('heroTitle').textContent = course.course_title;
    document.getElementById('heroThumbnail').src = course.thumbnail || '/images/course-default.svg';
    document.getElementById('heroBadge').textContent = course.category || 'ไม่ระบุหมวดหมู่';
    document.getElementById('heroInstructor').innerHTML = `<i class="fas fa-user-tie mr-1"></i>${course.instructor_name || 'ไม่ระบุผู้สอน'}`;
    document.getElementById('heroDuration').innerHTML = `<i class="fas fa-clock mr-1"></i>${course.duration_hours || 0} ชั่วโมง`;
    document.getElementById('heroLevel').innerHTML = `<i class="fas fa-signal mr-1"></i>${course.difficulty_level || 'ทั่วไป'}`;

    document.getElementById('heroProgress').textContent = course.avg_progress + '%';
    document.getElementById('heroProgressBar').style.width = course.avg_progress + '%';

    document.getElementById('heroEnrollments').textContent = course.total_enrollments;
    document.getElementById('heroInProgress').textContent = course.in_progress;
    document.getElementById('heroCompleted').textContent = course.completed;
    document.getElementById('heroCompletionRate').textContent = course.completion_rate + '%';
}

function updateOverview() {
    const overview = reportData.overview;
    document.getElementById('totalCourses').textContent = overview.totalCourses.toLocaleString();
    document.getElementById('totalEnrollments').textContent = overview.totalEnrollments.toLocaleString();
    document.getElementById('activeEnrollments').textContent = overview.activeEnrollments.toLocaleString();
    document.getElementById('completedEnrollments').textContent = overview.completedEnrollments.toLocaleString();
    document.getElementById('avgProgress').textContent = overview.avgProgress + '%';
    document.getElementById('completionRate').textContent = overview.completionRate + '%';
}

function updateFilters() {
    // Update course dropdown
    const courseSelect = document.getElementById('filterCourse');
    const currentValue = courseSelect.value;
    courseSelect.innerHTML = '<option value="">ทุกหลักสูตร</option>';
    reportData.courses.forEach(course => {
        const option = document.createElement('option');
        option.value = course.course_id;
        option.textContent = course.title;
        if (course.course_id == currentFilters.course_id) {
            option.selected = true;
        }
        courseSelect.appendChild(option);
    });

    // Update department dropdown
    const deptSelect = document.getElementById('filterDepartment');
    deptSelect.innerHTML = '<option value="">ทุกแผนก</option>';
    reportData.departments.forEach(dept => {
        const option = document.createElement('option');
        option.value = dept;
        option.textContent = dept;
        deptSelect.appendChild(option);
    });
}

function initializeCharts() {
    // Destroy existing charts
    Object.values(charts).forEach(chart => chart.destroy());
    charts = {};

    const isSpecificCourse = selectedCourseId && reportData.courseSummary.length === 1;

    if (isSpecificCourse) {
        // Course-specific charts
        initializeCourseDetailCharts();
    } else {
        // Overview charts
        initializeOverviewCharts();
    }
}

function initializeOverviewCharts() {
    // Progress Distribution Chart
    const progressCtx = document.getElementById('progressChart').getContext('2d');
    charts.progress = new Chart(progressCtx, {
        type: 'doughnut',
        data: {
            labels: reportData.charts.progressDistribution.labels,
            datasets: [{
                data: reportData.charts.progressDistribution.data,
                backgroundColor: [
                    '#94a3b8', '#f87171', '#fb923c', '#facc15', '#4ade80', '#22c55e'
                ],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom', labels: { padding: 15, usePointStyle: true } }
            }
        }
    });

    // Department Enrollments Chart
    const deptCtx = document.getElementById('departmentChart').getContext('2d');
    charts.department = new Chart(deptCtx, {
        type: 'bar',
        data: {
            labels: reportData.charts.departmentEnrollments.labels,
            datasets: [
                { label: 'ลงทะเบียน', data: reportData.charts.departmentEnrollments.enrollments, backgroundColor: '#818cf8', borderRadius: 4 },
                { label: 'เสร็จสิ้น', data: reportData.charts.departmentEnrollments.completed, backgroundColor: '#34d399', borderRadius: 4 }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'bottom' } },
            scales: { y: { beginAtZero: true } }
        }
    });
}

function initializeCourseDetailCharts() {
    // Enrollment Timeline Chart
    const timelineCtx = document.getElementById('enrollmentTimelineChart').getContext('2d');

    // Generate monthly data from enrollments
    const monthlyData = generateMonthlyEnrollmentData();

    charts.timeline = new Chart(timelineCtx, {
        type: 'line',
        data: {
            labels: monthlyData.labels,
            datasets: [{
                label: 'ลงทะเบียนใหม่',
                data: monthlyData.enrollments,
                borderColor: '#6366f1',
                backgroundColor: 'rgba(99, 102, 241, 0.1)',
                fill: true,
                tension: 0.4
            }, {
                label: 'เรียนจบ',
                data: monthlyData.completions,
                borderColor: '#22c55e',
                backgroundColor: 'rgba(34, 197, 94, 0.1)',
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'bottom' } },
            scales: { y: { beginAtZero: true } }
        }
    });

    // Course Progress Distribution
    const progressCtx = document.getElementById('courseProgressChart').getContext('2d');
    charts.courseProgress = new Chart(progressCtx, {
        type: 'doughnut',
        data: {
            labels: reportData.charts.progressDistribution.labels,
            datasets: [{
                data: reportData.charts.progressDistribution.data,
                backgroundColor: [
                    '#94a3b8', '#f87171', '#fb923c', '#facc15', '#4ade80', '#22c55e'
                ],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom', labels: { padding: 15, usePointStyle: true } }
            }
        }
    });
}

function generateMonthlyEnrollmentData() {
    const months = [];
    const enrollments = [];
    const completions = [];

    // Get last 6 months
    for (let i = 5; i >= 0; i--) {
        const date = new Date();
        date.setMonth(date.getMonth() - i);
        months.push(date.toLocaleDateString('th-TH', { month: 'short', year: '2-digit' }));

        const monthStart = new Date(date.getFullYear(), date.getMonth(), 1);
        const monthEnd = new Date(date.getFullYear(), date.getMonth() + 1, 0);

        const monthEnrollments = reportData.enrollments.filter(e => {
            const enrollDate = new Date(e.enrollment_date);
            return enrollDate >= monthStart && enrollDate <= monthEnd;
        }).length;

        const monthCompletions = reportData.enrollments.filter(e => {
            if (!e.completion_date) return false;
            const compDate = new Date(e.completion_date);
            return compDate >= monthStart && compDate <= monthEnd;
        }).length;

        enrollments.push(monthEnrollments);
        completions.push(monthCompletions);
    }

    return { labels: months, enrollments, completions };
}

function renderLeaderboard() {
    const container = document.getElementById('leaderboardContainer');
    const sorted = [...reportData.enrollments].sort((a, b) => b.progress - a.progress);
    const top10 = sorted.slice(0, 10);

    if (top10.length === 0) {
        container.innerHTML = '<div class="text-center py-8 text-gray-500">ไม่มีข้อมูลผู้เรียน</div>';
        return;
    }

    container.innerHTML = top10.map((user, index) => `
        <div class="leaderboard-item flex items-center bg-gray-50 rounded-xl p-3 cursor-pointer hover:bg-gray-100" onclick="viewUserDetail(${user.user_id}, ${user.course_id})">
            <div class="rank-badge ${index < 3 ? 'rank-' + (index + 1) : 'rank-default'} mr-3 flex-shrink-0">
                ${index + 1}
            </div>
            <img src="${user.profile_image || '/images/default-avatar.png'}"
                 alt="${user.full_name}"
                 class="w-10 h-10 rounded-full object-cover mr-3 flex-shrink-0"
                 onerror="this.onerror=null; this.src='/images/default-avatar.png'">
            <div class="flex-1 min-w-0 mr-3">
                <p class="font-semibold text-gray-900 truncate">${user.full_name}</p>
                <div class="flex gap-2 text-xs">
                    <span class="text-blue-600"><i class="fas fa-building mr-1"></i>${user.division_name || '-'}</span>
                    <span class="text-green-600"><i class="fas fa-users mr-1"></i>${user.department_name || '-'}</span>
                </div>
            </div>
            <div class="text-right flex-shrink-0">
                <p class="text-xl font-bold" style="color: ${getProgressColor(user.progress)}">${user.progress}%</p>
                <span class="status-badge status-${getStatusClass(user.status)} text-xs">${getStatusText(user.status)}</span>
            </div>
        </div>
    `).join('');
}

function sortLeaderboard(sortType) {
    document.querySelectorAll('.leaderboard-sort-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.sort === sortType);
    });

    const container = document.getElementById('leaderboardContainer');
    let sorted;

    if (sortType === 'progress') {
        sorted = [...reportData.enrollments].sort((a, b) => b.progress - a.progress);
    } else {
        sorted = [...reportData.enrollments].sort((a, b) => new Date(b.enrollment_date) - new Date(a.enrollment_date));
    }

    const top10 = sorted.slice(0, 10);
    container.innerHTML = top10.map((user, index) => `
        <div class="leaderboard-item flex items-center bg-gray-50 rounded-xl p-3 cursor-pointer hover:bg-gray-100" onclick="viewUserDetail(${user.user_id}, ${user.course_id})">
            <div class="rank-badge ${index < 3 ? 'rank-' + (index + 1) : 'rank-default'} mr-3 flex-shrink-0">
                ${index + 1}
            </div>
            <img src="${user.profile_image || '/images/default-avatar.png'}"
                 alt="${user.full_name}"
                 class="w-10 h-10 rounded-full object-cover mr-3 flex-shrink-0"
                 onerror="this.onerror=null; this.src='/images/default-avatar.png'">
            <div class="flex-1 min-w-0 mr-3">
                <p class="font-semibold text-gray-900 truncate">${user.full_name}</p>
                <div class="flex gap-2 text-xs">
                    <span class="text-blue-600"><i class="fas fa-building mr-1"></i>${user.division_name || '-'}</span>
                    <span class="text-green-600"><i class="fas fa-users mr-1"></i>${user.department_name || '-'}</span>
                </div>
            </div>
            <div class="text-right flex-shrink-0">
                <p class="text-xl font-bold" style="color: ${getProgressColor(user.progress)}">${user.progress}%</p>
                <span class="status-badge status-${getStatusClass(user.status)} text-xs">${getStatusText(user.status)}</span>
            </div>
        </div>
    `).join('');
}

function renderEnrollmentTimeline() {
    const container = document.getElementById('timelineContainer');
    const sorted = [...reportData.enrollments].sort((a, b) => new Date(b.enrollment_date) - new Date(a.enrollment_date));
    const recent = sorted.slice(0, 8);

    if (recent.length === 0) {
        container.innerHTML = '<div class="text-center py-8 text-gray-500">ไม่มีประวัติการลงทะเบียน</div>';
        return;
    }

    container.innerHTML = recent.map(user => {
        const statusColor = user.status === 'Completed' ? '#22c55e' : user.status === 'Active' || user.status === 'In Progress' ? '#f59e0b' : '#ef4444';
        return `
            <div class="timeline-item">
                <div class="timeline-dot" style="border-color: ${statusColor}; background: white;"></div>
                <div class="bg-gray-50 rounded-xl p-3 cursor-pointer hover:bg-gray-100" onclick="viewUserDetail(${user.user_id}, ${user.course_id})">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center min-w-0 flex-1">
                            <img src="${user.profile_image || '/images/default-avatar.png'}"
                                 alt="${user.full_name}"
                                 class="w-9 h-9 rounded-full object-cover mr-2 flex-shrink-0"
                                 onerror="this.onerror=null; this.src='/images/default-avatar.png'">
                            <div class="min-w-0 flex-1">
                                <p class="font-semibold text-gray-900 truncate">${user.full_name}</p>
                                <div class="flex gap-2 text-xs">
                                    <span class="text-blue-600 truncate"><i class="fas fa-building mr-1"></i>${user.division_name || '-'}</span>
                                    <span class="text-green-600 truncate"><i class="fas fa-users mr-1"></i>${user.department_name || '-'}</span>
                                </div>
                            </div>
                        </div>
                        <div class="text-right flex-shrink-0 ml-2">
                            <p class="text-xs text-gray-500">${formatDate(user.enrollment_date)}</p>
                            <span class="status-badge status-${getStatusClass(user.status)} text-xs">${getStatusText(user.status)}</span>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between text-xs mb-1">
                            <span class="text-gray-600">ความก้าวหน้า</span>
                            <span class="font-medium">${user.progress}%</span>
                        </div>
                        <div class="progress-bar-container">
                            <div class="progress-bar-fill" style="width: ${user.progress}%; background: ${getProgressColor(user.progress)};"></div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

function renderCourseSummary() {
    const container = document.getElementById('courseSummaryContainer');
    const courses = reportData.courseSummary;

    if (courses.length === 0) {
        container.innerHTML = `
            <div class="col-span-full text-center py-8">
                <i class="fas fa-book-open text-gray-300 text-4xl mb-4"></i>
                <p class="text-gray-500">ไม่พบข้อมูลหลักสูตร</p>
            </div>
        `;
        return;
    }

    container.innerHTML = courses.map(course => `
        <div class="course-card bg-white rounded-xl p-5 cursor-pointer" onclick="filterByCourse('${course.course_id}')">
            <div class="flex items-start justify-between mb-3">
                <div class="flex-1">
                    <h4 class="font-semibold text-gray-900 line-clamp-2">${course.course_title}</h4>
                    <p class="text-sm text-gray-500 mt-1">${course.category}</p>
                </div>
                <span class="px-2 py-1 text-xs font-medium bg-indigo-100 text-indigo-700 rounded-full">
                    ${course.total_enrollments} คน
                </span>
            </div>

            <div class="space-y-3">
                <div>
                    <div class="flex justify-between text-sm mb-1">
                        <span class="text-gray-600">ความก้าวหน้าเฉลี่ย</span>
                        <span class="font-medium text-gray-900">${course.avg_progress}%</span>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar-fill" style="width: ${course.avg_progress}%; background: ${getProgressColor(course.avg_progress)};"></div>
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-2 text-center text-xs">
                    <div class="bg-yellow-50 rounded-lg p-2">
                        <p class="font-bold text-yellow-600">${course.in_progress}</p>
                        <p class="text-yellow-700">กำลังเรียน</p>
                    </div>
                    <div class="bg-green-50 rounded-lg p-2">
                        <p class="font-bold text-green-600">${course.completed}</p>
                        <p class="text-green-700">เสร็จสิ้น</p>
                    </div>
                    <div class="bg-red-50 rounded-lg p-2">
                        <p class="font-bold text-red-600">${course.dropped}</p>
                        <p class="text-red-700">ยกเลิก</p>
                    </div>
                </div>

                <div class="text-xs text-gray-500 pt-2 border-t">
                    <i class="fas fa-user mr-1"></i>${course.instructor_name || 'ไม่ระบุ'}
                    <span class="mx-2">|</span>
                    <i class="fas fa-trophy mr-1"></i>อัตราสำเร็จ ${course.completion_rate}%
                </div>
            </div>
        </div>
    `).join('');
}

function renderEnrollmentsTable() {
    const enrollments = reportData.enrollments;
    const start = (currentPage - 1) * itemsPerPage;
    const end = start + itemsPerPage;
    const paginatedData = enrollments.slice(start, end);
    const isSpecificCourse = selectedCourseId && reportData.courseSummary.length === 1;

    // Update table
    const tbody = document.getElementById('enrollmentsTableBody');

    if (paginatedData.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="9" class="px-4 py-8 text-center text-gray-500">
                    <i class="fas fa-users text-gray-300 text-4xl mb-4 block"></i>
                    <p>ไม่พบข้อมูลการลงทะเบียน</p>
                </td>
            </tr>
        `;
    } else {
        tbody.innerHTML = paginatedData.map((enrollment, index) => `
            <tr class="hover:bg-gray-50 transition-colors">
                <td class="px-4 py-3 text-sm text-gray-500">
                    ${start + index + 1}
                </td>
                <td class="px-4 py-3">
                    <div class="flex items-center">
                        <img src="${enrollment.profile_image || '/images/default-avatar.png'}"
                             alt="${enrollment.full_name}"
                             class="w-9 h-9 rounded-full object-cover mr-2 flex-shrink-0"
                             onerror="this.onerror=null; this.src='/images/default-avatar.png'">
                        <div class="min-w-0">
                            <p class="font-medium text-gray-900 truncate">${enrollment.full_name}</p>
                            <p class="text-xs text-gray-500">${enrollment.employee_id || '-'}</p>
                        </div>
                    </div>
                </td>
                <td class="px-4 py-3">
                    <p class="text-sm text-gray-900">${enrollment.division_name || '-'}</p>
                </td>
                <td class="px-4 py-3">
                    <p class="text-sm text-gray-900">${enrollment.department_name || '-'}</p>
                    <p class="text-xs text-gray-500">${enrollment.position_name || '-'}</p>
                </td>
                <td class="px-4 py-3 course-column">
                    <p class="text-sm text-gray-900 font-medium truncate max-w-xs">${enrollment.course_title}</p>
                </td>
                <td class="px-4 py-3 text-sm text-gray-600 whitespace-nowrap">
                    ${formatDate(enrollment.enrollment_date)}
                </td>
                <td class="px-4 py-3">
                    <div class="flex items-center">
                        <div class="w-16 progress-bar-container mr-2">
                            <div class="progress-bar-fill" style="width: ${enrollment.progress}%; background: ${getProgressColor(enrollment.progress)};"></div>
                        </div>
                        <span class="text-xs font-medium text-gray-700 w-8">${enrollment.progress}%</span>
                    </div>
                </td>
                <td class="px-4 py-3 text-center">
                    <span class="status-badge status-${getStatusClass(enrollment.status)} text-xs">${getStatusText(enrollment.status)}</span>
                </td>
                <td class="px-4 py-3 text-center">
                    <button onclick="viewUserDetail(${enrollment.user_id}, ${enrollment.course_id})"
                            class="text-indigo-600 hover:text-indigo-800" title="ดูรายละเอียด">
                        <i class="fas fa-eye"></i>
                    </button>
                </td>
            </tr>
        `).join('');
    }

    // Update cards view
    const cardsContainer = document.getElementById('enrollmentsCardsContainer');
    cardsContainer.innerHTML = paginatedData.map(enrollment => `
        <div class="bg-white rounded-xl p-4 border border-gray-200 hover:shadow-lg transition-shadow cursor-pointer" onclick="viewUserDetail(${enrollment.user_id}, ${enrollment.course_id})">
            <div class="flex items-center mb-3">
                <img src="${enrollment.profile_image || '/images/default-avatar.png'}"
                     alt="${enrollment.full_name}"
                     class="w-11 h-11 rounded-full object-cover mr-3 flex-shrink-0"
                     onerror="this.onerror=null; this.src='/images/default-avatar.png'">
                <div class="min-w-0 flex-1">
                    <p class="font-semibold text-gray-900 truncate">${enrollment.full_name}</p>
                    <p class="text-xs text-gray-500">${enrollment.employee_id || '-'}</p>
                </div>
                <span class="status-badge status-${getStatusClass(enrollment.status)} text-xs flex-shrink-0">${getStatusText(enrollment.status)}</span>
            </div>
            <div class="grid grid-cols-2 gap-2 text-xs mb-3">
                <div class="bg-blue-50 rounded px-2 py-1">
                    <span class="text-blue-600 font-medium">ฝ่าย:</span>
                    <span class="text-blue-800 truncate block">${enrollment.division_name || '-'}</span>
                </div>
                <div class="bg-green-50 rounded px-2 py-1">
                    <span class="text-green-600 font-medium">แผนก:</span>
                    <span class="text-green-800 truncate block">${enrollment.department_name || '-'}</span>
                </div>
            </div>
            ${!isSpecificCourse ? `<div class="bg-gray-50 rounded-lg p-2 mb-3">
                <p class="font-medium text-gray-900 text-sm truncate">${enrollment.course_title}</p>
                <p class="text-xs text-gray-500 mt-1">ลงทะเบียน: ${formatDate(enrollment.enrollment_date)}</p>
            </div>` : `<div class="text-xs text-gray-500 mb-3">ลงทะเบียน: ${formatDate(enrollment.enrollment_date)}</div>`}
            <div>
                <div class="flex justify-between text-xs mb-1">
                    <span class="text-gray-600">ความก้าวหน้า</span>
                    <span class="font-semibold">${enrollment.progress}%</span>
                </div>
                <div class="progress-bar-container">
                    <div class="progress-bar-fill" style="width: ${enrollment.progress}%; background: ${getProgressColor(enrollment.progress)};"></div>
                </div>
            </div>
        </div>
    `).join('');

    // Update pagination
    updatePagination(enrollments.length);
}

function updatePagination(total) {
    const totalPages = Math.ceil(total / itemsPerPage);
    const from = total === 0 ? 0 : (currentPage - 1) * itemsPerPage + 1;
    const to = Math.min(currentPage * itemsPerPage, total);

    document.getElementById('paginationFrom').textContent = from;
    document.getElementById('paginationTo').textContent = to;
    document.getElementById('paginationTotal').textContent = total;
    document.getElementById('currentPage').textContent = currentPage;
    document.getElementById('totalPages').textContent = totalPages || 1;
    document.getElementById('showingCount').textContent = total;

    document.getElementById('prevBtn').disabled = currentPage <= 1;
    document.getElementById('nextBtn').disabled = currentPage >= totalPages;
}

function previousPage() {
    if (currentPage > 1) {
        currentPage--;
        renderEnrollmentsTable();
    }
}

function nextPage() {
    const totalPages = Math.ceil(reportData.enrollments.length / itemsPerPage);
    if (currentPage < totalPages) {
        currentPage++;
        renderEnrollmentsTable();
    }
}

function applyFilters() {
    currentFilters = {
        course_id: document.getElementById('filterCourse').value,
        department: document.getElementById('filterDepartment').value,
        status: document.getElementById('filterStatus').value,
        date_from: document.getElementById('filterDateFrom').value,
        date_to: document.getElementById('filterDateTo').value,
        search: document.getElementById('searchInput').value
    };

    // Remove empty values
    Object.keys(currentFilters).forEach(key => {
        if (!currentFilters[key]) delete currentFilters[key];
    });

    currentPage = 1;
    loadReportData();
}

function clearFilters() {
    document.getElementById('filterCourse').value = '';
    document.getElementById('filterDepartment').value = '';
    document.getElementById('filterStatus').value = '';
    document.getElementById('filterDateFrom').value = '';
    document.getElementById('filterDateTo').value = '';
    document.getElementById('searchInput').value = '';

    currentFilters = {};
    currentPage = 1;
    loadReportData();
}

function filterByCourse(courseId) {
    document.getElementById('filterCourse').value = courseId;
    applyFilters();
}

function sortCourses() {
    const sortBy = document.getElementById('courseSortBy').value;

    reportData.courseSummary.sort((a, b) => {
        switch (sortBy) {
            case 'enrollments': return b.total_enrollments - a.total_enrollments;
            case 'completion': return b.completion_rate - a.completion_rate;
            case 'progress': return b.avg_progress - a.avg_progress;
            case 'name': return a.course_title.localeCompare(b.course_title);
            default: return 0;
        }
    });

    renderCourseSummary();
}

function sortTable(field) {
    if (sortField === field) {
        sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
    } else {
        sortField = field;
        sortDirection = 'asc';
    }

    reportData.enrollments.sort((a, b) => {
        let aVal, bVal;

        switch (field) {
            case 'employee_id': aVal = a.employee_id || ''; bVal = b.employee_id || ''; break;
            case 'division': aVal = a.division_name || ''; bVal = b.division_name || ''; break;
            case 'department': aVal = a.department_name || ''; bVal = b.department_name || ''; break;
            case 'course': aVal = a.course_title || ''; bVal = b.course_title || ''; break;
            case 'enrollment_date': aVal = new Date(a.enrollment_date); bVal = new Date(b.enrollment_date); break;
            case 'progress': aVal = a.progress; bVal = b.progress; break;
            case 'status': aVal = a.status || ''; bVal = b.status || ''; break;
            default: return 0;
        }

        if (typeof aVal === 'string') {
            return sortDirection === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
        }
        return sortDirection === 'asc' ? aVal - bVal : bVal - aVal;
    });

    currentPage = 1;
    renderEnrollmentsTable();
}

function toggleView(view) {
    document.getElementById('viewTable').classList.toggle('active', view === 'table');
    document.getElementById('viewCards').classList.toggle('active', view === 'cards');
    document.getElementById('tableView').classList.toggle('hidden', view !== 'table');
    document.getElementById('cardsView').classList.toggle('hidden', view !== 'cards');
}

function viewUserDetail(userId, courseId) {
    const enrollment = reportData.enrollments.find(e => e.user_id === userId && e.course_id === courseId);
    if (!enrollment) return;

    const modal = document.getElementById('userDetailModal');
    const content = document.getElementById('userDetailContent');

    content.innerHTML = `
        <div class="text-center mb-6">
            <img src="${enrollment.profile_image || '/images/default-avatar.png'}"
                 alt="${enrollment.full_name}"
                 class="w-20 h-20 rounded-full object-cover mx-auto mb-3"
                 onerror="this.onerror=null; this.src='/images/default-avatar.png'">
            <h3 class="text-xl font-bold text-gray-900">${enrollment.full_name}</h3>
            <p class="text-gray-500">${enrollment.employee_id || '-'} | ${enrollment.email}</p>
        </div>

        <div class="grid grid-cols-3 gap-4 mb-6">
            <div class="bg-gray-50 rounded-lg p-4">
                <p class="text-sm text-gray-500">ฝ่าย</p>
                <p class="font-semibold text-gray-900">${enrollment.division_name || '-'}</p>
            </div>
            <div class="bg-gray-50 rounded-lg p-4">
                <p class="text-sm text-gray-500">แผนก</p>
                <p class="font-semibold text-gray-900">${enrollment.department_name || '-'}</p>
            </div>
            <div class="bg-gray-50 rounded-lg p-4">
                <p class="text-sm text-gray-500">ตำแหน่ง</p>
                <p class="font-semibold text-gray-900">${enrollment.position_name || '-'}</p>
            </div>
        </div>

        <div class="bg-indigo-50 rounded-lg p-4 mb-6">
            <h4 class="font-semibold text-indigo-900 mb-2">${enrollment.course_title}</h4>
            <div class="grid grid-cols-2 gap-4 text-sm">
                <div>
                    <p class="text-indigo-700">วันที่ลงทะเบียน</p>
                    <p class="font-medium text-indigo-900">${formatDate(enrollment.enrollment_date)}</p>
                </div>
                <div>
                    <p class="text-indigo-700">สถานะ</p>
                    <span class="status-badge status-${getStatusClass(enrollment.status)}">${getStatusText(enrollment.status)}</span>
                </div>
            </div>
        </div>

        <div class="mb-6">
            <div class="flex justify-between mb-2">
                <span class="font-medium text-gray-700">ความก้าวหน้า</span>
                <span class="font-bold text-indigo-600">${enrollment.progress}%</span>
            </div>
            <div class="h-3 bg-gray-200 rounded-full overflow-hidden">
                <div class="h-full rounded-full transition-all" style="width: ${enrollment.progress}%; background: ${getProgressColor(enrollment.progress)};"></div>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-4 text-sm">
            <div class="bg-gray-50 rounded-lg p-3">
                <p class="text-gray-500">วันที่เสร็จสิ้น</p>
                <p class="font-medium text-gray-900">${enrollment.completion_date ? formatDate(enrollment.completion_date) : '-'}</p>
            </div>
            <div class="bg-gray-50 rounded-lg p-3">
                <p class="text-gray-500">เข้าใช้ล่าสุด</p>
                <p class="font-medium text-gray-900">${enrollment.last_access_date ? formatDateTime(enrollment.last_access_date) : '-'}</p>
            </div>
            <div class="bg-gray-50 rounded-lg p-3">
                <p class="text-gray-500">เกรด</p>
                <p class="font-medium text-gray-900">${enrollment.grade || '-'}</p>
            </div>
            <div class="bg-gray-50 rounded-lg p-3">
                <p class="text-gray-500">ใบประกาศนียบัตร</p>
                <p class="font-medium ${enrollment.certificate_issued ? 'text-green-600' : 'text-gray-900'}">
                    ${enrollment.certificate_issued ? '<i class="fas fa-check-circle mr-1"></i>ได้รับแล้ว' : 'ยังไม่ได้รับ'}
                </p>
            </div>
        </div>
    `;

    modal.classList.remove('hidden');
}

function closeUserModal() {
    document.getElementById('userDetailModal').classList.add('hidden');
}

function exportReport() {
    const params = new URLSearchParams(currentFilters);
    window.location.href = `/reports/api/export/course-enrollments?${params}`;
}

function refreshData() {
    loadReportData();
}

// Utility functions
function getProgressColor(progress) {
    if (progress >= 100) return '#22c55e';
    if (progress >= 75) return '#4ade80';
    if (progress >= 50) return '#facc15';
    if (progress >= 25) return '#fb923c';
    return '#f87171';
}

function getStatusClass(status) {
    switch (status) {
        case 'Active': return 'active';
        case 'In Progress': return 'in-progress';
        case 'Completed': return 'completed';
        case 'Dropped':
        case 'Cancelled': return 'dropped';
        default: return 'active';
    }
}

function getStatusText(status) {
    switch (status) {
        case 'Active': return 'กำลังเรียน';
        case 'In Progress': return 'กำลังดำเนินการ';
        case 'Completed': return 'เสร็จสิ้น';
        case 'Dropped': return 'ยกเลิก';
        case 'Cancelled': return 'ยกเลิก';
        default: return status || 'กำลังเรียน';
    }
}

function formatDate(dateStr) {
    if (!dateStr) return '-';
    const date = new Date(dateStr);
    return date.toLocaleDateString('th-TH', { year: 'numeric', month: 'short', day: 'numeric' });
}

function formatDateTime(dateStr) {
    if (!dateStr) return '-';
    const date = new Date(dateStr);
    return date.toLocaleDateString('th-TH', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
}

function showLoading(show) {
    document.getElementById('loadingOverlay').classList.toggle('hidden', !show);
}

function showError(message) {
    alert('Error: ' + message);
}
</script>
