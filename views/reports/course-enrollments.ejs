<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Header -->
    <div id="mainHeader" class="rounded-2xl p-6 mb-8 text-white shadow-lg" style="background: linear-gradient(to right, <%= systemSettings.primary_color || '#3b82f6' %>, <%= systemSettings.secondary_color || '#10b981' %>);">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
            <div>
                <h1 class="text-3xl font-bold text-white">
                    <i class="fas fa-clipboard-list mr-3"></i><%= typeof t === 'function' ? t('courseEnrollmentsReport') : 'รายงานการลงทะเบียนหลักสูตร' %>
                </h1>
                <p class="text-white/80 mt-1"><%= typeof t === 'function' ? t('courseEnrollmentsSubtitle') : 'ติดตามการลงทะเบียนและความก้าวหน้าของผู้เรียนในแต่ละหลักสูตร' %></p>
            </div>
            <div class="flex space-x-3 mt-4 md:mt-0">
                <button onclick="exportReport()" class="bg-white/20 hover:bg-white/30 backdrop-blur-sm text-white font-medium py-2 px-4 rounded-lg transition-all duration-200 flex items-center">
                    <i class="fas fa-file-excel mr-2"></i><%= typeof t === 'function' ? t('exportExcel') : 'Export Excel' %>
                </button>
                <button onclick="refreshData()" class="bg-white/20 hover:bg-white/30 backdrop-blur-sm text-white font-medium py-2 px-4 rounded-lg transition-all duration-200 flex items-center">
                    <i class="fas fa-sync-alt mr-2"></i><%= typeof t === 'function' ? t('refresh') : 'รีเฟรช' %>
                </button>
            </div>
        </div>
    </div>

    <!-- Selected Course Hero Section (Hidden by default) -->
    <div id="selectedCourseHero" class="hidden mb-8">
        <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
            <!-- Top Banner with Gradient -->
            <div class="relative px-6 py-5" style="background: linear-gradient(135deg, <%= systemSettings.primary_color || '#3b82f6' %> 0%, <%= systemSettings.secondary_color || '#10b981' %> 100%);">
                <div class="flex justify-between items-center">
                    <button onclick="clearFilters()" class="flex items-center gap-2 px-4 py-2 bg-white/20 hover:bg-white/30 rounded-lg text-white font-medium transition-all">
                        <i class="fas fa-arrow-left"></i>
                        <span><%= typeof t === 'function' ? t('backToAllCourses') : 'กลับไปดูทุกหลักสูตร' %></span>
                    </button>
                    <span id="heroBadge" class="px-4 py-1.5 bg-white/20 rounded-full text-white text-sm font-medium"></span>
                </div>
            </div>

            <!-- Course Info Section -->
            <div class="p-6">
                <div class="flex flex-col lg:flex-row gap-6">
                    <!-- Left: Thumbnail -->
                    <div class="flex-shrink-0">
                        <div class="w-full lg:w-56 h-36 rounded-xl overflow-hidden shadow-lg border border-gray-200">
                            <img id="heroThumbnail" src="/images/course-default.svg" alt="Course" class="w-full h-full object-cover" onerror="this.onerror=null; this.src='/images/course-default.svg'">
                        </div>
                    </div>

                    <!-- Right: Course Details -->
                    <div class="flex-1">
                        <!-- Title -->
                        <h2 id="heroTitle" class="text-2xl font-bold text-gray-800 mb-3"></h2>

                        <!-- Meta Info -->
                        <div class="flex flex-wrap gap-3 mb-4">
                            <span id="heroInstructor" class="inline-flex items-center gap-2 px-3 py-1.5 bg-gray-100 rounded-lg text-sm text-gray-700">
                                <i class="fas fa-user-tie" style="color: <%= systemSettings.primary_color || '#3b82f6' %>;"></i>
                                <span></span>
                            </span>
                            <span id="heroDuration" class="inline-flex items-center gap-2 px-3 py-1.5 bg-gray-100 rounded-lg text-sm text-gray-700">
                                <i class="fas fa-clock" style="color: <%= systemSettings.secondary_color || '#10b981' %>;"></i>
                                <span></span>
                            </span>
                            <span id="heroLevel" class="inline-flex items-center gap-2 px-3 py-1.5 bg-gray-100 rounded-lg text-sm text-gray-700">
                                <i class="fas fa-signal" style="color: <%= systemSettings.primary_color || '#3b82f6' %>;"></i>
                                <span></span>
                            </span>
                        </div>

                        <!-- Progress Bar -->
                        <div class="bg-gray-50 rounded-xl p-4 border border-gray-100">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm font-medium text-gray-600"><%= typeof t === 'function' ? t('avgLearnerProgress') : 'ความก้าวหน้าเฉลี่ยของผู้เรียน' %></span>
                                <span id="heroProgress" class="text-xl font-bold" style="color: <%= systemSettings.primary_color || '#3b82f6' %>;">0%</span>
                            </div>
                            <div class="h-3 bg-gray-200 rounded-full overflow-hidden">
                                <div id="heroProgressBar" class="h-full rounded-full transition-all duration-500" style="width: 0%; background: linear-gradient(to right, <%= systemSettings.primary_color || '#3b82f6' %>, <%= systemSettings.secondary_color || '#10b981' %>);"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Stats Cards -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-6">
                    <div class="bg-blue-50 rounded-xl p-4 text-center border border-blue-100">
                        <div class="w-10 h-10 mx-auto mb-2 bg-blue-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-users text-blue-600"></i>
                        </div>
                        <p id="heroEnrollments" class="text-2xl font-bold text-blue-700">0</p>
                        <p class="text-xs text-blue-600 font-medium mt-1"><%= typeof t === 'function' ? t('totalEnrollments') : 'ลงทะเบียนทั้งหมด' %></p>
                    </div>
                    <div class="bg-yellow-50 rounded-xl p-4 text-center border border-yellow-100">
                        <div class="w-10 h-10 mx-auto mb-2 bg-yellow-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-spinner text-yellow-600"></i>
                        </div>
                        <p id="heroInProgress" class="text-2xl font-bold text-yellow-700">0</p>
                        <p class="text-xs text-yellow-600 font-medium mt-1"><%= typeof t === 'function' ? t('activeEnrollments') : 'กำลังเรียน' %></p>
                    </div>
                    <div class="bg-green-50 rounded-xl p-4 text-center border border-green-100">
                        <div class="w-10 h-10 mx-auto mb-2 bg-green-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-check-circle text-green-600"></i>
                        </div>
                        <p id="heroCompleted" class="text-2xl font-bold text-green-700">0</p>
                        <p class="text-xs text-green-600 font-medium mt-1"><%= typeof t === 'function' ? t('completedEnrollments') : 'เรียนจบแล้ว' %></p>
                    </div>
                    <div class="bg-purple-50 rounded-xl p-4 text-center border border-purple-100">
                        <div class="w-10 h-10 mx-auto mb-2 bg-purple-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-trophy text-purple-600"></i>
                        </div>
                        <p id="heroCompletionRate" class="text-2xl font-bold text-purple-700">0%</p>
                        <p class="text-xs text-purple-600 font-medium mt-1"><%= typeof t === 'function' ? t('completionRate') : 'อัตราสำเร็จ' %></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Overview Cards - Dashboard Style -->
    <div id="overviewCards" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-6">
        <div class="stat-card bg-white rounded-xl border border-gray-200 p-4">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs font-medium text-gray-500 mb-1"><%= typeof t === 'function' ? t('totalCourses') : 'หลักสูตรทั้งหมด' %></p>
                    <p class="text-xl font-bold text-gray-900" id="totalCourses">0</p>
                </div>
                <div class="icon-box bg-blue-100" style="width: 36px; height: 36px;">
                    <i class="fas fa-book text-blue-600 text-sm"></i>
                </div>
            </div>
        </div>
        <div class="stat-card bg-white rounded-xl border border-gray-200 p-4">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs font-medium text-gray-500 mb-1"><%= typeof t === 'function' ? t('totalEnrollments') : 'ลงทะเบียนทั้งหมด' %></p>
                    <p class="text-xl font-bold text-gray-900" id="totalEnrollments">0</p>
                </div>
                <div class="icon-box bg-green-100" style="width: 36px; height: 36px;">
                    <i class="fas fa-user-plus text-green-600 text-sm"></i>
                </div>
            </div>
        </div>
        <div class="stat-card bg-white rounded-xl border border-gray-200 p-4">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs font-medium text-gray-500 mb-1"><%= typeof t === 'function' ? t('activeEnrollments') : 'กำลังเรียน' %></p>
                    <p class="text-xl font-bold text-gray-900" id="activeEnrollments">0</p>
                </div>
                <div class="icon-box bg-yellow-100" style="width: 36px; height: 36px;">
                    <i class="fas fa-spinner text-yellow-600 text-sm"></i>
                </div>
            </div>
        </div>
        <div class="stat-card bg-white rounded-xl border border-gray-200 p-4">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs font-medium text-gray-500 mb-1"><%= typeof t === 'function' ? t('completedEnrollments') : 'เรียนจบแล้ว' %></p>
                    <p class="text-xl font-bold text-gray-900" id="completedEnrollments">0</p>
                </div>
                <div class="icon-box bg-emerald-100" style="width: 36px; height: 36px;">
                    <i class="fas fa-check-circle text-emerald-600 text-sm"></i>
                </div>
            </div>
        </div>
        <div class="stat-card bg-white rounded-xl border border-gray-200 p-4">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs font-medium text-gray-500 mb-1"><%= typeof t === 'function' ? t('avgProgress') : 'ความก้าวหน้าเฉลี่ย' %></p>
                    <p class="text-xl font-bold text-gray-900" id="avgProgress">0%</p>
                </div>
                <div class="icon-box bg-purple-100" style="width: 36px; height: 36px;">
                    <i class="fas fa-chart-line text-purple-600 text-sm"></i>
                </div>
            </div>
        </div>
        <div class="stat-card bg-white rounded-xl border border-gray-200 p-4">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs font-medium text-gray-500 mb-1"><%= typeof t === 'function' ? t('completionRate') : 'อัตราสำเร็จ' %></p>
                    <p class="text-xl font-bold text-gray-900" id="completionRate">0%</p>
                </div>
                <div class="icon-box bg-indigo-100" style="width: 36px; height: 36px;">
                    <i class="fas fa-trophy text-indigo-600 text-sm"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="bg-white rounded-xl border border-gray-200 p-4 mb-6">
        <h3 class="text-sm font-semibold text-gray-900 mb-3"><i class="fas fa-filter mr-1 text-gray-400" style="font-size: 12px;"></i><%= typeof t === 'function' ? t('filterData') : 'ตัวกรองข้อมูล' %></h3>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-3">
            <div>
                <label class="block text-xs font-medium text-gray-700 mb-1"><%= typeof t === 'function' ? t('course') : 'หลักสูตร' %></label>
                <select id="filterCourse" class="w-full border border-gray-300 rounded px-2 py-1.5 text-xs focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500">
                    <option value=""><%= typeof t === 'function' ? t('allCourses') : 'ทุกหลักสูตร' %></option>
                </select>
            </div>
            <div>
                <label class="block text-xs font-medium text-gray-700 mb-1"><%= typeof t === 'function' ? t('department') : 'แผนก' %></label>
                <select id="filterDepartment" class="w-full border border-gray-300 rounded px-2 py-1.5 text-xs focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500">
                    <option value=""><%= typeof t === 'function' ? t('allDepartments') : 'ทุกแผนก' %></option>
                </select>
            </div>
            <div>
                <label class="block text-xs font-medium text-gray-700 mb-1"><%= typeof t === 'function' ? t('status') : 'สถานะ' %></label>
                <select id="filterStatus" class="w-full border border-gray-300 rounded px-2 py-1.5 text-xs focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500">
                    <option value=""><%= typeof t === 'function' ? t('allStatuses') : 'ทุกสถานะ' %></option>
                    <option value="Active"><%= typeof t === 'function' ? t('statusActive') : 'กำลังเรียน' %></option>
                    <option value="In Progress"><%= typeof t === 'function' ? t('statusInProgress') : 'กำลังดำเนินการ' %></option>
                    <option value="Completed"><%= typeof t === 'function' ? t('statusCompleted') : 'เสร็จสิ้น' %></option>
                    <option value="Dropped"><%= typeof t === 'function' ? t('statusDropped') : 'ยกเลิก' %></option>
                </select>
            </div>
            <div>
                <label class="block text-xs font-medium text-gray-700 mb-1"><%= typeof t === 'function' ? t('startDate') : 'วันที่เริ่มต้น' %></label>
                <input type="date" id="filterDateFrom" class="w-full border border-gray-300 rounded px-2 py-1.5 text-xs focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <div>
                <label class="block text-xs font-medium text-gray-700 mb-1"><%= typeof t === 'function' ? t('endDate') : 'วันที่สิ้นสุด' %></label>
                <input type="date" id="filterDateTo" class="w-full border border-gray-300 rounded px-2 py-1.5 text-xs focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500">
            </div>
        </div>
        <div class="mt-3 flex justify-between items-center">
            <div class="flex-1 max-w-sm">
                <div class="relative">
                    <input type="text" id="searchInput" placeholder="<%= typeof t === 'function' ? t('searchPlaceholder') : 'ค้นหาชื่อ, รหัสพนักงาน หรืออีเมล...' %>"
                           class="w-full border border-gray-300 rounded pl-7 pr-3 py-1.5 text-xs focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500">
                    <i class="fas fa-search absolute left-2 top-1/2 transform -translate-y-1/2 text-gray-400" style="font-size: 10px;"></i>
                </div>
            </div>
            <div class="flex space-x-2">
                <button onclick="applyFilters()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-1.5 px-3 rounded text-xs transition-all duration-200">
                    <i class="fas fa-search mr-1" style="font-size: 10px;"></i><%= typeof t === 'function' ? t('filter') : 'กรอง' %>
                </button>
                <button onclick="clearFilters()" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-1.5 px-3 rounded text-xs transition-all duration-200">
                    <i class="fas fa-times mr-1" style="font-size: 10px;"></i><%= typeof t === 'function' ? t('clear') : 'ล้าง' %>
                </button>
            </div>
        </div>
    </div>

    <!-- Charts Section (Show when course selected) -->
    <div id="courseDetailCharts" class="hidden grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <!-- Enrollment Timeline Chart -->
        <div class="bg-white rounded-xl border border-gray-200">
            <div class="px-6 py-4 border-b border-gray-100">
                <h3 class="text-lg font-semibold text-gray-900"><i class="fas fa-chart-line mr-2" style="color: <%= systemSettings.primary_color || '#3b82f6' %>;"></i><%= typeof t === 'function' ? t('monthlyEnrollments') : 'การลงทะเบียนรายเดือน' %></h3>
            </div>
            <div class="p-6" style="position: relative; height: 240px;">
                <canvas id="enrollmentTimelineChart"></canvas>
            </div>
        </div>

        <!-- Progress Distribution for Selected Course -->
        <div class="bg-white rounded-xl border border-gray-200">
            <div class="px-6 py-4 border-b border-gray-100">
                <h3 class="text-lg font-semibold text-gray-900"><i class="fas fa-chart-pie mr-2" style="color: <%= systemSettings.secondary_color || '#10b981' %>;"></i><%= typeof t === 'function' ? t('progressDistribution') : 'การกระจายความก้าวหน้า' %></h3>
            </div>
            <div class="p-6" style="position: relative; height: 240px;">
                <canvas id="courseProgressChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Charts Section (Show when no course selected) -->
    <div id="overviewCharts" class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <!-- Progress Distribution Chart -->
        <div class="bg-white rounded-xl border border-gray-200">
            <div class="px-6 py-4 border-b border-gray-100">
                <h3 class="text-lg font-semibold text-gray-900"><i class="fas fa-chart-pie mr-2" style="color: <%= systemSettings.primary_color || '#3b82f6' %>;"></i><%= typeof t === 'function' ? t('progressDistribution') : 'การกระจายความก้าวหน้า' %></h3>
            </div>
            <div class="p-6" style="position: relative; height: 240px;">
                <canvas id="progressChart"></canvas>
            </div>
        </div>

        <!-- Department Enrollments Chart -->
        <div class="bg-white rounded-xl border border-gray-200">
            <div class="px-6 py-4 border-b border-gray-100">
                <h3 class="text-lg font-semibold text-gray-900"><i class="fas fa-building mr-2" style="color: <%= systemSettings.secondary_color || '#10b981' %>;"></i><%= typeof t === 'function' ? t('departmentEnrollments') : 'การลงทะเบียนตามแผนก' %></h3>
            </div>
            <div class="p-6" style="position: relative; height: 240px;">
                <canvas id="departmentChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Learner Progress Leaderboard (Show when course selected) -->
    <div id="learnerLeaderboard" class="hidden bg-white rounded-xl border border-gray-200 mb-6">
        <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center">
            <h3 class="text-lg font-semibold text-gray-900"><i class="fas fa-medal mr-2" style="color: <%= systemSettings.primary_color || '#3b82f6' %>;"></i><%= typeof t === 'function' ? t('learnerRanking') : 'อันดับผู้เรียน' %></h3>
            <div class="flex space-x-2">
                <button onclick="sortLeaderboard('progress')" class="leaderboard-sort-btn active px-3 py-1.5 rounded text-sm" data-sort="progress">
                    <%= typeof t === 'function' ? t('progress') : 'ความก้าวหน้า' %>
                </button>
                <button onclick="sortLeaderboard('recent')" class="leaderboard-sort-btn px-3 py-1.5 rounded text-sm" data-sort="recent">
                    <%= typeof t === 'function' ? t('latest') : 'ล่าสุด' %>
                </button>
            </div>
        </div>
        <div id="leaderboardContainer" class="space-y-2 p-6 pt-0">
            <!-- Leaderboard items will be loaded here -->
        </div>
    </div>

    <!-- Course Summary Cards (Show when no course selected) -->
    <div id="courseSummarySection" class="bg-white rounded-xl border border-gray-200 mb-6">
        <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center">
            <h3 class="text-lg font-semibold text-gray-900"><i class="fas fa-book-open mr-2" style="color: <%= systemSettings.primary_color || '#3b82f6' %>;"></i><%= typeof t === 'function' ? t('courseSummary') : 'สรุปรายหลักสูตร' %></h3>
            <div class="flex items-center space-x-2">
                <span class="text-sm text-gray-500"><%= typeof t === 'function' ? t('sortBy') : 'เรียงตาม' %>:</span>
                <select id="courseSortBy" class="border border-gray-300 rounded px-3 py-1.5 text-sm focus:ring-1 focus:ring-indigo-500" onchange="sortCourses()">
                    <option value="enrollments"><%= typeof t === 'function' ? t('enrollmentCount') : 'จำนวนลงทะเบียน' %></option>
                    <option value="completion"><%= typeof t === 'function' ? t('completionRate') : 'อัตราสำเร็จ' %></option>
                    <option value="progress"><%= typeof t === 'function' ? t('progress') : 'ความก้าวหน้า' %></option>
                    <option value="name"><%= typeof t === 'function' ? t('courseName') : 'ชื่อหลักสูตร' %></option>
                </select>
            </div>
        </div>
        <div id="courseSummaryContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 p-6">
            <!-- Course cards will be loaded here -->
        </div>
    </div>

    <!-- Enrollment Timeline (Show when course selected) -->
    <div id="enrollmentTimeline" class="hidden bg-white rounded-xl border border-gray-200 mb-6">
        <div class="px-6 py-4 border-b border-gray-100">
            <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                <i class="fas fa-history mr-3" style="color: <%= systemSettings.secondary_color || '#10b981' %>;"></i>
                <%= typeof t === 'function' ? t('enrollmentHistory') : 'ประวัติการลงทะเบียน' %>
            </h3>
        </div>
        <div id="timelineContainer" class="relative p-6">
            <!-- Timeline items will be loaded here -->
        </div>
    </div>

    <!-- Detailed Enrollments Table (Hidden by default, show when course selected) -->
    <div id="enrollmentsTableSection" class="hidden bg-white rounded-xl border border-gray-200 overflow-hidden mt-6">
        <!-- Header with system gradient -->
        <div class="px-8 py-6" style="background: linear-gradient(135deg, <%= systemSettings.primary_color || '#3b82f6' %> 0%, <%= systemSettings.secondary_color || '#10b981' %> 100%);">
            <div class="flex justify-between items-center">
                <div class="text-white">
                    <h3 id="tableTitle" class="text-2xl font-bold flex items-center">
                        <div class="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center mr-4">
                            <i class="fas fa-users text-lg"></i>
                        </div>
                        <%= typeof t === 'function' ? t('enrollmentDetails') : 'รายละเอียดผู้ลงทะเบียน' %>
                    </h3>
                    <p class="text-white/80 text-base mt-2 ml-14"><span id="showingCount">0</span> <%= typeof t === 'function' ? t('items') : 'รายการ' %></p>
                </div>
                <div class="flex items-center gap-3">
                    <div class="bg-white/20 backdrop-blur-sm rounded-xl p-1 flex shadow-inner">
                        <button onclick="toggleView('table')" id="viewTable" class="view-toggle-btn active px-4 py-2 rounded-lg text-sm font-medium text-white transition-all duration-200">
                            <i class="fas fa-list mr-2"></i><%= typeof t === 'function' ? t('tableView') : 'ตาราง' %>
                        </button>
                        <button onclick="toggleView('cards')" id="viewCards" class="view-toggle-btn px-4 py-2 rounded-lg text-sm font-medium text-white/70 hover:text-white transition-all duration-200">
                            <i class="fas fa-th-large mr-2"></i><%= typeof t === 'function' ? t('cardView') : 'การ์ด' %>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Table View -->
        <div id="tableView" class="overflow-x-auto">
            <table class="min-w-full">
                <thead>
                    <tr class="bg-gradient-to-r from-gray-50 to-gray-100 border-b-2 border-gray-200">
                        <th class="px-6 py-4 text-left text-sm font-bold text-gray-700 uppercase tracking-wider w-12">#</th>
                        <th class="px-6 py-4 text-left text-sm font-bold text-gray-700 uppercase tracking-wider cursor-pointer hover:bg-gray-200/50 transition-all duration-200 rounded-lg" onclick="sortTable('employee_id')">
                            <span class="flex items-center gap-2"><%= typeof t === 'function' ? t('employee') : 'พนักงาน' %> <i class="fas fa-sort text-gray-400 text-xs"></i></span>
                        </th>
                        <th class="px-6 py-4 text-left text-sm font-bold text-gray-700 uppercase tracking-wider cursor-pointer hover:bg-gray-200/50 transition-all duration-200 rounded-lg" onclick="sortTable('department')">
                            <span class="flex items-center gap-2"><%= typeof t === 'function' ? t('affiliation') : 'สังกัด' %> <i class="fas fa-sort text-gray-400 text-xs"></i></span>
                        </th>
                        <th id="courseColumn" class="px-6 py-4 text-left text-sm font-bold text-gray-700 uppercase tracking-wider cursor-pointer hover:bg-gray-200/50 transition-all duration-200 rounded-lg" onclick="sortTable('course')">
                            <span class="flex items-center gap-2"><%= typeof t === 'function' ? t('course') : 'หลักสูตร' %> <i class="fas fa-sort text-gray-400 text-xs"></i></span>
                        </th>
                        <th class="px-6 py-4 text-center text-sm font-bold text-gray-700 uppercase tracking-wider cursor-pointer hover:bg-gray-200/50 transition-all duration-200 rounded-lg" onclick="sortTable('progress')">
                            <span class="flex items-center justify-center gap-2"><%= typeof t === 'function' ? t('progress') : 'ความก้าวหน้า' %> <i class="fas fa-sort text-gray-400 text-xs"></i></span>
                        </th>
                        <th class="px-6 py-4 text-center text-sm font-bold text-gray-700 uppercase tracking-wider cursor-pointer hover:bg-gray-200/50 transition-all duration-200 rounded-lg" onclick="sortTable('status')">
                            <span class="flex items-center justify-center gap-2"><%= typeof t === 'function' ? t('status') : 'สถานะ' %> <i class="fas fa-sort text-gray-400 text-xs"></i></span>
                        </th>
                        <th class="px-6 py-4 text-center text-sm font-bold text-gray-700 w-16"></th>
                    </tr>
                </thead>
                <tbody id="enrollmentsTableBody" class="divide-y divide-gray-100 bg-white">
                    <!-- Data will be loaded here -->
                </tbody>
            </table>
        </div>

        <!-- Cards View (Hidden by default) -->
        <div id="cardsView" class="hidden p-4">
            <div id="enrollmentsCardsContainer" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-3">
                <!-- Cards will be loaded here -->
            </div>
        </div>

        <!-- Pagination -->
        <div class="px-8 py-4 border-t-2 border-gray-100 bg-gradient-to-r from-gray-50 to-white flex justify-between items-center">
            <p class="text-base text-gray-600 font-medium">
                <%= typeof t === 'function' ? t('showing') : 'แสดง' %> <span id="paginationFrom" class="font-bold" style="color: <%= systemSettings.primary_color || '#3b82f6' %>;">0</span>-<span id="paginationTo" class="font-bold" style="color: <%= systemSettings.primary_color || '#3b82f6' %>;">0</span> <%= typeof t === 'function' ? t('of') : 'จาก' %> <span id="paginationTotal" class="font-bold" style="color: <%= systemSettings.primary_color || '#3b82f6' %>;">0</span> <%= typeof t === 'function' ? t('items') : 'รายการ' %>
            </p>
            <div class="flex items-center gap-3">
                <button onclick="previousPage()" id="prevBtn" disabled class="w-10 h-10 flex items-center justify-center rounded-xl border-2 border-gray-200 text-gray-500 hover:bg-gray-100 hover:border-gray-300 disabled:opacity-40 disabled:cursor-not-allowed transition-all duration-200 shadow-sm">
                    <i class="fas fa-chevron-left text-sm"></i>
                </button>
                <span class="px-4 py-2 bg-white rounded-xl border-2 border-gray-200 text-base font-semibold text-gray-700 shadow-sm">
                    <span id="currentPage">1</span> / <span id="totalPages">1</span>
                </span>
                <button onclick="nextPage()" id="nextBtn" class="w-10 h-10 flex items-center justify-center rounded-xl border-2 border-gray-200 text-gray-500 hover:bg-gray-100 hover:border-gray-300 disabled:opacity-40 disabled:cursor-not-allowed transition-all duration-200 shadow-sm">
                    <i class="fas fa-chevron-right text-sm"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- User Detail Modal -->
<div id="userDetailModal" class="hidden fixed inset-0 z-50 overflow-y-auto">
    <div class="flex items-center justify-center min-h-screen px-4">
        <div class="fixed inset-0 bg-black bg-opacity-50 transition-opacity" onclick="closeUserModal()"></div>
        <div class="relative bg-white rounded-xl max-w-md w-full p-4 shadow-xl">
            <button onclick="closeUserModal()" class="absolute top-3 right-3 text-gray-400 hover:text-gray-600">
                <i class="fas fa-times text-base"></i>
            </button>
            <div id="userDetailContent">
                <!-- User details will be loaded here -->
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-xl p-6 flex items-center space-x-4">
        <div class="animate-spin rounded-full h-10 w-10 border-4 border-t-transparent" style="border-color: <%= systemSettings.primary_color || '#3b82f6' %>; border-top-color: transparent;"></div>
        <span class="text-gray-700 font-medium text-base"><%= typeof t === 'function' ? t('loadingData') : 'กำลังโหลดข้อมูล...' %></span>
    </div>
</div>

<style>
/* View toggle buttons */
.view-toggle-btn {
    transition: all 0.2s;
}
.view-toggle-btn:hover {
    background: rgba(255, 255, 255, 0.3);
}
.view-toggle-btn.active {
    background: rgba(255, 255, 255, 0.3);
    color: white;
}

.leaderboard-sort-btn {
    background: #f3f4f6;
    color: #6b7280;
    transition: all 0.2s;
}
.leaderboard-sort-btn:hover {
    background: #e5e7eb;
}
.leaderboard-sort-btn.active {
    background: #4f46e5;
    color: white;
}

.progress-bar-container {
    width: 100%;
    height: 6px;
    background: #e5e7eb;
    border-radius: 3px;
    overflow: hidden;
}
.progress-bar-fill {
    height: 100%;
    border-radius: 3px;
    transition: width 0.3s ease;
}

.status-badge {
    padding: 2px 8px;
    border-radius: 9999px;
    font-size: 10px;
    font-weight: 600;
}
.status-active { background: #fef3c7; color: #d97706; }
.status-in-progress { background: #dbeafe; color: #2563eb; }
.status-completed { background: #d1fae5; color: #059669; }
.status-dropped { background: #fee2e2; color: #dc2626; }

.course-card {
    transition: all 0.2s;
    border: 1px solid #e5e7eb;
}
.course-card:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px -2px rgba(0, 0, 0, 0.1);
}

/* Timeline styles */
.timeline-item {
    position: relative;
    padding-left: 24px;
    padding-bottom: 10px;
}
.timeline-item:last-child {
    padding-bottom: 0;
}
.timeline-item::before {
    content: '';
    position: absolute;
    left: 9px;
    top: 16px;
    bottom: 0;
    width: 1px;
    background: #e5e7eb;
}
.timeline-item:last-child::before {
    display: none;
}
.timeline-dot {
    position: absolute;
    left: 5px;
    top: 3px;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    border: 2px solid;
}

/* Leaderboard item styles */
.leaderboard-item {
    transition: all 0.2s;
}
.leaderboard-item:hover {
    transform: translateX(2px);
}
.rank-badge {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 11px;
}
.rank-1 { background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); color: white; }
.rank-2 { background: linear-gradient(135deg, #9ca3af 0%, #6b7280 100%); color: white; }
.rank-3 { background: linear-gradient(135deg, #d97706 0%, #b45309 100%); color: white; }
.rank-default { background: #f3f4f6; color: #6b7280; }
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Translations for JavaScript
const translations = {
    noLearnerData: '<%= typeof t === "function" ? t("noLearnerData") : "ไม่มีข้อมูลผู้เรียน" %>',
    noEnrollmentHistory: '<%= typeof t === "function" ? t("noEnrollmentHistory") : "ไม่มีประวัติการลงทะเบียน" %>',
    noCourseData: '<%= typeof t === "function" ? t("noCourseData") : "ไม่พบข้อมูลหลักสูตร" %>',
    noEnrollmentData: '<%= typeof t === "function" ? t("noEnrollmentData") : "ไม่พบข้อมูลการลงทะเบียน" %>',
    enrollmentDetails: '<%= typeof t === "function" ? t("enrollmentDetails") : "รายละเอียดผู้ลงทะเบียน" %>',
    learnersInCourse: '<%= typeof t === "function" ? t("learnersInCourse") : "ผู้เรียนในหลักสูตร" %>',
    avgProgress: '<%= typeof t === "function" ? t("avgProgress") : "ความก้าวหน้าเฉลี่ย" %>',
    statusActive: '<%= typeof t === "function" ? t("statusActive") : "กำลังเรียน" %>',
    statusInProgress: '<%= typeof t === "function" ? t("statusInProgress") : "กำลังดำเนินการ" %>',
    statusCompleted: '<%= typeof t === "function" ? t("statusCompleted") : "เสร็จสิ้น" %>',
    statusDropped: '<%= typeof t === "function" ? t("statusDropped") : "ยกเลิก" %>',
    allCourses: '<%= typeof t === "function" ? t("allCourses") : "ทุกหลักสูตร" %>',
    allDepartments: '<%= typeof t === "function" ? t("allDepartments") : "ทุกแผนก" %>',
    people: '<%= typeof t === "function" ? t("people") : "คน" %>',
    inProgress: '<%= typeof t === "function" ? t("inProgress") : "กำลังเรียน" %>',
    completed: '<%= typeof t === "function" ? t("completed") : "เสร็จสิ้น" %>',
    dropped: '<%= typeof t === "function" ? t("dropped") : "ยกเลิก" %>',
    notSpecified: '<%= typeof t === "function" ? t("notSpecified") : "ไม่ระบุ" %>',
    completionRateLabel: '<%= typeof t === "function" ? t("completionRate") : "อัตราสำเร็จ" %>',
    errorLoadingData: '<%= typeof t === "function" ? t("errorLoadingData") : "ไม่สามารถโหลดข้อมูลได้" %>',
    errorOccurred: '<%= typeof t === "function" ? t("errorOccurred") : "เกิดข้อผิดพลาดในการโหลดข้อมูล" %>',
    division: '<%= typeof t === "function" ? t("division") : "ฝ่าย" %>',
    department: '<%= typeof t === "function" ? t("department") : "แผนก" %>',
    position: '<%= typeof t === "function" ? t("position") : "ตำแหน่ง" %>',
    enrollmentDate: '<%= typeof t === "function" ? t("enrollmentDate") : "วันที่ลงทะเบียน" %>',
    status: '<%= typeof t === "function" ? t("status") : "สถานะ" %>',
    progress: '<%= typeof t === "function" ? t("progress") : "ความก้าวหน้า" %>',
    completionDate: '<%= typeof t === "function" ? t("completionDate") : "วันที่เสร็จสิ้น" %>',
    lastAccess: '<%= typeof t === "function" ? t("lastAccess") : "เข้าใช้ล่าสุด" %>',
    grade: '<%= typeof t === "function" ? t("grade") : "เกรด" %>',
    certificate: '<%= typeof t === "function" ? t("certificate") : "ใบประกาศนียบัตร" %>',
    received: '<%= typeof t === "function" ? t("received") : "ได้รับแล้ว" %>',
    notReceived: '<%= typeof t === "function" ? t("notReceived") : "ยังไม่ได้รับ" %>',
    hours: '<%= typeof t === "function" ? t("hours") : "ชั่วโมง" %>',
    noCategory: '<%= typeof t === "function" ? t("noCategory") : "ไม่ระบุหมวดหมู่" %>',
    noInstructor: '<%= typeof t === "function" ? t("noInstructor") : "ไม่ระบุผู้สอน" %>',
    general: '<%= typeof t === "function" ? t("general") : "ทั่วไป" %>'
};

let reportData = null;
let charts = {};
let currentPage = 1;
let itemsPerPage = 15;
let sortField = 'enrollment_date';
let sortDirection = 'desc';
let currentFilters = {};
let selectedCourseId = null;

document.addEventListener('DOMContentLoaded', function() {
    loadReportData();

    // Enter key to search
    document.getElementById('searchInput').addEventListener('keyup', function(e) {
        if (e.key === 'Enter') applyFilters();
    });

    // Course filter change
    document.getElementById('filterCourse').addEventListener('change', function() {
        applyFilters();
    });
});

async function loadReportData() {
    showLoading(true);

    try {
        const params = new URLSearchParams(currentFilters);
        const response = await fetch(`/reports/api/course-enrollments?${params}`);
        const result = await response.json();

        if (result.success) {
            reportData = result.data;
            selectedCourseId = currentFilters.course_id || null;

            updateOverview();
            updateFilters();
            initializeCharts();
            renderCourseSummary();
            renderEnrollmentsTable();

            if (selectedCourseId) {
                renderLeaderboard();
                renderEnrollmentTimeline();
            }

            // Call after table is rendered so course-column elements exist
            updateUIForCourseSelection();
        } else {
            showError('ไม่สามารถโหลดข้อมูลได้');
        }
    } catch (error) {
        console.error('Error loading report data:', error);
        showError('เกิดข้อผิดพลาดในการโหลดข้อมูล');
    } finally {
        showLoading(false);
    }
}

function updateUIForCourseSelection() {
    const isSpecificCourse = selectedCourseId && reportData.courseSummary.length === 1;

    // Toggle UI sections
    document.getElementById('mainHeader').classList.toggle('hidden', isSpecificCourse);
    document.getElementById('selectedCourseHero').classList.toggle('hidden', !isSpecificCourse);
    document.getElementById('overviewCards').classList.toggle('hidden', isSpecificCourse);
    document.getElementById('overviewCharts').classList.toggle('hidden', isSpecificCourse);
    document.getElementById('courseDetailCharts').classList.toggle('hidden', !isSpecificCourse);
    document.getElementById('courseSummarySection').classList.toggle('hidden', isSpecificCourse);
    document.getElementById('learnerLeaderboard').classList.toggle('hidden', !isSpecificCourse);
    document.getElementById('enrollmentTimeline').classList.toggle('hidden', !isSpecificCourse);
    document.getElementById('enrollmentsTableSection').classList.toggle('hidden', !isSpecificCourse);

    // Toggle course column in header
    document.getElementById('courseColumn').classList.toggle('hidden', isSpecificCourse);

    // Toggle course column in table body
    document.querySelectorAll('.course-column').forEach(td => {
        td.classList.toggle('hidden', isSpecificCourse);
    });

    // Update table title
    if (isSpecificCourse) {
        const course = reportData.courseSummary[0];
        document.getElementById('tableTitle').innerHTML = `<i class="fas fa-users mr-2"></i>${translations.learnersInCourse}: ${course.course_title}`;

        // Update hero section
        updateCourseHero(course);
    } else {
        document.getElementById('tableTitle').innerHTML = '<i class="fas fa-users mr-2"></i>' + translations.enrollmentDetails;
    }
}

function updateCourseHero(course) {
    document.getElementById('heroTitle').textContent = course.course_title;
    document.getElementById('heroThumbnail').src = course.thumbnail || '/images/course-default.svg';
    document.getElementById('heroBadge').textContent = course.category || translations.noCategory;

    // Update meta info - find span inside each element
    const instructorEl = document.getElementById('heroInstructor');
    const instructorSpan = instructorEl.querySelector('span');
    if (instructorSpan) {
        instructorSpan.textContent = course.instructor_name || translations.noInstructor;
    }

    const durationEl = document.getElementById('heroDuration');
    const durationSpan = durationEl.querySelector('span');
    if (durationSpan) {
        durationSpan.textContent = (course.duration_hours || 0) + ' ' + translations.hours;
    }

    const levelEl = document.getElementById('heroLevel');
    const levelSpan = levelEl.querySelector('span');
    if (levelSpan) {
        levelSpan.textContent = course.difficulty_level || translations.general;
    }

    document.getElementById('heroProgress').textContent = course.avg_progress + '%';
    document.getElementById('heroProgressBar').style.width = course.avg_progress + '%';

    document.getElementById('heroEnrollments').textContent = course.total_enrollments;
    document.getElementById('heroInProgress').textContent = course.in_progress;
    document.getElementById('heroCompleted').textContent = course.completed;
    document.getElementById('heroCompletionRate').textContent = course.completion_rate + '%';
}

function updateOverview() {
    const overview = reportData.overview;
    document.getElementById('totalCourses').textContent = overview.totalCourses.toLocaleString();
    document.getElementById('totalEnrollments').textContent = overview.totalEnrollments.toLocaleString();
    document.getElementById('activeEnrollments').textContent = overview.activeEnrollments.toLocaleString();
    document.getElementById('completedEnrollments').textContent = overview.completedEnrollments.toLocaleString();
    document.getElementById('avgProgress').textContent = overview.avgProgress + '%';
    document.getElementById('completionRate').textContent = overview.completionRate + '%';
}

function updateFilters() {
    // Update course dropdown
    const courseSelect = document.getElementById('filterCourse');
    const currentValue = courseSelect.value;
    courseSelect.innerHTML = `<option value="">${translations.allCourses}</option>`;
    reportData.courses.forEach(course => {
        const option = document.createElement('option');
        option.value = course.course_id;
        option.textContent = course.title;
        if (course.course_id == currentFilters.course_id) {
            option.selected = true;
        }
        courseSelect.appendChild(option);
    });

    // Update department dropdown
    const deptSelect = document.getElementById('filterDepartment');
    deptSelect.innerHTML = `<option value="">${translations.allDepartments}</option>`;
    reportData.departments.forEach(dept => {
        const option = document.createElement('option');
        option.value = dept;
        option.textContent = dept;
        deptSelect.appendChild(option);
    });
}

function initializeCharts() {
    // Destroy existing charts
    Object.values(charts).forEach(chart => chart.destroy());
    charts = {};

    const isSpecificCourse = selectedCourseId && reportData.courseSummary.length === 1;

    if (isSpecificCourse) {
        // Course-specific charts
        initializeCourseDetailCharts();
    } else {
        // Overview charts
        initializeOverviewCharts();
    }
}

function initializeOverviewCharts() {
    // Progress Distribution Chart
    const progressCtx = document.getElementById('progressChart').getContext('2d');
    charts.progress = new Chart(progressCtx, {
        type: 'doughnut',
        data: {
            labels: reportData.charts.progressDistribution.labels,
            datasets: [{
                data: reportData.charts.progressDistribution.data,
                backgroundColor: [
                    '#94a3b8', '#f87171', '#fb923c', '#facc15', '#4ade80', '#22c55e'
                ],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom', labels: { padding: 15, usePointStyle: true } }
            }
        }
    });

    // Department Enrollments Chart
    const deptCtx = document.getElementById('departmentChart').getContext('2d');
    charts.department = new Chart(deptCtx, {
        type: 'bar',
        data: {
            labels: reportData.charts.departmentEnrollments.labels,
            datasets: [
                { label: 'ลงทะเบียน', data: reportData.charts.departmentEnrollments.enrollments, backgroundColor: '#818cf8', borderRadius: 4 },
                { label: 'เสร็จสิ้น', data: reportData.charts.departmentEnrollments.completed, backgroundColor: '#34d399', borderRadius: 4 }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'bottom' } },
            scales: { y: { beginAtZero: true } }
        }
    });
}

function initializeCourseDetailCharts() {
    // Enrollment Timeline Chart
    const timelineCtx = document.getElementById('enrollmentTimelineChart').getContext('2d');

    // Generate monthly data from enrollments
    const monthlyData = generateMonthlyEnrollmentData();

    charts.timeline = new Chart(timelineCtx, {
        type: 'line',
        data: {
            labels: monthlyData.labels,
            datasets: [{
                label: 'ลงทะเบียนใหม่',
                data: monthlyData.enrollments,
                borderColor: '#6366f1',
                backgroundColor: 'rgba(99, 102, 241, 0.1)',
                fill: true,
                tension: 0.4
            }, {
                label: 'เรียนจบ',
                data: monthlyData.completions,
                borderColor: '#22c55e',
                backgroundColor: 'rgba(34, 197, 94, 0.1)',
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'bottom' } },
            scales: { y: { beginAtZero: true } }
        }
    });

    // Course Progress Distribution
    const progressCtx = document.getElementById('courseProgressChart').getContext('2d');
    charts.courseProgress = new Chart(progressCtx, {
        type: 'doughnut',
        data: {
            labels: reportData.charts.progressDistribution.labels,
            datasets: [{
                data: reportData.charts.progressDistribution.data,
                backgroundColor: [
                    '#94a3b8', '#f87171', '#fb923c', '#facc15', '#4ade80', '#22c55e'
                ],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom', labels: { padding: 15, usePointStyle: true } }
            }
        }
    });
}

function generateMonthlyEnrollmentData() {
    const months = [];
    const enrollments = [];
    const completions = [];

    // Get last 6 months
    for (let i = 5; i >= 0; i--) {
        const date = new Date();
        date.setMonth(date.getMonth() - i);
        months.push(date.toLocaleDateString('th-TH', { month: 'short', year: '2-digit' }));

        const monthStart = new Date(date.getFullYear(), date.getMonth(), 1);
        const monthEnd = new Date(date.getFullYear(), date.getMonth() + 1, 0);

        const monthEnrollments = reportData.enrollments.filter(e => {
            const enrollDate = new Date(e.enrollment_date);
            return enrollDate >= monthStart && enrollDate <= monthEnd;
        }).length;

        const monthCompletions = reportData.enrollments.filter(e => {
            if (!e.completion_date) return false;
            const compDate = new Date(e.completion_date);
            return compDate >= monthStart && compDate <= monthEnd;
        }).length;

        enrollments.push(monthEnrollments);
        completions.push(monthCompletions);
    }

    return { labels: months, enrollments, completions };
}

function renderLeaderboard() {
    const container = document.getElementById('leaderboardContainer');
    const sorted = [...reportData.enrollments].sort((a, b) => b.progress - a.progress);
    const top10 = sorted.slice(0, 10);

    if (top10.length === 0) {
        container.innerHTML = '<div class="text-center py-8 text-gray-500 text-sm">' + translations.noLearnerData + '</div>';
        return;
    }

    container.innerHTML = top10.map((user, index) => `
        <div class="leaderboard-item flex items-center bg-gray-50 rounded-xl p-3 cursor-pointer hover:bg-gray-100" onclick="viewUserDetail(${user.user_id}, ${user.course_id})">
            <div class="rank-badge ${index < 3 ? 'rank-' + (index + 1) : 'rank-default'} mr-3 flex-shrink-0" style="width: 28px; height: 28px; font-size: 13px;">
                ${index + 1}
            </div>
            <img src="${user.profile_image || '/images/default-avatar.png'}"
                 alt="${user.full_name}"
                 class="w-10 h-10 rounded-full object-cover mr-3 flex-shrink-0 ring-2 ring-white shadow"
                 onerror="this.onerror=null; this.src='/images/default-avatar.png'">
            <div class="flex-1 min-w-0 mr-3">
                <p class="text-sm font-semibold text-gray-900 truncate">${user.full_name}</p>
                <p class="text-sm text-gray-500 truncate">${user.department_name || '-'}</p>
            </div>
            <div class="text-right flex-shrink-0">
                <p class="text-base font-bold" style="color: ${getProgressColor(user.progress)}">${user.progress}%</p>
            </div>
        </div>
    `).join('');
}

function sortLeaderboard(sortType) {
    document.querySelectorAll('.leaderboard-sort-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.sort === sortType);
    });

    const container = document.getElementById('leaderboardContainer');
    let sorted;

    if (sortType === 'progress') {
        sorted = [...reportData.enrollments].sort((a, b) => b.progress - a.progress);
    } else {
        sorted = [...reportData.enrollments].sort((a, b) => new Date(b.enrollment_date) - new Date(a.enrollment_date));
    }

    const top10 = sorted.slice(0, 10);
    container.innerHTML = top10.map((user, index) => `
        <div class="leaderboard-item flex items-center bg-gray-50 rounded-xl p-3 cursor-pointer hover:bg-gray-100" onclick="viewUserDetail(${user.user_id}, ${user.course_id})">
            <div class="rank-badge ${index < 3 ? 'rank-' + (index + 1) : 'rank-default'} mr-3 flex-shrink-0" style="width: 28px; height: 28px; font-size: 13px;">
                ${index + 1}
            </div>
            <img src="${user.profile_image || '/images/default-avatar.png'}"
                 alt="${user.full_name}"
                 class="w-10 h-10 rounded-full object-cover mr-3 flex-shrink-0 ring-2 ring-white shadow"
                 onerror="this.onerror=null; this.src='/images/default-avatar.png'">
            <div class="flex-1 min-w-0 mr-3">
                <p class="text-sm font-semibold text-gray-900 truncate">${user.full_name}</p>
                <p class="text-sm text-gray-500 truncate">${user.department_name || '-'}</p>
            </div>
            <div class="text-right flex-shrink-0">
                <p class="text-base font-bold" style="color: ${getProgressColor(user.progress)}">${user.progress}%</p>
            </div>
        </div>
    `).join('');
}

function renderEnrollmentTimeline() {
    const container = document.getElementById('timelineContainer');
    const sorted = [...reportData.enrollments].sort((a, b) => new Date(b.enrollment_date) - new Date(a.enrollment_date));
    const recent = sorted.slice(0, 8);

    if (recent.length === 0) {
        container.innerHTML = '<div class="text-center py-6 text-gray-500 text-sm">' + translations.noEnrollmentHistory + '</div>';
        return;
    }

    container.innerHTML = recent.map(user => {
        const statusColor = user.status === 'Completed' ? '#22c55e' : user.status === 'Active' || user.status === 'In Progress' ? '#f59e0b' : '#ef4444';
        return `
            <div class="timeline-item" style="padding-left: 32px; padding-bottom: 14px;">
                <div class="timeline-dot" style="border-color: ${statusColor}; background: white; width: 12px; height: 12px; left: 5px; top: 4px;"></div>
                <div class="bg-gray-50 rounded-xl p-3 cursor-pointer hover:bg-gray-100" onclick="viewUserDetail(${user.user_id}, ${user.course_id})">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center min-w-0 flex-1">
                            <img src="${user.profile_image || '/images/default-avatar.png'}"
                                 alt="${user.full_name}"
                                 class="w-10 h-10 rounded-full object-cover mr-3 flex-shrink-0 ring-2 ring-white shadow"
                                 onerror="this.onerror=null; this.src='/images/default-avatar.png'">
                            <div class="min-w-0 flex-1">
                                <p class="text-sm font-semibold text-gray-900 truncate">${user.full_name}</p>
                                <p class="text-sm text-gray-500">${user.department_name || '-'}</p>
                            </div>
                        </div>
                        <div class="text-right flex-shrink-0 ml-3">
                            <p class="text-sm text-gray-500">${formatDate(user.enrollment_date)}</p>
                            <div class="flex items-center justify-end gap-1">
                                <span class="text-sm font-medium" style="color: ${getProgressColor(user.progress)}">${user.progress}%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

function renderCourseSummary() {
    const container = document.getElementById('courseSummaryContainer');
    const courses = reportData.courseSummary;

    if (courses.length === 0) {
        container.innerHTML = `
            <div class="col-span-full text-center py-10">
                <i class="fas fa-book-open text-gray-300 text-5xl mb-4"></i>
                <p class="text-gray-500 text-base">${translations.noCourseData}</p>
            </div>
        `;
        return;
    }

    container.innerHTML = courses.map(course => `
        <div class="course-card bg-white rounded-xl p-4 cursor-pointer" onclick="filterByCourse('${course.course_id}')">
            <div class="flex items-start justify-between mb-3">
                <div class="flex-1">
                    <h4 class="text-sm font-semibold text-gray-900 line-clamp-2">${course.course_title}</h4>
                    <p class="text-sm text-gray-500">${course.category}</p>
                </div>
                <span class="px-2 py-1 text-xs font-medium bg-indigo-100 text-indigo-700 rounded-full">
                    ${course.total_enrollments} ${translations.people}
                </span>
            </div>

            <div class="space-y-3">
                <div>
                    <div class="flex justify-between text-sm mb-1">
                        <span class="text-gray-600">${translations.avgProgress}</span>
                        <span class="font-medium text-gray-900">${course.avg_progress}%</span>
                    </div>
                    <div class="progress-bar-container" style="height: 8px;">
                        <div class="progress-bar-fill" style="width: ${course.avg_progress}%; background: ${getProgressColor(course.avg_progress)};"></div>
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-2 text-center">
                    <div class="bg-yellow-50 rounded-lg p-2">
                        <p class="text-sm font-bold text-yellow-600">${course.in_progress}</p>
                        <p class="text-xs text-yellow-700">${translations.inProgress}</p>
                    </div>
                    <div class="bg-green-50 rounded-lg p-2">
                        <p class="text-sm font-bold text-green-600">${course.completed}</p>
                        <p class="text-xs text-green-700">${translations.completed}</p>
                    </div>
                    <div class="bg-red-50 rounded-lg p-2">
                        <p class="text-sm font-bold text-red-600">${course.dropped}</p>
                        <p class="text-xs text-red-700">${translations.dropped}</p>
                    </div>
                </div>

                <div class="text-sm text-gray-500 pt-2 border-t">
                    <i class="fas fa-user mr-1"></i>${course.instructor_name || translations.notSpecified}
                    <span class="mx-2">|</span>
                    <i class="fas fa-trophy mr-1"></i>${translations.completionRateLabel} ${course.completion_rate}%
                </div>
            </div>
        </div>
    `).join('');
}

function renderEnrollmentsTable() {
    const enrollments = reportData.enrollments;
    const start = (currentPage - 1) * itemsPerPage;
    const end = start + itemsPerPage;
    const paginatedData = enrollments.slice(start, end);
    const isSpecificCourse = selectedCourseId && reportData.courseSummary.length === 1;

    // Update table
    const tbody = document.getElementById('enrollmentsTableBody');

    if (paginatedData.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="px-4 py-8 text-center">
                    <div class="flex flex-col items-center">
                        <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center mb-2">
                            <i class="fas fa-users text-gray-400"></i>
                        </div>
                        <p class="text-sm text-gray-500">ไม่พบข้อมูลการลงทะเบียน</p>
                    </div>
                </td>
            </tr>
        `;
    } else {
        tbody.innerHTML = paginatedData.map((enrollment, index) => `
            <tr class="hover:bg-blue-50/50 transition-colors group cursor-pointer" onclick="viewUserDetail(${enrollment.user_id}, ${enrollment.course_id})">
                <td class="px-4 py-3 text-gray-400 text-sm">${start + index + 1}</td>
                <td class="px-4 py-3">
                    <div class="flex items-center gap-3">
                        <img src="${enrollment.profile_image || '/images/default-avatar.png'}"
                             alt="${enrollment.full_name}"
                             class="w-10 h-10 rounded-full object-cover ring-2 ring-white shadow-sm"
                             onerror="this.onerror=null; this.src='/images/default-avatar.png'">
                        <div class="min-w-0">
                            <p class="text-sm font-semibold text-gray-800 truncate group-hover:text-blue-600 transition">${enrollment.full_name}</p>
                            <p class="text-sm text-gray-400">${enrollment.employee_id || '-'}</p>
                        </div>
                    </div>
                </td>
                <td class="px-4 py-3">
                    <div class="text-sm">
                        <p class="text-gray-700 truncate">${enrollment.division_name || '-'}</p>
                        <p class="text-gray-400 truncate">${enrollment.department_name || '-'}</p>
                    </div>
                </td>
                <td class="px-4 py-3 course-column">
                    <p class="text-sm text-gray-700 font-medium truncate max-w-[180px]">${enrollment.course_title}</p>
                    <p class="text-sm text-gray-400">${formatDate(enrollment.enrollment_date)}</p>
                </td>
                <td class="px-4 py-3">
                    <div class="flex items-center justify-center gap-2">
                        <div class="w-20 h-2 bg-gray-200 rounded-full overflow-hidden">
                            <div class="h-full rounded-full transition-all" style="width: ${enrollment.progress}%; background: ${getProgressColor(enrollment.progress)};"></div>
                        </div>
                        <span class="text-sm font-bold min-w-[36px] text-right" style="color: ${getProgressColor(enrollment.progress)}">${enrollment.progress}%</span>
                    </div>
                </td>
                <td class="px-4 py-3 text-center">
                    <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium status-${getStatusClass(enrollment.status)}">${getStatusText(enrollment.status)}</span>
                </td>
                <td class="px-4 py-3 text-center">
                    <button class="w-7 h-7 rounded-full bg-blue-100 text-blue-600 hover:bg-blue-200 transition flex items-center justify-center opacity-0 group-hover:opacity-100">
                        <i class="fas fa-eye text-xs"></i>
                    </button>
                </td>
            </tr>
        `).join('');
    }

    // Update cards view
    const cardsContainer = document.getElementById('enrollmentsCardsContainer');
    cardsContainer.innerHTML = paginatedData.map(enrollment => `
        <div class="bg-white rounded-lg p-3 border border-gray-100 hover:border-blue-200 hover:shadow-md transition-all cursor-pointer group" onclick="viewUserDetail(${enrollment.user_id}, ${enrollment.course_id})">
            <div class="flex items-center gap-3 mb-2">
                <img src="${enrollment.profile_image || '/images/default-avatar.png'}"
                     alt="${enrollment.full_name}"
                     class="w-10 h-10 rounded-full object-cover ring-2 ring-white shadow"
                     onerror="this.onerror=null; this.src='/images/default-avatar.png'">
                <div class="min-w-0 flex-1">
                    <p class="text-sm font-semibold text-gray-800 truncate group-hover:text-blue-600">${enrollment.full_name}</p>
                    <p class="text-sm text-gray-400 truncate">${enrollment.department_name || '-'}</p>
                </div>
            </div>
            ${!isSpecificCourse ? `<p class="text-sm font-medium text-gray-700 truncate mb-2">${enrollment.course_title}</p>` : ''}
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-2 flex-1">
                    <div class="flex-1 h-2 bg-gray-100 rounded-full overflow-hidden">
                        <div class="h-full rounded-full" style="width: ${enrollment.progress}%; background: ${getProgressColor(enrollment.progress)};"></div>
                    </div>
                    <span class="text-sm font-bold" style="color: ${getProgressColor(enrollment.progress)}">${enrollment.progress}%</span>
                </div>
                <span class="ml-2 inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium status-${getStatusClass(enrollment.status)}">${getStatusText(enrollment.status)}</span>
            </div>
        </div>
    `).join('');

    // Update pagination
    updatePagination(enrollments.length);
}

function updatePagination(total) {
    const totalPages = Math.ceil(total / itemsPerPage);
    const from = total === 0 ? 0 : (currentPage - 1) * itemsPerPage + 1;
    const to = Math.min(currentPage * itemsPerPage, total);

    document.getElementById('paginationFrom').textContent = from;
    document.getElementById('paginationTo').textContent = to;
    document.getElementById('paginationTotal').textContent = total;
    document.getElementById('currentPage').textContent = currentPage;
    document.getElementById('totalPages').textContent = totalPages || 1;
    document.getElementById('showingCount').textContent = total;

    document.getElementById('prevBtn').disabled = currentPage <= 1;
    document.getElementById('nextBtn').disabled = currentPage >= totalPages;
}

function previousPage() {
    if (currentPage > 1) {
        currentPage--;
        renderEnrollmentsTable();
    }
}

function nextPage() {
    const totalPages = Math.ceil(reportData.enrollments.length / itemsPerPage);
    if (currentPage < totalPages) {
        currentPage++;
        renderEnrollmentsTable();
    }
}

function applyFilters() {
    // Get date values and ensure they are in ISO format (YYYY-MM-DD)
    let dateFrom = document.getElementById('filterDateFrom').value;
    let dateTo = document.getElementById('filterDateTo').value;

    // Convert Buddhist Era (พ.ศ.) date to Christian Era (ค.ศ.) if needed
    dateFrom = convertToISODate(dateFrom);
    dateTo = convertToISODate(dateTo);

    currentFilters = {
        course_id: document.getElementById('filterCourse').value,
        department: document.getElementById('filterDepartment').value,
        status: document.getElementById('filterStatus').value,
        date_from: dateFrom,
        date_to: dateTo,
        search: document.getElementById('searchInput').value
    };

    // Remove empty values
    Object.keys(currentFilters).forEach(key => {
        if (!currentFilters[key]) delete currentFilters[key];
    });

    currentPage = 1;
    loadReportData();
}

// Convert date to ISO format, handling Buddhist Era dates
function convertToISODate(dateStr) {
    if (!dateStr) return '';

    // If already in ISO format (YYYY-MM-DD), check for Buddhist Era year
    if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
        const year = parseInt(dateStr.substring(0, 4));
        // Buddhist Era years are 543 years ahead of Christian Era
        // If year > 2400, it's likely Buddhist Era
        if (year > 2400) {
            const ceYear = year - 543;
            return ceYear + dateStr.substring(4);
        }
        return dateStr;
    }

    // Handle DD/MM/YYYY or D/M/YYYY format (Thai locale)
    if (dateStr.includes('/')) {
        const parts = dateStr.split('/');
        if (parts.length === 3) {
            let day = parts[0].padStart(2, '0');
            let month = parts[1].padStart(2, '0');
            let year = parseInt(parts[2]);

            // Convert Buddhist Era to Christian Era if needed
            if (year > 2400) {
                year = year - 543;
            }

            return `${year}-${month}-${day}`;
        }
    }

    // Try parsing as a date object
    try {
        const date = new Date(dateStr);
        if (!isNaN(date.getTime())) {
            let year = date.getFullYear();
            // Check if it's Buddhist Era
            if (year > 2400) {
                year = year - 543;
            }
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
    } catch (e) {
        // Ignore parsing errors
    }

    return dateStr;
}

function clearFilters() {
    document.getElementById('filterCourse').value = '';
    document.getElementById('filterDepartment').value = '';
    document.getElementById('filterStatus').value = '';
    document.getElementById('filterDateFrom').value = '';
    document.getElementById('filterDateTo').value = '';
    document.getElementById('searchInput').value = '';

    currentFilters = {};
    currentPage = 1;
    loadReportData();
}

function filterByCourse(courseId) {
    document.getElementById('filterCourse').value = courseId;
    applyFilters();
}

function sortCourses() {
    const sortBy = document.getElementById('courseSortBy').value;

    reportData.courseSummary.sort((a, b) => {
        switch (sortBy) {
            case 'enrollments': return b.total_enrollments - a.total_enrollments;
            case 'completion': return b.completion_rate - a.completion_rate;
            case 'progress': return b.avg_progress - a.avg_progress;
            case 'name': return a.course_title.localeCompare(b.course_title);
            default: return 0;
        }
    });

    renderCourseSummary();
}

function sortTable(field) {
    if (sortField === field) {
        sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
    } else {
        sortField = field;
        sortDirection = 'asc';
    }

    reportData.enrollments.sort((a, b) => {
        let aVal, bVal;

        switch (field) {
            case 'employee_id': aVal = a.employee_id || ''; bVal = b.employee_id || ''; break;
            case 'division': aVal = a.division_name || ''; bVal = b.division_name || ''; break;
            case 'department': aVal = a.department_name || ''; bVal = b.department_name || ''; break;
            case 'course': aVal = a.course_title || ''; bVal = b.course_title || ''; break;
            case 'enrollment_date': aVal = new Date(a.enrollment_date); bVal = new Date(b.enrollment_date); break;
            case 'progress': aVal = a.progress; bVal = b.progress; break;
            case 'status': aVal = a.status || ''; bVal = b.status || ''; break;
            default: return 0;
        }

        if (typeof aVal === 'string') {
            return sortDirection === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
        }
        return sortDirection === 'asc' ? aVal - bVal : bVal - aVal;
    });

    currentPage = 1;
    renderEnrollmentsTable();
}

function toggleView(view) {
    const tableBtn = document.getElementById('viewTable');
    const cardsBtn = document.getElementById('viewCards');

    // Update button styles
    if (view === 'table') {
        tableBtn.classList.add('active');
        tableBtn.classList.remove('text-white/70');
        tableBtn.classList.add('text-white');
        cardsBtn.classList.remove('active');
        cardsBtn.classList.add('text-white/70');
        cardsBtn.classList.remove('text-white');
    } else {
        cardsBtn.classList.add('active');
        cardsBtn.classList.remove('text-white/70');
        cardsBtn.classList.add('text-white');
        tableBtn.classList.remove('active');
        tableBtn.classList.add('text-white/70');
        tableBtn.classList.remove('text-white');
    }

    // Toggle views
    document.getElementById('tableView').classList.toggle('hidden', view !== 'table');
    document.getElementById('cardsView').classList.toggle('hidden', view !== 'cards');
}

function viewUserDetail(userId, courseId) {
    const enrollment = reportData.enrollments.find(e => e.user_id === userId && e.course_id === courseId);
    if (!enrollment) return;

    const modal = document.getElementById('userDetailModal');
    const content = document.getElementById('userDetailContent');

    content.innerHTML = `
        <div class="text-center mb-4">
            <img src="${enrollment.profile_image || '/images/default-avatar.png'}"
                 alt="${enrollment.full_name}"
                 class="w-14 h-14 rounded-full object-cover mx-auto mb-2"
                 onerror="this.onerror=null; this.src='/images/default-avatar.png'">
            <h3 class="text-base font-bold text-gray-900">${enrollment.full_name}</h3>
            <p class="text-xs text-gray-500">${enrollment.employee_id || '-'} | ${enrollment.email}</p>
        </div>

        <div class="grid grid-cols-3 gap-2 mb-4">
            <div class="bg-gray-50 rounded-lg p-2">
                <p class="text-xs text-gray-500">ฝ่าย</p>
                <p class="text-xs font-semibold text-gray-900 truncate">${enrollment.division_name || '-'}</p>
            </div>
            <div class="bg-gray-50 rounded-lg p-2">
                <p class="text-xs text-gray-500">แผนก</p>
                <p class="text-xs font-semibold text-gray-900 truncate">${enrollment.department_name || '-'}</p>
            </div>
            <div class="bg-gray-50 rounded-lg p-2">
                <p class="text-xs text-gray-500">ตำแหน่ง</p>
                <p class="text-xs font-semibold text-gray-900 truncate">${enrollment.position_name || '-'}</p>
            </div>
        </div>

        <div class="bg-indigo-50 rounded-lg p-3 mb-4">
            <h4 class="text-sm font-semibold text-indigo-900 mb-2 truncate">${enrollment.course_title}</h4>
            <div class="grid grid-cols-2 gap-3 text-xs">
                <div>
                    <p class="text-indigo-700">วันที่ลงทะเบียน</p>
                    <p class="font-medium text-indigo-900">${formatDate(enrollment.enrollment_date)}</p>
                </div>
                <div>
                    <p class="text-indigo-700">สถานะ</p>
                    <span class="status-badge status-${getStatusClass(enrollment.status)}">${getStatusText(enrollment.status)}</span>
                </div>
            </div>
        </div>

        <div class="mb-4">
            <div class="flex justify-between mb-1">
                <span class="text-xs font-medium text-gray-700">ความก้าวหน้า</span>
                <span class="text-sm font-bold text-indigo-600">${enrollment.progress}%</span>
            </div>
            <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
                <div class="h-full rounded-full transition-all" style="width: ${enrollment.progress}%; background: ${getProgressColor(enrollment.progress)};"></div>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-2 text-xs">
            <div class="bg-gray-50 rounded-lg p-2">
                <p class="text-gray-500">วันที่เสร็จสิ้น</p>
                <p class="font-medium text-gray-900">${enrollment.completion_date ? formatDate(enrollment.completion_date) : '-'}</p>
            </div>
            <div class="bg-gray-50 rounded-lg p-2">
                <p class="text-gray-500">เข้าใช้ล่าสุด</p>
                <p class="font-medium text-gray-900">${enrollment.last_access_date ? formatDateTime(enrollment.last_access_date) : '-'}</p>
            </div>
            <div class="bg-gray-50 rounded-lg p-2">
                <p class="text-gray-500">เกรด</p>
                <p class="font-medium text-gray-900">${enrollment.grade || '-'}</p>
            </div>
            <div class="bg-gray-50 rounded-lg p-2">
                <p class="text-gray-500">ใบประกาศนียบัตร</p>
                <p class="font-medium ${enrollment.certificate_issued ? 'text-green-600' : 'text-gray-900'}">
                    ${enrollment.certificate_issued ? '<i class="fas fa-check-circle mr-1"></i>ได้รับแล้ว' : 'ยังไม่ได้รับ'}
                </p>
            </div>
        </div>
    `;

    modal.classList.remove('hidden');
}

function closeUserModal() {
    document.getElementById('userDetailModal').classList.add('hidden');
}

function exportReport() {
    const params = new URLSearchParams(currentFilters);
    window.location.href = `/reports/api/export/course-enrollments?${params}`;
}

function refreshData() {
    loadReportData();
}

// Utility functions
function getProgressColor(progress) {
    if (progress >= 100) return '#22c55e';
    if (progress >= 75) return '#4ade80';
    if (progress >= 50) return '#facc15';
    if (progress >= 25) return '#fb923c';
    return '#f87171';
}

function getStatusClass(status) {
    const s = (status || '').toLowerCase();
    switch (s) {
        case 'active': return 'active';
        case 'in progress':
        case 'in_progress': return 'in-progress';
        case 'completed': return 'completed';
        case 'dropped':
        case 'cancelled': return 'dropped';
        default: return 'active';
    }
}

function getStatusText(status) {
    const s = (status || '').toLowerCase();
    switch (s) {
        case 'active': return translations.statusActive;
        case 'in progress':
        case 'in_progress': return translations.statusInProgress;
        case 'completed': return translations.statusCompleted;
        case 'dropped': return translations.statusDropped;
        case 'cancelled': return translations.statusDropped;
        default: return translations.statusActive;
    }
}

function formatDate(dateStr) {
    if (!dateStr) return '-';
    const date = new Date(dateStr);
    return date.toLocaleDateString('th-TH', { year: 'numeric', month: 'short', day: 'numeric' });
}

function formatDateTime(dateStr) {
    if (!dateStr) return '-';
    const date = new Date(dateStr);
    return date.toLocaleDateString('th-TH', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
}

function showLoading(show) {
    document.getElementById('loadingOverlay').classList.toggle('hidden', !show);
}

function showError(message) {
    alert('Error: ' + message);
}
</script>
