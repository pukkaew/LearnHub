<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Header - Gradient Style เหมือนหน้าอื่น -->
    <div class="rounded-2xl p-6 mb-8 text-white shadow-lg" style="background: linear-gradient(to right, <%= systemSettings.primary_color || '#3b82f6' %>, <%= systemSettings.secondary_color || '#10b981' %>);">
        <div class="flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold text-white">
                    <i class="fas fa-graduation-cap mr-3"></i><%= t('learningProgressReport') %>
                </h1>
                <p class="text-white/80 mt-1"><%= t('learningProgressDescription') %></p>
            </div>
            <div class="flex space-x-3">
                <button onclick="window.print()" class="bg-white/20 hover:bg-white/30 backdrop-blur-sm text-white font-medium py-2 px-4 rounded-lg transition-all duration-200 flex items-center">
                    <i class="fas fa-print mr-2"></i><%= t('print') %>
                </button>
                <button onclick="exportCSV()" class="bg-white/20 hover:bg-white/30 backdrop-blur-sm text-white font-medium py-2 px-4 rounded-lg transition-all duration-200 flex items-center">
                    <i class="fas fa-file-excel mr-2"></i><%= t('export') %>
                </button>
                <button onclick="refreshData()" class="bg-white/20 hover:bg-white/30 backdrop-blur-sm text-white font-medium py-2 px-4 rounded-lg transition-all duration-200 flex items-center">
                    <i class="fas fa-sync-alt mr-2"></i><%= t('refresh') %>
                </button>
            </div>
        </div>
    </div>

    <!-- Summary Cards - Dashboard Style -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-6 mb-6">
        <div class="stat-card bg-white rounded-xl border border-gray-200 p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-500 mb-1"><%= t('totalEmployees') %></p>
                    <p class="text-3xl font-bold text-gray-900" id="total-employees">0</p>
                    <p class="text-xs text-gray-500 mt-2"><%= t('activeUsers') %></p>
                </div>
                <div class="icon-box bg-blue-100">
                    <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
                    </svg>
                </div>
            </div>
        </div>
        <div class="stat-card bg-white rounded-xl border border-gray-200 p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-500 mb-1"><%= t('completedEnrollments') %></p>
                    <p class="text-3xl font-bold text-green-600" id="completed-courses">0</p>
                    <p class="text-xs text-gray-500 mt-2"><%= t('coursesCompleted100') %></p>
                </div>
                <div class="icon-box bg-green-100">
                    <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"/>
                    </svg>
                </div>
            </div>
        </div>
        <div class="stat-card bg-white rounded-xl border border-gray-200 p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-500 mb-1"><%= t('inProgress') %></p>
                    <p class="text-3xl font-bold text-yellow-600" id="in-progress-courses">0</p>
                    <p class="text-xs text-gray-500 mt-2"><%= t('currentlyLearning') %></p>
                </div>
                <div class="icon-box bg-yellow-100">
                    <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                </div>
            </div>
        </div>
        <div class="stat-card bg-white rounded-xl border border-gray-200 p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-500 mb-1"><%= t('completionRate') %></p>
                    <p class="text-3xl font-bold text-purple-600"><span id="pass-rate">0</span>%</p>
                    <p class="text-xs text-gray-500 mt-2"><%= t('fromTotalEnrollments') %></p>
                </div>
                <div class="icon-box bg-purple-100">
                    <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"/>
                    </svg>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters Section -->
    <div class="bg-white rounded-xl border border-gray-200 p-4 mb-6">
        <h3 class="text-sm font-semibold text-gray-900 mb-3">
            <i class="fas fa-filter mr-2 text-gray-400"></i><%= t('filters') %>
        </h3>
        <form id="filter-form" class="grid grid-cols-1 md:grid-cols-5 gap-3">
            <div>
                <label for="department" class="block text-xs font-medium text-gray-700 mb-1"><%= t('department') %></label>
                <select id="department" name="department" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value=""><%= t('allDepartments') %></option>
                </select>
            </div>
            <div>
                <label for="course" class="block text-xs font-medium text-gray-700 mb-1"><%= t('course') %></label>
                <select id="course" name="course" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value=""><%= t('allCourses') %></option>
                </select>
            </div>
            <div>
                <label for="date_from" class="block text-xs font-medium text-gray-700 mb-1"><%= t('startDate') %></label>
                <input type="date" id="date_from" name="date_from" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div>
                <label for="date_to" class="block text-xs font-medium text-gray-700 mb-1"><%= t('endDate') %></label>
                <input type="date" id="date_to" name="date_to" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div class="flex items-end space-x-2">
                <button type="button" onclick="clearFilters()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-2 px-3 rounded-lg text-sm transition-all">
                    <i class="fas fa-times mr-1"></i><%= t('clear') %>
                </button>
                <button type="submit" class="flex-1 text-white font-medium py-2 px-3 rounded-lg text-sm transition-all" style="background: <%= systemSettings.primary_color || '#3b82f6' %>;">
                    <i class="fas fa-search mr-1"></i><%= t('search') %>
                </button>
            </div>
        </form>
    </div>

    <!-- Charts Section -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <!-- Progress Distribution Chart -->
        <div class="bg-white rounded-xl border border-gray-200">
            <div class="px-6 py-4 border-b border-gray-100">
                <h3 class="text-lg font-semibold text-gray-900">
                    <i class="fas fa-chart-pie mr-2" style="color: <%= systemSettings.primary_color || '#3b82f6' %>;"></i><%= t('statusDistribution') %>
                </h3>
            </div>
            <div class="p-6 flex items-center">
                <div style="position: relative; width: 180px; height: 180px;">
                    <canvas id="progressChart"></canvas>
                </div>
                <div class="ml-6 space-y-3">
                    <div class="flex items-center">
                        <div class="w-3 h-3 bg-green-500 rounded-full mr-2"></div>
                        <div>
                            <p class="text-sm text-gray-600"><%= t('completed') %></p>
                            <p class="text-lg font-bold text-green-600"><span id="chart-completed">0</span></p>
                        </div>
                    </div>
                    <div class="flex items-center">
                        <div class="w-3 h-3 bg-yellow-500 rounded-full mr-2"></div>
                        <div>
                            <p class="text-sm text-gray-600"><%= t('inProgress') %></p>
                            <p class="text-lg font-bold text-yellow-600"><span id="chart-inprogress">0</span></p>
                        </div>
                    </div>
                    <div class="flex items-center">
                        <div class="w-3 h-3 bg-gray-400 rounded-full mr-2"></div>
                        <div>
                            <p class="text-sm text-gray-600"><%= t('notStarted') %></p>
                            <p class="text-lg font-bold text-gray-600"><span id="chart-notstarted">0</span></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Department Performance Chart -->
        <div class="bg-white rounded-xl border border-gray-200">
            <div class="px-6 py-4 border-b border-gray-100">
                <h3 class="text-lg font-semibold text-gray-900">
                    <i class="fas fa-building mr-2" style="color: <%= systemSettings.secondary_color || '#10b981' %>;"></i><%= t('completionRateByDepartment') %>
                </h3>
            </div>
            <div class="p-6" style="position: relative; height: 240px;">
                <canvas id="departmentChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Department Rankings -->
    <div class="bg-white rounded-xl border border-gray-200 mb-6">
        <div class="px-6 py-4 border-b border-gray-100">
            <h3 class="text-lg font-semibold text-gray-900">
                <i class="fas fa-trophy mr-2 text-yellow-500"></i><%= t('topPerformingDepartments') %>
            </h3>
        </div>
        <div id="department-rankings" class="grid grid-cols-1 md:grid-cols-3 gap-4 p-6">
            <!-- Rankings will be loaded here -->
        </div>
    </div>

    <!-- Individual Progress Table -->
    <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-100">
            <div class="flex flex-col md:flex-row md:justify-between md:items-center gap-4">
                <div>
                    <h3 class="text-lg font-semibold text-gray-900">
                        <i class="fas fa-users mr-2" style="color: <%= systemSettings.primary_color || '#3b82f6' %>;"></i><%= t('individualProgress') %>
                    </h3>
                    <p class="text-sm text-gray-500 mt-1"><%= t('individualProgressDescription') %></p>
                </div>
                <div class="flex items-center space-x-3">
                    <div class="relative">
                        <input type="text" id="table-search" placeholder="<%= t('searchEmployee') %>"
                               class="pl-9 pr-4 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 w-64">
                        <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 text-sm"></i>
                    </div>
                    <select id="table-sort" class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500">
                        <option value="name"><%= t('sortByEmployeeName') %></option>
                        <option value="progress"><%= t('sortByProgressPercent') %></option>
                        <option value="department"><%= t('sortByDepartment') %></option>
                    </select>
                </div>
            </div>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase"><%= t('employeeId') %></th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase"><%= t('fullName') %></th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase"><%= t('department') %></th>
                        <th class="px-4 py-3 text-center text-xs font-semibold text-gray-500 uppercase"><%= t('enrolled') %></th>
                        <th class="px-4 py-3 text-center text-xs font-semibold text-gray-500 uppercase"><%= t('completed') %></th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase" style="min-width: 150px;"><%= t('progress') %></th>
                        <th class="px-4 py-3 text-center text-xs font-semibold text-gray-500 uppercase"><%= t('status') %></th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase"><%= t('lastActivity') %></th>
                    </tr>
                </thead>
                <tbody id="progress-table-body" class="bg-white divide-y divide-gray-100">
                    <!-- Data will be loaded here -->
                </tbody>
            </table>
        </div>
        <div class="px-5 py-4 border-t border-gray-100 bg-gray-50">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                <span class="text-sm text-gray-600">
                    <%= t('showing') %> <span id="showing-from" class="font-semibold">0</span> <%= t('to') %> <span id="showing-to" class="font-semibold">0</span> <%= t('of') %> <span id="total-records" class="font-semibold">0</span> <%= t('results') %>
                </span>
                <div class="flex items-center space-x-2" id="pagination-container">
                    <!-- Pagination will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-xl p-6 flex items-center space-x-4">
        <div class="animate-spin rounded-full h-10 w-10 border-4 border-t-transparent" style="border-color: <%= systemSettings.primary_color || '#3b82f6' %>; border-top-color: transparent;"></div>
        <span class="text-gray-700 font-medium"><%= t('loadingData') %></span>
    </div>
</div>

<!-- Print Styles -->
<style>
@media print {
    .no-print, button, form, input, select { display: none !important; }
    .shadow, .shadow-sm { box-shadow: none !important; }
}
#progress-table-body tr:hover { background-color: #f8fafc; }
.progress-bar-animated { animation: progressAnimation 1s ease-out forwards; }
@keyframes progressAnimation { from { width: 0%; } }
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// System colors
const primaryColor = '<%= systemSettings.primary_color || "#3b82f6" %>';
const secondaryColor = '<%= systemSettings.secondary_color || "#10b981" %>';

// i18n strings
const i18n = {
    noDataAvailable: '<%= t("noDataAvailable") %>',
    completedAll: '<%= t("completedAll") %>',
    inProgress: '<%= t("inProgress") %>',
    notStarted: '<%= t("notStarted") %>',
    noCourses: '<%= t("noCourses") %>',
    rank: '<%= t("rank") %>',
    completionRate: '<%= t("completionRate") %>',
    errorLoadingData: '<%= t("errorLoadingData") %>',
    connectionError: '<%= t("connectionError") %>',
    exportSuccess: '<%= t("exportSuccess") %>',
    exportFailed: '<%= t("exportFailed") %>',
    dataRefreshed: '<%= t("dataRefreshed") %>'
};

let progressChart, departmentChart;
let allData = [];
let originalData = [];
let currentPage = 1;
const pageSize = 15;

document.addEventListener('DOMContentLoaded', function() {
    initializeCharts();
    loadDepartmentOptions();
    loadCourseOptions();
    loadProgressData();

    document.getElementById('filter-form').addEventListener('submit', function(e) {
        e.preventDefault();
        currentPage = 1;
        loadProgressData();
    });

    document.getElementById('table-search').addEventListener('input', debounce(filterTable, 300));
    document.getElementById('table-sort').addEventListener('change', sortTable);
});

function debounce(func, wait) {
    let timeout;
    return function(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func(...args), wait);
    };
}

function showLoading(show) {
    document.getElementById('loading-overlay').classList.toggle('hidden', !show);
}

function showToast(message, type = 'success') {
    const toast = document.createElement('div');
    toast.className = `fixed top-4 right-4 ${type === 'error' ? 'bg-red-500' : 'bg-green-500'} text-white px-6 py-3 rounded-lg shadow-lg z-50 flex items-center`;
    toast.innerHTML = `<i class="fas fa-${type === 'error' ? 'exclamation-circle' : 'check-circle'} mr-2"></i>${message}`;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}

function clearFilters() {
    document.getElementById('filter-form').reset();
    currentPage = 1;
    loadProgressData();
}

async function loadDepartmentOptions() {
    try {
        const response = await fetch('/organization/api/departments');
        const data = await response.json();
        const select = document.getElementById('department');
        if (data.success && data.data) {
            data.data.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept.department_name;
                option.textContent = dept.department_name;
                select.appendChild(option);
            });
        }
    } catch (error) {
        console.error('Error loading departments:', error);
    }
}

async function loadCourseOptions() {
    try {
        const response = await fetch('/courses/api/all');
        const data = await response.json();
        const select = document.getElementById('course');
        if (data.success && data.data) {
            data.data.forEach(course => {
                const option = document.createElement('option');
                option.value = course.course_id;
                option.textContent = course.title;
                select.appendChild(option);
            });
        }
    } catch (error) {
        console.error('Error loading courses:', error);
    }
}

function initializeCharts() {
    // Progress Doughnut Chart
    const progressCtx = document.getElementById('progressChart').getContext('2d');
    progressChart = new Chart(progressCtx, {
        type: 'doughnut',
        data: {
            labels: ['<%= t("completed") %>', '<%= t("inProgress") %>', '<%= t("notStarted") %>'],
            datasets: [{
                data: [0, 0, 0],
                backgroundColor: ['#10B981', '#F59E0B', '#9CA3AF'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            cutout: '70%',
            plugins: { legend: { display: false } }
        }
    });

    // Department Bar Chart
    const departmentCtx = document.getElementById('departmentChart').getContext('2d');
    departmentChart = new Chart(departmentCtx, {
        type: 'bar',
        data: {
            labels: [],
            datasets: [{
                label: '<%= t("completionRate") %> (%)',
                data: [],
                backgroundColor: function(context) {
                    const value = context.raw || 0;
                    if (value >= 80) return '#10B981';
                    if (value >= 60) return '#3B82F6';
                    if (value >= 40) return '#F59E0B';
                    return '#EF4444';
                },
                borderRadius: 6,
                barThickness: 20
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            scales: {
                x: { beginAtZero: true, max: 100, grid: { color: 'rgba(0,0,0,0.05)' }, ticks: { callback: v => v + '%' } },
                y: { grid: { display: false } }
            },
            plugins: { legend: { display: false } }
        }
    });
}

async function loadProgressData() {
    showLoading(true);
    try {
        const formData = new FormData(document.getElementById('filter-form'));
        const params = new URLSearchParams(formData);
        const response = await fetch('/reports/api/learning-progress?' + params);
        const data = await response.json();

        if (data.success) {
            updateSummaryCards(data.summary);
            updateCharts(data.charts);
            originalData = data.tableData?.data || [];
            allData = [...originalData];
            updateTable();
            updateDepartmentRankings(data.charts.departments);
        } else {
            showToast(i18n.errorLoadingData, 'error');
        }
    } catch (error) {
        showToast(i18n.connectionError, 'error');
        console.error(error);
    } finally {
        showLoading(false);
    }
}

function updateSummaryCards(summary) {
    document.getElementById('total-employees').textContent = (summary.totalEmployees || 0).toLocaleString();
    document.getElementById('completed-courses').textContent = (summary.completedCourses || 0).toLocaleString();
    document.getElementById('in-progress-courses').textContent = (summary.inProgressCourses || 0).toLocaleString();
    document.getElementById('pass-rate').textContent = (summary.passRate || 0);
}

function updateCharts(chartData) {
    if (chartData.progress) {
        const completed = chartData.progress.completed || 0;
        const inProgress = chartData.progress.inProgress || 0;
        const notStarted = chartData.progress.notStarted || 0;

        progressChart.data.datasets[0].data = [completed, inProgress, notStarted];
        progressChart.update();

        document.getElementById('chart-completed').textContent = completed.toLocaleString();
        document.getElementById('chart-inprogress').textContent = inProgress.toLocaleString();
        document.getElementById('chart-notstarted').textContent = notStarted.toLocaleString();
    }

    if (chartData.departments && chartData.departments.length > 0) {
        const sortedDepts = [...chartData.departments].sort((a, b) => b.completion_rate - a.completion_rate).slice(0, 8);
        departmentChart.data.labels = sortedDepts.map(d => d.name);
        departmentChart.data.datasets[0].data = sortedDepts.map(d => parseFloat(d.completion_rate) || 0);
        departmentChart.update();
    }
}

function updateDepartmentRankings(departments) {
    const container = document.getElementById('department-rankings');
    if (!departments || departments.length === 0) {
        container.innerHTML = `<p class="text-gray-500 col-span-3 text-center py-4">${i18n.noDataAvailable}</p>`;
        return;
    }

    const sortedDepts = [...departments].sort((a, b) => b.completion_rate - a.completion_rate).slice(0, 3);
    const medals = ['<i class="fas fa-crown text-yellow-500"></i>', '2', '3'];
    const bgColors = ['bg-yellow-50 border-yellow-300', 'bg-gray-50 border-gray-300', 'bg-orange-50 border-orange-300'];

    container.innerHTML = sortedDepts.map((dept, index) => `
        <div class="rounded-xl p-4 border-2 ${bgColors[index]}">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <span class="inline-flex items-center justify-center w-8 h-8 rounded-full ${index === 0 ? 'bg-yellow-100' : 'bg-gray-100'} mr-3 font-bold text-gray-700">
                        ${medals[index]}
                    </span>
                    <div>
                        <p class="font-semibold text-gray-900">${dept.name}</p>
                        <p class="text-xs text-gray-500">${i18n.rank} ${index + 1}</p>
                    </div>
                </div>
                <div class="text-right">
                    <p class="text-xl font-bold text-gray-900">${parseFloat(dept.completion_rate).toFixed(1)}%</p>
                    <p class="text-xs text-gray-500">${i18n.completionRate}</p>
                </div>
            </div>
        </div>
    `).join('');
}

function updateTable() {
    const tbody = document.getElementById('progress-table-body');
    tbody.innerHTML = '';

    const startIndex = (currentPage - 1) * pageSize;
    const endIndex = startIndex + pageSize;
    const pageData = allData.slice(startIndex, endIndex);

    if (pageData.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="8" class="px-4 py-12 text-center text-gray-500">
                    <i class="fas fa-inbox text-4xl text-gray-300 mb-3"></i>
                    <p>${i18n.noDataAvailable}</p>
                </td>
            </tr>`;
        document.getElementById('showing-from').textContent = '0';
        document.getElementById('showing-to').textContent = '0';
        document.getElementById('total-records').textContent = '0';
        return;
    }

    pageData.forEach(row => {
        const progress = row.progress_percentage || 0;
        let progressColor = 'bg-gray-400';
        if (progress >= 80) progressColor = 'bg-green-500';
        else if (progress >= 60) progressColor = 'bg-blue-500';
        else if (progress >= 40) progressColor = 'bg-yellow-500';
        else if (progress > 0) progressColor = 'bg-red-500';

        const enrolled = row.enrolled_courses || 0;
        const completed = row.completed_courses || 0;

        let statusBadge = '';
        if (completed > 0 && completed === enrolled) {
            statusBadge = `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800"><i class="fas fa-check-circle mr-1"></i>${i18n.completedAll}</span>`;
        } else if (progress > 0) {
            statusBadge = `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800"><i class="fas fa-spinner mr-1"></i>${i18n.inProgress}</span>`;
        } else if (enrolled > 0) {
            statusBadge = `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800"><i class="fas fa-pause-circle mr-1"></i>${i18n.notStarted}</span>`;
        } else {
            statusBadge = `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-500"><i class="fas fa-minus-circle mr-1"></i>${i18n.noCourses}</span>`;
        }

        const tr = document.createElement('tr');
        tr.className = 'hover:bg-gray-50';
        tr.innerHTML = `
            <td class="px-4 py-3 text-sm text-gray-600 font-mono">${row.employee_id || '-'}</td>
            <td class="px-4 py-3">
                <div class="flex items-center">
                    <img class="h-8 w-8 rounded-full object-cover" src="${row.profile_image || '/images/default-avatar.png'}" alt="" onerror="this.src='/images/default-avatar.png'">
                    <span class="ml-3 text-sm font-medium text-gray-900">${row.full_name || '-'}</span>
                </div>
            </td>
            <td class="px-4 py-3 text-sm text-gray-600">${row.department || '-'}</td>
            <td class="px-4 py-3 text-center text-sm font-semibold text-gray-900">${enrolled}</td>
            <td class="px-4 py-3 text-center text-sm font-semibold text-green-600">${completed}</td>
            <td class="px-4 py-3">
                <div class="flex items-center">
                    <div class="flex-1 bg-gray-200 rounded-full h-2 mr-2" style="min-width: 80px;">
                        <div class="${progressColor} h-2 rounded-full progress-bar-animated" style="width: ${progress}%"></div>
                    </div>
                    <span class="text-sm font-medium text-gray-700 w-10 text-right">${progress}%</span>
                </div>
            </td>
            <td class="px-4 py-3 text-center">${statusBadge}</td>
            <td class="px-4 py-3 text-sm text-gray-500">${formatDate(row.last_activity)}</td>
        `;
        tbody.appendChild(tr);
    });

    document.getElementById('showing-from').textContent = allData.length > 0 ? startIndex + 1 : 0;
    document.getElementById('showing-to').textContent = Math.min(endIndex, allData.length);
    document.getElementById('total-records').textContent = allData.length;

    updatePagination();
}

function updatePagination() {
    const totalPages = Math.ceil(allData.length / pageSize);
    const container = document.getElementById('pagination-container');
    container.innerHTML = '';

    if (totalPages <= 1) return;

    // Previous
    const prevBtn = document.createElement('button');
    prevBtn.className = `px-3 py-1.5 border rounded-lg text-sm ${currentPage === 1 ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : 'bg-white hover:bg-gray-50 text-gray-700'}`;
    prevBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
    prevBtn.disabled = currentPage === 1;
    prevBtn.onclick = () => { if (currentPage > 1) { currentPage--; updateTable(); } };
    container.appendChild(prevBtn);

    // Page indicator
    const pageIndicator = document.createElement('span');
    pageIndicator.className = 'px-4 py-1.5 rounded-lg text-sm font-medium text-white';
    pageIndicator.style.background = primaryColor;
    pageIndicator.textContent = `${currentPage} / ${totalPages}`;
    container.appendChild(pageIndicator);

    // Next
    const nextBtn = document.createElement('button');
    nextBtn.className = `px-3 py-1.5 border rounded-lg text-sm ${currentPage === totalPages ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : 'bg-white hover:bg-gray-50 text-gray-700'}`;
    nextBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
    nextBtn.disabled = currentPage === totalPages;
    nextBtn.onclick = () => { if (currentPage < totalPages) { currentPage++; updateTable(); } };
    container.appendChild(nextBtn);
}

function filterTable() {
    const searchTerm = document.getElementById('table-search').value.toLowerCase().trim();
    if (searchTerm) {
        allData = originalData.filter(row =>
            (row.full_name && row.full_name.toLowerCase().includes(searchTerm)) ||
            (row.employee_id && row.employee_id.toLowerCase().includes(searchTerm)) ||
            (row.department && row.department.toLowerCase().includes(searchTerm))
        );
    } else {
        allData = [...originalData];
    }
    currentPage = 1;
    updateTable();
}

function sortTable() {
    const sortBy = document.getElementById('table-sort').value;
    allData.sort((a, b) => {
        if (sortBy === 'name') return (a.full_name || '').localeCompare(b.full_name || '', 'th');
        if (sortBy === 'progress') return (b.progress_percentage || 0) - (a.progress_percentage || 0);
        if (sortBy === 'department') return (a.department || '').localeCompare(b.department || '', 'th');
        return 0;
    });
    currentPage = 1;
    updateTable();
}

async function exportCSV() {
    try {
        const BOM = '\uFEFF';
        let csv = BOM + 'Employee ID,Name,Department,Enrolled,Completed,Progress(%),Status,Last Activity\n';

        originalData.forEach(row => {
            const status = (row.completed_courses > 0 && row.completed_courses === row.enrolled_courses) ? 'Completed' :
                          (row.progress_percentage > 0) ? 'In Progress' :
                          (row.enrolled_courses > 0) ? 'Not Started' : 'No Courses';
            csv += `"${row.employee_id || ''}","${row.full_name || ''}","${row.department || ''}",${row.enrolled_courses || 0},${row.completed_courses || 0},${row.progress_percentage || 0},"${status}","${formatDate(row.last_activity)}"\n`;
        });

        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'learning-progress-report_' + new Date().toISOString().split('T')[0] + '.csv';
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        a.remove();

        showToast(i18n.exportSuccess);
    } catch (error) {
        showToast(i18n.exportFailed, 'error');
    }
}

function refreshData() {
    loadProgressData();
    showToast(i18n.dataRefreshed);
}

function formatDate(dateString) {
    if (!dateString) return '-';
    try {
        const date = new Date(dateString);
        if (isNaN(date.getTime())) return '-';
        return date.toLocaleDateString('<%= language === "th" ? "th-TH" : "en-US" %>', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    } catch (e) {
        return '-';
    }
}
</script>
