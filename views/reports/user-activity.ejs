<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Header - Gradient Style -->
    <div class="rounded-2xl p-6 mb-8 text-white shadow-lg" style="background: linear-gradient(to right, <%= systemSettings.primary_color || '#3b82f6' %>, <%= systemSettings.secondary_color || '#10b981' %>);">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
            <div>
                <h1 class="text-3xl font-bold text-white">
                    <i class="fas fa-user-clock mr-3"></i><%= t('userActivityReport') %>
                </h1>
                <p class="text-white/80 mt-1"><%= t('userActivityDescription') %></p>
            </div>
            <div class="flex flex-wrap gap-3 mt-4 md:mt-0">
                <select id="time-period" class="bg-white/20 backdrop-blur-sm text-white border-0 rounded-lg px-4 py-2 focus:ring-2 focus:ring-white/50">
                    <option value="today" class="text-gray-900"><%= t('today') %></option>
                    <option value="7" class="text-gray-900"><%= t('last7Days') %></option>
                    <option value="30" selected class="text-gray-900"><%= t('last30Days') %></option>
                    <option value="90" class="text-gray-900"><%= t('last90Days') %></option>
                </select>
                <button onclick="realTimeMode()" id="realtime-btn" class="bg-white/20 hover:bg-white/30 backdrop-blur-sm text-white font-medium py-2 px-4 rounded-lg transition-all duration-200 flex items-center">
                    <i class="fas fa-broadcast-tower mr-2"></i><%= t('liveView') %>
                </button>
                <button onclick="exportActivity()" class="bg-white/20 hover:bg-white/30 backdrop-blur-sm text-white font-medium py-2 px-4 rounded-lg transition-all duration-200 flex items-center">
                    <i class="fas fa-download mr-2"></i><%= t('export') %>
                </button>
            </div>
        </div>
    </div>

    <!-- Real-time Status Banner -->
    <div id="realtime-banner" class="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-6 hidden">
        <div class="flex items-center justify-between">
            <div class="flex items-center">
                <div class="h-3 w-3 bg-green-500 rounded-full animate-pulse mr-3"></div>
                <span class="text-blue-800 font-medium"><%= t('realtimeMonitoringActive') %></span>
                <span class="text-blue-600 text-sm ml-2"><%= t('updatesEvery30Seconds') %></span>
            </div>
            <button onclick="exitRealTime()" class="text-blue-600 hover:text-blue-800">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>

    <!-- Overview Cards -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-6 mb-6">
        <div class="stat-card bg-white rounded-xl border border-gray-200 p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-500 mb-1"><%= t('activeUsers') %></p>
                    <p class="text-3xl font-bold text-gray-900" id="active-users">0</p>
                    <p class="text-xs text-green-600 mt-2" id="active-trend-container">
                        <i class="fas fa-arrow-up"></i>
                        <span id="active-trend">+12%</span> <%= t('vsYesterday') %>
                    </p>
                </div>
                <div class="icon-box bg-blue-100">
                    <i class="fas fa-users text-xl text-blue-600"></i>
                </div>
            </div>
        </div>

        <div class="stat-card bg-white rounded-xl border border-gray-200 p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-500 mb-1"><%= t('avgSessionTime') %></p>
                    <p class="text-3xl font-bold text-gray-900" id="avg-session">0m</p>
                    <p class="text-xs text-green-600 mt-2" id="session-trend-container">
                        <i class="fas fa-arrow-up"></i>
                        <span id="session-trend">+8m</span> <%= t('vsYesterday') %>
                    </p>
                </div>
                <div class="icon-box bg-green-100">
                    <i class="fas fa-clock text-xl text-green-600"></i>
                </div>
            </div>
        </div>

        <div class="stat-card bg-white rounded-xl border border-gray-200 p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-500 mb-1"><%= t('pageViews') %></p>
                    <p class="text-3xl font-bold text-gray-900" id="page-views">0</p>
                    <p class="text-xs text-green-600 mt-2" id="views-trend-container">
                        <i class="fas fa-arrow-up"></i>
                        <span id="views-trend">+15%</span> <%= t('vsYesterday') %>
                    </p>
                </div>
                <div class="icon-box bg-yellow-100">
                    <i class="fas fa-eye text-xl text-yellow-600"></i>
                </div>
            </div>
        </div>

        <div class="stat-card bg-white rounded-xl border border-gray-200 p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-500 mb-1"><%= t('engagementRate') %></p>
                    <p class="text-3xl font-bold text-gray-900" id="engagement-rate">0%</p>
                    <p class="text-xs text-green-600 mt-2" id="engagement-trend-container">
                        <i class="fas fa-arrow-up"></i>
                        <span id="engagement-trend">+3.2%</span> <%= t('vsYesterday') %>
                    </p>
                </div>
                <div class="icon-box bg-purple-100">
                    <i class="fas fa-mouse-pointer text-xl text-purple-600"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Filter Panel -->
    <div class="bg-white rounded-xl border border-gray-200 p-6 mb-6">
        <h3 class="text-sm font-semibold text-gray-900 mb-4">
            <i class="fas fa-filter mr-2 text-gray-400"></i><%= t('filters') %>
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div>
                <label for="user-type" class="block text-xs font-medium text-gray-700 mb-1"><%= t('userType') %></label>
                <select id="user-type" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500">
                    <option value=""><%= t('allUsers') %></option>
                    <option value="student"><%= t('students') %></option>
                    <option value="instructor"><%= t('instructors') %></option>
                    <option value="admin"><%= t('administrators') %></option>
                </select>
            </div>
            <div>
                <label for="department-filter" class="block text-xs font-medium text-gray-700 mb-1"><%= t('department') %></label>
                <select id="department-filter" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500">
                    <option value=""><%= t('allDepartments') %></option>
                </select>
            </div>
            <div>
                <label for="activity-type" class="block text-xs font-medium text-gray-700 mb-1"><%= t('activityType') %></label>
                <select id="activity-type" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500">
                    <option value=""><%= t('allActivities') %></option>
                    <option value="course_view"><%= t('courseViews') %></option>
                    <option value="test_attempt"><%= t('testAttempts') %></option>
                    <option value="video_watch"><%= t('videoWatching') %></option>
                    <option value="download"><%= t('downloads') %></option>
                </select>
            </div>
            <div>
                <label for="search-user" class="block text-xs font-medium text-gray-700 mb-1"><%= t('searchUser') %></label>
                <div class="relative">
                    <input type="text" id="search-user" placeholder="<%= t('usernameOrEmail') %>"
                           class="w-full pl-9 pr-4 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500">
                    <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 text-sm"></i>
                </div>
            </div>
        </div>
        <div class="flex justify-end mt-4 space-x-3">
            <button onclick="clearFilters()" class="px-4 py-2 border border-gray-300 rounded-lg text-sm text-gray-700 hover:bg-gray-50">
                <%= t('clear') %>
            </button>
            <button onclick="applyFilters()" class="px-4 py-2 rounded-lg text-sm text-white" style="background: <%= systemSettings.primary_color || '#3b82f6' %>;">
                <%= t('applyFilters') %>
            </button>
        </div>
    </div>

    <!-- Charts -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <!-- Activity Timeline -->
        <div class="bg-white rounded-xl border border-gray-200">
            <div class="px-6 py-4 border-b border-gray-100">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg font-semibold text-gray-900">
                        <i class="fas fa-chart-area mr-2" style="color: <%= systemSettings.primary_color || '#3b82f6' %>;"></i><%= t('activityTimeline') %>
                    </h3>
                    <div class="flex space-x-2">
                        <button onclick="changeTimelineView('hourly')" class="timeline-btn active" data-view="hourly"><%= t('hourly') %></button>
                        <button onclick="changeTimelineView('daily')" class="timeline-btn" data-view="daily"><%= t('daily') %></button>
                    </div>
                </div>
            </div>
            <div class="p-6" style="position: relative; height: 280px;">
                <canvas id="activityTimelineChart"></canvas>
            </div>
        </div>

        <!-- Top Activities -->
        <div class="bg-white rounded-xl border border-gray-200">
            <div class="px-6 py-4 border-b border-gray-100">
                <h3 class="text-lg font-semibold text-gray-900">
                    <i class="fas fa-chart-bar mr-2" style="color: <%= systemSettings.secondary_color || '#10b981' %>;"></i><%= t('topActivities') %>
                </h3>
            </div>
            <div class="p-6" style="position: relative; height: 280px;">
                <canvas id="topActivitiesChart"></canvas>
            </div>
        </div>

        <!-- Session Duration -->
        <div class="bg-white rounded-xl border border-gray-200">
            <div class="px-6 py-4 border-b border-gray-100">
                <h3 class="text-lg font-semibold text-gray-900">
                    <i class="fas fa-hourglass-half mr-2" style="color: <%= systemSettings.primary_color || '#3b82f6' %>;"></i><%= t('sessionDuration') %>
                </h3>
            </div>
            <div class="p-6" style="position: relative; height: 280px;">
                <canvas id="sessionChart"></canvas>
            </div>
        </div>

        <!-- Device & Browser -->
        <div class="bg-white rounded-xl border border-gray-200">
            <div class="px-6 py-4 border-b border-gray-100">
                <h3 class="text-lg font-semibold text-gray-900">
                    <i class="fas fa-mobile-alt mr-2" style="color: <%= systemSettings.secondary_color || '#10b981' %>;"></i><%= t('deviceBrowserUsage') %>
                </h3>
            </div>
            <div class="p-6">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <h4 class="text-sm font-medium text-gray-700 mb-2 text-center"><%= t('devices') %></h4>
                        <div style="position: relative; height: 200px;">
                            <canvas id="deviceChart"></canvas>
                        </div>
                    </div>
                    <div>
                        <h4 class="text-sm font-medium text-gray-700 mb-2 text-center"><%= t('browsers') %></h4>
                        <div style="position: relative; height: 200px;">
                            <canvas id="browserChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Active Users Table -->
    <div class="bg-white rounded-xl border border-gray-200 overflow-hidden mb-6">
        <div class="px-6 py-4 border-b border-gray-100">
            <div class="flex justify-between items-center">
                <div>
                    <h3 class="text-lg font-semibold text-gray-900">
                        <i class="fas fa-user-check mr-2" style="color: <%= systemSettings.primary_color || '#3b82f6' %>;"></i><%= t('currentlyActiveUsers') %>
                    </h3>
                    <p class="text-sm text-gray-500 mt-1"><%= t('usersActiveLast5Min') %></p>
                </div>
                <div class="flex items-center space-x-2">
                    <span class="text-sm text-gray-500"><%= t('autoRefresh') %>:</span>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="auto-refresh" class="sr-only peer" checked>
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                    </label>
                </div>
            </div>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase"><%= t('user') %></th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase"><%= t('currentActivity') %></th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase"><%= t('location') %></th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase"><%= t('sessionDuration') %></th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase"><%= t('lastAction') %></th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase"><%= t('status') %></th>
                    </tr>
                </thead>
                <tbody id="active-users-table" class="bg-white divide-y divide-gray-100">
                </tbody>
            </table>
        </div>
    </div>

    <!-- Activity Log -->
    <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-100">
            <div class="flex justify-between items-center">
                <div>
                    <h3 class="text-lg font-semibold text-gray-900">
                        <i class="fas fa-list-alt mr-2" style="color: <%= systemSettings.secondary_color || '#10b981' %>;"></i><%= t('detailedActivityLog') %>
                    </h3>
                    <p class="text-sm text-gray-500 mt-1"><%= t('completeActivityHistory') %></p>
                </div>
                <div class="flex items-center space-x-3">
                    <div class="flex items-center space-x-2">
                        <label for="rows-per-page" class="text-sm text-gray-600"><%= t('show') %>:</label>
                        <select id="rows-per-page" class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500">
                            <option value="5" selected>5</option>
                            <option value="10">10</option>
                            <option value="20">20</option>
                            <option value="50">50</option>
                        </select>
                        <span class="text-sm text-gray-600"><%= t('rows') %></span>
                    </div>
                    <select id="activity-level" class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500">
                        <option value="all"><%= t('allActivities') %></option>
                        <option value="critical"><%= t('criticalOnly') %></option>
                        <option value="learning"><%= t('learningOnly') %></option>
                        <option value="system"><%= t('systemOnly') %></option>
                    </select>
                </div>
            </div>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase cursor-pointer" onclick="sortActivities('timestamp')">
                            <%= t('timestamp') %> <i class="fas fa-sort ml-1"></i>
                        </th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase"><%= t('user') %></th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase"><%= t('activity') %></th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase"><%= t('details') %></th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase"><%= t('ipAddress') %></th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase"><%= t('device') %></th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase"><%= t('actions') %></th>
                    </tr>
                </thead>
                <tbody id="activity-log-table" class="bg-white divide-y divide-gray-100">
                </tbody>
            </table>
        </div>
        <div class="px-6 py-4 border-t border-gray-100 bg-gray-50">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                <span class="text-sm text-gray-600">
                    <%= t('showing') %> <span id="showing-from" class="font-semibold">1</span> <%= t('to') %> <span id="showing-to" class="font-semibold">20</span> <%= t('of') %> <span id="total-activities" class="font-semibold">0</span> <%= t('activities') %>
                </span>
                <div class="flex items-center space-x-2">
                    <button onclick="previousPage()" class="px-3 py-1.5 border rounded-lg text-sm bg-white hover:bg-gray-50 text-gray-700" id="prev-btn" disabled>
                        <i class="fas fa-chevron-left mr-1"></i><%= t('previous') %>
                    </button>
                    <span class="px-4 py-1.5 rounded-lg text-sm font-medium text-white" style="background: <%= systemSettings.primary_color || '#3b82f6' %>;">
                        <span id="current-page">1</span> / <span id="total-pages">1</span>
                    </span>
                    <button onclick="nextPage()" class="px-3 py-1.5 border rounded-lg text-sm bg-white hover:bg-gray-50 text-gray-700" id="next-btn">
                        <%= t('next') %> <i class="fas fa-chevron-right ml-1"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-xl p-6 flex items-center space-x-4">
        <div class="animate-spin rounded-full h-10 w-10 border-4 border-t-transparent" style="border-color: <%= systemSettings.primary_color || '#3b82f6' %>; border-top-color: transparent;"></div>
        <span class="text-gray-700 font-medium"><%= t('loadingData') %></span>
    </div>
</div>

<style>
.timeline-btn {
    padding: 4px 12px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    background: white;
    color: #6b7280;
    font-size: 0.75rem;
    cursor: pointer;
    transition: all 0.2s;
}
.timeline-btn.active {
    background: <%= systemSettings.primary_color || '#3b82f6' %>;
    color: white;
    border-color: <%= systemSettings.primary_color || '#3b82f6' %>;
}
.timeline-btn:hover:not(.active) {
    background: #f9fafb;
}
.activity-badge { display: inline-flex; align-items: center; padding: 0.25rem 0.5rem; border-radius: 0.375rem; font-size: 0.75rem; font-weight: 500; }
.badge-login { background-color: #dcfce7; color: #166534; }
.badge-course { background-color: #dbeafe; color: #1e40af; }
.badge-test { background-color: #fef3c7; color: #92400e; }
.badge-video { background-color: #f3e8ff; color: #7c3aed; }
.badge-download { background-color: #ecfdf5; color: #065f46; }
.badge-system { background-color: #f1f5f9; color: #475569; }
.status-online { background-color: #10b981; animation: pulse 2s infinite; }
.status-away { background-color: #f59e0b; }
.status-offline { background-color: #6b7280; }
@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const i18n = {
    noActiveUsers: '<%= t("noActiveUsers") %>',
    noActivityData: '<%= t("noActivityData") %>',
    activeUsersLabel: '<%= t("activeUsers") %>',
    exportSuccess: '<%= t("exportSuccess") %>',
    exportFailed: '<%= t("exportFailed") %>',
    errorLoadingData: '<%= t("errorLoadingData") %>',
    view: '<%= t("view") %>',
    online: '<%= t("online") %>',
    away: '<%= t("away") %>',
    offline: '<%= t("offline") %>',
    // Chart labels
    sessions: '<%= t("sessions") %>',
    count: '<%= t("count") %>',
    duration0to5: '<%= t("duration0to5") %>',
    duration5to15: '<%= t("duration5to15") %>',
    duration15to30: '<%= t("duration15to30") %>',
    duration30to60: '<%= t("duration30to60") %>',
    duration1hPlus: '<%= t("duration1hPlus") %>',
    // Activity types
    loginSuccess: '<%= t("loginSuccess") %>',
    loginFailed: '<%= t("loginFailed") %>',
    viewingCourse: '<%= t("viewingCourse") %>'
};

const primaryColor = '<%= systemSettings.primary_color || "#3b82f6" %>';
const secondaryColor = '<%= systemSettings.secondary_color || "#10b981" %>';

let activityData = {};
let charts = {};
let currentPage = 1;
let itemsPerPage = 5;
let sortField = 'timestamp';
let sortDirection = 'desc';
let currentFilters = {};
let isRealTime = false;
let realTimeInterval = null;
let timelineView = 'hourly';

document.addEventListener('DOMContentLoaded', function() {
    loadActivityData();
    document.getElementById('time-period').addEventListener('change', loadActivityData);
    document.getElementById('search-user').addEventListener('input', debounce(applyFilters, 500));
    document.getElementById('activity-level').addEventListener('change', loadActivityLog);
    document.getElementById('rows-per-page').addEventListener('change', function() {
        itemsPerPage = parseInt(this.value);
        currentPage = 1;
        loadActivityLog();
    });
});

async function loadActivityData() {
    showLoading(true);
    try {
        const timePeriod = document.getElementById('time-period').value;
        const params = new URLSearchParams({ timePeriod, ...currentFilters });
        const response = await fetch(`/reports/api/user-activity?${params}`);
        const data = await response.json();

        if (data.success) {
            activityData = data.data;
            updateOverviewCards();
            initializeCharts();
            loadActiveUsers();
            loadActivityLog();
        } else {
            showToast(i18n.errorLoadingData, 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        showToast(i18n.errorLoadingData, 'error');
    } finally {
        showLoading(false);
    }
}

function updateOverviewCards() {
    const overview = activityData.overview || {};
    document.getElementById('active-users').textContent = overview.activeUsers || 0;
    document.getElementById('avg-session').textContent = formatDuration(overview.avgSessionTime || 0);
    document.getElementById('page-views').textContent = (overview.pageViews || 0).toLocaleString();
    document.getElementById('engagement-rate').textContent = (overview.engagementRate || 0) + '%';
}

function initializeCharts() {
    Object.values(charts).forEach(chart => chart.destroy());
    charts = {};

    // Activity Timeline Chart
    const timelineCtx = document.getElementById('activityTimelineChart').getContext('2d');
    charts.timeline = new Chart(timelineCtx, {
        type: 'line',
        data: {
            labels: activityData.timeline?.[timelineView]?.labels || [],
            datasets: [{
                label: i18n.activeUsersLabel,
                data: activityData.timeline?.[timelineView]?.data || [],
                borderColor: primaryColor,
                backgroundColor: primaryColor + '20',
                tension: 0.4,
                fill: true
            }]
        },
        options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } }
    });

    // Top Activities Chart
    const activitiesCtx = document.getElementById('topActivitiesChart').getContext('2d');
    charts.activities = new Chart(activitiesCtx, {
        type: 'bar',
        data: {
            labels: (activityData.topActivities || []).map(a => a.name),
            datasets: [{ label: i18n.count, data: (activityData.topActivities || []).map(a => a.count), backgroundColor: secondaryColor }]
        },
        options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', scales: { x: { beginAtZero: true } } }
    });

    // Session Duration Chart
    const sessionCtx = document.getElementById('sessionChart').getContext('2d');
    charts.session = new Chart(sessionCtx, {
        type: 'bar',
        data: {
            labels: [i18n.duration0to5, i18n.duration5to15, i18n.duration15to30, i18n.duration30to60, i18n.duration1hPlus],
            datasets: [{ label: i18n.sessions, data: activityData.sessionDistribution || [0, 0, 0, 0, 0], backgroundColor: '#8B5CF6' }]
        },
        options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
    });

    // Device Chart
    const deviceCtx = document.getElementById('deviceChart').getContext('2d');
    charts.device = new Chart(deviceCtx, {
        type: 'doughnut',
        data: {
            labels: (activityData.devices || []).map(d => d.name),
            datasets: [{ data: (activityData.devices || []).map(d => d.count), backgroundColor: [primaryColor, secondaryColor, '#F59E0B', '#EF4444'] }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
    });

    // Browser Chart
    const browserCtx = document.getElementById('browserChart').getContext('2d');
    charts.browser = new Chart(browserCtx, {
        type: 'doughnut',
        data: {
            labels: (activityData.browsers || []).map(b => b.name),
            datasets: [{ data: (activityData.browsers || []).map(b => b.count), backgroundColor: ['#8B5CF6', '#06B6D4', '#84CC16', '#F97316'] }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
    });
}

function changeTimelineView(view) {
    timelineView = view;
    document.querySelectorAll('.timeline-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelector(`[data-view="${view}"]`).classList.add('active');
    if (charts.timeline) {
        charts.timeline.data.labels = activityData.timeline?.[view]?.labels || [];
        charts.timeline.data.datasets[0].data = activityData.timeline?.[view]?.data || [];
        charts.timeline.update();
    }
}

function loadActiveUsers() {
    const tbody = document.getElementById('active-users-table');
    tbody.innerHTML = '';
    const activeUsers = activityData.activeUsers || [];

    activeUsers.forEach(user => {
        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-50';
        const statusText = getStatusText(user.status);
        row.innerHTML = `
            <td class="px-4 py-3">
                <div class="flex items-center">
                    <img class="h-8 w-8 rounded-full object-cover" src="${user.avatar || '/images/default-avatar.png'}" alt="" onerror="this.src='/images/default-avatar.png'">
                    <div class="ml-3">
                        <p class="text-sm font-medium text-gray-900">${user.name}</p>
                        <p class="text-xs text-gray-500">@${user.username}</p>
                    </div>
                </div>
            </td>
            <td class="px-4 py-3"><span class="activity-badge ${getActivityBadgeClass(user.currentActivity?.type)}">${user.currentActivity?.name || '-'}</span></td>
            <td class="px-4 py-3 text-sm text-gray-500">${user.location || '-'}</td>
            <td class="px-4 py-3 text-sm text-gray-900">${formatDuration(user.sessionDuration)}</td>
            <td class="px-4 py-3 text-sm text-gray-500">${user.lastAction ? new Date(user.lastAction).toLocaleTimeString() : '-'}</td>
            <td class="px-4 py-3">
                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium">
                    <span class="w-2 h-2 rounded-full mr-1 ${getStatusClass(user.status)}"></span>
                    ${statusText}
                </span>
            </td>
        `;
        tbody.appendChild(row);
    });

    if (activeUsers.length === 0) {
        tbody.innerHTML = `<tr><td colspan="6" class="px-4 py-8 text-center text-gray-500">${i18n.noActiveUsers}</td></tr>`;
    }
}

function getStatusText(status) {
    const statusTexts = { online: i18n.online, away: i18n.away, offline: i18n.offline };
    return statusTexts[status] || i18n.online;
}

function getActivityBadgeClass(type) {
    const classes = { login: 'badge-login', course_view: 'badge-course', test_attempt: 'badge-test', video_watch: 'badge-video', download: 'badge-download', system: 'badge-system' };
    return classes[type] || 'badge-system';
}

function getStatusClass(status) {
    const classes = { online: 'status-online', away: 'status-away', offline: 'status-offline' };
    return classes[status] || 'status-online';
}

function loadActivityLog() {
    const tbody = document.getElementById('activity-log-table');
    tbody.innerHTML = '';
    const activities = activityData.activities || [];
    const level = document.getElementById('activity-level').value;
    let filtered = level === 'all' ? activities : activities.filter(a => a.level === level);
    const start = (currentPage - 1) * itemsPerPage;
    const paginated = filtered.slice(start, start + itemsPerPage);

    paginated.forEach(activity => {
        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-50';
        row.innerHTML = `
            <td class="px-4 py-3 text-sm text-gray-900">${new Date(activity.timestamp).toLocaleString()}</td>
            <td class="px-4 py-3">
                <div class="flex items-center">
                    <img class="h-6 w-6 rounded-full" src="${activity.user?.avatar || '/images/default-avatar.png'}" alt="" onerror="this.src='/images/default-avatar.png'">
                    <span class="ml-2 text-sm font-medium text-gray-900">${activity.user?.name || '-'}</span>
                </div>
            </td>
            <td class="px-4 py-3"><span class="activity-badge ${getActivityBadgeClass(activity.type)}">${activity.activity}</span></td>
            <td class="px-4 py-3 text-sm text-gray-500 max-w-xs truncate">${activity.details || '-'}</td>
            <td class="px-4 py-3 text-sm text-gray-500">${activity.ipAddress || '-'}</td>
            <td class="px-4 py-3 text-sm text-gray-500">${activity.device || '-'}</td>
            <td class="px-4 py-3 text-sm font-medium">
                <button onclick="viewActivityDetails('${activity.id}')" class="text-blue-600 hover:text-blue-900">${i18n.view}</button>
            </td>
        `;
        tbody.appendChild(row);
    });

    if (paginated.length === 0) {
        tbody.innerHTML = `<tr><td colspan="7" class="px-4 py-8 text-center text-gray-500">${i18n.noActivityData}</td></tr>`;
    }
    updatePagination(filtered.length);
}

function updatePagination(totalItems) {
    const totalPages = Math.ceil(totalItems / itemsPerPage);
    document.getElementById('showing-from').textContent = totalItems === 0 ? 0 : (currentPage - 1) * itemsPerPage + 1;
    document.getElementById('showing-to').textContent = Math.min(currentPage * itemsPerPage, totalItems);
    document.getElementById('total-activities').textContent = totalItems;
    document.getElementById('current-page').textContent = currentPage;
    document.getElementById('total-pages').textContent = totalPages || 1;
    document.getElementById('prev-btn').disabled = currentPage <= 1;
    document.getElementById('next-btn').disabled = currentPage >= totalPages;
}

function sortActivities(field) {
    if (sortField === field) sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
    else { sortField = field; sortDirection = 'desc'; }
    activityData.activities.sort((a, b) => {
        let aVal = a[field], bVal = b[field];
        if (field === 'timestamp') { aVal = new Date(aVal).getTime(); bVal = new Date(bVal).getTime(); }
        return sortDirection === 'asc' ? (aVal > bVal ? 1 : -1) : (aVal < bVal ? 1 : -1);
    });
    loadActivityLog();
}

function previousPage() { if (currentPage > 1) { currentPage--; loadActivityLog(); } }
function nextPage() {
    const totalPages = Math.ceil((activityData.activities || []).length / itemsPerPage);
    if (currentPage < totalPages) { currentPage++; loadActivityLog(); }
}

function applyFilters() {
    currentFilters = {
        userType: document.getElementById('user-type').value,
        department: document.getElementById('department-filter').value,
        activityType: document.getElementById('activity-type').value,
        searchUser: document.getElementById('search-user').value
    };
    Object.keys(currentFilters).forEach(key => { if (!currentFilters[key]) delete currentFilters[key]; });
    currentPage = 1;
    loadActivityData();
}

function clearFilters() {
    currentFilters = {};
    document.getElementById('user-type').value = '';
    document.getElementById('department-filter').value = '';
    document.getElementById('activity-type').value = '';
    document.getElementById('search-user').value = '';
    loadActivityData();
}

function realTimeMode() {
    isRealTime = !isRealTime;
    const btn = document.getElementById('realtime-btn');
    const banner = document.getElementById('realtime-banner');
    if (isRealTime) {
        btn.innerHTML = '<i class="fas fa-stop mr-2"></i><%= t("stopLive") %>';
        banner.classList.remove('hidden');
        realTimeInterval = setInterval(loadActivityData, 30000);
    } else { exitRealTime(); }
}

function exitRealTime() {
    isRealTime = false;
    document.getElementById('realtime-btn').innerHTML = '<i class="fas fa-broadcast-tower mr-2"></i><%= t("liveView") %>';
    document.getElementById('realtime-banner').classList.add('hidden');
    if (realTimeInterval) { clearInterval(realTimeInterval); realTimeInterval = null; }
}

async function exportActivity() {
    showLoading(true);
    try {
        const timePeriod = document.getElementById('time-period').value;
        const params = new URLSearchParams({ timePeriod, ...currentFilters });
        const response = await fetch(`/reports/api/user-activity/export?${params}`);
        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `user-activity-${new Date().toISOString().split('T')[0]}.xlsx`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            a.remove();
            showToast(i18n.exportSuccess);
        } else {
            showToast(i18n.exportFailed, 'error');
        }
    } catch (error) {
        showToast(i18n.exportFailed, 'error');
    } finally {
        showLoading(false);
    }
}

function viewActivityDetails(activityId) { alert('Activity details: ' + activityId); }

function formatDuration(minutes) {
    if (!minutes) return '0m';
    const hours = Math.floor(minutes / 60);
    const mins = minutes % 60;
    return hours > 0 ? `${hours}h ${mins}m` : `${mins}m`;
}

function showLoading(show) { document.getElementById('loading-overlay').classList.toggle('hidden', !show); }

function showToast(message, type = 'success') {
    const toast = document.createElement('div');
    toast.className = `fixed top-4 right-4 ${type === 'error' ? 'bg-red-500' : 'bg-green-500'} text-white px-6 py-3 rounded-lg shadow-lg z-50`;
    toast.innerHTML = `<i class="fas fa-${type === 'error' ? 'exclamation-circle' : 'check-circle'} mr-2"></i>${message}`;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}

function debounce(func, wait) {
    let timeout;
    return function(...args) { clearTimeout(timeout); timeout = setTimeout(() => func(...args), wait); };
}

window.addEventListener('beforeunload', function() { if (realTimeInterval) clearInterval(realTimeInterval); });
</script>
