<%- contentFor('body') %>

<div class="min-h-screen bg-gray-50 py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Header -->
        <div class="mb-8">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">
                        <i class="fas fa-history mr-2"></i>
                        ประวัติการเปลี่ยนแปลงการตั้งค่า
                    </h1>
                    <p class="mt-2 text-sm text-gray-600">
                        ตรวจสอบประวัติการแก้ไขการตั้งค่าทั้งหมด
                    </p>
                </div>
                <a href="/settings" class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                    <i class="fas fa-arrow-left mr-2"></i>
                    กลับไปหน้าการตั้งค่า
                </a>
            </div>
        </div>

        <!-- Filters -->
        <div class="bg-white shadow rounded-lg p-6 mb-6">
            <h3 class="text-lg font-medium text-gray-900 mb-4">
                <i class="fas fa-filter mr-2"></i>
                ตัวกรอง
            </h3>
            <form method="GET" action="/settings/audit-log" class="grid grid-cols-1 gap-4 sm:grid-cols-4">
                <div>
                    <label for="type" class="block text-sm font-medium text-gray-700">ประเภท</label>
                    <select
                        id="type"
                        name="type"
                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                    >
                        <option value="">ทั้งหมด</option>
                        <option value="system" <%= filters.settingType === 'system' ? 'selected' : '' %>>ระบบ</option>
                        <option value="user" <%= filters.settingType === 'user' ? 'selected' : '' %>>ผู้ใช้</option>
                        <option value="department" <%= filters.settingType === 'department' ? 'selected' : '' %>>แผนก</option>
                    </select>
                </div>

                <div>
                    <label for="key" class="block text-sm font-medium text-gray-700">คีย์</label>
                    <input
                        type="text"
                        id="key"
                        name="key"
                        value="<%= filters.settingKey || '' %>"
                        placeholder="เช่น system_name"
                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                    >
                </div>

                <div>
                    <label for="days" class="block text-sm font-medium text-gray-700">ช่วงเวลา</label>
                    <select
                        id="days"
                        name="days"
                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                    >
                        <option value="7" <%= filters.days == 7 ? 'selected' : '' %>>7 วันที่แล้ว</option>
                        <option value="30" <%= filters.days == 30 ? 'selected' : '' %>>30 วันที่แล้ว</option>
                        <option value="90" <%= filters.days == 90 ? 'selected' : '' %>>90 วันที่แล้ว</option>
                        <option value="365" <%= filters.days == 365 ? 'selected' : '' %>>1 ปีที่แล้ว</option>
                    </select>
                </div>

                <div class="flex items-end">
                    <button
                        type="submit"
                        class="w-full inline-flex justify-center items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700"
                    >
                        <i class="fas fa-search mr-2"></i>
                        ค้นหา
                    </button>
                </div>
            </form>
        </div>

        <!-- Audit Log Table -->
        <div class="bg-white shadow rounded-lg overflow-hidden">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                วันที่/เวลา
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                ประเภท
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                คีย์
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                ค่าเดิม
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                ค่าใหม่
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                ผู้แก้ไข
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                เหตุผล
                            </th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <% if (auditLog && auditLog.length > 0) { %>
                            <% auditLog.forEach(log => { %>
                                <tr class="hover:bg-gray-50">
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                        <%= new Date(log.changed_date).toLocaleString('th-TH') %>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <% if (log.setting_type === 'system') { %>
                                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                                <i class="fas fa-cog mr-1"></i>
                                                ระบบ
                                            </span>
                                        <% } else if (log.setting_type === 'user') { %>
                                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                                <i class="fas fa-user mr-1"></i>
                                                ผู้ใช้
                                            </span>
                                        <% } else if (log.setting_type === 'department') { %>
                                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
                                                <i class="fas fa-building mr-1"></i>
                                                แผนก
                                            </span>
                                        <% } %>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-mono text-gray-900">
                                        <%= log.setting_key %>
                                    </td>
                                    <td class="px-6 py-4 text-sm text-gray-500 max-w-xs truncate">
                                        <%= log.old_value || '-' %>
                                    </td>
                                    <td class="px-6 py-4 text-sm text-gray-900 max-w-xs truncate font-medium">
                                        <%= log.new_value %>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                        <%= log.changed_by_name %>
                                    </td>
                                    <td class="px-6 py-4 text-sm text-gray-500 max-w-xs truncate">
                                        <%= log.change_reason || '-' %>
                                    </td>
                                </tr>
                            <% }); %>
                        <% } else { %>
                            <tr>
                                <td colspan="7" class="px-6 py-12 text-center">
                                    <div class="flex flex-col items-center">
                                        <i class="fas fa-inbox text-4xl text-gray-300 mb-3"></i>
                                        <p class="text-gray-500">ไม่พบประวัติการเปลี่ยนแปลง</p>
                                    </div>
                                </td>
                            </tr>
                        <% } %>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
