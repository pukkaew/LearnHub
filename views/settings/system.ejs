<!-- CSRF Token -->
<meta name="csrf-token" content="<%= csrfToken %>">

<div id="settings-page" class="min-h-screen bg-gray-50 py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Header with Gradient -->
        <div class="rounded-2xl p-6 mb-8 text-white shadow-lg" style="background: linear-gradient(to right, <%= systemSettings.primary_color || '#3b82f6' %>, <%= systemSettings.secondary_color || '#10b981' %>);">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-white flex items-center">
                        <i class="fas fa-cog mr-3"></i>
                        <span class="lang-switch" data-lang-th="‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö" data-lang-en="System Settings">‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</span>
                    </h1>
                    <p class="mt-2 text-white/80 lang-switch" data-lang-th="‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" data-lang-en="Manage all system settings">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                </div>
                <div class="flex items-center space-x-3">
                    <a href="/settings/audit-log" class="bg-white/20 hover:bg-white/30 text-white font-medium py-2 px-4 rounded-lg transition-all duration-200 flex items-center">
                        <i class="fas fa-history mr-2"></i>
                        <span class="lang-switch" data-lang-th="‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á" data-lang-en="Audit Log">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á</span>
                    </a>
                    <button type="button" id="saveAllBtn" class="bg-white/20 hover:bg-white/30 text-white font-medium py-2 px-4 rounded-lg transition-all duration-200 flex items-center">
                        <i class="fas fa-save mr-2"></i>
                        <span class="lang-switch" data-lang-th="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" data-lang-en="Save All">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Alert Messages -->
        <div id="alertContainer"></div>

        <!-- Tabs -->
        <div class="bg-white shadow rounded-lg">
            <!-- Tab Navigation -->
            <div class="border-b border-gray-200">
                <nav class="-mb-px flex space-x-8 px-6" aria-label="Tabs">
                    <% const tabCategories = [
                        { key: 'general', label: '‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ', labelEn: 'General', icon: 'fa-info-circle' },
                        { key: 'appearance', label: '‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö', labelEn: 'Appearance', icon: 'fa-palette' },
                        { key: 'security', label: '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢', labelEn: 'Security', icon: 'fa-shield-alt' },
                        { key: 'email', label: '‡∏≠‡∏µ‡πÄ‡∏°‡∏•', labelEn: 'Email', icon: 'fa-envelope' },
                        { key: 'notification', label: '‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', labelEn: 'Notification', icon: 'fa-bell' },
                        { key: 'course', label: '‡∏Ñ‡∏≠‡∏£‡πå‡∏™', labelEn: 'Course', icon: 'fa-book' },
                        { key: 'upload', label: '‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå', labelEn: 'Upload', icon: 'fa-upload' },
                        { key: 'gamification', label: 'Gamification', labelEn: 'Gamification', icon: 'fa-trophy' },
                        { key: 'backup', label: '‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', labelEn: 'Backup', icon: 'fa-database' },
                        { key: 'api', label: 'API', labelEn: 'API', icon: 'fa-plug' }
                    ]; %>

                    <% tabCategories.forEach((tab, index) => { %>
                        <button
                            data-tab="<%= tab.key %>"
                            data-label-th="<%= tab.label %>"
                            data-label-en="<%= tab.labelEn %>"
                            class="tab-button <%= activeTab === tab.key ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300' %> whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm"
                        >
                            <i class="fas <%= tab.icon %> mr-2"></i>
                            <span class="tab-label"><%= tab.label %></span>
                        </button>
                    <% }); %>
                </nav>
            </div>

            <!-- Tab Content -->
            <div class="p-6">
                <% tabCategories.forEach(tab => { %>
                    <div id="tab-<%= tab.key %>" class="tab-content <%= activeTab !== tab.key ? 'hidden' : '' %>">
                        <% if (settings[tab.key] && settings[tab.key].length > 0) { %>
                            <!-- Reset button for appearance tab -->
                            <% if (tab.key === 'appearance') { %>
                                <div class="mb-6 flex justify-end">
                                    <button
                                        type="button"
                                        onclick="resetAppearanceToDefault()"
                                        class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all"
                                    >
                                        <i class="fas fa-undo mr-2"></i>
                                        <span class="lang-text" data-lang-th="‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô" data-lang-en="Reset to Default">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</span>
                                    </button>
                                </div>
                            <% } %>
                            <div class="space-y-6">
                                <% settings[tab.key].forEach(setting => { %>
                                    <div class="setting-item">
                                        <label class="block">
                                            <div class="flex items-center justify-between mb-2">
                                                <span class="text-sm font-medium text-gray-700">
                                                    <span class="setting-label-text" data-setting-key="<%= setting.setting_key %>" data-label-th="<%= setting.setting_label %>"><%= setting.setting_label %></span>
                                                    <% if (setting.is_sensitive) { %>
                                                        <i class="fas fa-lock text-xs text-yellow-600 ml-1 sensitive-icon" title="‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏±‡∏ö" data-lang-th="‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏±‡∏ö" data-lang-en="Sensitive data"></i>
                                                    <% } %>
                                                </span>
                                                <% if (!setting.is_editable) { %>
                                                    <span class="text-xs text-gray-500">
                                                        <i class="fas fa-ban mr-1"></i>
                                                        <span class="lang-switch" data-lang-th="‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ" data-lang-en="Not editable">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ</span>
                                                    </span>
                                                <% } %>
                                            </div>
                                            <% if (setting.setting_description) { %>
                                                <p class="text-xs text-gray-500 mb-2 setting-description" data-setting-key="<%= setting.setting_key %>" data-desc-th="<%= setting.setting_description %>"><%= setting.setting_description %></p>
                                            <% } %>

                                            <!-- Input Fields based on setting_type -->
                                            <% if (setting.setting_type === 'boolean') { %>
                                                <% const boolValue = (setting.setting_value !== null && setting.setting_value !== '') ? setting.setting_value : setting.default_value; %>
                                                <div class="flex items-center">
                                                    <input
                                                        type="checkbox"
                                                        id="<%= setting.setting_key %>"
                                                        name="<%= setting.setting_key %>"
                                                        <%= boolValue === 'true' ? 'checked' : '' %>
                                                        <%= !setting.is_editable ? 'disabled' : '' %>
                                                        class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                                                        data-setting-key="<%= setting.setting_key %>"
                                                        data-setting-type="boolean"
                                                    >
                                                    <label for="<%= setting.setting_key %>" class="ml-2 block text-sm text-gray-900 lang-switch" data-lang-th="‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô" data-lang-en="Enable">‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</label>
                                                </div>

                                            <% } else if (setting.setting_type === 'number') { %>
                                                <% const numValue = (setting.setting_value !== null && setting.setting_value !== '') ? setting.setting_value : setting.default_value; %>
                                                <input
                                                    type="number"
                                                    id="<%= setting.setting_key %>"
                                                    name="<%= setting.setting_key %>"
                                                    value="<%= numValue %>"
                                                    <%= !setting.is_editable ? 'disabled' : '' %>
                                                    <% if (setting.validation_rules) { %>
                                                        <% if (setting.validation_rules.min !== undefined) { %>
                                                            min="<%= setting.validation_rules.min %>"
                                                        <% } %>
                                                        <% if (setting.validation_rules.max !== undefined) { %>
                                                            max="<%= setting.validation_rules.max %>"
                                                        <% } %>
                                                    <% } %>
                                                    class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                                                    data-setting-key="<%= setting.setting_key %>"
                                                    data-setting-type="number"
                                                >

                                            <% } else if (setting.setting_type === 'color') { %>
                                                <% const colorValue = (setting.setting_value !== null && setting.setting_value !== '') ? setting.setting_value : setting.default_value; %>
                                                <div class="flex items-center space-x-2">
                                                    <input
                                                        type="color"
                                                        id="<%= setting.setting_key %>"
                                                        name="<%= setting.setting_key %>"
                                                        value="<%= colorValue %>"
                                                        <%= !setting.is_editable ? 'disabled' : '' %>
                                                        class="h-10 w-20 border border-gray-300 rounded"
                                                        data-setting-key="<%= setting.setting_key %>"
                                                        data-setting-type="color"
                                                    >
                                                    <input
                                                        type="text"
                                                        value="<%= colorValue %>"
                                                        <%= !setting.is_editable ? 'disabled' : '' %>
                                                        class="flex-1 border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                                                        data-color-input="<%= setting.setting_key %>"
                                                    >
                                                </div>

                                            <% } else if (setting.setting_type === 'text') { %>
                                                <% const textValue = (setting.setting_value !== null && setting.setting_value !== '') ? setting.setting_value : setting.default_value; %>
                                                <textarea
                                                    id="<%= setting.setting_key %>"
                                                    name="<%= setting.setting_key %>"
                                                    rows="3"
                                                    <%= !setting.is_editable ? 'disabled' : '' %>
                                                    class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                                                    data-setting-key="<%= setting.setting_key %>"
                                                    data-setting-type="text"
                                                ><%= textValue %></textarea>

                                            <% } else if (setting.setting_type === 'file') { %>
                                                <% const previewValue = (setting.setting_value !== null && setting.setting_value !== '') ? setting.setting_value : setting.default_value; %>
                                                <div class="space-y-3">
                                                    <!-- Image Preview -->
                                                    <% if (previewValue && (previewValue.match(/\.(jpg|jpeg|png|gif|svg)$/i))) { %>
                                                        <div class="relative group">
                                                            <div class="flex items-center justify-center bg-gradient-to-br from-gray-50 to-gray-100 border-2 border-gray-200 rounded-lg p-6 hover:border-blue-400 transition-all">
                                                                <img
                                                                    src="<%= previewValue %>"
                                                                    alt="<%= setting.setting_label %>"
                                                                    class="max-h-64 max-w-full object-contain cursor-pointer hover:scale-105 transition-transform shadow-lg"
                                                                    onclick="openImageModal(this.src, '<%= setting.setting_label %>')"
                                                                >
                                                            </div>
                                                            <div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                                                <button
                                                                    type="button"
                                                                    onclick="openImageModal('<%= previewValue %>', '<%= setting.setting_label %>')"
                                                                    class="px-3 py-1.5 bg-blue-600 text-white text-xs font-medium rounded-full hover:bg-blue-700 transition-colors shadow-lg"
                                                                >
                                                                    <i class="fas fa-search-plus mr-1"></i>
                                                                    <span class="lang-text" data-lang-th="‡∏î‡∏π‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏ï‡πá‡∏°" data-lang-en="View Full Size">‡∏î‡∏π‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏ï‡πá‡∏°</span>
                                                                </button>
                                                            </div>
                                                            <div class="absolute bottom-2 left-2 bg-black bg-opacity-60 text-white text-xs px-3 py-1 rounded-full opacity-0 group-hover:opacity-100 transition-opacity">
                                                                <i class="fas fa-info-circle mr-1"></i>
                                                                <span class="lang-text" data-lang-th="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ç‡∏¢‡∏≤‡∏¢" data-lang-en="Click to expand">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ç‡∏¢‡∏≤‡∏¢</span>
                                                            </div>
                                                        </div>
                                                    <% } else { %>
                                                        <!-- No Image Placeholder -->
                                                        <div class="flex items-center justify-center bg-gray-100 border-2 border-dashed border-gray-300 rounded-lg p-8">
                                                            <div class="text-center">
                                                                <i class="fas fa-image text-4xl text-gray-400 mb-2"></i>
                                                                <p class="text-sm text-gray-500 lang-text" data-lang-th="‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û" data-lang-en="No image">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</p>
                                                            </div>
                                                        </div>
                                                    <% } %>

                                                    <!-- URL Input -->
                                                    <div class="space-y-2">
                                                        <label class="flex items-center text-xs font-medium text-gray-700">
                                                            <i class="fas fa-link mr-1 text-blue-600"></i>
                                                            <span class="lang-text" data-lang-th="URL ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û" data-lang-en="Image URL">URL ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</span>
                                                        </label>
                                                        <div class="flex items-center space-x-2">
                                                            <div class="flex-1 relative">
                                                                <% const fileValue = (setting.setting_value !== null && setting.setting_value !== '') ? setting.setting_value : setting.default_value; %>
                                                                <input
                                                                    type="text"
                                                                    id="<%= setting.setting_key %>"
                                                                    name="<%= setting.setting_key %>"
                                                                    value="<%= fileValue %>"
                                                                    <%= !setting.is_editable ? 'disabled' : '' %>
                                                                    class="w-full border border-gray-300 rounded-md shadow-sm py-2 pl-3 pr-10 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm file-url-input"
                                                                    data-setting-key="<%= setting.setting_key %>"
                                                                    data-setting-type="file"
                                                                    data-placeholder-th="/images/your-image.png"
                                                                    data-placeholder-en="/images/your-image.png"
                                                                    onchange="previewImageUrl(this)"
                                                                >
                                                                <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                                                    <i class="fas fa-image text-gray-400 text-sm"></i>
                                                                </div>
                                                            </div>
                                                            <button
                                                                type="button"
                                                                onclick="document.getElementById('<%= setting.setting_key %>').value = ''; document.getElementById('<%= setting.setting_key %>').dispatchEvent(new Event('change'));"
                                                                class="px-3 py-2 border border-red-300 text-red-600 rounded-md text-sm hover:bg-red-50 transition-colors clear-btn"
                                                                data-lang-th="‡∏•‡πâ‡∏≤‡∏á"
                                                                data-lang-en="Clear"
                                                            >
                                                                <i class="fas fa-trash-alt"></i>
                                                            </button>
                                                        </div>
                                                        <% if (setting.validation_rules && setting.validation_rules.fileType) { %>
                                                            <p class="text-xs text-gray-500 flex items-start">
                                                                <i class="fas fa-info-circle mt-0.5 mr-1 text-blue-500"></i>
                                                                <span class="lang-text" data-lang-th="‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö: <%= setting.validation_rules.fileType.join(', ') %>" data-lang-en="Supported: <%= setting.validation_rules.fileType.join(', ') %>">
                                                                    ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö: <%= setting.validation_rules.fileType.join(', ') %>
                                                                </span>
                                                            </p>
                                                        <% } %>
                                                    </div>
                                                </div>

                                            <% } else if (setting.validation_rules && setting.validation_rules.enum) { %>
                                                <% const enumValue = (setting.setting_value !== null && setting.setting_value !== '') ? setting.setting_value : setting.default_value; %>
                                                <select
                                                    id="<%= setting.setting_key %>"
                                                    name="<%= setting.setting_key %>"
                                                    <%= !setting.is_editable ? 'disabled' : '' %>
                                                    class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                                                    data-setting-key="<%= setting.setting_key %>"
                                                    data-setting-type="<%= setting.setting_type %>"
                                                >
                                                    <% setting.validation_rules.enum.forEach(option => { %>
                                                        <option value="<%= option %>" <%= enumValue === option ? 'selected' : '' %>>
                                                            <%= option %>
                                                        </option>
                                                    <% }); %>
                                                </select>

                                            <% } else { %>
                                                <% const stringValue = (setting.setting_value !== null && setting.setting_value !== '') ? setting.setting_value : setting.default_value; %>
                                                <input
                                                    type="<%= setting.setting_type === 'email' ? 'email' : (setting.setting_type === 'url' ? 'url' : 'text') %>"
                                                    id="<%= setting.setting_key %>"
                                                    name="<%= setting.setting_key %>"
                                                    value="<%= stringValue %>"
                                                    <%= !setting.is_editable ? 'disabled' : '' %>
                                                    <% if (setting.validation_rules) { %>
                                                        <% if (setting.validation_rules.required) { %>
                                                            required
                                                        <% } %>
                                                        <% if (setting.validation_rules.maxLength) { %>
                                                            maxlength="<%= setting.validation_rules.maxLength %>"
                                                        <% } %>
                                                    <% } %>
                                                    class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                                                    data-setting-key="<%= setting.setting_key %>"
                                                    data-setting-type="<%= setting.setting_type %>"
                                                >
                                            <% } %>

                                            <% if (setting.default_value && setting.default_value !== setting.setting_value) { %>
                                                <p class="mt-1 text-xs text-gray-500">
                                                    <span class="lang-switch" data-lang-th="‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô" data-lang-en="Default">‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</span>: <%= setting.default_value %>
                                                </p>
                                            <% } %>
                                        </label>
                                    </div>
                                <% }); %>
                            </div>
                        <% } else { %>
                            <div class="text-center py-12">
                                <i class="fas fa-inbox text-4xl text-gray-300 mb-3"></i>
                                <p class="text-gray-500 lang-switch" data-lang-th="‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏ô‡∏µ‡πâ" data-lang-en="No settings in this category">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏ô‡∏µ‡πâ</p>
                            </div>
                        <% } %>
                    </div>
                <% }); %>
            </div>
        </div>
    </div>
</div>

<!-- Image Modal -->
<div id="imageModal" class="fixed inset-0 bg-black bg-opacity-75 z-50 hidden items-center justify-center p-4" onclick="closeImageModal()">
    <div class="relative max-w-7xl max-h-full" onclick="event.stopPropagation()">
        <button
            onclick="closeImageModal()"
            class="absolute -top-12 right-0 text-white hover:text-gray-300 transition-colors"
        >
            <i class="fas fa-times text-2xl"></i>
        </button>
        <img
            id="modalImage"
            src=""
            alt=""
            class="max-w-full max-h-[90vh] object-contain rounded-lg shadow-2xl"
        >
        <div id="modalTitle" class="absolute -bottom-12 left-0 right-0 text-center text-white text-lg font-medium"></div>
    </div>
</div>

<style>
/* Force Thai font for better readability in settings page */
#settings-page *:not(.fa):not(.fas):not(.far):not(.fab):not(.fal):not([class*="fa-"]):not(#preview-sidebar):not(#preview-sidebar *) {
    font-family: 'Sarabun', 'Prompt', 'Noto Sans Thai', sans-serif !important;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
}

/* Ensure Font Awesome icons display correctly */
#settings-page .fa,
#settings-page .fas,
#settings-page .far,
#settings-page .fab,
#settings-page .fal,
#settings-page [class*="fa-"] {
    font-family: 'Font Awesome 6 Free', 'Font Awesome 6 Brands' !important;
}

/* Fix preview sidebar text visibility - HIGHEST PRIORITY */
#preview-sidebar {
    background-color: #1f2937 !important;
    color: #ffffff !important;
}

#preview-sidebar * {
    color: #ffffff !important;
    font-family: 'Sarabun', 'Prompt', 'Noto Sans Thai', sans-serif !important;
}

#preview-sidebar > div > div {
    color: #ffffff !important;
}

#preview-sidebar div[class*="py-2"] {
    color: #ffffff !important;
    background-color: rgba(255, 255, 255, 0.1) !important;
}

/* Fix all preview elements */
#preview-container * {
    font-family: 'Sarabun', 'Prompt', 'Noto Sans Thai', sans-serif !important;
}

#preview-header * {
    color: white !important;
}

#preview-card h4 {
    color: #1f2937 !important;
}

#preview-card p {
    color: #4b5563 !important;
}

#preview-card button {
    color: white !important;
}

.tab-content {
    animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.setting-item {
    padding-bottom: 1.5rem;
    border-bottom: 1px solid #e5e7eb;
}

.setting-item:last-child {
    border-bottom: none;
    padding-bottom: 0;
}

/* Appearance Settings Enhancements */
#tab-appearance .setting-item {
    background: linear-gradient(to right, #f9fafb 0%, #ffffff 100%);
    padding: 1.25rem;
    border-radius: 0.5rem;
    transition: all 0.3s ease;
    border: 1px solid #e5e7eb;
}

#tab-appearance .setting-item:hover {
    transform: translateX(4px);
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    border-color: #3b82f6;
}

/* Color picker enhancements */
input[type="color"] {
    cursor: pointer;
    transition: all 0.3s ease;
}

input[type="color"]:hover {
    transform: scale(1.1);
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2);
}

/* Number input enhancements */
#tab-appearance input[type="number"] {
    font-weight: 500;
    color: #1f2937;
}

#tab-appearance input[type="number"]:focus {
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

/* Preview panel animation */
#appearance-preview {
    animation: slideUp 0.5s ease-out;
}

@keyframes slideUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Preview elements transitions */
#preview-container > div {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

#preview-container button:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2);
}

/* Image Preview Enhancements */
.setting-item img {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.setting-item .group:hover img {
    filter: brightness(1.05);
}

/* Modal Animations */
#imageModal {
    animation: fadeIn 0.3s ease-out;
    backdrop-filter: blur(4px);
}

#imageModal img {
    animation: zoomIn 0.3s ease-out;
}

@keyframes zoomIn {
    from {
        opacity: 0;
        transform: scale(0.9);
    }
    to {
        opacity: 1;
        transform: scale(1);
    }
}

/* File input enhancements */
input[data-setting-type="file"] {
    font-family: 'Monaco', 'Consolas', monospace;
    font-size: 0.875rem;
}

input[data-setting-type="file"]:focus {
    background-color: #f0f9ff;
}

/* Image container hover effect */
.setting-item .bg-gray-50:hover {
    background-color: #f9fafb;
    border-color: #60a5fa;
}
</style>

<script src="/js/settings.js?v=<%= Date.now() %>"></script>
<script src="/js/appearance-settings.js?v=<%= Date.now() %>"></script>

<script>
// Image Modal Functions
function openImageModal(imageSrc, imageTitle) {
    const modal = document.getElementById('imageModal');
    const modalImage = document.getElementById('modalImage');
    const modalTitle = document.getElementById('modalTitle');

    if (modal && modalImage && modalTitle) {
        modalImage.src = imageSrc;
        modalImage.alt = imageTitle;
        modalTitle.textContent = imageTitle;
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        document.body.style.overflow = 'hidden';
    }
}

function closeImageModal() {
    const modal = document.getElementById('imageModal');
    if (modal) {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        document.body.style.overflow = '';
    }
}

// Close modal on ESC key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeImageModal();
    }
});

// Preview image URL on change
function previewImageUrl(input) {
    const url = input.value.trim();
    if (!url) return;

    // Check if it's an image URL
    const imageExtensions = /\.(jpg|jpeg|png|gif|svg|webp)$/i;
    if (!imageExtensions.test(url)) {
        console.log('Not an image URL:', url);
        return;
    }

    // Trigger a visual update by reloading the page section
    // Or you can implement a dynamic image preview here
    console.log('Image URL updated:', url);
}

// Language Support for System Settings
(function() {
    'use strict';

    // Get language from multiple sources
    const localStorageLang = localStorage.getItem('preferred_language') ||
                             localStorage.getItem('ruxchai_language') ||
                             sessionStorage.getItem('ruxchai_language');
    const serverLang = '<%= currentLanguage %>';
    let currentLang = localStorageLang || serverLang || 'th';

    console.log('üåê Language sources:');
    console.log('  - localStorage:', localStorageLang);
    console.log('  - Server:', serverLang);
    console.log('  - Final:', currentLang);
    console.log('  - Document ready state:', document.readyState);

    // Translation Dictionary for Setting Labels and Descriptions
    const translations = {
        // General Settings
        '‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏ö': 'System Name',
        '‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö': 'Name of the system displayed on the website',
        '‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏ö (EN)': 'System Name (EN)',
        '‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©': 'System name in English',
        '‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó': 'Company Name',
        '‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£': 'Company or organization name',
        '‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó (EN)': 'Company Name (EN)',
        '‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©': 'Company name in English',
        '‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠': 'Contact Email',
        '‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ': 'Email for general contact',
        '‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ù‡πà‡∏≤‡∏¢‡∏™‡∏ô‡∏±‡∏ö‡∏™‡∏ô‡∏∏‡∏ô': 'Support Email',
        '‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠': 'Email for support requests',
        '‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠': 'Contact Phone',
        '‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠': 'Phone number for contact',
        '‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£': 'Organization Website',
        'URL ‡∏Ç‡∏≠‡∏á‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå‡∏´‡∏•‡∏±‡∏Å‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£': 'URL of the main organization website',
        '‡∏†‡∏≤‡∏©‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô': 'Default Language',
        '‡∏†‡∏≤‡∏©‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö': 'Default system language',
        '‡πÄ‡∏Ç‡∏ï‡πÄ‡∏ß‡∏•‡∏≤': 'Timezone',
        '‡πÄ‡∏Ç‡∏ï‡πÄ‡∏ß‡∏•‡∏≤‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö': 'System timezone',
        '‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà': 'Date Format',
        '‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà': 'Date display format',
        '‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏ß‡∏•‡∏≤': 'Time Format',
        '‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏ß‡∏•‡∏≤': 'Time display format',

        // Appearance Settings
        '‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡∏£‡∏∞‡∏ö‡∏ö': 'System Logo',
        '‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö': 'Logo displayed on the website',
        'Favicon': 'Favicon',
        '‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏ö‡∏ô browser tab': 'Icon displayed on browser tab',
        '‡∏™‡∏µ‡∏´‡∏•‡∏±‡∏Å': 'Primary Color',
        '‡∏™‡∏µ‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö': 'Primary color of the system',
        '‡∏™‡∏µ‡∏£‡∏≠‡∏á': 'Secondary Color',
        '‡∏™‡∏µ‡∏£‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö': 'Secondary color of the system',
        '‡πÇ‡∏´‡∏°‡∏î‡∏ò‡∏µ‡∏°': 'Theme Mode',
        '‡πÇ‡∏´‡∏°‡∏î‡∏™‡∏µ‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö': 'System color mode',
        '‡∏ü‡∏≠‡∏ô‡∏ï‡πå': 'Font',
        '‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö': 'Font used in the system',

        // Security Settings
        'Session Timeout (‡∏ô‡∏≤‡∏ó‡∏µ)': 'Session Timeout (minutes)',
        '‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡πà‡∏≠‡∏ô session ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏': 'Duration before session expires',
        '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥': 'Minimum Password Length',
        '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥‡∏Ç‡∏≠‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô': 'Minimum number of password characters',
        '‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏´‡∏ç‡πà': 'Require Uppercase',
        '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏´‡∏ç‡πà': 'Password must contain uppercase letters',
        '‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏•‡πá‡∏Å': 'Require Lowercase',
        '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏•‡πá‡∏Å': 'Password must contain lowercase letters',
        '‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç': 'Require Numbers',
        '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç': 'Password must contain numbers',
        '‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏±‡∏Å‡∏Ç‡∏£‡∏∞‡∏û‡∏¥‡πÄ‡∏®‡∏©': 'Require Special Characters',
        '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏±‡∏Å‡∏Ç‡∏£‡∏∞‡∏û‡∏¥‡πÄ‡∏®‡∏©': 'Password must contain special characters',
        '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î': 'Maximum Login Attempts',
        '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏ú‡∏¥‡∏î‡πÑ‡∏î‡πâ‡∏Å‡πà‡∏≠‡∏ô‡∏ñ‡∏π‡∏Å‡∏•‡πá‡∏≠‡∏Ñ': 'Number of failed login attempts before lockout',
        '‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏•‡πá‡∏≠‡∏Ñ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ (‡∏ô‡∏≤‡∏ó‡∏µ)': 'Account Lockout Duration (minutes)',
        '‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ñ‡∏π‡∏Å‡∏•‡πá‡∏≠‡∏Ñ‡∏´‡∏•‡∏±‡∏á‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏ú‡∏¥‡∏î': 'Duration account is locked after failed login',
        '‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ Two-Factor Authentication': 'Enable Two-Factor Authentication',
        '‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô 2 ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô': 'Enable 2-step verification',
        '‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (‡∏ß‡∏±‡∏ô)': 'Force Password Change (days)',
        '‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ó‡∏∏‡∏Å‡∏Å‡∏µ‡πà‡∏ß‡∏±‡∏ô (0 = ‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)': 'Force password change every N days (0 = not forced)',

        // Email Settings
        'SMTP Host': 'SMTP Host',
        '‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà SMTP server': 'SMTP server address',
        'SMTP Port': 'SMTP Port',
        '‡∏û‡∏≠‡∏£‡πå‡∏ï‡∏Ç‡∏≠‡∏á SMTP server': 'SMTP server port',
        'SMTP Secure (SSL)': 'SMTP Secure (SSL)',
        '‡πÉ‡∏ä‡πâ SSL/TLS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö SMTP': 'Use SSL/TLS for SMTP',
        'SMTP Username': 'SMTP Username',
        'Username ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö SMTP authentication': 'Username for SMTP authentication',
        'SMTP Password': 'SMTP Password',
        'Password ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö SMTP authentication': 'Password for SMTP authentication',
        '‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á': 'Sender Email',
        '‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á': 'Email address used as sender',
        '‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á': 'Sender Name',
        '‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•': 'Name displayed as email sender',

        // Notification Settings
        '‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ó‡∏≤‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•': 'Enable Email Notifications',
        '‡∏™‡πà‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ó‡∏≤‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•': 'Send email notifications',
        '‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ö‡∏ô Browser': 'Enable Browser Notifications',
        '‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ö‡∏ô browser': 'Show browser notifications',
        '‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ó‡∏≤‡∏á SMS': 'Enable SMS Notifications',
        '‡∏™‡πà‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ó‡∏≤‡∏á SMS': 'Send SMS notifications',
        '‡πÄ‡∏Å‡πá‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô (‡∏ß‡∏±‡∏ô)': 'Notification Retention (days)',
        '‡πÄ‡∏Å‡πá‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Å‡∏µ‡πà‡∏ß‡∏±‡∏ô': 'Keep notification history for N days',

        // Course Settings
        '‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏≠‡∏£‡πå‡∏™': 'Enable Course Rating',
        '‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏≠‡∏£‡πå‡∏™': 'Allow learners to rate courses',
        '‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô': 'Enable Course Comments',
        '‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡πÉ‡∏ô‡∏Ñ‡∏≠‡∏£‡πå‡∏™': 'Allow comments in courses',
        '‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (%)': 'Default Passing Score (%)',
        '‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≤‡∏ô‡∏Ñ‡∏≠‡∏£‡πå‡∏™': 'Minimum score to pass course',
        '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏≠‡∏£‡πå‡∏™‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏ï‡πà‡∏≠‡∏Ñ‡∏ô': 'Maximum Courses Per User',
        '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏≠‡∏£‡πå‡∏™‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô‡πÑ‡∏î‡πâ': 'Number of courses a user can enroll in simultaneously',
        '‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡πÉ‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ô‡∏µ‡∏¢‡∏ö‡∏±‡∏ï‡∏£': 'Enable Certificates',
        '‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ô‡∏µ‡∏¢‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ú‡πà‡∏≤‡∏ô‡∏Ñ‡∏≠‡∏£‡πå‡∏™': 'Issue certificates upon course completion',

        // Upload Settings
        '‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î (bytes)': 'Maximum File Size (bytes)',
        '‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏î‡πâ (100MB)': 'Maximum file size allowed for upload (100MB)',
        '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï': 'Allowed File Types',
        '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏î‡πâ (‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏à‡∏∏‡∏•‡∏†‡∏≤‡∏Ñ)': 'Allowed file types for upload (comma separated)',
        '‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ü‡∏•‡πå': 'Upload Path',
        '‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î': 'Folder for storing uploaded files',

        // Gamification Settings
        '‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö Gamification': 'Enable Gamification',
        '‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏ï‡πâ‡∏°‡πÅ‡∏•‡∏∞‡∏ï‡∏£‡∏≤‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå': 'Enable points and badges system',
        '‡πÅ‡∏ï‡πâ‡∏°‡∏ï‡πà‡∏≠‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô': 'Points Per Lesson',
        '‡πÅ‡∏ï‡πâ‡∏°‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏à‡∏ö‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô': 'Points earned upon lesson completion',
        '‡πÅ‡∏ï‡πâ‡∏°‡∏ï‡πà‡∏≠‡∏Ñ‡∏≠‡∏£‡πå‡∏™': 'Points Per Course',
        '‡πÅ‡∏ï‡πâ‡∏°‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏à‡∏ö‡∏Ñ‡∏≠‡∏£‡πå‡∏™': 'Points earned upon course completion',
        '‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏ô‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô': 'Enable Leaderboard',
        '‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏ô‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô': 'Display competitive leaderboard',

        // Backup Settings
        '‡πÄ‡∏õ‡∏¥‡∏î Auto Backup': 'Enable Auto Backup',
        '‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥': 'Automatic backup',
        '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏£‡∏≠‡∏á': 'Backup Frequency',
        '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•': 'Frequency of data backup',
        '‡πÄ‡∏Å‡πá‡∏ö Backup (‡∏ß‡∏±‡∏ô)': 'Backup Retention (days)',
        '‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ü‡∏•‡πå backup ‡∏Å‡∏µ‡πà‡∏ß‡∏±‡∏ô': 'Keep backup files for N days',

        // API Settings
        '‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ API': 'Enable API',
        '‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô REST API': 'Enable REST API usage',
        'API Rate Limit': 'API Rate Limit',
        '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô request ‡∏ï‡πà‡∏≠‡∏ô‡∏≤‡∏ó‡∏µ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î': 'Maximum requests per minute',
        'API Key': 'API Key',
        'API Key ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö external integration': 'API Key for external integration'
    };

    // Function to translate text
    function translateText(thaiText) {
        if (currentLang === 'en') {
            const translated = translations[thaiText];
            if (translated) {
                console.log('üìù Translated:', thaiText, '->', translated);
                return translated;
            } else {
                console.warn('‚ö†Ô∏è No translation for:', thaiText);
                return thaiText;
            }
        }
        return thaiText;
    }

    // Update tab labels based on current language
    function updateLanguage(lang) {
        if (lang) currentLang = lang;

        console.log('üåê Updating Settings page language to:', currentLang);

        // Update tab labels
        const tabButtons = document.querySelectorAll('.tab-button');
        console.log('üîÑ Found', tabButtons.length, 'tab buttons');

        tabButtons.forEach(btn => {
            const labelElement = btn.querySelector('.tab-label');
            const labelTh = btn.getAttribute('data-label-th');
            const labelEn = btn.getAttribute('data-label-en');

            console.log('Tab:', labelTh, '->', labelEn, 'Current lang:', currentLang);

            if (labelElement) {
                if (currentLang === 'en' && labelEn) {
                    labelElement.textContent = labelEn;
                    console.log('‚úÖ Tab changed to EN:', labelEn);
                } else if (labelTh) {
                    labelElement.textContent = labelTh;
                    console.log('‚úÖ Tab changed to TH:', labelTh);
                }
            } else {
                console.warn('‚ö†Ô∏è No .tab-label found in button');
            }
        });

        // Update all elements with lang-switch class
        const langSwitchElements = document.querySelectorAll('.lang-switch');
        console.log('üîÑ Found', langSwitchElements.length, 'elements with .lang-switch class');

        langSwitchElements.forEach(element => {
            const thText = element.getAttribute('data-lang-th');
            const enText = element.getAttribute('data-lang-en');

            console.log('Element:', element.tagName, 'TH:', thText, 'EN:', enText, 'Current:', currentLang);

            if (currentLang === 'en' && enText) {
                element.textContent = enText;
                console.log('‚úÖ Changed to EN:', enText);
            } else if (thText) {
                element.textContent = thText;
                console.log('‚úÖ Changed to TH:', thText);
            }
        });

        // Update title attributes for sensitive icons
        document.querySelectorAll('.sensitive-icon').forEach(element => {
            const thText = element.getAttribute('data-lang-th');
            const enText = element.getAttribute('data-lang-en');

            if (currentLang === 'en' && enText) {
                element.setAttribute('title', enText);
            } else if (thText) {
                element.setAttribute('title', thText);
            }
        });

        // Update all elements with data-lang attributes
        document.querySelectorAll('[data-lang-th][data-lang-en]').forEach(element => {
            const thText = element.getAttribute('data-lang-th');
            const enText = element.getAttribute('data-lang-en');

            if (currentLang === 'en' && enText) {
                element.textContent = enText;
            } else if (thText) {
                element.textContent = thText;
            }
        });

        // Update preview panel language
        document.querySelectorAll('.lang-text').forEach(element => {
            const thText = element.getAttribute('data-lang-th');
            const enText = element.getAttribute('data-lang-en');

            if (currentLang === 'en' && enText) {
                element.textContent = enText;
            } else if (thText) {
                element.textContent = thText;
            }
        });

        // Update setting labels from database
        const settingLabels = document.querySelectorAll('.setting-label-text');
        console.log('üîÑ Found', settingLabels.length, 'setting labels');

        settingLabels.forEach(element => {
            const thaiLabel = element.getAttribute('data-label-th');
            if (thaiLabel) {
                const translatedText = translateText(thaiLabel);
                element.textContent = translatedText;
                console.log('‚úÖ Label:', thaiLabel, '->', translatedText);
            }
        });

        // Update setting descriptions from database
        const settingDescriptions = document.querySelectorAll('.setting-description');
        console.log('üîÑ Found', settingDescriptions.length, 'setting descriptions');

        settingDescriptions.forEach(element => {
            const thaiDesc = element.getAttribute('data-desc-th');
            if (thaiDesc) {
                const translatedText = translateText(thaiDesc);
                element.textContent = translatedText;
                console.log('Description:', thaiDesc, '->', translatedText);
            }
        });

        // Update file URL input placeholders
        document.querySelectorAll('.file-url-input').forEach(input => {
            const placeholderTh = input.getAttribute('data-placeholder-th');
            const placeholderEn = input.getAttribute('data-placeholder-en');

            if (currentLang === 'en' && placeholderEn) {
                input.setAttribute('placeholder', placeholderEn);
            } else if (placeholderTh) {
                input.setAttribute('placeholder', placeholderTh);
            }
        });

        // Update clear button titles
        document.querySelectorAll('.clear-btn').forEach(btn => {
            const titleTh = btn.getAttribute('data-lang-th');
            const titleEn = btn.getAttribute('data-lang-en');

            if (currentLang === 'en' && titleEn) {
                btn.setAttribute('title', titleEn);
            } else if (titleTh) {
                btn.setAttribute('title', titleTh);
            }
        });
    }

    // Listen for language change events
    window.addEventListener('languageChanged', function(e) {
        console.log('üîÑ Language changed event received in Settings:', e.detail);
        updateLanguage(e.detail.language);
    });

    // Listen for custom event from navigation
    document.addEventListener('languageChange', function(e) {
        console.log('üîÑ Language change event received in Settings:', e.detail);
        if (e.detail && e.detail.language) {
            updateLanguage(e.detail.language);
        }
    });

    // Check localStorage for language changes
    function checkLanguageChange() {
        const storedLang = localStorage.getItem('preferred_language') ||
                          localStorage.getItem('ruxchai_language') ||
                          sessionStorage.getItem('ruxchai_language');
        if (storedLang && storedLang !== currentLang) {
            console.log('üîÑ Language changed from localStorage:', storedLang);
            updateLanguage(storedLang);
        }
    }

    // Check localStorage immediately
    checkLanguageChange();

    // Initialize on page load - update immediately
    updateLanguage();

    // Force update after a short delay to ensure DOM is ready
    setTimeout(() => {
        console.log('‚è∞ Delayed update triggered');
        updateLanguage();
    }, 100);

    setTimeout(() => {
        console.log('‚è∞ Second delayed update triggered');
        updateLanguage();
    }, 500);

    // Also update when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üìÑ DOMContentLoaded triggered');
            updateLanguage();
        });
    }

    // Check every second for language changes
    setInterval(checkLanguageChange, 1000);

    // Watch for DOM changes (for dynamically loaded content)
    const observer = new MutationObserver((mutations) => {
        let shouldUpdate = false;
        mutations.forEach((mutation) => {
            if (mutation.addedNodes.length > 0) {
                shouldUpdate = true;
            }
        });
        if (shouldUpdate) {
            console.log('üîÑ DOM changed, updating language...');
            setTimeout(() => updateLanguage(), 50);
        }
    });

    observer.observe(document.body, {
        childList: true,
        subtree: true
    });

    console.log('‚úÖ Language system initialized');
})();
</script>
