

<div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Header -->
    <div class="mb-8">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">
                    <i class="fas fa-plus-circle mr-3 text-ruxchai-primary"></i><%= t('createNewTest') %>
                </h1>
                <p class="mt-2 text-gray-600"><%= t('createTestAndAssessment') %></p>
            </div>
            <a href="/tests" class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm bg-white text-sm font-medium text-gray-700 hover:bg-gray-50">
                <i class="fas fa-arrow-left mr-2"></i><%= t('backToTestList') %>
            </a>
        </div>
    </div>

    <!-- Test Creation Form -->
    <div class="bg-white shadow rounded-lg">
        <div class="p-6">
            <!-- Progress Steps -->
            <div class="mb-8">
                <nav aria-label="Progress">
                    <ol class="flex items-center">
                        <li class="relative pr-8 sm:pr-20">
                            <div class="absolute inset-0 flex items-center" aria-hidden="true">
                                <div class="h-0.5 w-full bg-ruxchai-primary"></div>
                            </div>
                            <div class="relative w-8 h-8 flex items-center justify-center bg-ruxchai-primary rounded-full">
                                <span class="text-white text-sm font-medium">1</span>
                            </div>
                            <span class="absolute top-10 left-0 text-xs font-medium text-gray-900"><%= t('basicInformation') %></span>
                        </li>

                        <li class="relative pr-8 sm:pr-20">
                            <div class="absolute inset-0 flex items-center" aria-hidden="true">
                                <div class="h-0.5 w-full bg-gray-200"></div>
                            </div>
                            <div class="relative w-8 h-8 flex items-center justify-center bg-gray-200 rounded-full">
                                <span class="text-gray-500 text-sm font-medium">2</span>
                            </div>
                            <span class="absolute top-10 left-0 text-xs font-medium text-gray-500"><%= t('settings') %></span>
                        </li>

                        <li class="relative">
                            <div class="relative w-8 h-8 flex items-center justify-center bg-gray-200 rounded-full">
                                <span class="text-gray-500 text-sm font-medium">3</span>
                            </div>
                            <span class="absolute top-10 left-0 text-xs font-medium text-gray-500"><%= t('questions') %></span>
                        </li>
                    </ol>
                </nav>
            </div>

            <form id="create-test-form">
                <!-- Step 1: Basic Information -->
                <div id="step-1" class="step-content">
                    <h3 class="text-lg font-medium text-gray-900 mb-6">
                        <i class="fas fa-info-circle mr-2 text-ruxchai-primary"></i><%= t('basicTestInfo') %>
                    </h3>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="md:col-span-2">
                            <label for="test_name" class="block text-sm font-medium text-gray-700 mb-2"><%= t('testName') %> <span class="text-red-500">*</span></label>
                            <input type="text" id="test_name" name="test_name" required
                                   class="w-full rounded-md border-gray-300 shadow-sm focus:border-ruxchai-primary focus:ring-ruxchai-primary"
                                   placeholder="<%= t('testName') %>">
                        </div>

                        <div>
                            <label for="test_code" class="block text-sm font-medium text-gray-700 mb-2"><%= t('testCode') %> <span class="text-red-500">*</span></label>
                            <input type="text" id="test_code" name="test_code" required
                                   class="w-full rounded-md border-gray-300 shadow-sm focus:border-ruxchai-primary focus:ring-ruxchai-primary"
                                   placeholder="TEST-001">
                        </div>

                        <div>
                            <label for="test_type" class="block text-sm font-medium text-gray-700 mb-2"><%= t('testType') %> <span class="text-red-500">*</span></label>
                            <select id="test_type" name="type" required onchange="handleTestTypeChange()"
                                    class="w-full rounded-md border-gray-300 shadow-sm focus:border-ruxchai-primary focus:ring-ruxchai-primary">
                                <option value=""><%= t('selectTestType') %></option>
                                <optgroup label="<%= t('courseAssessments') || 'Course Assessments' %>">
                                    <option value="chapter_test"><%= t('chapterTest') %></option>
                                    <option value="lesson_test"><%= t('lessonTest') %></option>
                                </optgroup>
                                <optgroup label="<%= t('trainingAssessments') || 'Training Assessments' %>">
                                    <option value="pre_training_assessment"><%= t('preTrainingAssessment') %></option>
                                    <option value="post_training_assessment"><%= t('postTrainingAssessment') %></option>
                                </optgroup>
                                <optgroup label="<%= t('evaluationAssessments') || 'Evaluation Assessments' %>">
                                    <option value="knowledge_check"><%= t('knowledgeCheck') %></option>
                                    <option value="progress_assessment"><%= t('progressAssessment') %></option>
                                    <option value="midcourse_assessment"><%= t('midcourseAssessment') %></option>
                                    <option value="final_assessment"><%= t('finalAssessment') %></option>
                                </optgroup>
                                <optgroup label="<%= t('otherAssessments') || 'Other' %>">
                                    <option value="assessment"><%= t('assessment') %></option>
                                    <option value="practice_exercise"><%= t('practiceExercise') %></option>
                                    <option value="certification_assessment"><%= t('certificationAssessment') %></option>
                                </optgroup>
                            </select>
                        </div>

                        <div>
                            <label for="course_id" class="block text-sm font-medium text-gray-700 mb-2"><%= t('relatedCourse') %></label>
                            <select id="course_id" name="course_id" onchange="handleCourseChange()"
                                    class="w-full rounded-md border-gray-300 shadow-sm focus:border-ruxchai-primary focus:ring-ruxchai-primary">
                                <option value=""><%= t('notRelatedToCourse') %></option>
                                <% if (courses && courses.length > 0) { %>
                                    <% courses.forEach(course => { %>
                                        <option value="<%= course.course_id %>">
                                            <%= course.title %><% if (course.category) { %> - <%= course.category %><% } %>
                                        </option>
                                    <% }); %>
                                <% } %>
                            </select>
                        </div>

                        <!-- Course Assessment Structure Display -->
                        <div id="course-assessment-structure" class="md:col-span-2 hidden">
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                <h4 class="text-sm font-semibold text-blue-900 mb-3 flex items-center">
                                    <i class="fas fa-clipboard-list mr-2"></i>
                                    <%= t('courseAssessmentStructure') %>
                                </h4>
                                <div id="assessment-structure-content">
                                    <div class="text-center py-4">
                                        <i class="fas fa-spinner fa-spin text-blue-500 text-2xl"></i>
                                        <p class="text-sm text-gray-600 mt-2"><%= t('loading') %></p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div>
                            <label for="chapter_id" class="block text-sm font-medium text-gray-700 mb-2">
                                <%= t('selectChapter') %> <span class="text-gray-500 text-xs">(<%= t('selectCourseFirst') %>)</span>
                            </label>
                            <select id="chapter_id" name="chapter_id" onchange="loadLessons()"
                                    class="w-full rounded-md border-gray-300 shadow-sm focus:border-ruxchai-primary focus:ring-ruxchai-primary"
                                    disabled>
                                <option value=""><%= t('selectCourseToLoadChapters') %></option>
                            </select>
                        </div>

                        <div>
                            <label for="lesson_id" class="block text-sm font-medium text-gray-700 mb-2">
                                <%= t('selectLesson') %> <span class="text-gray-500 text-xs">(<%= t('selectChapterFirst') %>)</span>
                            </label>
                            <select id="lesson_id" name="lesson_id"
                                    class="w-full rounded-md border-gray-300 shadow-sm focus:border-ruxchai-primary focus:ring-ruxchai-primary"
                                    disabled>
                                <option value=""><%= t('selectChapterToLoadLessons') %></option>
                            </select>
                        </div>

                        <div>
                            <label for="difficulty_level" class="block text-sm font-medium text-gray-700 mb-2"><%= t('difficultyLevel') %></label>
                            <select id="difficulty_level" name="difficulty_level"
                                    class="w-full rounded-md border-gray-300 shadow-sm focus:border-ruxchai-primary focus:ring-ruxchai-primary">
                                <option value="Easy"><%= t('easy') %></option>
                                <option value="Medium" selected><%= t('medium') %></option>
                                <option value="Hard"><%= t('hard') %></option>
                            </select>
                        </div>

                        <div>
                            <label for="language" class="block text-sm font-medium text-gray-700 mb-2"><%= t('teachingLanguageLabel') %> <span class="text-red-500">*</span></label>
                            <select id="language" name="language" required
                                    class="w-full rounded-md border-gray-300 shadow-sm focus:border-ruxchai-primary focus:ring-ruxchai-primary">
                                <option value=""><%= t('selectLanguage') %></option>
                                <option value="th"><%= t('thai') %></option>
                                <option value="en"><%= t('english') %></option>
                                <option value="th-en"><%= t('thaiEnglish') %></option>
                            </select>
                        </div>

                        <div class="md:col-span-2">
                            <label for="description" class="block text-sm font-medium text-gray-700 mb-2"><%= t('testDescription') %></label>
                            <textarea id="description" name="description" rows="4"
                                      class="w-full rounded-md border-gray-300 shadow-sm focus:border-ruxchai-primary focus:ring-ruxchai-primary"
                                      placeholder="<%= t('describeTestDetails') %>"></textarea>
                        </div>

                        <div class="md:col-span-2">
                            <label for="instructions" class="block text-sm font-medium text-gray-700 mb-2"><%= t('instructionsForTest') %></label>
                            <textarea id="instructions" name="instructions" rows="3"
                                      class="w-full rounded-md border-gray-300 shadow-sm focus:border-ruxchai-primary focus:ring-ruxchai-primary"
                                      placeholder="<%= t('testConditions') %>"></textarea>
                        </div>
                    </div>

                    <div class="flex justify-end mt-8">
                        <button type="button" onclick="nextStep()"
                                class="px-6 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white ruxchai-gradient hover:opacity-90">
                            <%= t('next') %> <i class="fas fa-arrow-right ml-2"></i>
                        </button>
                    </div>
                </div>

                <!-- Step 2: Test Settings -->
                <div id="step-2" class="step-content hidden">
                    <h3 class="text-lg font-medium text-gray-900 mb-6">
                        <i class="fas fa-cogs mr-2 text-ruxchai-primary"></i><%= t('testSettings') %>
                    </h3>

                    <div class="space-y-8">
                        <!-- Time Settings -->
                        <div class="border-b border-gray-200 pb-6">
                            <h4 class="text-md font-medium text-gray-900 mb-4"><%= t('timeSettings') %></h4>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div>
                                    <label for="time_limit" class="block text-sm font-medium text-gray-700 mb-2"><%= t('testDuration') %></label>
                                    <input type="number" id="time_limit" name="time_limit" min="1" max="300"
                                           class="w-full rounded-md border-gray-300 shadow-sm focus:border-ruxchai-primary focus:ring-ruxchai-primary"
                                           placeholder="60">
                                </div>

                                <div>
                                    <label for="start_date" class="block text-sm font-medium text-gray-700 mb-2"><%= t('startDate') %></label>
                                    <input type="datetime-local" id="start_date" name="start_date"
                                           class="w-full rounded-md border-gray-300 shadow-sm focus:border-ruxchai-primary focus:ring-ruxchai-primary">
                                </div>

                                <div>
                                    <label for="end_date" class="block text-sm font-medium text-gray-700 mb-2"><%= t('endDate') %></label>
                                    <input type="datetime-local" id="end_date" name="end_date"
                                           class="w-full rounded-md border-gray-300 shadow-sm focus:border-ruxchai-primary focus:ring-ruxchai-primary">
                                </div>
                            </div>
                        </div>

                        <!-- Attempt Settings -->
                        <div class="border-b border-gray-200 pb-6">
                            <h4 class="text-md font-medium text-gray-900 mb-4"><%= t('attemptSettings') %></h4>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div>
                                    <label for="max_attempts" class="block text-sm font-medium text-gray-700 mb-2"><%= t('maxAttempts') %></label>
                                    <input type="number" id="max_attempts" name="max_attempts" min="1" max="10" value="1"
                                           class="w-full rounded-md border-gray-300 shadow-sm focus:border-ruxchai-primary focus:ring-ruxchai-primary">
                                </div>

                                <div>
                                    <label for="passing_score" class="block text-sm font-medium text-gray-700 mb-2"><%= t('passingScore') %></label>
                                    <input type="number" id="passing_score" name="passing_score" min="0" max="100" value="70"
                                           class="w-full rounded-md border-gray-300 shadow-sm focus:border-ruxchai-primary focus:ring-ruxchai-primary">
                                </div>

                                <div>
                                    <label for="question_order" class="block text-sm font-medium text-gray-700 mb-2"><%= t('questionOrder') %></label>
                                    <select id="question_order" name="question_order"
                                            class="w-full rounded-md border-gray-300 shadow-sm focus:border-ruxchai-primary focus:ring-ruxchai-primary">
                                        <option value="fixed"><%= t('fixedOrder') %></option>
                                        <option value="random"><%= t('randomOrder') %></option>
                                    </select>
                                </div>
                            </div>

                            <!-- Anti-Cheating Settings -->
                            <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label for="questions_to_show" class="block text-sm font-medium text-gray-700 mb-2">จำนวนข้อที่ออกสอบ</label>
                                    <input type="number" id="questions_to_show" name="questions_to_show" min="0" placeholder="ทุกข้อ"
                                           class="w-full rounded-md border-gray-300 shadow-sm focus:border-ruxchai-primary focus:ring-ruxchai-primary">
                                    <p class="text-xs text-gray-500 mt-1">ถ้ามี 20 ข้อ ใส่ 10 = สุ่ม 10 ข้อจาก 20 (ว่าง = ออกทุกข้อ)</p>
                                </div>
                                <div class="flex items-center">
                                    <label class="inline-flex items-center mt-4">
                                        <input type="checkbox" id="randomize_options" name="randomize_options"
                                               class="rounded border-gray-300 text-ruxchai-primary shadow-sm focus:border-ruxchai-primary focus:ring-ruxchai-primary">
                                        <span class="ml-2 text-sm text-gray-700">สุ่มลำดับตัวเลือก (เฉพาะข้อเลือกตอบ)</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Display Settings -->
                        <div class="border-b border-gray-200 pb-6">
                            <h4 class="text-md font-medium text-gray-900 mb-4"><%= t('displaySettings') %></h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="space-y-4">
                                    <label class="inline-flex items-center">
                                        <input type="checkbox" id="show_score_immediately" name="show_score_immediately"
                                               class="rounded border-gray-300 text-ruxchai-primary shadow-sm focus:border-ruxchai-primary focus:ring-ruxchai-primary">
                                        <span class="ml-2 text-sm text-gray-700"><%= t('showScoreImmediately') %></span>
                                    </label>

                                    <label class="inline-flex items-center">
                                        <input type="checkbox" id="show_correct_answers" name="show_correct_answers"
                                               class="rounded border-gray-300 text-ruxchai-primary shadow-sm focus:border-ruxchai-primary focus:ring-ruxchai-primary">
                                        <span class="ml-2 text-sm text-gray-700"><%= t('showCorrectAnswers') %></span>
                                    </label>

                                    <label class="inline-flex items-center">
                                        <input type="checkbox" id="allow_review" name="allow_review"
                                               class="rounded border-gray-300 text-ruxchai-primary shadow-sm focus:border-ruxchai-primary focus:ring-ruxchai-primary">
                                        <span class="ml-2 text-sm text-gray-700"><%= t('allowReview') %></span>
                                    </label>
                                </div>

                                <div class="space-y-4">
                                    <label class="inline-flex items-center">
                                        <input type="checkbox" id="require_camera" name="require_camera"
                                               class="rounded border-gray-300 text-ruxchai-primary shadow-sm focus:border-ruxchai-primary focus:ring-ruxchai-primary">
                                        <span class="ml-2 text-sm text-gray-700"><%= t('requireCamera') %></span>
                                    </label>

                                    <label class="inline-flex items-center">
                                        <input type="checkbox" id="prevent_copy_paste" name="prevent_copy_paste" checked
                                               class="rounded border-gray-300 text-ruxchai-primary shadow-sm focus:border-ruxchai-primary focus:ring-ruxchai-primary">
                                        <span class="ml-2 text-sm text-gray-700"><%= t('preventCopyPaste') %></span>
                                    </label>

                                    <label class="inline-flex items-center">
                                        <input type="checkbox" id="track_tab_switching" name="track_tab_switching" checked
                                               class="rounded border-gray-300 text-ruxchai-primary shadow-sm focus:border-ruxchai-primary focus:ring-ruxchai-primary">
                                        <span class="ml-2 text-sm text-gray-700"><%= t('trackTabSwitching') %></span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Access Control -->
                        <div>
                            <h4 class="text-md font-medium text-gray-900 mb-4"><%= t('accessControl') %></h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label for="access_code" class="block text-sm font-medium text-gray-700 mb-2"><%= t('accessCode') %></label>
                                    <input type="text" id="access_code" name="access_code"
                                           class="w-full rounded-md border-gray-300 shadow-sm focus:border-ruxchai-primary focus:ring-ruxchai-primary"
                                           placeholder="<%= t('enterAccessCode') %>">
                                </div>

                                <div>
                                    <label for="status" class="block text-sm font-medium text-gray-700 mb-2"><%= t('status') %></label>
                                    <select id="status" name="status"
                                            class="w-full rounded-md border-gray-300 shadow-sm focus:border-ruxchai-primary focus:ring-ruxchai-primary">
                                        <option value="Draft"><%= t('draft') %></option>
                                        <option value="Published"><%= t('published') %></option>
                                        <option value="Archived"><%= t('archived') %></option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-between mt-8">
                        <button type="button" onclick="previousStep()"
                                class="px-6 py-2 border border-gray-300 rounded-md shadow-sm bg-white text-sm font-medium text-gray-700 hover:bg-gray-50">
                            <i class="fas fa-arrow-left mr-2"></i><%= t('previous') %>
                        </button>
                        <button type="button" onclick="nextStep()"
                                class="px-6 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white ruxchai-gradient hover:opacity-90">
                            <%= t('next') %> <i class="fas fa-arrow-right ml-2"></i>
                        </button>
                    </div>
                </div>

                <!-- Step 3: Questions -->
                <div id="step-3" class="step-content hidden">
                    <h3 class="text-lg font-medium text-gray-900 mb-6">
                        <i class="fas fa-question-circle mr-2 text-ruxchai-primary"></i><%= t('manageQuestions') %>
                    </h3>

                    <div class="mb-6">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="text-md font-medium text-gray-900"><%= t('questionList') %></h4>
                            <div class="flex space-x-3">
                                <button type="button" onclick="importQuestions()"
                                        class="inline-flex items-center px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-white text-sm font-medium text-gray-700 hover:bg-gray-50">
                                    <i class="fas fa-upload mr-2"></i><%= t('importFromQuestionBank') %>
                                </button>
                                <button type="button" onclick="addQuestion()"
                                        class="inline-flex items-center px-3 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white ruxchai-gradient hover:opacity-90">
                                    <i class="fas fa-plus mr-2"></i><%= t('addQuestion') %>
                                </button>
                            </div>
                        </div>

                        <div id="questions-container" class="space-y-4">
                            <!-- Questions will be added here -->
                        </div>

                        <div id="no-questions" class="text-center py-8 border-2 border-dashed border-gray-300 rounded-lg">
                            <i class="fas fa-question-circle text-gray-400 text-4xl mb-4"></i>
                            <p class="text-gray-500"><%= t('noQuestions') %></p>
                            <p class="text-sm text-gray-400 mt-2"><%= t('startWithFirstQuestion') %></p>
                        </div>
                    </div>

                    <div class="flex justify-between mt-8">
                        <button type="button" onclick="previousStep()"
                                class="px-6 py-2 border border-gray-300 rounded-md shadow-sm bg-white text-sm font-medium text-gray-700 hover:bg-gray-50">
                            <i class="fas fa-arrow-left mr-2"></i><%= t('previous') %>
                        </button>
                        <div class="flex space-x-3">
                            <button type="button" onclick="saveDraft()"
                                    class="px-6 py-2 border border-gray-300 rounded-md shadow-sm bg-white text-sm font-medium text-gray-700 hover:bg-gray-50">
                                <i class="fas fa-save mr-2"></i><%= t('saveDraft') %>
                            </button>
                            <button type="submit"
                                    class="px-6 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700">
                                <i class="fas fa-check mr-2"></i><%= t('createTest') %>
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Question Modal -->
<div id="question-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-medium text-gray-900">
                    <i class="fas fa-question-circle mr-2 text-ruxchai-primary"></i><%= t('addEditQuestion') %>
                </h3>
                <button onclick="closeQuestionModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <form id="question-form" class="space-y-4">
                <input type="hidden" id="question-index">

                <div>
                    <label for="question-type" class="block text-sm font-medium text-gray-700 mb-2"><%= t('testType') %></label>
                    <select id="question-type" name="question_type" onchange="changeQuestionType()"
                            class="w-full rounded-md border-gray-300 shadow-sm focus:border-ruxchai-primary focus:ring-ruxchai-primary">
                        <option value="multiple_choice"><%= t('multipleChoice') %></option>
                        <option value="true_false"><%= t('trueFalse') %></option>
                        <option value="essay"><%= t('essay') %></option>
                        <option value="fill_blank"><%= t('fillBlank') %></option>
                    </select>
                </div>

                <div>
                    <label for="question-text" class="block text-sm font-medium text-gray-700 mb-2"><%= t('question') %> <span class="text-red-500">*</span></label>
                    <textarea id="question-text" name="question_text" rows="3" required
                              class="w-full rounded-md border-gray-300 shadow-sm focus:border-ruxchai-primary focus:ring-ruxchai-primary"
                              placeholder="<%= t('enterQuestion') %>"></textarea>
                </div>

                <div>
                    <label for="question-image" class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-image mr-1"></i><%= t('questionImage') %>
                    </label>
                    <div class="flex items-center space-x-3">
                        <input type="file" id="question-image" name="question_image" accept="image/*"
                               onchange="previewQuestionImage(this)"
                               class="hidden">
                        <label for="question-image"
                               class="cursor-pointer inline-flex items-center px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-white text-sm font-medium text-gray-700 hover:bg-gray-50">
                            <i class="fas fa-upload mr-2"></i><%= t('selectImage') %>
                        </label>
                        <span id="question-image-name" class="text-sm text-gray-500"><%= t('noImage') %></span>
                    </div>
                    <div id="question-image-preview" class="mt-2 hidden">
                        <img src="" alt="Preview" class="max-w-xs rounded border border-gray-300">
                        <button type="button" onclick="removeQuestionImage()"
                                class="mt-2 text-sm text-red-600 hover:text-red-800">
                            <i class="fas fa-times mr-1"></i><%= t('removeImage') %>
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-1"><%= t('supportsImageFormat') %></p>
                </div>

                <div>
                    <label for="question-points" class="block text-sm font-medium text-gray-700 mb-2"><%= t('points') %></label>
                    <input type="number" id="question-points" name="points" min="1" max="100" value="1"
                           class="w-full rounded-md border-gray-300 shadow-sm focus:border-ruxchai-primary focus:ring-ruxchai-primary">
                </div>

                <!-- Answer Options (for multiple choice) -->
                <div id="answer-options" class="space-y-3">
                    <label class="block text-sm font-medium text-gray-700"><%= t('options') %></label>
                    <div id="options-container"></div>
                    <button type="button" onclick="addOption()" class="text-sm text-ruxchai-primary hover:text-blue-700">
                        <i class="fas fa-plus mr-1"></i><%= t('addOption') %>
                    </button>
                </div>

                <!-- True/False Options -->
                <div id="true-false-options" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2"><%= t('trueFalseCorrectAnswer') %></label>
                    <div class="space-y-2">
                        <label class="inline-flex items-center">
                            <input type="radio" name="correct_answer" value="true" class="form-radio">
                            <span class="ml-2"><%= t('true') %></span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="correct_answer" value="false" class="form-radio">
                            <span class="ml-2"><%= t('false') %></span>
                        </label>
                    </div>
                </div>

                <!-- Essay Answer -->
                <div id="essay-answer" class="hidden">
                    <label for="essay-sample" class="block text-sm font-medium text-gray-700 mb-2"><%= t('sampleAnswer') %></label>
                    <textarea id="essay-sample" name="sample_answer" rows="4"
                              class="w-full rounded-md border-gray-300 shadow-sm focus:border-ruxchai-primary focus:ring-ruxchai-primary"
                              placeholder="<%= t('sampleAnswerPlaceholder') %>"></textarea>
                </div>

                <!-- Fill Blank Answer -->
                <div id="fill-blank-answer" class="hidden">
                    <label for="blank-answers" class="block text-sm font-medium text-gray-700 mb-2"><%= t('correctAnswersComma') %></label>
                    <input type="text" id="blank-answers" name="blank_answers"
                           class="w-full rounded-md border-gray-300 shadow-sm focus:border-ruxchai-primary focus:ring-ruxchai-primary"
                           placeholder="<%= t('correctAnswerExample') %>">
                </div>

                <div>
                    <label for="question-explanation" class="block text-sm font-medium text-gray-700 mb-2"><%= t('additionalExplanation') %></label>
                    <textarea id="question-explanation" name="explanation" rows="2"
                              class="w-full rounded-md border-gray-300 shadow-sm focus:border-ruxchai-primary focus:ring-ruxchai-primary"
                              placeholder="<%= t('explainCorrectAnswer') %>"></textarea>
                </div>

                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" onclick="closeQuestionModal()"
                            class="px-4 py-2 border border-gray-300 rounded-md shadow-sm bg-white text-sm font-medium text-gray-700 hover:bg-gray-50">
                        <%= t('cancel') %>
                    </button>
                    <button type="submit"
                            class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white ruxchai-gradient hover:opacity-90">
                        <i class="fas fa-save mr-2"></i><%= t('saveQuestion') %>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// i18n translations
const i18n = {
    questionNumber: '<%= t("questionNumber") %>',
    points: '<%= t("points") %>',
    multipleChoice: '<%= t("questionTypeLabel") %>',
    trueFalse: '<%= t("trueFalseType") %>',
    essay: '<%= t("essayType") %>',
    fillBlank: '<%= t("fillBlankType") %>',
    edit: '<%= t("edit") %>',
    delete: '<%= t("delete") %>',
    answer: '<%= t("answer") %>',
    true: '<%= t("true") %>',
    false: '<%= t("false") %>',
    confirmDeleteQuestion: '<%= t("confirmDeleteQuestion") %>',
    noImage: '<%= t("noImage") %>',
    questionSaved: '<%= t("questionSaved") %>',
    min2Options: '<%= t("min2Options") %>',
    selectCorrectAnswer: '<%= t("selectCorrectAnswer") %>',
    enterCorrectAnswer: '<%= t("enterCorrectAnswer") %>',
    optionN: '<%= t("optionN") %>',
    addOptionImage: '<%= t("addOptionImage") %>',
    removeOptionImage: '<%= t("removeOptionImage") %>',
    testCreatedSuccess: '<%= t("testCreatedSuccess") %>',
    errorCreatingTest: '<%= t("errorCreatingTest") %>',
    connectionError: '<%= t("connectionError") %>',
    draftSaved: '<%= t("draftSaved") %>',
    importQuestionsFeature: '<%= t("importQuestionsFeature") %>',
    addAtLeast1Question: '<%= t("addAtLeast1Question") %>',
    fillInAllFields: '<%= t("fillInAllFields") %>',
    imageSizeLimit: '<%= t("imageSizeLimit") %>',
    selectImageOnly: '<%= t("selectImageOnly") %>'
};

let currentStep = 1;
let questions = [];
let editingQuestionIndex = -1;
let autoSaveTimer = null;

document.addEventListener('DOMContentLoaded', function() {
    // Note: Courses are already loaded server-side via EJS template
    // No need to call loadCourses() which would create duplicate options
    setupFormHandlers();
    initializeFirstQuestion();
    loadDraftFromStorage();
    enableAutoSave();
    setupBeforeUnloadWarning();
});

function handleCourseChange() {
    loadChapters();
    loadCourseAssessmentStructure();
    updateRequiredFields();
}

// Handle test type change - enforce course/chapter selection for chapter_test/lesson_test
function handleTestTypeChange() {
    const testType = document.getElementById('test_type').value;
    const courseSelect = document.getElementById('course_id');
    const chapterSelect = document.getElementById('chapter_id');
    const lessonSelect = document.getElementById('lesson_id');

    const courseLabel = document.querySelector('label[for="course_id"]');
    const chapterLabel = document.querySelector('label[for="chapter_id"]');
    const lessonLabel = document.querySelector('label[for="lesson_id"]');

    // Reset required indicators
    const resetRequired = (label) => {
        const requiredSpan = label.querySelector('.text-red-500');
        if (requiredSpan) requiredSpan.remove();
    };

    const addRequired = (label) => {
        if (!label.querySelector('.text-red-500')) {
            const span = document.createElement('span');
            span.className = 'text-red-500';
            span.textContent = ' *';
            label.appendChild(span);
        }
    };

    // Reset all
    resetRequired(courseLabel);
    resetRequired(chapterLabel);
    resetRequired(lessonLabel);
    courseSelect.removeAttribute('required');
    chapterSelect.removeAttribute('required');
    lessonSelect.removeAttribute('required');

    if (testType === 'chapter_test') {
        // Chapter test requires course and chapter
        addRequired(courseLabel);
        addRequired(chapterLabel);
        courseSelect.setAttribute('required', 'required');
        chapterSelect.setAttribute('required', 'required');

        // Show info message
        showTestTypeInfo('chapterTestInfo');
    } else if (testType === 'lesson_test') {
        // Lesson test requires course, chapter, and lesson
        addRequired(courseLabel);
        addRequired(chapterLabel);
        addRequired(lessonLabel);
        courseSelect.setAttribute('required', 'required');
        chapterSelect.setAttribute('required', 'required');
        lessonSelect.setAttribute('required', 'required');

        showTestTypeInfo('lessonTestInfo');
    } else {
        hideTestTypeInfo();
    }

    updateRequiredFields();
}

function showTestTypeInfo(infoType) {
    // Remove existing info
    hideTestTypeInfo();

    const testTypeDiv = document.getElementById('test_type').parentElement;
    const infoDiv = document.createElement('div');
    infoDiv.id = 'test-type-info';
    infoDiv.className = 'mt-2 p-3 bg-blue-50 border border-blue-200 rounded-md';

    if (infoType === 'chapterTestInfo') {
        infoDiv.innerHTML = `
            <p class="text-sm text-blue-800">
                <i class="fas fa-info-circle mr-2"></i>
                <strong><%= t('chapterTestNote') || 'Chapter Test' %>:</strong>
                <%= t('chapterTestDescription') || 'This test will appear at the end of the selected chapter. Please select a course and chapter.' %>
            </p>
        `;
    } else if (infoType === 'lessonTestInfo') {
        infoDiv.innerHTML = `
            <p class="text-sm text-blue-800">
                <i class="fas fa-info-circle mr-2"></i>
                <strong><%= t('lessonTestNote') || 'Lesson Test' %>:</strong>
                <%= t('lessonTestDescription') || 'This test will appear at the end of the selected lesson. Please select a course, chapter, and lesson.' %>
            </p>
        `;
    }

    testTypeDiv.appendChild(infoDiv);
}

function hideTestTypeInfo() {
    const existingInfo = document.getElementById('test-type-info');
    if (existingInfo) existingInfo.remove();
}

function updateRequiredFields() {
    const testType = document.getElementById('test_type').value;
    const chapterLabel = document.querySelector('label[for="chapter_id"]');
    const lessonLabel = document.querySelector('label[for="lesson_id"]');

    // Update label text based on test type
    if (testType === 'chapter_test' || testType === 'lesson_test') {
        chapterLabel.innerHTML = '<%= t("selectChapterRequired") || "Select Chapter" %> <span class="text-red-500">*</span>';
        if (testType === 'lesson_test') {
            lessonLabel.innerHTML = '<%= t("selectLessonRequired") || "Select Lesson" %> <span class="text-red-500">*</span>';
        } else {
            lessonLabel.innerHTML = '<%= t("selectLesson") %> <span class="text-gray-500 text-xs">(<%= t("selectChapterFirst") %>)</span>';
        }
    } else {
        chapterLabel.innerHTML = '<%= t("selectChapter") %> <span class="text-gray-500 text-xs">(<%= t("selectCourseFirst") %>)</span>';
        lessonLabel.innerHTML = '<%= t("selectLesson") %> <span class="text-gray-500 text-xs">(<%= t("selectChapterFirst") %>)</span>';
    }
}

function loadCourseAssessmentStructure() {
    const courseId = document.getElementById('course_id').value;
    const container = document.getElementById('course-assessment-structure');
    const contentDiv = document.getElementById('assessment-structure-content');

    if (!courseId) {
        container.classList.add('hidden');
        return;
    }

    // Show container with loading state
    container.classList.remove('hidden');
    contentDiv.innerHTML = `
        <div class="text-center py-4">
            <i class="fas fa-spinner fa-spin text-blue-500 text-2xl"></i>
            <p class="text-sm text-gray-600 mt-2"><%= t('loading') %></p>
        </div>
    `;

    // Fetch tests for this course
    fetch(`/tests/api/courses/${courseId}/tests`)
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                displayAssessmentStructure(result.data || []);
            } else {
                contentDiv.innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-exclamation-circle text-yellow-500 text-2xl"></i>
                        <p class="text-sm text-gray-600 mt-2">${result.message || '<%= t("failedToLoadTests") %>'}</p>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error loading course tests:', error);
            contentDiv.innerHTML = `
                <div class="text-center py-4">
                    <i class="fas fa-exclamation-triangle text-red-500 text-2xl"></i>
                    <p class="text-sm text-gray-600 mt-2"><%= t("failedToLoadTests") %></p>
                </div>
            `;
        });
}

function displayAssessmentStructure(tests) {
    const contentDiv = document.getElementById('assessment-structure-content');

    // Define all test types with their display info
    const testTypes = [
        { key: 'pre_training_assessment', label: '<%= t("preTrainingAssessment") %>', icon: 'fa-clipboard-check', color: 'blue' },
        { key: 'knowledge_check', label: '<%= t("knowledgeCheck") %>', icon: 'fa-brain', color: 'purple' },
        { key: 'progress_assessment', label: '<%= t("progressAssessment") %>', icon: 'fa-chart-line', color: 'indigo' },
        { key: 'midcourse_assessment', label: '<%= t("midcourseAssessment") %>', icon: 'fa-clipboard-list', color: 'yellow' },
        { key: 'final_assessment', label: '<%= t("finalAssessment") %>', icon: 'fa-trophy', color: 'red', required: true },
        { key: 'post_training_assessment', label: '<%= t("postTrainingAssessment") %>', icon: 'fa-clipboard-check', color: 'green' },
        { key: 'certification_assessment', label: '<%= t("certificationAssessment") %>', icon: 'fa-certificate', color: 'yellow' },
        { key: 'practice_exercise', label: '<%= t("practiceExercise") %>', icon: 'fa-pencil-alt', color: 'gray' }
    ];

    // Group tests by type
    const testsByType = {};
    tests.forEach(test => {
        if (!testsByType[test.type]) {
            testsByType[test.type] = [];
        }
        testsByType[test.type].push(test);
    });

    // Build HTML
    let html = '<div class="space-y-2">';

    // Show existing tests
    let hasTests = false;
    testTypes.forEach(type => {
        const typeTests = testsByType[type.key] || [];
        if (typeTests.length > 0) {
            hasTests = true;
            html += `
                <div class="flex items-center justify-between p-2 bg-white rounded border border-${type.color}-200">
                    <div class="flex items-center space-x-2">
                        <i class="fas ${type.icon} text-${type.color}-600"></i>
                        <span class="text-sm font-medium text-gray-900">${type.label}</span>
                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-${type.color}-100 text-${type.color}-800">
                            ${typeTests.length} test${typeTests.length > 1 ? 's' : ''}
                        </span>
                    </div>
                    <i class="fas fa-check-circle text-green-500"></i>
                </div>
            `;
        }
    });

    if (!hasTests) {
        html += `
            <div class="text-center py-3 bg-white rounded border border-gray-200">
                <i class="fas fa-inbox text-gray-400 text-xl mb-2"></i>
                <p class="text-sm text-gray-600"><%= t('noCourseTestsYet') %></p>
            </div>
        `;
    }

    // Show missing required tests
    const missingRequired = testTypes.filter(type => type.required && !testsByType[type.key]);
    if (missingRequired.length > 0) {
        html += `
            <div class="mt-3 p-3 bg-yellow-50 border border-yellow-200 rounded">
                <h5 class="text-xs font-semibold text-yellow-900 mb-2 flex items-center">
                    <i class="fas fa-exclamation-triangle mr-2"></i>
                    <%= t('missingRequiredTests') %>
                </h5>
        `;
        missingRequired.forEach(type => {
            html += `
                <div class="flex items-center space-x-2 text-sm text-yellow-800 py-1">
                    <i class="fas ${type.icon}"></i>
                    <span>${type.label}</span>
                </div>
            `;
        });
        html += '</div>';
    }

    // Show suggested tests
    const missingOptional = testTypes.filter(type => !type.required && !testsByType[type.key]);
    if (missingOptional.length > 0 && hasTests) {
        html += `
            <div class="mt-2">
                <p class="text-xs font-medium text-gray-700 mb-2">
                    <i class="fas fa-lightbulb mr-1 text-yellow-500"></i>
                    <%= t('suggestedTests') %>:
                </p>
                <div class="flex flex-wrap gap-2">
        `;
        missingOptional.slice(0, 4).forEach(type => {
            html += `
                <span class="inline-flex items-center px-2 py-1 rounded text-xs bg-gray-100 text-gray-700">
                    <i class="fas ${type.icon} mr-1"></i>
                    ${type.label}
                </span>
            `;
        });
        html += '</div></div>';
    }

    html += '</div>';
    contentDiv.innerHTML = html;
}

// Track data source for chapters (chapters table or course_materials)
let chaptersSource = 'chapters';

function loadChapters() {
    const courseId = document.getElementById('course_id').value;
    const chapterSelect = document.getElementById('chapter_id');
    const lessonSelect = document.getElementById('lesson_id');

    // Reset chapters and lessons
    chapterSelect.innerHTML = '<option value=""><%= t("selectCourseToLoadChapters") %></option>';
    lessonSelect.innerHTML = '<option value=""><%= t("selectChapterToLoadLessons") %></option>';
    chapterSelect.disabled = true;
    lessonSelect.disabled = true;
    chaptersSource = 'chapters';

    if (!courseId) {
        return;
    }

    // Load chapters for selected course
    fetch(`/tests/api/courses/${courseId}/chapters`)
        .then(response => response.json())
        .then(result => {
            if (result.success && result.data && result.data.length > 0) {
                // Track the source type
                chaptersSource = result.source || 'chapters';

                chapterSelect.innerHTML = '<option value=""><%= t("noChapterSelected") %></option>';
                chapterSelect.disabled = false;

                result.data.forEach(chapter => {
                    const option = document.createElement('option');
                    option.value = chapter.chapter_id;
                    option.textContent = chapter.title;
                    // Store source type in data attribute
                    option.dataset.source = chaptersSource;
                    chapterSelect.appendChild(option);
                });

                // If source is materials, hide lesson select (materials don't have sub-lessons)
                if (chaptersSource === 'materials') {
                    lessonSelect.parentElement.style.display = 'none';
                } else {
                    lessonSelect.parentElement.style.display = '';
                }
            } else {
                chapterSelect.innerHTML = '<option value=""><%= t("noCourseChapters") %></option>';
            }
        })
        .catch(error => console.error('Error loading chapters:', error));
}

function loadLessons() {
    const chapterId = document.getElementById('chapter_id').value;
    const lessonSelect = document.getElementById('lesson_id');

    // Reset lessons
    lessonSelect.innerHTML = '<option value=""><%= t("selectChapterToLoadLessons") %></option>';
    lessonSelect.disabled = true;

    if (!chapterId) {
        return;
    }

    // If chapters came from materials, don't load lessons
    if (chaptersSource === 'materials') {
        lessonSelect.innerHTML = '<option value=""><%= t("noLessonsForMaterial") || "ไม่มีบทเรียนย่อย" %></option>';
        return;
    }

    // Load lessons for selected chapter
    fetch(`/tests/api/chapters/${chapterId}/lessons?source=${chaptersSource}`)
        .then(response => response.json())
        .then(result => {
            if (result.success && result.data.length > 0) {
                lessonSelect.innerHTML = '<option value=""><%= t("noLessonSelected") %></option>';
                lessonSelect.disabled = false;
                result.data.forEach(lesson => {
                    const option = document.createElement('option');
                    option.value = lesson.lesson_id;
                    option.textContent = lesson.title;
                    lessonSelect.appendChild(option);
                });
            } else {
                lessonSelect.innerHTML = '<option value=""><%= t("noChapterLessons") %></option>';
            }
        })
        .catch(error => console.error('Error loading lessons:', error));
}

function setupFormHandlers() {
    document.getElementById('create-test-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        await submitTest();
    });

    document.getElementById('question-form').addEventListener('submit', function(e) {
        e.preventDefault();
        saveQuestion();
    });
}

function nextStep() {
    if (validateCurrentStep()) {
        hideStep(currentStep);
        currentStep++;
        showStep(currentStep);
        updateProgressSteps();
    }
}

function previousStep() {
    hideStep(currentStep);
    currentStep--;
    showStep(currentStep);
    updateProgressSteps();
}

function hideStep(step) {
    document.getElementById(`step-${step}`).classList.add('hidden');
}

function showStep(step) {
    document.getElementById(`step-${step}`).classList.remove('hidden');
}

function updateProgressSteps() {
    for (let i = 1; i <= 3; i++) {
        const stepElement = document.querySelector(`nav ol li:nth-child(${i}) .relative`);
        const textElement = document.querySelector(`nav ol li:nth-child(${i}) span`);

        if (i <= currentStep) {
            stepElement.className = stepElement.className.replace('bg-gray-200', 'bg-ruxchai-primary');
            stepElement.querySelector('span').className = 'text-white text-sm font-medium';
            textElement.className = textElement.className.replace('text-gray-500', 'text-gray-900');
        } else {
            stepElement.className = stepElement.className.replace('bg-ruxchai-primary', 'bg-gray-200');
            stepElement.querySelector('span').className = 'text-gray-500 text-sm font-medium';
            textElement.className = textElement.className.replace('text-gray-900', 'text-gray-500');
        }
    }

    // Update connecting lines
    const lines = document.querySelectorAll('nav ol li .absolute.inset-0 div');
    lines.forEach((line, index) => {
        if (index < currentStep - 1) {
            line.className = line.className.replace('bg-gray-200', 'bg-ruxchai-primary');
        } else {
            line.className = line.className.replace('bg-ruxchai-primary', 'bg-gray-200');
        }
    });
}

function validateCurrentStep() {
    const requiredFields = document.querySelectorAll(`#step-${currentStep} [required]`);
    let isValid = true;

    requiredFields.forEach(field => {
        if (!field.value.trim()) {
            field.classList.add('border-red-500');
            isValid = false;
        } else {
            field.classList.remove('border-red-500');
        }
    });

    if (!isValid) {
        showError(i18n.fillInAllFields);
    }

    return isValid;
}

function initializeFirstQuestion() {
    // Show the "no questions" state initially
    updateQuestionsDisplay();
}

// ========================================
// AUTO-SAVE FUNCTIONALITY
// ========================================

function enableAutoSave() {
    // Auto-save every 30 seconds
    autoSaveTimer = setInterval(() => {
        saveToLocalStorage();
    }, 30000);
    console.log('✅ Auto-save enabled (every 30 seconds)');
}

function saveToLocalStorage() {
    if (questions.length === 0 && currentStep === 1) {
        // Don't save empty state
        return;
    }

    const testDraft = {
        currentStep: currentStep,
        formData: collectFormData(),
        questions: questions,
        timestamp: new Date().toISOString()
    };

    try {
        localStorage.setItem('test_draft', JSON.stringify(testDraft));
        console.log('💾 Auto-saved at', new Date().toLocaleTimeString());

        // Show brief success indicator
        const indicator = document.createElement('div');
        indicator.className = 'fixed bottom-4 right-4 bg-green-500 text-white px-4 py-2 rounded shadow-lg text-sm z-50';
        indicator.innerHTML = '<i class="fas fa-check mr-2"></i>Draft saved';
        document.body.appendChild(indicator);

        setTimeout(() => {
            indicator.remove();
        }, 2000);
    } catch (error) {
        console.error('Failed to save draft:', error);
    }
}

function loadDraftFromStorage() {
    const draft = localStorage.getItem('test_draft');

    if (draft) {
        try {
            const testDraft = JSON.parse(draft);
            const draftTime = new Date(testDraft.timestamp);
            const timeDiff = Date.now() - draftTime.getTime();
            const hoursDiff = timeDiff / (1000 * 60 * 60);

            // Only show prompt if draft is less than 24 hours old
            if (hoursDiff < 24) {
                const timeAgo = hoursDiff < 1
                    ? Math.round(timeDiff / (1000 * 60)) + ' minutes ago'
                    : Math.round(hoursDiff) + ' hours ago';

                if (confirm(`Found a saved draft from ${timeAgo}.\n\nDo you want to restore it?`)) {
                    restoreDraft(testDraft);
                    showSuccess('Draft restored successfully');
                }
            } else {
                // Clear old draft
                localStorage.removeItem('test_draft');
            }
        } catch (error) {
            console.error('Failed to load draft:', error);
        }
    }
}

function restoreDraft(testDraft) {
    // Restore form data
    const formData = testDraft.formData;
    Object.keys(formData).forEach(key => {
        const element = document.getElementById(key) || document.querySelector(`[name="${key}"]`);
        if (element) {
            if (element.type === 'checkbox') {
                element.checked = formData[key];
            } else {
                element.value = formData[key];
            }
        }
    });

    // After restoring form data, trigger course change if course was selected
    // This loads chapters/lessons dropdowns and shows course assessment structure
    if (formData.course_id) {
        handleCourseChange();

        // If chapter_id was also saved, restore lessons after chapters load
        if (formData.chapter_id) {
            setTimeout(() => {
                const chapterSelect = document.getElementById('chapter_id');
                if (chapterSelect) {
                    chapterSelect.value = formData.chapter_id;
                    loadLessons();

                    // If lesson_id was also saved, restore it after lessons load
                    if (formData.lesson_id) {
                        setTimeout(() => {
                            const lessonSelect = document.getElementById('lesson_id');
                            if (lessonSelect) {
                                lessonSelect.value = formData.lesson_id;
                            }
                        }, 500);
                    }
                }
            }, 500);
        }
    }

    // Restore questions
    questions = testDraft.questions || [];
    updateQuestionsDisplay();

    // Restore step
    if (testDraft.currentStep > 1) {
        hideStep(currentStep);
        currentStep = testDraft.currentStep;
        showStep(currentStep);
        updateProgressSteps();
    }
}

function collectFormData() {
    return {
        test_name: document.getElementById('test_name')?.value || '',
        test_code: document.getElementById('test_code')?.value || '',
        description: document.getElementById('description')?.value || '',
        instructions: document.getElementById('instructions')?.value || '',
        type: document.getElementById('test_type')?.value || '',
        course_id: document.getElementById('course_id')?.value || '',
        chapter_id: document.getElementById('chapter_id')?.value || '',
        lesson_id: document.getElementById('lesson_id')?.value || '',
        difficulty_level: document.getElementById('difficulty_level')?.value || '',
        language: document.getElementById('language')?.value || '',
        time_limit: document.getElementById('time_limit')?.value || '',
        start_date: document.getElementById('start_date')?.value || '',
        end_date: document.getElementById('end_date')?.value || '',
        max_attempts: document.getElementById('max_attempts')?.value || '',
        passing_score: document.getElementById('passing_score')?.value || '',
        question_order: document.getElementById('question_order')?.value || '',
        show_score_immediately: document.getElementById('show_score_immediately')?.checked || false,
        show_correct_answers: document.getElementById('show_correct_answers')?.checked || false,
        allow_review: document.getElementById('allow_review')?.checked || false,
        require_camera: document.getElementById('require_camera')?.checked || false,
        prevent_copy_paste: document.getElementById('prevent_copy_paste')?.checked || false,
        track_tab_switching: document.getElementById('track_tab_switching')?.checked || false,
        randomize_options: document.getElementById('randomize_options')?.checked || false,
        questions_to_show: document.getElementById('questions_to_show')?.value || '',
        access_code: document.getElementById('access_code')?.value || '',
        status: document.getElementById('status')?.value || ''
    };
}

function setupBeforeUnloadWarning() {
    window.addEventListener('beforeunload', (e) => {
        if (questions.length > 0 || document.getElementById('test_name')?.value) {
            e.preventDefault();
            e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
            return e.returnValue;
        }
    });
}

function clearDraft() {
    localStorage.removeItem('test_draft');
    console.log('Draft cleared');
}

function addQuestion() {
    editingQuestionIndex = -1;
    resetQuestionForm();
    changeQuestionType(); // Set up initial question type
    document.getElementById('question-modal').classList.remove('hidden');
}

function duplicateQuestion(index) {
    if (index < 0 || index >= questions.length) {
        showError('Invalid question index');
        return;
    }

    try {
        // Deep clone the question (without File objects)
        const original = questions[index];
        const duplicate = {
            question_type: original.question_type,
            question_text: original.question_text + ' (Copy)',
            points: original.points,
            explanation: original.explanation,
            question_image: null, // Images can't be easily cloned
        };

        // Clone type-specific data
        if (original.question_type === 'multiple_choice' && original.options) {
            duplicate.options = original.options.map(opt => ({
                text: opt.text,
                is_correct: opt.is_correct,
                image: null // Images can't be easily cloned
            }));
        } else if (original.question_type === 'true_false') {
            duplicate.correct_answer = original.correct_answer;
        } else if (original.question_type === 'essay') {
            duplicate.sample_answer = original.sample_answer;
        } else if (original.question_type === 'fill_blank') {
            duplicate.correct_answers = [...(original.correct_answers || [])];
        }

        // Insert after the original question
        questions.splice(index + 1, 0, duplicate);
        updateQuestionsDisplay();
        showSuccess('Question duplicated successfully! (Note: Images are not copied)');
    } catch (error) {
        console.error('Error duplicating question:', error);
        showError('Failed to duplicate question');
    }
}

function editQuestion(index) {
    editingQuestionIndex = index;
    const question = questions[index];
    populateQuestionForm(question);
    document.getElementById('question-modal').classList.remove('hidden');
}

function deleteQuestion(index) {
    if (confirm(i18n.confirmDeleteQuestion)) {
        questions.splice(index, 1);
        updateQuestionsDisplay();
    }
}

function resetQuestionForm() {
    document.getElementById('question-form').reset();
    document.getElementById('question-type').value = 'multiple_choice';
    document.getElementById('question-points').value = 1;

    // Clear question image preview
    const questionImagePreview = document.getElementById('question-image-preview');
    const questionImageName = document.getElementById('question-image-name');
    questionImagePreview.classList.add('hidden');
    questionImageName.textContent = i18n.noImage;

    // Clear options container
    const optionsContainer = document.getElementById('options-container');
    optionsContainer.innerHTML = '';
}

function populateQuestionForm(question) {
    document.getElementById('question-type').value = question.question_type;
    document.getElementById('question-text').value = question.question_text;
    document.getElementById('question-points').value = question.points;
    document.getElementById('question-explanation').value = question.explanation || '';

    // Restore question image if exists
    if (question.question_image) {
        const questionImageInput = document.getElementById('question-image');
        const preview = document.getElementById('question-image-preview');
        const img = preview.querySelector('img');
        const fileName = document.getElementById('question-image-name');

        img.src = URL.createObjectURL(question.question_image);
        preview.classList.remove('hidden');
        fileName.textContent = question.question_image.name;

        // Create a new FileList with the existing file
        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(question.question_image);
        questionImageInput.files = dataTransfer.files;
    }

    // Clear and setup question type
    const optionsContainer = document.getElementById('options-container');
    optionsContainer.innerHTML = '';

    changeQuestionType();

    // Populate answers based on question type
    if (question.question_type === 'multiple_choice') {
        // Clear default options first
        optionsContainer.innerHTML = '';
        question.options.forEach((option, index) => {
            const imageUrl = option.image ? URL.createObjectURL(option.image) : '';
            addOption(option.text, option.is_correct, imageUrl);

            // If option has image, restore it to the file input
            if (option.image) {
                const optionImageInput = document.getElementById(`option_image_${index}`);
                const fileName = document.getElementById(`option_image_name_${index}`);
                const preview = document.getElementById(`option_image_preview_${index}`);

                fileName.textContent = option.image.name;
                preview.classList.remove('hidden');

                // Create a new FileList with the existing file
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(option.image);
                optionImageInput.files = dataTransfer.files;
            }
        });
    } else if (question.question_type === 'true_false') {
        const correctRadio = document.querySelector(`input[name="correct_answer"][value="${question.correct_answer}"]`);
        if (correctRadio) correctRadio.checked = true;
    } else if (question.question_type === 'essay') {
        document.getElementById('essay-sample').value = question.sample_answer || '';
    } else if (question.question_type === 'fill_blank') {
        document.getElementById('blank-answers').value = question.correct_answers ? question.correct_answers.join(', ') : '';
    }
}

function changeQuestionType() {
    const type = document.getElementById('question-type').value;

    // Hide all answer sections
    document.getElementById('answer-options').classList.add('hidden');
    document.getElementById('true-false-options').classList.add('hidden');
    document.getElementById('essay-answer').classList.add('hidden');
    document.getElementById('fill-blank-answer').classList.add('hidden');

    // Clear previous options
    const optionsContainer = document.getElementById('options-container');
    optionsContainer.innerHTML = '';

    // Show relevant section
    if (type === 'multiple_choice') {
        document.getElementById('answer-options').classList.remove('hidden');
        // ✅ Add 4 default options (A, B, C, D) for better UX
        ['A', 'B', 'C', 'D'].forEach((letter, index) => {
            addOption(`Option ${letter}`, index === 0); // First option selected by default
        });
    } else if (type === 'true_false') {
        document.getElementById('true-false-options').classList.remove('hidden');
    } else if (type === 'essay') {
        document.getElementById('essay-answer').classList.remove('hidden');
    } else if (type === 'fill_blank') {
        document.getElementById('fill-blank-answer').classList.remove('hidden');
    }
}

function addOption(text = '', isCorrect = false, imageUrl = '') {
    const container = document.getElementById('options-container');
    const optionIndex = container.children.length;

    const optionDiv = document.createElement('div');
    optionDiv.className = 'border border-gray-200 rounded-md p-3 mb-2';
    optionDiv.innerHTML = `
        <div class="flex items-center space-x-2 mb-2">
            <input type="radio" name="correct_option" value="${optionIndex}" ${isCorrect ? 'checked' : ''}
                   class="form-radio">
            <input type="text" name="option_text_${optionIndex}" value="${text}" required
                   class="flex-1 rounded-md border-gray-300 shadow-sm focus:border-ruxchai-primary focus:ring-ruxchai-primary"
                   placeholder="${i18n.optionN} ${optionIndex + 1}">
            <button type="button" onclick="removeOption(this)" class="text-red-600 hover:text-red-800">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="flex items-center space-x-2">
            <input type="file" id="option_image_${optionIndex}" name="option_image_${optionIndex}" accept="image/*"
                   onchange="previewOptionImage(this, ${optionIndex})"
                   class="hidden">
            <label for="option_image_${optionIndex}"
                   class="cursor-pointer inline-flex items-center px-2 py-1 border border-gray-300 rounded text-xs text-gray-600 hover:bg-gray-50">
                <i class="fas fa-image mr-1"></i>${i18n.addOptionImage}
            </label>
            <span id="option_image_name_${optionIndex}" class="text-xs text-gray-500"></span>
        </div>
        <div id="option_image_preview_${optionIndex}" class="mt-2 hidden">
            <img src="${imageUrl}" alt="Option preview" class="max-w-xs max-h-32 rounded border border-gray-300">
            <button type="button" onclick="removeOptionImage(${optionIndex})"
                    class="mt-1 text-xs text-red-600 hover:text-red-800">
                <i class="fas fa-times mr-1"></i>${i18n.removeOptionImage}
            </button>
        </div>
    `;

    container.appendChild(optionDiv);
}

function removeOption(button) {
    const container = document.getElementById('options-container');
    if (container.children.length > 2) {
        button.parentElement.remove();
        // Re-index options
        Array.from(container.children).forEach((option, index) => {
            const radio = option.querySelector('input[type="radio"]');
            const text = option.querySelector('input[type="text"]');
            const placeholder = option.querySelector('input[type="text"]');

            radio.value = index;
            text.name = `option_text_${index}`;
            placeholder.placeholder = `${i18n.optionN} ${index + 1}`;
        });
    }
}

function saveQuestion() {
    const formData = new FormData(document.getElementById('question-form'));
    const questionType = formData.get('question_type');

    const question = {
        question_type: questionType,
        question_text: formData.get('question_text'),
        points: parseInt(formData.get('points')),
        explanation: formData.get('explanation') || '',
        question_image: document.getElementById('question-image').files[0] || null
    };

    // Handle answers based on question type
    if (questionType === 'multiple_choice') {
        const options = [];
        const container = document.getElementById('options-container');
        const correctIndex = parseInt(formData.get('correct_option'));

        Array.from(container.children).forEach((option, index) => {
            const text = option.querySelector('input[type="text"]').value;
            const imageInput = option.querySelector('input[type="file"]');
            if (text.trim()) {
                options.push({
                    text: text,
                    is_correct: index === correctIndex,
                    image: imageInput && imageInput.files[0] ? imageInput.files[0] : null
                });
            }
        });

        if (options.length < 2) {
            showError(i18n.min2Options);
            return;
        }

        if (correctIndex === undefined || correctIndex < 0) {
            showError(i18n.selectCorrectAnswer);
            return;
        }

        question.options = options;
    } else if (questionType === 'true_false') {
        question.correct_answer = formData.get('correct_answer');
        if (!question.correct_answer) {
            showError(i18n.selectCorrectAnswer);
            return;
        }
    } else if (questionType === 'essay') {
        question.sample_answer = formData.get('sample_answer');
    } else if (questionType === 'fill_blank') {
        const answers = formData.get('blank_answers');
        if (!answers || !answers.trim()) {
            showError(i18n.enterCorrectAnswer);
            return;
        }
        question.correct_answers = answers.split(',').map(a => a.trim()).filter(a => a);
    }

    // Add or update question
    if (editingQuestionIndex >= 0) {
        questions[editingQuestionIndex] = question;
    } else {
        questions.push(question);
    }

    updateQuestionsDisplay();
    closeQuestionModal();
    showSuccess(i18n.questionSaved);
}

function updateQuestionsDisplay() {
    const container = document.getElementById('questions-container');
    const noQuestions = document.getElementById('no-questions');

    if (questions.length === 0) {
        container.classList.add('hidden');
        noQuestions.classList.remove('hidden');
        return;
    }

    container.classList.remove('hidden');
    noQuestions.classList.add('hidden');

    // Clear container
    container.innerHTML = '';

    // Create elements for each question
    questions.forEach((question, index) => {
        console.log('Rendering question', index, 'with image:', question.question_image);

        const questionDiv = document.createElement('div');
        questionDiv.className = 'border border-gray-200 rounded-lg p-4';

        questionDiv.innerHTML = `
            <div class="flex items-start justify-between">
                <div class="flex-1">
                    <div class="flex items-center space-x-3 mb-2">
                        <span class="text-sm font-medium text-gray-900">${i18n.questionNumber} ${index + 1}</span>
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getQuestionTypeColor(question.question_type)}">
                            ${getQuestionTypeText(question.question_type)}
                        </span>
                        <span class="text-xs text-gray-500">${question.points} ${i18n.points}</span>
                    </div>
                    <p class="text-sm text-gray-700 mb-2">${question.question_text}</p>
                    <div class="question-image-placeholder"></div>
                    <div class="question-preview-placeholder"></div>
                </div>
                <div class="flex space-x-2 ml-4">
                    <button onclick="duplicateQuestion(${index})" class="text-purple-600 hover:text-purple-800 text-sm" title="Duplicate question">
                        <i class="fas fa-copy"></i>
                    </button>
                    <button onclick="editQuestion(${index})" class="text-blue-600 hover:text-blue-800 text-sm" title="Edit question">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button onclick="deleteQuestion(${index})" class="text-red-600 hover:text-red-800 text-sm" title="Delete question">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `;

        // Append to container first
        container.appendChild(questionDiv);

        // Now find placeholders after element is in DOM
        const imagePlaceholder = questionDiv.querySelector('.question-image-placeholder');
        const previewPlaceholder = questionDiv.querySelector('.question-preview-placeholder');

        // Add question image if exists
        if (question.question_image) {
            console.log('Creating image element for question', index);
            const img = document.createElement('img');
            img.src = URL.createObjectURL(question.question_image);
            img.alt = `Question ${index + 1}`;
            img.className = 'mb-3 max-w-md max-h-48 rounded border border-gray-300';
            img.onload = () => console.log('Image loaded successfully for question', index);
            img.onerror = (e) => console.error('Image failed to load for question', index, e);
            imagePlaceholder.appendChild(img);
        } else {
            console.log('No question image for question', index);
        }

        // Add question preview
        if (question.question_type === 'multiple_choice') {
            const optionsDiv = document.createElement('div');
            optionsDiv.className = 'space-y-2';

            question.options.forEach((option, optIndex) => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'text-sm';

                const textDiv = document.createElement('div');
                textDiv.className = 'flex items-center space-x-2';
                textDiv.innerHTML = `
                    <span class="${option.is_correct ? 'text-green-600 font-medium' : 'text-gray-600'}">
                        ${String.fromCharCode(65 + optIndex)}. ${option.text}
                        ${option.is_correct ? '<i class="fas fa-check ml-1"></i>' : ''}
                    </span>
                `;
                optionDiv.appendChild(textDiv);

                // Add option image if exists
                if (option.image) {
                    const img = document.createElement('img');
                    img.src = URL.createObjectURL(option.image);
                    img.alt = `Option ${optIndex + 1}`;
                    img.className = 'mt-1 ml-4 max-w-xs max-h-24 rounded border border-gray-300';
                    optionDiv.appendChild(img);
                }

                optionsDiv.appendChild(optionDiv);
            });

            previewPlaceholder.appendChild(optionsDiv);
        } else if (question.question_type === 'true_false') {
            previewPlaceholder.innerHTML = `<p class="text-sm text-green-600 font-medium">${i18n.answer}: ${question.correct_answer === 'true' ? i18n.true : i18n.false}</p>`;
        } else if (question.question_type === 'fill_blank') {
            previewPlaceholder.innerHTML = `<p class="text-sm text-green-600 font-medium">${i18n.answer}: ${question.correct_answers.join(', ')}</p>`;
        }
    });
}

function getQuestionTypeColor(type) {
    const colors = {
        'multiple_choice': 'bg-blue-100 text-blue-800',
        'true_false': 'bg-green-100 text-green-800',
        'essay': 'bg-purple-100 text-purple-800',
        'fill_blank': 'bg-yellow-100 text-yellow-800'
    };
    return colors[type] || 'bg-gray-100 text-gray-800';
}

function getQuestionTypeText(type) {
    const types = {
        'multiple_choice': i18n.multipleChoice,
        'true_false': i18n.trueFalse,
        'essay': i18n.essay,
        'fill_blank': i18n.fillBlank
    };
    return types[type] || type;
}

function closeQuestionModal() {
    document.getElementById('question-modal').classList.add('hidden');
    resetQuestionForm();
}

function importQuestions() {
    // Implementation for importing questions from question bank
    showSuccess(i18n.importQuestionsFeature);
}

async function submitTest() {
    if (questions.length === 0) {
        showError(i18n.addAtLeast1Question);
        return;
    }

    const formData = new FormData(document.getElementById('create-test-form'));

    // Prepare test data without images (for now)
    const testData = {
        test_name: formData.get('test_name'),
        test_code: formData.get('test_code'),
        description: formData.get('description'),
        instructions: formData.get('instructions'),
        type: formData.get('type'),
        course_id: formData.get('course_id') || null,
        difficulty_level: formData.get('difficulty_level'),
        language: formData.get('language'),
        time_limit: formData.get('time_limit') ? parseInt(formData.get('time_limit')) : null,
        start_date: formData.get('start_date') || null,
        end_date: formData.get('end_date') || null,
        max_attempts: parseInt(formData.get('max_attempts')),
        passing_score: parseInt(formData.get('passing_score')),
        question_order: formData.get('question_order'),
        show_score_immediately: formData.get('show_score_immediately') ? true : false,
        show_correct_answers: formData.get('show_correct_answers') ? true : false,
        allow_review: formData.get('allow_review') ? true : false,
        require_camera: formData.get('require_camera') ? true : false,
        prevent_copy_paste: formData.get('prevent_copy_paste') ? true : false,
        track_tab_switching: formData.get('track_tab_switching') ? true : false,
        randomize_options: formData.get('randomize_options') ? true : false,
        questions_to_show: formData.get('questions_to_show') ? parseInt(formData.get('questions_to_show')) : null,
        access_code: formData.get('access_code') || null,
        status: formData.get('status'),
        questions: questions.map(q => ({
            question_type: q.question_type,
            question_text: q.question_text,
            points: q.points,
            explanation: q.explanation,
            // Remove image files from the data sent to server (for now)
            options: q.options ? q.options.map(opt => ({
                text: opt.text,
                is_correct: opt.is_correct
            })) : undefined,
            correct_answer: q.correct_answer,
            sample_answer: q.sample_answer,
            correct_answers: q.correct_answers
        }))
    };

    console.log('Submitting test data:', testData);

    try {
        const response = await fetch('/tests/api/create', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(testData)
        });

        const result = await response.json();

        if (result.success) {
            showSuccess(i18n.testCreatedSuccess);
            setTimeout(() => {
                window.location.href = `/tests/${result.data.test_id}`;
            }, 1500);
        } else {
            showError(result.message || i18n.errorCreatingTest);
        }
    } catch (error) {
        showError(i18n.connectionError);
    }
}

async function saveDraft() {
    // Implementation for saving draft
    showSuccess(i18n.draftSaved);
}

// Image handling functions
function previewQuestionImage(input) {
    const file = input.files[0];
    if (file) {
        // Validate file size (5MB)
        if (file.size > 5 * 1024 * 1024) {
            showError(i18n.imageSizeLimit);
            input.value = '';
            return;
        }

        // Validate file type
        if (!file.type.startsWith('image/')) {
            showError(i18n.selectImageOnly);
            input.value = '';
            return;
        }

        // Show preview
        const reader = new FileReader();
        reader.onload = function(e) {
            const preview = document.getElementById('question-image-preview');
            const img = preview.querySelector('img');
            img.src = e.target.result;
            preview.classList.remove('hidden');
        };
        reader.readAsDataURL(file);

        // Update file name
        document.getElementById('question-image-name').textContent = file.name;
    }
}

function removeQuestionImage() {
    document.getElementById('question-image').value = '';
    document.getElementById('question-image-name').textContent = i18n.noImage;
    document.getElementById('question-image-preview').classList.add('hidden');
}

function previewOptionImage(input, optionIndex) {
    const file = input.files[0];
    if (file) {
        // Validate file size (5MB)
        if (file.size > 5 * 1024 * 1024) {
            showError(i18n.imageSizeLimit);
            input.value = '';
            return;
        }

        // Validate file type
        if (!file.type.startsWith('image/')) {
            showError(i18n.selectImageOnly);
            input.value = '';
            return;
        }

        // Show preview
        const reader = new FileReader();
        reader.onload = function(e) {
            const preview = document.getElementById(`option_image_preview_${optionIndex}`);
            const img = preview.querySelector('img');
            img.src = e.target.result;
            preview.classList.remove('hidden');
        };
        reader.readAsDataURL(file);

        // Update file name
        document.getElementById(`option_image_name_${optionIndex}`).textContent = file.name;
    }
}

function removeOptionImage(optionIndex) {
    const input = document.getElementById(`option_image_${optionIndex}`);
    if (input) input.value = '';

    const nameSpan = document.getElementById(`option_image_name_${optionIndex}`);
    if (nameSpan) nameSpan.textContent = '';

    const preview = document.getElementById(`option_image_preview_${optionIndex}`);
    if (preview) preview.classList.add('hidden');
}

function showSuccess(message) {
    const toast = document.createElement('div');
    toast.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
    toast.innerHTML = `
        <div class="flex items-center">
            <i class="fas fa-check-circle mr-2"></i>
            <span>${message}</span>
        </div>
    `;
    document.body.appendChild(toast);

    setTimeout(() => {
        toast.remove();
    }, 3000);
}

function showError(message) {
    const toast = document.createElement('div');
    toast.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
    toast.innerHTML = `
        <div class="flex items-center">
            <i class="fas fa-exclamation-circle mr-2"></i>
            <span>${message}</span>
            <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-white hover:text-gray-200">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `;
    document.body.appendChild(toast);

    setTimeout(() => {
        toast.remove();
    }, 5000);
}
</script>