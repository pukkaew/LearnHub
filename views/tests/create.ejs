

<div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Header -->
    <div class="rounded-2xl p-6 mb-8 text-white shadow-lg" style="background: linear-gradient(to right, <%= systemSettings.primary_color || '#3b82f6' %>, <%= systemSettings.secondary_color || '#10b981' %>);">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold text-white">
                    <i class="fas fa-plus-circle mr-3"></i><%= t('createNewTest') %>
                </h1>
                <p class="mt-2 text-white/80"><%= t('createTestAndAssessment') %></p>
            </div>
            <a href="/tests" class="bg-white/20 hover:bg-white/30 text-white font-medium py-2 px-4 rounded-lg transition-all duration-200 flex items-center">
                <i class="fas fa-arrow-left mr-2"></i><%= t('backToTestList') %>
            </a>
        </div>
    </div>

    <!-- Test Creation Form -->
    <div class="bg-white shadow rounded-lg">
        <div class="p-6">
            <!-- Progress Steps -->
            <div class="mb-8">
                <nav aria-label="Progress">
                    <ol class="flex items-center">
                        <li class="relative pr-8 sm:pr-20">
                            <div class="absolute inset-0 flex items-center" aria-hidden="true">
                                <div class="h-0.5 w-full bg-ruxchai-primary"></div>
                            </div>
                            <div class="relative w-8 h-8 flex items-center justify-center bg-ruxchai-primary rounded-full">
                                <span class="text-white text-sm font-medium">1</span>
                            </div>
                            <span class="absolute top-10 left-0 text-xs font-medium text-gray-900"><%= t('basicInformation') %></span>
                        </li>

                        <li class="relative pr-8 sm:pr-20">
                            <div class="absolute inset-0 flex items-center" aria-hidden="true">
                                <div class="h-0.5 w-full bg-gray-200"></div>
                            </div>
                            <div class="relative w-8 h-8 flex items-center justify-center bg-gray-200 rounded-full">
                                <span class="text-gray-500 text-sm font-medium">2</span>
                            </div>
                            <span class="absolute top-10 left-0 text-xs font-medium text-gray-500"><%= t('settings') %></span>
                        </li>

                        <li class="relative">
                            <div class="relative w-8 h-8 flex items-center justify-center bg-gray-200 rounded-full">
                                <span class="text-gray-500 text-sm font-medium">3</span>
                            </div>
                            <span class="absolute top-10 left-0 text-xs font-medium text-gray-500"><%= t('questions') %></span>
                        </li>
                    </ol>
                </nav>
            </div>

            <form id="create-test-form">
                <!-- Step 1: Basic Information -->
                <div id="step-1" class="step-content">
                    <h3 class="text-lg font-medium text-gray-900 mb-6">
                        <i class="fas fa-info-circle mr-2 text-ruxchai-primary"></i><%= t('basicTestInfo') %>
                    </h3>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="md:col-span-2">
                            <label for="test_name" class="block text-sm font-medium text-gray-700 mb-2"><%= t('testName') %> <span class="text-red-500">*</span></label>
                            <input type="text" id="test_name" name="test_name" required
                                   class="w-full rounded-md border-gray-300 shadow-sm focus:border-ruxchai-primary focus:ring-ruxchai-primary"
                                   placeholder="<%= t('testName') %>">
                        </div>

                        <div>
                            <label for="test_code" class="block text-sm font-medium text-gray-700 mb-2"><%= t('testCode') %> <span class="text-red-500">*</span></label>
                            <div class="flex items-center">
                                <input type="text" id="test_code" name="test_code" required readonly
                                       class="flex-1 rounded-md border-gray-300 bg-gray-50 shadow-sm focus:border-ruxchai-primary focus:ring-ruxchai-primary"
                                       value="TEST-2025-0001">
                                <button type="button" onclick="generateTestCode()" class="ml-2 px-3 py-2 text-sm text-blue-600 hover:text-blue-800">
                                    <i class="fas fa-sync-alt"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà
                                </button>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">‡∏£‡∏´‡∏±‡∏™‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</p>
                        </div>

                        <div>
                            <label for="test_type" class="block text-sm font-medium text-gray-700 mb-2">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö <span class="text-red-500">*</span></label>
                            <select id="test_type" name="type" required onchange="handleTestTypeChange()"
                                    class="w-full rounded-md border-gray-300 shadow-sm focus:border-ruxchai-primary focus:ring-ruxchai-primary">
                                <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö --</option>
                                <optgroup label="üìö ‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£">
                                    <option value="pre_training_assessment">‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (Pre-Test)</option>
                                    <option value="post_training_assessment">‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (Post-Test)</option>
                                    <option value="chapter_test">‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏ó‡πâ‡∏≤‡∏¢‡∏ö‡∏ó</option>
                                    <option value="final_assessment">‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏õ‡∏•‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£</option>
                                </optgroup>
                                <optgroup label="üìù ‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ">
                                    <option value="knowledge_check">‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ</option>
                                    <option value="practice_exercise">‡πÅ‡∏ö‡∏ö‡∏ù‡∏∂‡∏Å‡∏´‡∏±‡∏î</option>
                                    <option value="assessment">‡πÅ‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</option>
                                </optgroup>
                                <optgroup label="üíº ‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏á‡∏≤‡∏ô/‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á">
                                    <option value="job_application_test">‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏á‡∏≤‡∏ô</option>
                                    <option value="aptitude_test">‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏ô‡∏±‡∏î</option>
                                    <option value="certification_assessment">‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ß‡∏∏‡∏í‡∏¥</option>
                                </optgroup>
                            </select>
                            <p id="test-type-hint" class="text-xs text-gray-500 mt-1"></p>
                        </div>

                        <div id="course-field">
                            <label for="course_id" class="block text-sm font-medium text-gray-700 mb-2"><%= t('relatedCourse') %></label>
                            <select id="course_id" name="course_id" onchange="handleCourseChange()"
                                    class="w-full rounded-md border-gray-300 shadow-sm focus:border-ruxchai-primary focus:ring-ruxchai-primary">
                                <option value=""><%= t('notRelatedToCourse') %></option>
                                <% if (courses && courses.length > 0) { %>
                                    <% courses.forEach(course => { %>
                                        <option value="<%= course.course_id %>">
                                            <%= course.title %><% if (course.category) { %> - <%= course.category %><% } %>
                                        </option>
                                    <% }); %>
                                <% } %>
                            </select>
                        </div>

                        <!-- Position Selection for Recruitment Tests -->
                        <div id="position-selection" class="md:col-span-2 hidden">
                            <!-- Global Test Checkbox -->
                            <div class="mb-4 p-4 bg-amber-50 border border-amber-200 rounded-lg">
                                <label class="flex items-center cursor-pointer">
                                    <input type="checkbox" id="is_global_applicant_test" name="is_global_applicant_test"
                                           class="w-5 h-5 rounded border-amber-300 text-amber-600 focus:ring-amber-500 mr-3"
                                           onchange="toggleGlobalTest()">
                                    <div>
                                        <span class="font-medium text-amber-900">
                                            <i class="fas fa-globe mr-1"></i>
                                            ‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏Å‡∏•‡∏≤‡∏á (‡∏ó‡∏∏‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏≠‡∏ö)
                                        </span>
                                        <p class="text-xs text-amber-700 mt-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ô‡∏µ‡πâ‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏ó‡∏∏‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏ô‡∏µ‡πâ</p>
                                    </div>
                                </label>
                            </div>

                            <!-- Department & Position Selection (Course Style) -->
                            <div id="position-multi-select" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <!-- Department Selection -->
                                <div>
                                    <label for="target_departments" class="block text-sm font-medium text-gray-700 mb-2">
                                        <span class="inline-flex items-center">
                                            <span class="bg-blue-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs mr-2">1</span>
                                            ‡πÅ‡∏ú‡∏ô‡∏Å/‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô
                                        </span>
                                        <span class="text-gray-400 text-xs ml-7">(‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡πà‡∏≠‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á)</span>
                                    </label>
                                    <select id="target_departments" name="target_departments[]" multiple size="8"
                                            class="w-full rounded-md border-2 border-gray-300 shadow-sm focus:border-blue-500 focus:ring-2 focus:ring-blue-200 p-2"
                                            style="height: auto;">
                                        <option value="" disabled class="text-gray-400">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</option>
                                    </select>
                                    <div class="mt-2 flex items-center justify-between">
                                        <p class="text-xs text-gray-600">
                                            <i class="fas fa-mouse-pointer text-blue-500"></i> <strong>‡∏Ñ‡∏•‡∏¥‡∏Å</strong> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å/‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                                        </p>
                                        <button type="button" id="clear-departments-btn"
                                                class="text-xs text-red-600 hover:text-red-800 hover:underline">
                                            <i class="fas fa-times-circle"></i> ‡∏•‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                                        </button>
                                    </div>
                                </div>

                                <!-- Position Selection -->
                                <div>
                                    <label for="target_positions" class="block text-sm font-medium text-gray-700 mb-2">
                                        <span class="inline-flex items-center">
                                            <span class="bg-green-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs mr-2">2</span>
                                            ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏≠‡∏ö
                                        </span>
                                        <span class="text-gray-400 text-xs ml-7">(‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å = ‡∏ó‡∏∏‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á)</span>
                                    </label>
                                    <select id="target_positions" name="target_positions[]" multiple size="8"
                                            class="w-full rounded-md border-2 border-gray-300 shadow-sm focus:border-green-500 focus:ring-2 focus:ring-green-200 p-2"
                                            style="height: auto;">
                                        <option value="" disabled class="text-gray-400">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</option>
                                    </select>
                                    <div class="mt-2 flex items-center justify-between">
                                        <p class="text-xs text-gray-600">
                                            <i class="fas fa-filter text-green-500"></i> ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡πÅ‡∏ú‡∏ô‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                                        </p>
                                        <button type="button" id="clear-positions-btn"
                                                class="text-xs text-red-600 hover:text-red-800 hover:underline">
                                            <i class="fas fa-times-circle"></i> ‡∏•‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                                        </button>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-1">
                                        <span id="selected-positions-count">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß 0 ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</span>
                                    </p>
                                </div>
                            </div>

                            <!-- Hidden field for legacy support -->
                            <input type="hidden" id="position_id" name="position_id" value="">
                        </div>

                        <!-- Course Assessment Structure Display -->
                        <div id="course-assessment-structure" class="md:col-span-2 hidden">
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                <h4 class="text-sm font-semibold text-blue-900 mb-3 flex items-center">
                                    <i class="fas fa-clipboard-list mr-2"></i>
                                    <%= t('courseAssessmentStructure') %>
                                </h4>
                                <div id="assessment-structure-content">
                                    <div class="text-center py-3 bg-white rounded border border-gray-200">
                                        <i class="fas fa-hand-pointer text-gray-400 text-xl mb-2"></i>
                                        <p class="text-sm text-gray-600">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="chapter-field">
                            <label for="chapter_id" class="block text-sm font-medium text-gray-700 mb-2">
                                <%= t('selectChapter') %> <span class="text-gray-500 text-xs">(<%= t('selectCourseFirst') %>)</span>
                            </label>
                            <select id="chapter_id" name="chapter_id" onchange="loadLessons()"
                                    class="w-full rounded-md border-gray-300 shadow-sm focus:border-ruxchai-primary focus:ring-ruxchai-primary"
                                    disabled>
                                <option value=""><%= t('selectCourseToLoadChapters') %></option>
                            </select>
                        </div>

                        <div id="lesson-field">
                            <label for="lesson_id" class="block text-sm font-medium text-gray-700 mb-2">
                                <%= t('selectLesson') %> <span class="text-gray-500 text-xs">(<%= t('selectChapterFirst') %>)</span>
                            </label>
                            <select id="lesson_id" name="lesson_id"
                                    class="w-full rounded-md border-gray-300 shadow-sm focus:border-ruxchai-primary focus:ring-ruxchai-primary"
                                    disabled>
                                <option value=""><%= t('selectChapterToLoadLessons') %></option>
                            </select>
                        </div>

                        <div>
                            <label for="difficulty_level" class="block text-sm font-medium text-gray-700 mb-2"><%= t('difficultyLevel') %></label>
                            <select id="difficulty_level" name="difficulty_level"
                                    class="w-full rounded-md border-gray-300 shadow-sm focus:border-ruxchai-primary focus:ring-ruxchai-primary">
                                <option value="Easy"><%= t('easy') %></option>
                                <option value="Medium" selected><%= t('medium') %></option>
                                <option value="Hard"><%= t('hard') %></option>
                            </select>
                        </div>

                        <div>
                            <label for="language" class="block text-sm font-medium text-gray-700 mb-2"><%= t('teachingLanguageLabel') %> <span class="text-red-500">*</span></label>
                            <select id="language" name="language" required
                                    class="w-full rounded-md border-gray-300 shadow-sm focus:border-ruxchai-primary focus:ring-ruxchai-primary">
                                <option value=""><%= t('selectLanguage') %></option>
                                <option value="th"><%= t('thai') %></option>
                                <option value="en"><%= t('english') %></option>
                                <option value="th-en"><%= t('thaiEnglish') %></option>
                            </select>
                        </div>

                        <div class="md:col-span-2">
                            <label for="description" class="block text-sm font-medium text-gray-700 mb-2"><%= t('testDescription') %></label>
                            <textarea id="description" name="description" rows="4"
                                      class="w-full rounded-md border-gray-300 shadow-sm focus:border-ruxchai-primary focus:ring-ruxchai-primary"
                                      placeholder="<%= t('describeTestDetails') %>"></textarea>
                        </div>

                        <div class="md:col-span-2">
                            <label for="instructions" class="block text-sm font-medium text-gray-700 mb-2"><%= t('instructionsForTest') %></label>
                            <textarea id="instructions" name="instructions" rows="3"
                                      class="w-full rounded-md border-gray-300 shadow-sm focus:border-ruxchai-primary focus:ring-ruxchai-primary"
                                      placeholder="<%= t('testConditions') %>"></textarea>
                        </div>
                    </div>

                    <div class="flex justify-end mt-8">
                        <button type="button" onclick="nextStep()"
                                class="px-6 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white ruxchai-gradient hover:opacity-90">
                            <%= t('next') %> <i class="fas fa-arrow-right ml-2"></i>
                        </button>
                    </div>
                </div>

                <!-- Step 2: Test Settings -->
                <div id="step-2" class="step-content hidden">
                    <h3 class="text-lg font-medium text-gray-900 mb-6">
                        <i class="fas fa-cogs mr-2 text-ruxchai-primary"></i><%= t('testSettings') %>
                    </h3>

                    <div class="space-y-8">
                        <!-- Time Settings -->
                        <div class="border-b border-gray-200 pb-6">
                            <h4 class="text-md font-medium text-gray-900 mb-4"><%= t('timeSettings') %></h4>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div>
                                    <label for="time_limit" class="block text-sm font-medium text-gray-700 mb-2"><%= t('testDuration') %></label>
                                    <input type="number" id="time_limit" name="time_limit" min="1" max="300"
                                           class="w-full rounded-md border-gray-300 shadow-sm focus:border-ruxchai-primary focus:ring-ruxchai-primary"
                                           placeholder="60">
                                </div>

                                <div>
                                    <label for="start_date" class="block text-sm font-medium text-gray-700 mb-2"><%= t('startDate') %></label>
                                    <input type="datetime-local" id="start_date" name="start_date"
                                           class="w-full rounded-md border-gray-300 shadow-sm focus:border-ruxchai-primary focus:ring-ruxchai-primary">
                                </div>

                                <div>
                                    <label for="end_date" class="block text-sm font-medium text-gray-700 mb-2"><%= t('endDate') %></label>
                                    <input type="datetime-local" id="end_date" name="end_date"
                                           class="w-full rounded-md border-gray-300 shadow-sm focus:border-ruxchai-primary focus:ring-ruxchai-primary">
                                </div>
                            </div>
                        </div>

                        <!-- Attempt Settings -->
                        <div class="border-b border-gray-200 pb-6">
                            <h4 class="text-md font-medium text-gray-900 mb-4"><%= t('attemptSettings') %></h4>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div>
                                    <label for="max_attempts" class="block text-sm font-medium text-gray-700 mb-2"><%= t('maxAttempts') %></label>
                                    <input type="number" id="max_attempts" name="max_attempts" min="1" max="10" value="1"
                                           class="w-full rounded-md border-gray-300 shadow-sm focus:border-ruxchai-primary focus:ring-ruxchai-primary">
                                </div>

                                <div>
                                    <label for="passing_score" class="block text-sm font-medium text-gray-700 mb-2"><%= t('passingScore') %></label>
                                    <input type="number" id="passing_score" name="passing_score" min="0" max="100" value="70"
                                           class="w-full rounded-md border-gray-300 shadow-sm focus:border-ruxchai-primary focus:ring-ruxchai-primary">
                                </div>

                                <div>
                                    <label for="question_order" class="block text-sm font-medium text-gray-700 mb-2"><%= t('questionOrder') %></label>
                                    <select id="question_order" name="question_order"
                                            class="w-full rounded-md border-gray-300 shadow-sm focus:border-ruxchai-primary focus:ring-ruxchai-primary">
                                        <option value="fixed"><%= t('fixedOrder') %></option>
                                        <option value="random"><%= t('randomOrder') %></option>
                                    </select>
                                </div>
                            </div>

                            <!-- Anti-Cheating Settings -->
                            <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label for="questions_to_show" class="block text-sm font-medium text-gray-700 mb-2">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å‡∏™‡∏≠‡∏ö</label>
                                    <input type="number" id="questions_to_show" name="questions_to_show" min="0" placeholder="‡∏ó‡∏∏‡∏Å‡∏Ç‡πâ‡∏≠"
                                           class="w-full rounded-md border-gray-300 shadow-sm focus:border-ruxchai-primary focus:ring-ruxchai-primary">
                                    <p class="text-xs text-gray-500 mt-1">‡∏ñ‡πâ‡∏≤‡∏°‡∏µ 20 ‡∏Ç‡πâ‡∏≠ ‡πÉ‡∏™‡πà 10 = ‡∏™‡∏∏‡πà‡∏° 10 ‡∏Ç‡πâ‡∏≠‡∏à‡∏≤‡∏Å 20 (‡∏ß‡πà‡∏≤‡∏á = ‡∏≠‡∏≠‡∏Å‡∏ó‡∏∏‡∏Å‡∏Ç‡πâ‡∏≠)</p>
                                </div>
                                <div class="flex items-center">
                                    <label class="inline-flex items-center mt-4">
                                        <input type="checkbox" id="randomize_options" name="randomize_options"
                                               class="rounded border-gray-300 text-ruxchai-primary shadow-sm focus:border-ruxchai-primary focus:ring-ruxchai-primary">
                                        <span class="ml-2 text-sm text-gray-700">‡∏™‡∏∏‡πà‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡πâ‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≠‡∏ö)</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Recurring Test Settings -->
                        <div class="border-b border-gray-200 pb-6">
                            <h4 class="text-md font-medium text-gray-900 mb-4">
                                <i class="fas fa-sync-alt mr-2 text-orange-500"></i>‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏õ‡∏µ (‡∏ó‡∏≥‡∏ã‡πâ‡∏≥‡∏ó‡∏∏‡∏Å‡∏£‡∏≠‡∏ö)
                            </h4>
                            <div class="space-y-4">
                                <label class="flex items-center">
                                    <input type="checkbox" id="is_recurring" name="is_recurring" value="1"
                                           class="mr-2 rounded text-ruxchai-primary focus:ring-ruxchai-primary"
                                           onchange="toggleRecurringTestSettings()">
                                    <span class="text-sm text-gray-700">‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏ã‡πâ‡∏≥‡∏ó‡∏∏‡∏Å‡∏õ‡∏µ/‡∏ó‡∏∏‡∏Å‡∏£‡∏≠‡∏ö</span>
                                </label>
                                <div id="recurring-test-settings" class="ml-6 space-y-4" style="display: none;">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏ã‡πâ‡∏≥</label>
                                        <div class="flex flex-col space-y-3">
                                            <label class="flex items-start">
                                                <input type="radio" name="recurrence_type" value="calendar_year" checked
                                                       class="mr-2 mt-1 text-ruxchai-primary focus:ring-ruxchai-primary"
                                                       onchange="toggleTestRecurrenceType()">
                                                <div>
                                                    <span class="text-sm font-medium text-gray-700">‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏õ‡∏µ (1 ‡∏°.‡∏Ñ. - 31 ‡∏ò.‡∏Ñ.)</span>
                                                    <p class="text-xs text-gray-500">‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏õ‡∏µ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ç‡∏∂‡πâ‡∏ô‡∏õ‡∏µ‡πÉ‡∏´‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡πÉ‡∏´‡∏°‡πà</p>
                                                </div>
                                            </label>
                                            <label class="flex items-start">
                                                <input type="radio" name="recurrence_type" value="custom_months"
                                                       class="mr-2 mt-1 text-ruxchai-primary focus:ring-ruxchai-primary"
                                                       onchange="toggleTestRecurrenceType()">
                                                <div>
                                                    <span class="text-sm font-medium text-gray-700">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤ (‡∏ô‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏™‡∏≠‡∏ö‡∏ú‡πà‡∏≤‡∏ô)</span>
                                                    <p class="text-xs text-gray-500">‡πÄ‡∏ä‡πà‡∏ô ‡∏ó‡∏∏‡∏Å 6 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ó‡∏∏‡∏Å 2 ‡∏õ‡∏µ</p>
                                                </div>
                                            </label>
                                        </div>
                                    </div>
                                    <div id="test-recurrence-months-container">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">‡∏£‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏ã‡πâ‡∏≥</label>
                                        <select id="recurrence_months" name="recurrence_months"
                                                class="w-full md:w-1/2 rounded-md border-gray-300 shadow-sm focus:border-ruxchai-primary focus:ring-ruxchai-primary">
                                            <option value="6">‡∏ó‡∏∏‡∏Å 6 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                                            <option value="12" selected>‡∏ó‡∏∏‡∏Å‡∏õ‡∏µ (12 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</option>
                                            <option value="24">‡∏ó‡∏∏‡∏Å 2 ‡∏õ‡∏µ (24 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</option>
                                            <option value="36">‡∏ó‡∏∏‡∏Å 3 ‡∏õ‡∏µ (36 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤</label>
                                        <select id="notify_days_before" name="notify_days_before"
                                                class="w-full md:w-1/2 rounded-md border-gray-300 shadow-sm focus:border-ruxchai-primary focus:ring-ruxchai-primary">
                                            <option value="7">7 ‡∏ß‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô</option>
                                            <option value="14">14 ‡∏ß‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô</option>
                                            <option value="30" selected>30 ‡∏ß‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô</option>
                                            <option value="60">60 ‡∏ß‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô</option>
                                        </select>
                                    </div>
                                    <div class="p-3 bg-blue-50 rounded-lg">
                                        <p class="text-sm text-blue-800">
                                            <i class="fas fa-info-circle mr-1"></i>
                                            ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏≥‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏ú‡πà‡∏≤‡∏ô ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡∏∞‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ñ‡∏∂‡∏á‡∏£‡∏≠‡∏ö
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Display Settings -->
                        <div class="border-b border-gray-200 pb-6">
                            <h4 class="text-md font-medium text-gray-900 mb-4"><%= t('displaySettings') %></h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="space-y-4">
                                    <label class="inline-flex items-center">
                                        <input type="checkbox" id="show_score_immediately" name="show_score_immediately"
                                               class="rounded border-gray-300 text-ruxchai-primary shadow-sm focus:border-ruxchai-primary focus:ring-ruxchai-primary">
                                        <span class="ml-2 text-sm text-gray-700"><%= t('showScoreImmediately') %></span>
                                    </label>

                                    <label class="inline-flex items-center">
                                        <input type="checkbox" id="show_correct_answers" name="show_correct_answers"
                                               class="rounded border-gray-300 text-ruxchai-primary shadow-sm focus:border-ruxchai-primary focus:ring-ruxchai-primary">
                                        <span class="ml-2 text-sm text-gray-700">‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏•‡∏¢‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</span>
                                    </label>

                                    <label class="inline-flex items-center">
                                        <input type="checkbox" id="show_explanation" name="show_explanation"
                                               class="rounded border-gray-300 text-ruxchai-primary shadow-sm focus:border-ruxchai-primary focus:ring-ruxchai-primary">
                                        <span class="ml-2 text-sm text-gray-700">‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÄ‡∏â‡∏•‡∏¢</span>
                                    </label>

                                    <label class="inline-flex items-center">
                                        <input type="checkbox" id="allow_review" name="allow_review"
                                               class="rounded border-gray-300 text-ruxchai-primary shadow-sm focus:border-ruxchai-primary focus:ring-ruxchai-primary">
                                        <span class="ml-2 text-sm text-gray-700"><%= t('allowReview') %></span>
                                    </label>
                                </div>

                                <div class="space-y-4">
                                    <label class="inline-flex items-center">
                                        <input type="checkbox" id="require_camera" name="require_camera"
                                               class="rounded border-gray-300 text-ruxchai-primary shadow-sm focus:border-ruxchai-primary focus:ring-ruxchai-primary">
                                        <span class="ml-2 text-sm text-gray-700"><%= t('requireCamera') %></span>
                                    </label>

                                    <label class="inline-flex items-center">
                                        <input type="checkbox" id="prevent_copy_paste" name="prevent_copy_paste" checked
                                               class="rounded border-gray-300 text-ruxchai-primary shadow-sm focus:border-ruxchai-primary focus:ring-ruxchai-primary">
                                        <span class="ml-2 text-sm text-gray-700"><%= t('preventCopyPaste') %></span>
                                    </label>

                                    <label class="inline-flex items-center">
                                        <input type="checkbox" id="track_tab_switching" name="track_tab_switching" checked
                                               class="rounded border-gray-300 text-ruxchai-primary shadow-sm focus:border-ruxchai-primary focus:ring-ruxchai-primary">
                                        <span class="ml-2 text-sm text-gray-700"><%= t('trackTabSwitching') %></span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Access Control -->
                        <div>
                            <h4 class="text-md font-medium text-gray-900 mb-4"><%= t('accessControl') %></h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label for="access_code" class="block text-sm font-medium text-gray-700 mb-2"><%= t('accessCode') %></label>
                                    <input type="text" id="access_code" name="access_code"
                                           class="w-full rounded-md border-gray-300 shadow-sm focus:border-ruxchai-primary focus:ring-ruxchai-primary"
                                           placeholder="<%= t('enterAccessCode') %>">
                                </div>

                                <div>
                                    <label for="status" class="block text-sm font-medium text-gray-700 mb-2"><%= t('status') %></label>
                                    <select id="status" name="status"
                                            class="w-full rounded-md border-gray-300 shadow-sm focus:border-ruxchai-primary focus:ring-ruxchai-primary">
                                        <option value="Draft"><%= t('draft') %></option>
                                        <option value="Published"><%= t('published') %></option>
                                        <option value="Archived"><%= t('archived') %></option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-between mt-8">
                        <button type="button" onclick="previousStep()"
                                class="px-6 py-2 border border-gray-300 rounded-md shadow-sm bg-white text-sm font-medium text-gray-700 hover:bg-gray-50">
                            <i class="fas fa-arrow-left mr-2"></i><%= t('previous') %>
                        </button>
                        <button type="button" onclick="nextStep()"
                                class="px-6 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white ruxchai-gradient hover:opacity-90">
                            <%= t('next') %> <i class="fas fa-arrow-right ml-2"></i>
                        </button>
                    </div>
                </div>

                <!-- Step 3: Questions -->
                <div id="step-3" class="step-content hidden">
                    <h3 class="text-lg font-medium text-gray-900 mb-6">
                        <i class="fas fa-question-circle mr-2 text-ruxchai-primary"></i><%= t('manageQuestions') %>
                    </h3>

                    <div class="mb-6">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="text-md font-medium text-gray-900"><%= t('questionList') %></h4>
                            <div class="flex space-x-3">
                                <button type="button" onclick="importQuestions()"
                                        class="inline-flex items-center px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-white text-sm font-medium text-gray-700 hover:bg-gray-50">
                                    <i class="fas fa-upload mr-2"></i><%= t('importFromQuestionBank') %>
                                </button>
                                <button type="button" onclick="addQuestion()"
                                        class="inline-flex items-center px-3 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white ruxchai-gradient hover:opacity-90">
                                    <i class="fas fa-plus mr-2"></i><%= t('addQuestion') %>
                                </button>
                            </div>
                        </div>

                        <div id="questions-container" class="space-y-4">
                            <!-- Questions will be added here -->
                        </div>

                        <div id="no-questions" class="text-center py-8 border-2 border-dashed border-gray-300 rounded-lg">
                            <i class="fas fa-question-circle text-gray-400 text-4xl mb-4"></i>
                            <p class="text-gray-500"><%= t('noQuestions') %></p>
                            <p class="text-sm text-gray-400 mt-2"><%= t('startWithFirstQuestion') %></p>
                        </div>
                    </div>

                    <div class="flex justify-between mt-8">
                        <button type="button" onclick="previousStep()"
                                class="px-6 py-2 border border-gray-300 rounded-md shadow-sm bg-white text-sm font-medium text-gray-700 hover:bg-gray-50">
                            <i class="fas fa-arrow-left mr-2"></i><%= t('previous') %>
                        </button>
                        <div class="flex space-x-3">
                            <button type="button" onclick="saveDraft()"
                                    class="px-6 py-2 border border-gray-300 rounded-md shadow-sm bg-white text-sm font-medium text-gray-700 hover:bg-gray-50">
                                <i class="fas fa-save mr-2"></i><%= t('saveDraft') %>
                            </button>
                            <button type="submit"
                                    class="px-6 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700">
                                <i class="fas fa-check mr-2"></i><%= t('createTest') %>
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Question Modal -->
<div id="question-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-medium text-gray-900">
                    <i class="fas fa-question-circle mr-2 text-ruxchai-primary"></i><%= t('addEditQuestion') %>
                </h3>
                <button onclick="closeQuestionModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <form id="question-form" class="space-y-4">
                <input type="hidden" id="question-index">

                <div>
                    <label for="question-type" class="block text-sm font-medium text-gray-700 mb-2"><%= t('testType') %></label>
                    <select id="question-type" name="question_type" onchange="changeQuestionType()"
                            class="w-full rounded-md border-gray-300 shadow-sm focus:border-ruxchai-primary focus:ring-ruxchai-primary">
                        <option value="multiple_choice"><%= t('multipleChoice') %></option>
                        <option value="true_false"><%= t('trueFalse') %></option>
                        <option value="essay"><%= t('essay') %></option>
                        <option value="fill_blank"><%= t('fillBlank') %></option>
                    </select>
                </div>

                <div>
                    <label for="question-text" class="block text-sm font-medium text-gray-700 mb-2"><%= t('question') %> <span class="text-red-500">*</span></label>
                    <textarea id="question-text" name="question_text" rows="3" required
                              class="w-full rounded-md border-gray-300 shadow-sm focus:border-ruxchai-primary focus:ring-ruxchai-primary"
                              placeholder="<%= t('enterQuestion') %>"></textarea>
                </div>

                <div>
                    <label for="question-image" class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-image mr-1"></i><%= t('questionImage') %>
                    </label>
                    <div class="flex items-center space-x-3">
                        <input type="file" id="question-image" name="question_image" accept="image/*"
                               onchange="previewQuestionImage(this)"
                               class="hidden">
                        <label for="question-image"
                               class="cursor-pointer inline-flex items-center px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-white text-sm font-medium text-gray-700 hover:bg-gray-50">
                            <i class="fas fa-upload mr-2"></i><%= t('selectImage') %>
                        </label>
                        <span id="question-image-name" class="text-sm text-gray-500"><%= t('noImage') %></span>
                    </div>
                    <div id="question-image-preview" class="mt-2 hidden">
                        <img src="" alt="Preview"
                             class="max-w-sm h-auto rounded-lg border border-gray-300 shadow-sm cursor-pointer hover:shadow-md transition-shadow"
                             onclick="window.open(this.src, '_blank')" title="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏†‡∏≤‡∏û‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà">
                        <button type="button" onclick="removeQuestionImage()"
                                class="mt-2 text-sm text-red-600 hover:text-red-800">
                            <i class="fas fa-times mr-1"></i><%= t('removeImage') %>
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-1"><%= t('supportsImageFormat') %></p>
                </div>

                <div>
                    <label for="question-points" class="block text-sm font-medium text-gray-700 mb-2"><%= t('points') %></label>
                    <input type="number" id="question-points" name="points" min="1" max="100" value="1"
                           class="w-full rounded-md border-gray-300 shadow-sm focus:border-ruxchai-primary focus:ring-ruxchai-primary">
                </div>

                <!-- Answer Options (for multiple choice) -->
                <div id="answer-options" class="space-y-3">
                    <label class="block text-sm font-medium text-gray-700"><%= t('options') %></label>
                    <div id="options-container"></div>
                    <button type="button" onclick="addOption()" class="text-sm text-ruxchai-primary hover:text-blue-700">
                        <i class="fas fa-plus mr-1"></i><%= t('addOption') %>
                    </button>
                </div>

                <!-- True/False Options -->
                <div id="true-false-options" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2"><%= t('trueFalseCorrectAnswer') %></label>
                    <div class="space-y-2">
                        <label class="inline-flex items-center">
                            <input type="radio" name="correct_answer" value="true" class="form-radio">
                            <span class="ml-2"><%= t('true') %></span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="correct_answer" value="false" class="form-radio">
                            <span class="ml-2"><%= t('false') %></span>
                        </label>
                    </div>
                </div>

                <!-- Essay Answer -->
                <div id="essay-answer" class="hidden">
                    <label for="essay-sample" class="block text-sm font-medium text-gray-700 mb-2"><%= t('sampleAnswer') %></label>
                    <textarea id="essay-sample" name="sample_answer" rows="4"
                              class="w-full rounded-md border-gray-300 shadow-sm focus:border-ruxchai-primary focus:ring-ruxchai-primary"
                              placeholder="<%= t('sampleAnswerPlaceholder') %>"></textarea>
                </div>

                <!-- Fill Blank Answer -->
                <div id="fill-blank-answer" class="hidden">
                    <label for="blank-answers" class="block text-sm font-medium text-gray-700 mb-2"><%= t('correctAnswersComma') %></label>
                    <input type="text" id="blank-answers" name="blank_answers"
                           class="w-full rounded-md border-gray-300 shadow-sm focus:border-ruxchai-primary focus:ring-ruxchai-primary"
                           placeholder="<%= t('correctAnswerExample') %>">
                </div>

                <div>
                    <label for="question-explanation" class="block text-sm font-medium text-gray-700 mb-2"><%= t('additionalExplanation') %></label>
                    <textarea id="question-explanation" name="explanation" rows="2"
                              class="w-full rounded-md border-gray-300 shadow-sm focus:border-ruxchai-primary focus:ring-ruxchai-primary"
                              placeholder="<%= t('explainCorrectAnswer') %>"></textarea>
                </div>

                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" onclick="closeQuestionModal()"
                            class="px-4 py-2 border border-gray-300 rounded-md shadow-sm bg-white text-sm font-medium text-gray-700 hover:bg-gray-50">
                        <%= t('cancel') %>
                    </button>
                    <button type="submit"
                            class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white ruxchai-gradient hover:opacity-90">
                        <i class="fas fa-save mr-2"></i><%= t('saveQuestion') %>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// i18n translations
const i18n = {
    questionNumber: '<%= t("questionNumber") %>',
    points: '<%= t("points") %>',
    multipleChoice: '<%= t("questionTypeLabel") %>',
    trueFalse: '<%= t("trueFalseType") %>',
    essay: '<%= t("essayType") %>',
    fillBlank: '<%= t("fillBlankType") %>',
    edit: '<%= t("edit") %>',
    delete: '<%= t("delete") %>',
    answer: '<%= t("answer") %>',
    true: '<%= t("true") %>',
    false: '<%= t("false") %>',
    confirmDeleteQuestion: '<%= t("confirmDeleteQuestion") %>',
    noImage: '<%= t("noImage") %>',
    questionSaved: '<%= t("questionSaved") %>',
    min2Options: '<%= t("min2Options") %>',
    selectCorrectAnswer: '<%= t("selectCorrectAnswer") %>',
    enterCorrectAnswer: '<%= t("enterCorrectAnswer") %>',
    optionN: '<%= t("optionN") %>',
    addOptionImage: '<%= t("addOptionImage") %>',
    removeOptionImage: '<%= t("removeOptionImage") %>',
    testCreatedSuccess: '<%= t("testCreatedSuccess") %>',
    errorCreatingTest: '<%= t("errorCreatingTest") %>',
    connectionError: '<%= t("connectionError") %>',
    draftSaved: '<%= t("draftSaved") %>',
    importQuestionsFeature: '<%= t("importQuestionsFeature") %>',
    addAtLeast1Question: '<%= t("addAtLeast1Question") %>',
    fillInAllFields: '<%= t("fillInAllFields") %>',
    imageSizeLimit: '<%= t("imageSizeLimit") %>',
    selectImageOnly: '<%= t("selectImageOnly") %>'
};

let currentStep = 1;
let questions = [];
let editingQuestionIndex = -1;
let autoSaveTimer = null;

// Generate test code automatically (like course code)
function generateTestCode() {
    const year = new Date().getFullYear();
    const random = Math.floor(Math.random() * 9999).toString().padStart(4, '0');
    const code = `TEST-${year}-${random}`;

    const input = document.getElementById('test_code');
    if (input) {
        input.value = code;
    }
    return code;
}

document.addEventListener('DOMContentLoaded', function() {
    // Note: Courses are already loaded server-side via EJS template
    // No need to call loadCourses() which would create duplicate options
    setupFormHandlers();
    initializeFirstQuestion();
    loadDraftFromStorage();
    enableAutoSave();
    setupBeforeUnloadWarning();

    // Generate initial test code
    generateTestCode();
});

function handleCourseChange() {
    loadChapters();
    loadCourseAssessmentStructure();
    updateRequiredFields();
    updatePositionSelectionVisibility();
}

// Show/hide position selection based on course selection
function updatePositionSelectionVisibility() {
    const testType = document.getElementById('test_type').value;
    const courseId = document.getElementById('course_id').value;
    const positionSelection = document.getElementById('position-selection');

    // Types that require course (chapter_test, lesson_test) - don't show position selection
    const courseRequiredTypes = ['chapter_test', 'lesson_test'];

    // Recruitment types - always show position selection (no course)
    const recruitmentTestTypes = ['job_application_test', 'aptitude_test', 'personality_test'];

    if (courseRequiredTypes.includes(testType)) {
        // Course-required tests: no position selection needed
        positionSelection.classList.add('hidden');
    } else if (recruitmentTestTypes.includes(testType)) {
        // Recruitment tests: always show position selection
        positionSelection.classList.remove('hidden');
    } else {
        // Other test types: show position selection only if NO course selected
        if (courseId && courseId !== '') {
            // Course selected - hide position selection (use course's target audience)
            positionSelection.classList.add('hidden');
        } else {
            // No course selected - show position selection
            positionSelection.classList.remove('hidden');
        }
    }
}

// Handle test type change - enforce course/chapter selection for chapter_test/lesson_test
function handleTestTypeChange() {
    const testType = document.getElementById('test_type').value;
    const courseSelect = document.getElementById('course_id');
    const chapterSelect = document.getElementById('chapter_id');
    const lessonSelect = document.getElementById('lesson_id');
    const positionSelection = document.getElementById('position-selection');
    const positionSelect = document.getElementById('position_id');

    // Show hint text based on test type
    const hintElement = document.getElementById('test-type-hint');
    const testTypeHints = {
        'pre_training_assessment': 'üí° ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô',
        'post_training_assessment': 'üí° ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏à‡∏ö ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏î‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡πÅ‡∏•‡∏∞‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á',
        'chapter_test': 'üí° ‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏ó‡πâ‡∏≤‡∏¢‡∏ö‡∏ó ‡∏ï‡πâ‡∏≠‡∏á‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ö‡∏ó‡∏ñ‡∏±‡∏î‡πÑ‡∏õ',
        'final_assessment': 'üí° ‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏õ‡∏•‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£ ‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡∏ú‡πà‡∏≤‡∏ô/‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô',
        'knowledge_check': 'üí° ‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ ‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏ú‡∏π‡∏Å‡∏Å‡∏±‡∏ö‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£',
        'practice_exercise': 'üí° ‡πÅ‡∏ö‡∏ö‡∏ù‡∏∂‡∏Å‡∏´‡∏±‡∏î‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏ã‡πâ‡∏≥‡πÑ‡∏î‡πâ ‡πÑ‡∏°‡πà‡∏ô‡∏±‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô',
        'assessment': 'üí° ‡πÅ‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ',
        'job_application_test': 'üí° ‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏á‡∏≤‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ô‡∏µ‡πâ',
        'aptitude_test': 'üí° ‡∏ß‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏ô‡∏±‡∏î‡πÅ‡∏•‡∏∞‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á',
        'certification_assessment': 'üí° ‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ß‡∏∏‡∏í‡∏¥‡∏ß‡∏¥‡∏ä‡∏≤‡∏ä‡∏µ‡∏û'
    };
    if (hintElement) {
        hintElement.textContent = testTypeHints[testType] || '';
    }

    // Field containers
    const courseField = document.getElementById('course-field');
    const chapterField = document.getElementById('chapter-field');
    const lessonField = document.getElementById('lesson-field');
    const courseAssessmentStructure = document.getElementById('course-assessment-structure');

    const courseLabel = document.querySelector('label[for="course_id"]');
    const chapterLabel = document.querySelector('label[for="chapter_id"]');
    const lessonLabel = document.querySelector('label[for="lesson_id"]');

    // Reset required indicators
    const resetRequired = (label) => {
        if (!label) return;
        const requiredSpan = label.querySelector('.text-red-500');
        if (requiredSpan) requiredSpan.remove();
    };

    const addRequired = (label) => {
        if (!label) return;
        if (!label.querySelector('.text-red-500')) {
            const span = document.createElement('span');
            span.className = 'text-red-500';
            span.textContent = ' *';
            label.appendChild(span);
        }
    };

    // Reset all
    resetRequired(courseLabel);
    resetRequired(chapterLabel);
    resetRequired(lessonLabel);
    courseSelect.removeAttribute('required');
    chapterSelect.removeAttribute('required');
    lessonSelect.removeAttribute('required');

    // Hide position selection by default
    positionSelection.classList.add('hidden');
    positionSelect.removeAttribute('required');

    // Show all course-related fields by default
    courseField.classList.remove('hidden');
    chapterField.classList.remove('hidden');
    lessonField.classList.remove('hidden');
    if (courseAssessmentStructure) courseAssessmentStructure.classList.remove('hidden');

    /*
     * Test Type Categories and Field Requirements:
     *
     * 1. Course-based (‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£):
     *    - chapter_test: ‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£(‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö) + ‡∏ö‡∏ó(‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)
     *    - lesson_test: ‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£(‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö) + ‡∏ö‡∏ó(‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö) + ‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô(‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)
     *    - midcourse_assessment: ‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£(‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)
     *    - final_assessment: ‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£(‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)
     *
     * 2. Position-based (‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á, ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£):
     *    - job_application_test: ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á(‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö) - ‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏á‡∏≤‡∏ô
     *    - aptitude_test: ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á(‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö) - ‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏ô‡∏±‡∏î
     *    - personality_test: ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á(‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö) - ‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏ö‡∏∏‡∏Ñ‡∏•‡∏¥‡∏Å‡∏†‡∏≤‡∏û
     *    - pre_training_assessment: ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á(‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö) - ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡∏ö‡∏£‡∏°
     *    - post_training_assessment: ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á(‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö) - ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏ö‡∏£‡∏°
     *
     * 3. Flexible (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á ‡∏Å‡πá‡πÑ‡∏î‡πâ):
     *    - knowledge_check: ‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£(‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ) ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á(‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ)
     *    - progress_assessment: ‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£(‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ) ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á(‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ)
     *    - assessment: ‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£(‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ) ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á(‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ)
     *    - certification_assessment: ‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£(‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ) ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á(‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ)
     *
     * 4. No position (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á):
     *    - practice_exercise: ‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£(‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ)
     */

    // Types that REQUIRE course (‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£)
    const courseRequiredTypes = ['chapter_test', 'lesson_test', 'midcourse_assessment', 'final_assessment', 'pre_training_assessment', 'post_training_assessment'];

    // Types that REQUIRE position and hide course (‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£)
    const positionRequiredTypes = ['job_application_test', 'aptitude_test', 'personality_test'];

    // Types that can use EITHER course OR position (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡πÅ‡∏•‡∏∞‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á)
    const flexibleTypes = ['knowledge_check', 'progress_assessment', 'assessment', 'certification_assessment'];

    // Types that only use course, no position selection
    const courseOnlyTypes = ['practice_exercise'];

    if (positionRequiredTypes.includes(testType)) {
        // === Position-based tests (Recruitment & Training assessments) ===
        // Show position selection, hide course fields
        positionSelection.classList.remove('hidden');

        // Hide course-related fields completely
        courseField.classList.add('hidden');
        chapterField.classList.add('hidden');
        lessonField.classList.add('hidden');
        if (courseAssessmentStructure) courseAssessmentStructure.classList.add('hidden');

        // Reset course-related values
        courseSelect.value = '';
        chapterSelect.value = '';
        lessonSelect.value = '';

        // Show appropriate info message
        if (['job_application_test', 'aptitude_test', 'personality_test'].includes(testType)) {
            showTestTypeInfo('recruitmentTestInfo');
        } else {
            showTestTypeInfo('trainingTestInfo');
        }

    } else if (courseRequiredTypes.includes(testType)) {
        // === Course-based tests ===
        // Show course fields, hide position selection
        courseField.classList.remove('hidden');

        if (testType === 'chapter_test') {
            // Chapter test requires course and chapter
            chapterField.classList.remove('hidden');
            lessonField.classList.add('hidden');
            addRequired(courseLabel);
            addRequired(chapterLabel);
            courseSelect.setAttribute('required', 'required');
            chapterSelect.setAttribute('required', 'required');
            showTestTypeInfo('chapterTestInfo');

        } else if (testType === 'lesson_test') {
            // Lesson test requires course, chapter, and lesson
            chapterField.classList.remove('hidden');
            lessonField.classList.remove('hidden');
            addRequired(courseLabel);
            addRequired(chapterLabel);
            addRequired(lessonLabel);
            courseSelect.setAttribute('required', 'required');
            chapterSelect.setAttribute('required', 'required');
            lessonSelect.setAttribute('required', 'required');
            showTestTypeInfo('lessonTestInfo');

        } else {
            // midcourse_assessment, final_assessment - require course only
            chapterField.classList.add('hidden');
            lessonField.classList.add('hidden');
            addRequired(courseLabel);
            courseSelect.setAttribute('required', 'required');
            showTestTypeInfo('courseAssessmentInfo');
        }

    } else if (flexibleTypes.includes(testType)) {
        // === Flexible tests (can use course OR position) ===
        // Show both options
        courseField.classList.remove('hidden');
        chapterField.classList.add('hidden');
        lessonField.classList.add('hidden');
        positionSelection.classList.remove('hidden');

        showTestTypeInfo('flexibleTestInfo');

    } else if (courseOnlyTypes.includes(testType)) {
        // === Course-only tests (no position needed) ===
        courseField.classList.remove('hidden');
        chapterField.classList.add('hidden');
        lessonField.classList.add('hidden');

        showTestTypeInfo('practiceTestInfo');

    } else {
        // Default - no type selected
        hideTestTypeInfo();
    }

    updateRequiredFields();
}

function showTestTypeInfo(infoType) {
    // Remove existing info
    hideTestTypeInfo();

    const testTypeDiv = document.getElementById('test_type').parentElement;
    const infoDiv = document.createElement('div');
    infoDiv.id = 'test-type-info';
    infoDiv.className = 'mt-2 p-3 bg-blue-50 border border-blue-200 rounded-md';

    if (infoType === 'chapterTestInfo') {
        infoDiv.innerHTML = `
            <p class="text-sm text-blue-800">
                <i class="fas fa-info-circle mr-2"></i>
                <strong><%= t('chapterTestNote') || 'Chapter Test' %>:</strong>
                <%= t('chapterTestDescription') || 'This test will appear at the end of the selected chapter. Please select a course and chapter.' %>
            </p>
        `;
    } else if (infoType === 'lessonTestInfo') {
        infoDiv.innerHTML = `
            <p class="text-sm text-blue-800">
                <i class="fas fa-info-circle mr-2"></i>
                <strong><%= t('lessonTestNote') || 'Lesson Test' %>:</strong>
                <%= t('lessonTestDescription') || 'This test will appear at the end of the selected lesson. Please select a course, chapter, and lesson.' %>
            </p>
        `;
    } else if (infoType === 'recruitmentTestInfo') {
        infoDiv.innerHTML = `
            <p class="text-sm text-blue-800">
                <i class="fas fa-briefcase mr-2"></i>
                <strong><%= t('recruitmentTestNote') || 'Recruitment Test' %>:</strong>
                <%= t('recruitmentTestDescription') || 'This test will be used for job applicants. Please select the job position this test is for.' %>
            </p>
        `;
    } else if (infoType === 'generalTestInfo') {
        infoDiv.innerHTML = `
            <p class="text-sm text-blue-800">
                <i class="fas fa-clipboard-check mr-2"></i>
                <strong>‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ:</strong>
                ‡∏´‡∏≤‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£ ‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏ô‡∏±‡πâ‡∏ô (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏≠‡∏µ‡∏Å)<br>
                <span class="text-blue-600">‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£ ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏≠‡∏á‡πÑ‡∏î‡πâ</span>
            </p>
        `;
    } else if (infoType === 'trainingTestInfo') {
        infoDiv.innerHTML = `
            <p class="text-sm text-blue-800">
                <i class="fas fa-graduation-cap mr-2"></i>
                <strong>‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ù‡∏∂‡∏Å‡∏≠‡∏ö‡∏£‡∏°:</strong>
                ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô/‡∏´‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏£‡∏ù‡∏∂‡∏Å‡∏≠‡∏ö‡∏£‡∏°<br>
                <span class="text-blue-600"><i class="fas fa-building mr-1"></i>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å/‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô ‡πÅ‡∏•‡∏∞‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏≠‡∏ö‡πÑ‡∏î‡πâ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á</span>
            </p>
        `;
    } else if (infoType === 'courseAssessmentInfo') {
        infoDiv.innerHTML = `
            <p class="text-sm text-blue-800">
                <i class="fas fa-book mr-2"></i>
                <strong>‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£:</strong>
                ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏ï‡∏≤‡∏°‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô/‡∏ö‡∏ó<br>
                <span class="text-blue-600"><i class="fas fa-list mr-1"></i>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£ ‡πÅ‡∏•‡∏∞‡∏ö‡∏ó/‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á</span>
            </p>
        `;
    } else if (infoType === 'flexibleTestInfo') {
        infoDiv.innerHTML = `
            <p class="text-sm text-blue-800">
                <i class="fas fa-random mr-2"></i>
                <strong>‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡πÅ‡∏ö‡∏ö‡∏¢‡∏∑‡∏î‡∏´‡∏¢‡∏∏‡πà‡∏ô:</strong>
                ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÑ‡∏î‡πâ 2 ‡πÅ‡∏ö‡∏ö<br>
                <span class="text-blue-600"><i class="fas fa-book mr-1"></i>‡∏ú‡∏π‡∏Å‡∏Å‡∏±‡∏ö‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£ - ‡πÉ‡∏ä‡πâ‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£</span><br>
                <span class="text-green-600"><i class="fas fa-building mr-1"></i>‡∏ú‡∏π‡∏Å‡∏Å‡∏±‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á - ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å/‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô ‡πÅ‡∏•‡∏∞‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á</span>
            </p>
        `;
    } else if (infoType === 'practiceTestInfo') {
        infoDiv.innerHTML = `
            <p class="text-sm text-blue-800">
                <i class="fas fa-pencil-alt mr-2"></i>
                <strong>‡πÅ‡∏ö‡∏ö‡∏ù‡∏∂‡∏Å‡∏´‡∏±‡∏î:</strong>
                ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ù‡∏∂‡∏Å‡∏ù‡∏ô‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô<br>
                <span class="text-blue-600"><i class="fas fa-book mr-1"></i>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡∏Å‡πÅ‡∏ö‡∏ö‡∏ù‡∏∂‡∏Å‡∏´‡∏±‡∏î</span>
            </p>
        `;
    }

    testTypeDiv.appendChild(infoDiv);
}

function hideTestTypeInfo() {
    const existingInfo = document.getElementById('test-type-info');
    if (existingInfo) existingInfo.remove();
}

function updateRequiredFields() {
    const testType = document.getElementById('test_type').value;
    const chapterLabel = document.querySelector('label[for="chapter_id"]');
    const lessonLabel = document.querySelector('label[for="lesson_id"]');

    // Update label text based on test type
    if (testType === 'chapter_test' || testType === 'lesson_test') {
        chapterLabel.innerHTML = '<%= t("selectChapterRequired") || "Select Chapter" %> <span class="text-red-500">*</span>';
        if (testType === 'lesson_test') {
            lessonLabel.innerHTML = '<%= t("selectLessonRequired") || "Select Lesson" %> <span class="text-red-500">*</span>';
        } else {
            lessonLabel.innerHTML = '<%= t("selectLesson") %> <span class="text-gray-500 text-xs">(<%= t("selectChapterFirst") %>)</span>';
        }
    } else {
        chapterLabel.innerHTML = '<%= t("selectChapter") %> <span class="text-gray-500 text-xs">(<%= t("selectCourseFirst") %>)</span>';
        lessonLabel.innerHTML = '<%= t("selectLesson") %> <span class="text-gray-500 text-xs">(<%= t("selectChapterFirst") %>)</span>';
    }
}

function loadCourseAssessmentStructure() {
    const courseId = document.getElementById('course_id').value;
    const container = document.getElementById('course-assessment-structure');
    const contentDiv = document.getElementById('assessment-structure-content');

    if (!courseId) {
        container.classList.add('hidden');
        return;
    }

    // Show container with loading state
    container.classList.remove('hidden');
    contentDiv.innerHTML = `
        <div class="text-center py-4">
            <i class="fas fa-spinner fa-spin text-blue-500 text-2xl"></i>
            <p class="text-sm text-gray-600 mt-2"><%= t('loading') %></p>
        </div>
    `;

    // Fetch tests for this course
    fetch(`/tests/api/courses/${courseId}/tests`)
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                displayAssessmentStructure(result.data || []);
            } else {
                contentDiv.innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-exclamation-circle text-yellow-500 text-2xl"></i>
                        <p class="text-sm text-gray-600 mt-2">${result.message || '<%= t("failedToLoadTests") %>'}</p>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error loading course tests:', error);
            contentDiv.innerHTML = `
                <div class="text-center py-4">
                    <i class="fas fa-exclamation-triangle text-red-500 text-2xl"></i>
                    <p class="text-sm text-gray-600 mt-2"><%= t("failedToLoadTests") %></p>
                </div>
            `;
        });
}

function displayAssessmentStructure(tests) {
    const contentDiv = document.getElementById('assessment-structure-content');

    // Define all test types with their display info
    const testTypes = [
        { key: 'pre_training_assessment', label: '<%= t("preTrainingAssessment") %>', icon: 'fa-clipboard-check', color: 'blue' },
        { key: 'knowledge_check', label: '<%= t("knowledgeCheck") %>', icon: 'fa-brain', color: 'purple' },
        { key: 'progress_assessment', label: '<%= t("progressAssessment") %>', icon: 'fa-chart-line', color: 'indigo' },
        { key: 'midcourse_assessment', label: '<%= t("midcourseAssessment") %>', icon: 'fa-clipboard-list', color: 'yellow' },
        { key: 'final_assessment', label: '<%= t("finalAssessment") %>', icon: 'fa-trophy', color: 'red', required: true },
        { key: 'post_training_assessment', label: '<%= t("postTrainingAssessment") %>', icon: 'fa-clipboard-check', color: 'green' },
        { key: 'certification_assessment', label: '<%= t("certificationAssessment") %>', icon: 'fa-certificate', color: 'yellow' },
        { key: 'practice_exercise', label: '<%= t("practiceExercise") %>', icon: 'fa-pencil-alt', color: 'gray' }
    ];

    // Group tests by type
    const testsByType = {};
    tests.forEach(test => {
        if (!testsByType[test.type]) {
            testsByType[test.type] = [];
        }
        testsByType[test.type].push(test);
    });

    // Build HTML
    let html = '<div class="space-y-2">';

    // Show existing tests
    let hasTests = false;
    testTypes.forEach(type => {
        const typeTests = testsByType[type.key] || [];
        if (typeTests.length > 0) {
            hasTests = true;
            html += `
                <div class="flex items-center justify-between p-2 bg-white rounded border border-${type.color}-200">
                    <div class="flex items-center space-x-2">
                        <i class="fas ${type.icon} text-${type.color}-600"></i>
                        <span class="text-sm font-medium text-gray-900">${type.label}</span>
                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-${type.color}-100 text-${type.color}-800">
                            ${typeTests.length} test${typeTests.length > 1 ? 's' : ''}
                        </span>
                    </div>
                    <i class="fas fa-check-circle text-green-500"></i>
                </div>
            `;
        }
    });

    if (!hasTests) {
        html += `
            <div class="text-center py-3 bg-white rounded border border-gray-200">
                <i class="fas fa-inbox text-gray-400 text-xl mb-2"></i>
                <p class="text-sm text-gray-600"><%= t('noCourseTestsYet') %></p>
            </div>
        `;
    }

    // Show missing required tests
    const missingRequired = testTypes.filter(type => type.required && !testsByType[type.key]);
    if (missingRequired.length > 0) {
        html += `
            <div class="mt-3 p-3 bg-yellow-50 border border-yellow-200 rounded">
                <h5 class="text-xs font-semibold text-yellow-900 mb-2 flex items-center">
                    <i class="fas fa-exclamation-triangle mr-2"></i>
                    <%= t('missingRequiredTests') %>
                </h5>
        `;
        missingRequired.forEach(type => {
            html += `
                <div class="flex items-center space-x-2 text-sm text-yellow-800 py-1">
                    <i class="fas ${type.icon}"></i>
                    <span>${type.label}</span>
                </div>
            `;
        });
        html += '</div>';
    }

    // Show suggested tests
    const missingOptional = testTypes.filter(type => !type.required && !testsByType[type.key]);
    if (missingOptional.length > 0 && hasTests) {
        html += `
            <div class="mt-2">
                <p class="text-xs font-medium text-gray-700 mb-2">
                    <i class="fas fa-lightbulb mr-1 text-yellow-500"></i>
                    <%= t('suggestedTests') %>:
                </p>
                <div class="flex flex-wrap gap-2">
        `;
        missingOptional.slice(0, 4).forEach(type => {
            html += `
                <span class="inline-flex items-center px-2 py-1 rounded text-xs bg-gray-100 text-gray-700">
                    <i class="fas ${type.icon} mr-1"></i>
                    ${type.label}
                </span>
            `;
        });
        html += '</div></div>';
    }

    html += '</div>';
    contentDiv.innerHTML = html;
}

// Track data source for chapters (chapters table or course_materials)
let chaptersSource = 'chapters';

function loadChapters() {
    const courseId = document.getElementById('course_id').value;
    const chapterSelect = document.getElementById('chapter_id');
    const lessonSelect = document.getElementById('lesson_id');

    // Reset chapters and lessons
    chapterSelect.innerHTML = '<option value=""><%= t("selectCourseToLoadChapters") %></option>';
    lessonSelect.innerHTML = '<option value=""><%= t("selectChapterToLoadLessons") %></option>';
    chapterSelect.disabled = true;
    lessonSelect.disabled = true;
    chaptersSource = 'chapters';

    if (!courseId) {
        return;
    }

    // Load chapters for selected course
    fetch(`/tests/api/courses/${courseId}/chapters`)
        .then(response => response.json())
        .then(result => {
            if (result.success && result.data && result.data.length > 0) {
                // Track the source type
                chaptersSource = result.source || 'chapters';

                chapterSelect.innerHTML = '<option value=""><%= t("noChapterSelected") %></option>';
                chapterSelect.disabled = false;

                result.data.forEach(chapter => {
                    const option = document.createElement('option');
                    option.value = chapter.chapter_id;
                    option.textContent = chapter.title;
                    // Store source type in data attribute
                    option.dataset.source = chaptersSource;
                    chapterSelect.appendChild(option);
                });

                // If source is materials, hide lesson select (materials don't have sub-lessons)
                if (chaptersSource === 'materials') {
                    lessonSelect.parentElement.style.display = 'none';
                } else {
                    lessonSelect.parentElement.style.display = '';
                }
            } else {
                chapterSelect.innerHTML = '<option value=""><%= t("noCourseChapters") %></option>';
            }
        })
        .catch(error => console.error('Error loading chapters:', error));
}

function loadLessons() {
    const chapterId = document.getElementById('chapter_id').value;
    const lessonSelect = document.getElementById('lesson_id');

    // Reset lessons
    lessonSelect.innerHTML = '<option value=""><%= t("selectChapterToLoadLessons") %></option>';
    lessonSelect.disabled = true;

    if (!chapterId) {
        return;
    }

    // If chapters came from materials, don't load lessons
    if (chaptersSource === 'materials') {
        lessonSelect.innerHTML = '<option value=""><%= t("noLessonsForMaterial") || "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏¢‡πà‡∏≠‡∏¢" %></option>';
        return;
    }

    // Load lessons for selected chapter
    fetch(`/tests/api/chapters/${chapterId}/lessons?source=${chaptersSource}`)
        .then(response => response.json())
        .then(result => {
            if (result.success && result.data.length > 0) {
                lessonSelect.innerHTML = '<option value=""><%= t("noLessonSelected") %></option>';
                lessonSelect.disabled = false;
                result.data.forEach(lesson => {
                    const option = document.createElement('option');
                    option.value = lesson.lesson_id;
                    option.textContent = lesson.title;
                    lessonSelect.appendChild(option);
                });
            } else {
                lessonSelect.innerHTML = '<option value=""><%= t("noChapterLessons") %></option>';
            }
        })
        .catch(error => console.error('Error loading lessons:', error));
}

function setupFormHandlers() {
    document.getElementById('create-test-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        await submitTest();
    });

    document.getElementById('question-form').addEventListener('submit', function(e) {
        e.preventDefault();
        saveQuestion();
    });
}

function nextStep() {
    if (validateCurrentStep()) {
        hideStep(currentStep);
        currentStep++;
        showStep(currentStep);
        updateProgressSteps();
    }
}

function previousStep() {
    hideStep(currentStep);
    currentStep--;
    showStep(currentStep);
    updateProgressSteps();
}

function hideStep(step) {
    document.getElementById(`step-${step}`).classList.add('hidden');
}

function showStep(step) {
    document.getElementById(`step-${step}`).classList.remove('hidden');
}

function updateProgressSteps() {
    for (let i = 1; i <= 3; i++) {
        const stepElement = document.querySelector(`nav ol li:nth-child(${i}) .relative`);
        const textElement = document.querySelector(`nav ol li:nth-child(${i}) span`);

        if (i <= currentStep) {
            stepElement.className = stepElement.className.replace('bg-gray-200', 'bg-ruxchai-primary');
            stepElement.querySelector('span').className = 'text-white text-sm font-medium';
            textElement.className = textElement.className.replace('text-gray-500', 'text-gray-900');
        } else {
            stepElement.className = stepElement.className.replace('bg-ruxchai-primary', 'bg-gray-200');
            stepElement.querySelector('span').className = 'text-gray-500 text-sm font-medium';
            textElement.className = textElement.className.replace('text-gray-900', 'text-gray-500');
        }
    }

    // Update connecting lines
    const lines = document.querySelectorAll('nav ol li .absolute.inset-0 div');
    lines.forEach((line, index) => {
        if (index < currentStep - 1) {
            line.className = line.className.replace('bg-gray-200', 'bg-ruxchai-primary');
        } else {
            line.className = line.className.replace('bg-ruxchai-primary', 'bg-gray-200');
        }
    });
}

function validateCurrentStep() {
    const requiredFields = document.querySelectorAll(`#step-${currentStep} [required]`);
    let isValid = true;

    requiredFields.forEach(field => {
        if (!field.value.trim()) {
            field.classList.add('border-red-500');
            isValid = false;
        } else {
            field.classList.remove('border-red-500');
        }
    });

    if (!isValid) {
        showError(i18n.fillInAllFields);
    }

    return isValid;
}

function initializeFirstQuestion() {
    // Show the "no questions" state initially
    updateQuestionsDisplay();
}

// ========================================
// AUTO-SAVE FUNCTIONALITY
// ========================================

function enableAutoSave() {
    // Auto-save every 30 seconds
    autoSaveTimer = setInterval(() => {
        saveToLocalStorage();
    }, 30000);
    console.log('‚úÖ Auto-save enabled (every 30 seconds)');
}

function saveToLocalStorage() {
    if (questions.length === 0 && currentStep === 1) {
        // Don't save empty state
        return;
    }

    // Create a serializable copy of questions (without File objects)
    const serializableQuestions = questions.map(q => {
        const cleanQuestion = { ...q };
        // Remove File objects which can't be serialized to JSON
        cleanQuestion.question_image = null;
        if (cleanQuestion.options) {
            cleanQuestion.options = cleanQuestion.options.map(opt => ({
                ...opt,
                image: null // Remove File object from options
            }));
        }
        return cleanQuestion;
    });

    const testDraft = {
        currentStep: currentStep,
        formData: collectFormData(),
        questions: serializableQuestions,
        timestamp: new Date().toISOString()
    };

    try {
        localStorage.setItem('test_draft', JSON.stringify(testDraft));
        console.log('üíæ Auto-saved at', new Date().toLocaleTimeString());

        // Show brief success indicator
        const indicator = document.createElement('div');
        indicator.className = 'fixed bottom-4 right-4 bg-green-500 text-white px-4 py-2 rounded shadow-lg text-sm z-50';
        indicator.innerHTML = '<i class="fas fa-check mr-2"></i>Draft saved';
        document.body.appendChild(indicator);

        setTimeout(() => {
            indicator.remove();
        }, 2000);
    } catch (error) {
        console.error('Failed to save draft:', error);
    }
}

function loadDraftFromStorage() {
    const draft = localStorage.getItem('test_draft');

    if (draft) {
        try {
            const testDraft = JSON.parse(draft);
            const draftTime = new Date(testDraft.timestamp);
            const timeDiff = Date.now() - draftTime.getTime();
            const hoursDiff = timeDiff / (1000 * 60 * 60);

            // Only show prompt if draft is less than 24 hours old
            if (hoursDiff < 24) {
                const timeAgo = hoursDiff < 1
                    ? Math.round(timeDiff / (1000 * 60)) + ' minutes ago'
                    : Math.round(hoursDiff) + ' hours ago';

                if (confirm(`Found a saved draft from ${timeAgo}.\n\nDo you want to restore it?`)) {
                    restoreDraft(testDraft);
                    showSuccess('Draft restored successfully');
                }
            } else {
                // Clear old draft
                localStorage.removeItem('test_draft');
            }
        } catch (error) {
            console.error('Failed to load draft:', error);
        }
    }
}

function restoreDraft(testDraft) {
    // Restore form data
    const formData = testDraft.formData;
    Object.keys(formData).forEach(key => {
        const element = document.getElementById(key) || document.querySelector(`[name="${key}"]`);
        if (element) {
            if (element.type === 'checkbox') {
                element.checked = formData[key];
            } else {
                element.value = formData[key];
            }
        }
    });

    // After restoring form data, trigger course change if course was selected
    // This loads chapters/lessons dropdowns and shows course assessment structure
    if (formData.course_id) {
        handleCourseChange();

        // If chapter_id was also saved, restore lessons after chapters load
        if (formData.chapter_id) {
            setTimeout(() => {
                const chapterSelect = document.getElementById('chapter_id');
                if (chapterSelect) {
                    chapterSelect.value = formData.chapter_id;
                    loadLessons();

                    // If lesson_id was also saved, restore it after lessons load
                    if (formData.lesson_id) {
                        setTimeout(() => {
                            const lessonSelect = document.getElementById('lesson_id');
                            if (lessonSelect) {
                                lessonSelect.value = formData.lesson_id;
                            }
                        }, 500);
                    }
                }
            }, 500);
        }
    }

    // Restore questions
    questions = testDraft.questions || [];
    updateQuestionsDisplay();

    // Restore step
    if (testDraft.currentStep > 1) {
        hideStep(currentStep);
        currentStep = testDraft.currentStep;
        showStep(currentStep);
        updateProgressSteps();
    }
}

function collectFormData() {
    return {
        test_name: document.getElementById('test_name')?.value || '',
        test_code: document.getElementById('test_code')?.value || '',
        description: document.getElementById('description')?.value || '',
        instructions: document.getElementById('instructions')?.value || '',
        type: document.getElementById('test_type')?.value || '',
        course_id: document.getElementById('course_id')?.value || '',
        position_id: document.getElementById('position_id')?.value || '',
        chapter_id: document.getElementById('chapter_id')?.value || '',
        lesson_id: document.getElementById('lesson_id')?.value || '',
        difficulty_level: document.getElementById('difficulty_level')?.value || '',
        language: document.getElementById('language')?.value || '',
        time_limit: document.getElementById('time_limit')?.value || '',
        start_date: document.getElementById('start_date')?.value || '',
        end_date: document.getElementById('end_date')?.value || '',
        max_attempts: document.getElementById('max_attempts')?.value || '',
        passing_score: document.getElementById('passing_score')?.value || '',
        question_order: document.getElementById('question_order')?.value || '',
        show_score_immediately: document.getElementById('show_score_immediately')?.checked || false,
        show_correct_answers: document.getElementById('show_correct_answers')?.checked || false,
        allow_review: document.getElementById('allow_review')?.checked || false,
        require_camera: document.getElementById('require_camera')?.checked || false,
        prevent_copy_paste: document.getElementById('prevent_copy_paste')?.checked || false,
        track_tab_switching: document.getElementById('track_tab_switching')?.checked || false,
        randomize_options: document.getElementById('randomize_options')?.checked || false,
        questions_to_show: document.getElementById('questions_to_show')?.value || '',
        access_code: document.getElementById('access_code')?.value || '',
        status: document.getElementById('status')?.value || ''
    };
}

function setupBeforeUnloadWarning() {
    window.addEventListener('beforeunload', (e) => {
        if (questions.length > 0 || document.getElementById('test_name')?.value) {
            e.preventDefault();
            e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
            return e.returnValue;
        }
    });
}

function clearDraft() {
    localStorage.removeItem('test_draft');
    console.log('Draft cleared');
}

function addQuestion() {
    editingQuestionIndex = -1;
    resetQuestionForm();
    changeQuestionType(); // Set up initial question type
    document.getElementById('question-modal').classList.remove('hidden');
}

function duplicateQuestion(index) {
    if (index < 0 || index >= questions.length) {
        showError('Invalid question index');
        return;
    }

    try {
        // Deep clone the question (without File objects)
        const original = questions[index];
        const duplicate = {
            question_type: original.question_type,
            question_text: original.question_text + ' (Copy)',
            points: original.points,
            explanation: original.explanation,
            question_image: null, // Images can't be easily cloned
        };

        // Clone type-specific data
        if (original.question_type === 'multiple_choice' && original.options) {
            duplicate.options = original.options.map(opt => ({
                text: opt.text,
                is_correct: opt.is_correct,
                image: null // Images can't be easily cloned
            }));
        } else if (original.question_type === 'true_false') {
            duplicate.correct_answer = original.correct_answer;
        } else if (original.question_type === 'essay') {
            duplicate.sample_answer = original.sample_answer;
        } else if (original.question_type === 'fill_blank') {
            duplicate.correct_answers = [...(original.correct_answers || [])];
        }

        // Insert after the original question
        questions.splice(index + 1, 0, duplicate);
        updateQuestionsDisplay();
        showSuccess('Question duplicated successfully! (Note: Images are not copied)');
    } catch (error) {
        console.error('Error duplicating question:', error);
        showError('Failed to duplicate question');
    }
}

function editQuestion(index) {
    editingQuestionIndex = index;
    const question = questions[index];
    populateQuestionForm(question);
    document.getElementById('question-modal').classList.remove('hidden');
}

function deleteQuestion(index) {
    if (confirm(i18n.confirmDeleteQuestion)) {
        questions.splice(index, 1);
        updateQuestionsDisplay();
    }
}

function resetQuestionForm() {
    document.getElementById('question-form').reset();
    document.getElementById('question-type').value = 'multiple_choice';
    document.getElementById('question-points').value = 1;

    // Clear question image preview
    const questionImagePreview = document.getElementById('question-image-preview');
    const questionImageName = document.getElementById('question-image-name');
    questionImagePreview.classList.add('hidden');
    questionImageName.textContent = i18n.noImage;

    // Clear options container
    const optionsContainer = document.getElementById('options-container');
    optionsContainer.innerHTML = '';

    // Clear image URLs
    currentQuestionImageUrl = null;
    optionImageUrls = {};
}

function populateQuestionForm(question) {
    document.getElementById('question-type').value = question.question_type;
    document.getElementById('question-text').value = question.question_text;
    document.getElementById('question-points').value = question.points;
    document.getElementById('question-explanation').value = question.explanation || '';

    // Restore question image if exists (now stored as URL string)
    if (question.question_image && typeof question.question_image === 'string') {
        currentQuestionImageUrl = question.question_image;
        const preview = document.getElementById('question-image-preview');
        const img = preview.querySelector('img');
        const fileName = document.getElementById('question-image-name');

        img.src = question.question_image;
        preview.classList.remove('hidden');
        fileName.textContent = 'Image loaded';
    }

    // Clear and setup question type
    const optionsContainer = document.getElementById('options-container');
    optionsContainer.innerHTML = '';

    changeQuestionType();

    // Populate answers based on question type
    if (question.question_type === 'multiple_choice') {
        // Clear default options first
        optionsContainer.innerHTML = '';
        // Clear option image URLs
        optionImageUrls = {};

        question.options.forEach((option, index) => {
            let imageUrl = '';
            // option.image is now a URL string
            if (option.image && typeof option.image === 'string') {
                imageUrl = option.image;
                optionImageUrls[index] = option.image; // Store for saving later
            }
            addOption(option.text, option.is_correct, imageUrl);

            // Show preview if option has image URL
            if (option.image && typeof option.image === 'string') {
                const fileName = document.getElementById(`option_image_name_${index}`);
                const preview = document.getElementById(`option_image_preview_${index}`);

                if (fileName) fileName.textContent = 'Image loaded';
                if (preview) preview.classList.remove('hidden');
            }
        });
    } else if (question.question_type === 'true_false') {
        const correctRadio = document.querySelector(`input[name="correct_answer"][value="${question.correct_answer}"]`);
        if (correctRadio) correctRadio.checked = true;
    } else if (question.question_type === 'essay') {
        document.getElementById('essay-sample').value = question.sample_answer || '';
    } else if (question.question_type === 'fill_blank') {
        document.getElementById('blank-answers').value = question.correct_answers ? question.correct_answers.join(', ') : '';
    }
}

function changeQuestionType() {
    const type = document.getElementById('question-type').value;

    // Hide all answer sections
    document.getElementById('answer-options').classList.add('hidden');
    document.getElementById('true-false-options').classList.add('hidden');
    document.getElementById('essay-answer').classList.add('hidden');
    document.getElementById('fill-blank-answer').classList.add('hidden');

    // Clear previous options
    const optionsContainer = document.getElementById('options-container');
    optionsContainer.innerHTML = '';

    // Show relevant section
    if (type === 'multiple_choice') {
        document.getElementById('answer-options').classList.remove('hidden');
        // ‚úÖ Add 4 default options (A, B, C, D) for better UX
        ['A', 'B', 'C', 'D'].forEach((letter, index) => {
            addOption(`Option ${letter}`, index === 0); // First option selected by default
        });
    } else if (type === 'true_false') {
        document.getElementById('true-false-options').classList.remove('hidden');
    } else if (type === 'essay') {
        document.getElementById('essay-answer').classList.remove('hidden');
    } else if (type === 'fill_blank') {
        document.getElementById('fill-blank-answer').classList.remove('hidden');
    }
}

function addOption(text = '', isCorrect = false, imageUrl = '') {
    const container = document.getElementById('options-container');
    const optionIndex = container.children.length;

    const optionDiv = document.createElement('div');
    optionDiv.className = 'border border-gray-200 rounded-md p-3 mb-2';
    optionDiv.innerHTML = `
        <div class="flex items-center space-x-2 mb-2">
            <input type="radio" name="correct_option" value="${optionIndex}" ${isCorrect ? 'checked' : ''}
                   class="form-radio">
            <input type="text" name="option_text_${optionIndex}" value="${text}" required
                   class="flex-1 rounded-md border-gray-300 shadow-sm focus:border-ruxchai-primary focus:ring-ruxchai-primary"
                   placeholder="${i18n.optionN} ${optionIndex + 1}">
            <button type="button" onclick="removeOption(this)" class="text-red-600 hover:text-red-800">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="flex items-center space-x-2">
            <input type="file" id="option_image_${optionIndex}" name="option_image_${optionIndex}" accept="image/*"
                   onchange="previewOptionImage(this, ${optionIndex})"
                   class="hidden">
            <label for="option_image_${optionIndex}"
                   class="cursor-pointer inline-flex items-center px-2 py-1 border border-gray-300 rounded text-xs text-gray-600 hover:bg-gray-50">
                <i class="fas fa-image mr-1"></i>${i18n.addOptionImage}
            </label>
            <span id="option_image_name_${optionIndex}" class="text-xs text-gray-500"></span>
        </div>
        <div id="option_image_preview_${optionIndex}" class="mt-2 hidden">
            <img src="${imageUrl}" alt="Option preview"
                 class="max-w-32 max-h-24 rounded-lg border border-gray-300 shadow-sm cursor-pointer hover:shadow-md transition-shadow"
                 onclick="window.open(this.src, '_blank')" title="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏†‡∏≤‡∏û‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà">
            <button type="button" onclick="removeOptionImage(${optionIndex})"
                    class="mt-1 text-xs text-red-600 hover:text-red-800">
                <i class="fas fa-times mr-1"></i>${i18n.removeOptionImage}
            </button>
        </div>
    `;

    container.appendChild(optionDiv);
}

function removeOption(button) {
    const container = document.getElementById('options-container');
    if (container.children.length > 2) {
        button.parentElement.remove();
        // Re-index options
        Array.from(container.children).forEach((option, index) => {
            const radio = option.querySelector('input[type="radio"]');
            const text = option.querySelector('input[type="text"]');
            const placeholder = option.querySelector('input[type="text"]');

            radio.value = index;
            text.name = `option_text_${index}`;
            placeholder.placeholder = `${i18n.optionN} ${index + 1}`;
        });
    }
}

function saveQuestion() {
    const formData = new FormData(document.getElementById('question-form'));
    const questionType = formData.get('question_type');

    const question = {
        question_type: questionType,
        question_text: formData.get('question_text'),
        points: parseInt(formData.get('points')),
        explanation: formData.get('explanation') || '',
        question_image: currentQuestionImageUrl || null  // Use uploaded URL instead of File
    };

    // Handle answers based on question type
    if (questionType === 'multiple_choice') {
        const options = [];
        const container = document.getElementById('options-container');
        const correctIndex = parseInt(formData.get('correct_option'));

        Array.from(container.children).forEach((option, index) => {
            const text = option.querySelector('input[type="text"]').value;
            if (text.trim()) {
                options.push({
                    text: text,
                    is_correct: index === correctIndex,
                    image: optionImageUrls[index] || null // Use uploaded URL
                });
            }
        });

        if (options.length < 2) {
            showError(i18n.min2Options);
            return;
        }

        if (correctIndex === undefined || correctIndex < 0) {
            showError(i18n.selectCorrectAnswer);
            return;
        }

        question.options = options;
    } else if (questionType === 'true_false') {
        question.correct_answer = formData.get('correct_answer');
        if (!question.correct_answer) {
            showError(i18n.selectCorrectAnswer);
            return;
        }
    } else if (questionType === 'essay') {
        question.sample_answer = formData.get('sample_answer');
    } else if (questionType === 'fill_blank') {
        const answers = formData.get('blank_answers');
        if (!answers || !answers.trim()) {
            showError(i18n.enterCorrectAnswer);
            return;
        }
        question.correct_answers = answers.split(',').map(a => a.trim()).filter(a => a);
    }

    // Add or update question
    if (editingQuestionIndex >= 0) {
        questions[editingQuestionIndex] = question;
    } else {
        questions.push(question);
    }

    updateQuestionsDisplay();
    closeQuestionModal();
    showSuccess(i18n.questionSaved);
}

function updateQuestionsDisplay() {
    const container = document.getElementById('questions-container');
    const noQuestions = document.getElementById('no-questions');

    if (questions.length === 0) {
        container.classList.add('hidden');
        noQuestions.classList.remove('hidden');
        return;
    }

    container.classList.remove('hidden');
    noQuestions.classList.add('hidden');

    // Clear container
    container.innerHTML = '';

    // Create elements for each question
    questions.forEach((question, index) => {
        console.log('Rendering question', index, 'with image:', question.question_image);

        const questionDiv = document.createElement('div');
        questionDiv.className = 'border border-gray-200 rounded-lg p-4';

        questionDiv.innerHTML = `
            <div class="flex items-start justify-between">
                <div class="flex-1">
                    <div class="flex items-center space-x-3 mb-2">
                        <span class="text-sm font-medium text-gray-900">${i18n.questionNumber} ${index + 1}</span>
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getQuestionTypeColor(question.question_type)}">
                            ${getQuestionTypeText(question.question_type)}
                        </span>
                        <span class="text-xs text-gray-500">${question.points} ${i18n.points}</span>
                    </div>
                    <p class="text-sm text-gray-700 mb-2">${question.question_text}</p>
                    <div class="question-image-placeholder"></div>
                    <div class="question-preview-placeholder"></div>
                </div>
                <div class="flex space-x-2 ml-4">
                    <button onclick="duplicateQuestion(${index})" class="text-purple-600 hover:text-purple-800 text-sm" title="Duplicate question">
                        <i class="fas fa-copy"></i>
                    </button>
                    <button onclick="editQuestion(${index})" class="text-blue-600 hover:text-blue-800 text-sm" title="Edit question">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button onclick="deleteQuestion(${index})" class="text-red-600 hover:text-red-800 text-sm" title="Delete question">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `;

        // Append to container first
        container.appendChild(questionDiv);

        // Now find placeholders after element is in DOM
        const imagePlaceholder = questionDiv.querySelector('.question-image-placeholder');
        const previewPlaceholder = questionDiv.querySelector('.question-preview-placeholder');

        // Add question image if exists (URL string or File object)
        if (question.question_image) {
            console.log('Creating image element for question', index, 'image:', question.question_image);
            try {
                const img = document.createElement('img');
                // Handle both URL strings and File objects
                if (typeof question.question_image === 'string') {
                    img.src = question.question_image;
                } else if (question.question_image instanceof File) {
                    img.src = URL.createObjectURL(question.question_image);
                }
                img.alt = `Question ${index + 1}`;
                img.className = 'mb-3 max-w-xs max-h-32 rounded border border-gray-300 object-contain cursor-pointer hover:opacity-80 transition-opacity';
                img.title = 'Click to view larger';
                img.onclick = () => window.open(img.src, '_blank');
                img.onload = () => console.log('Image loaded successfully for question', index);
                img.onerror = (e) => console.error('Image failed to load for question', index, e);
                imagePlaceholder.appendChild(img);
            } catch (e) {
                console.warn('Could not create image URL for question', index, e);
            }
        } else {
            console.log('No valid question image for question', index);
        }

        // Add question preview
        if (question.question_type === 'multiple_choice') {
            const optionsDiv = document.createElement('div');
            optionsDiv.className = 'space-y-2';

            question.options.forEach((option, optIndex) => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'text-sm';

                const textDiv = document.createElement('div');
                textDiv.className = 'flex items-center space-x-2';
                textDiv.innerHTML = `
                    <span class="${option.is_correct ? 'text-green-600 font-medium' : 'text-gray-600'}">
                        ${String.fromCharCode(65 + optIndex)}. ${option.text}
                        ${option.is_correct ? '<i class="fas fa-check ml-1"></i>' : ''}
                    </span>
                `;
                optionDiv.appendChild(textDiv);

                // Add option image if exists (URL string or File object)
                if (option.image) {
                    try {
                        const img = document.createElement('img');
                        // Handle both URL strings and File objects
                        if (typeof option.image === 'string') {
                            img.src = option.image;
                        } else if (option.image instanceof File) {
                            img.src = URL.createObjectURL(option.image);
                        }
                        img.alt = `Option ${optIndex + 1}`;
                        img.className = 'mt-1 ml-4 max-w-24 max-h-16 rounded border border-gray-300 object-contain cursor-pointer hover:opacity-80 transition-opacity';
                        img.title = 'Click to view larger';
                        img.onclick = () => window.open(img.src, '_blank');
                        optionDiv.appendChild(img);
                    } catch (e) {
                        console.warn('Could not create image URL for option', optIndex, e);
                    }
                }

                optionsDiv.appendChild(optionDiv);
            });

            previewPlaceholder.appendChild(optionsDiv);
        } else if (question.question_type === 'true_false') {
            previewPlaceholder.innerHTML = `<p class="text-sm text-green-600 font-medium">${i18n.answer}: ${question.correct_answer === 'true' ? i18n.true : i18n.false}</p>`;
        } else if (question.question_type === 'fill_blank') {
            previewPlaceholder.innerHTML = `<p class="text-sm text-green-600 font-medium">${i18n.answer}: ${question.correct_answers.join(', ')}</p>`;
        }
    });
}

function getQuestionTypeColor(type) {
    const colors = {
        'multiple_choice': 'bg-blue-100 text-blue-800',
        'true_false': 'bg-green-100 text-green-800',
        'essay': 'bg-purple-100 text-purple-800',
        'fill_blank': 'bg-yellow-100 text-yellow-800'
    };
    return colors[type] || 'bg-gray-100 text-gray-800';
}

function getQuestionTypeText(type) {
    const types = {
        'multiple_choice': i18n.multipleChoice,
        'true_false': i18n.trueFalse,
        'essay': i18n.essay,
        'fill_blank': i18n.fillBlank
    };
    return types[type] || type;
}

function closeQuestionModal() {
    document.getElementById('question-modal').classList.add('hidden');
    resetQuestionForm();
}

function importQuestions() {
    // Implementation for importing questions from question bank
    showSuccess(i18n.importQuestionsFeature);
}

async function submitTest() {
    if (questions.length === 0) {
        showError(i18n.addAtLeast1Question);
        return;
    }

    const formData = new FormData(document.getElementById('create-test-form'));

    // Prepare test data without images (for now)
    const testData = {
        test_name: formData.get('test_name'),
        test_code: formData.get('test_code'),
        description: formData.get('description'),
        instructions: formData.get('instructions'),
        type: formData.get('type'),
        course_id: formData.get('course_id') || null,
        position_id: formData.get('position_id') || null, // Legacy - For recruitment tests
        is_global_applicant_test: document.getElementById('is_global_applicant_test')?.checked || false,
        target_positions: getSelectedPositions(), // Multi-select positions
        difficulty_level: formData.get('difficulty_level'),
        language: formData.get('language'),
        time_limit: formData.get('time_limit') ? parseInt(formData.get('time_limit')) : null,
        start_date: formData.get('start_date') || null,
        end_date: formData.get('end_date') || null,
        max_attempts: parseInt(formData.get('max_attempts')),
        passing_score: parseInt(formData.get('passing_score')),
        question_order: formData.get('question_order'),
        show_score_immediately: formData.get('show_score_immediately') ? true : false,
        show_correct_answers: formData.get('show_correct_answers') ? true : false,
        allow_review: formData.get('allow_review') ? true : false,
        require_camera: formData.get('require_camera') ? true : false,
        prevent_copy_paste: formData.get('prevent_copy_paste') ? true : false,
        track_tab_switching: formData.get('track_tab_switching') ? true : false,
        randomize_options: formData.get('randomize_options') ? true : false,
        questions_to_show: formData.get('questions_to_show') ? parseInt(formData.get('questions_to_show')) : null,
        access_code: formData.get('access_code') || null,
        status: formData.get('status'),
        // Recurring test settings
        is_recurring: formData.get('is_recurring') ? true : false,
        recurrence_type: formData.get('recurrence_type') || 'calendar_year',
        recurrence_months: formData.get('recurrence_months') ? parseInt(formData.get('recurrence_months')) : null,
        notify_days_before: formData.get('notify_days_before') ? parseInt(formData.get('notify_days_before')) : 30,
        questions: questions.map(q => ({
            question_type: q.question_type,
            question_text: q.question_text,
            points: q.points,
            explanation: q.explanation,
            question_image: q.question_image || null,  // Include uploaded image URL
            options: q.options ? q.options.map(opt => ({
                text: opt.text,
                is_correct: opt.is_correct,
                image: opt.image || null // Include option image URL
            })) : undefined,
            correct_answer: q.correct_answer,
            sample_answer: q.sample_answer,
            correct_answers: q.correct_answers
        }))
    };

    console.log('Submitting test data:', testData);

    try {
        const response = await fetch('/tests/api/create', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(testData)
        });

        const result = await response.json();

        if (result.success) {
            showSuccess(i18n.testCreatedSuccess);
            setTimeout(() => {
                window.location.href = `/tests/${result.data.test_id}`;
            }, 1500);
        } else {
            showError(result.message || i18n.errorCreatingTest);
        }
    } catch (error) {
        showError(i18n.connectionError);
    }
}

async function saveDraft() {
    // Implementation for saving draft
    showSuccess(i18n.draftSaved);
}

// ============ Position Multi-Select Functions ============

// Store all positions data
let allPositionsData = [];
let allDepartmentsData = [];

function toggleGlobalTest() {
    const isGlobal = document.getElementById('is_global_applicant_test').checked;
    const multiSelect = document.getElementById('position-multi-select');

    if (isGlobal) {
        // Disable position selection when global is checked
        multiSelect.classList.add('opacity-50', 'pointer-events-none');
        // Clear all selections
        clearAllDepartments();
        clearAllPositions();
    } else {
        multiSelect.classList.remove('opacity-50', 'pointer-events-none');
    }
}

function clearAllDepartments() {
    const select = document.getElementById('target_departments');
    if (select) {
        Array.from(select.options).forEach(opt => opt.selected = false);
        // Also filter positions
        filterPositionsByDepartments();
    }
}

// Store selected positions persistently (moved here so it's available before use)
let persistentSelectedPositions = new Set();

function clearAllPositions() {
    const select = document.getElementById('target_positions');
    if (select) {
        Array.from(select.options).forEach(opt => opt.selected = false);
        // Clear persistent selection too
        persistentSelectedPositions.clear();
        // Refresh the list to remove "selected" markers
        filterPositionsByDepartments();
        updatePositionCount();
    }
}

function updatePositionCount() {
    const select = document.getElementById('target_positions');
    if (select) {
        const selectedCount = Array.from(select.selectedOptions).length;
        const countEl = document.getElementById('selected-positions-count');
        if (countEl) {
            countEl.textContent = `‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß ${selectedCount} ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á`;
        }
    }
}

function getSelectedPositions() {
    const select = document.getElementById('target_positions');
    if (select) {
        return Array.from(select.selectedOptions).map(opt => parseInt(opt.value));
    }
    return [];
}

// Load departments and positions
async function loadDepartmentsAndPositions() {
    try {
        // Load departments (org units) - use same endpoint as Course
        const deptResponse = await fetch('/courses/api/target-departments');
        const deptData = await deptResponse.json();

        if (deptData.success && deptData.data) {
            allDepartmentsData = deptData.data;
            populateDepartmentsSelect(deptData.data);
        }

        // Load positions - use same endpoint as Course
        const posResponse = await fetch('/courses/api/target-positions');
        const posData = await posResponse.json();

        if (posData.success && posData.data) {
            allPositionsData = posData.data;
            populatePositionsSelect(posData.data);
        }
    } catch (error) {
        console.error('Error loading departments/positions:', error);
    }
}

function populateDepartmentsSelect(departments) {
    const select = document.getElementById('target_departments');
    if (!select) return;

    select.innerHTML = '';

    if (departments.length === 0) {
        select.innerHTML = '<option value="" disabled>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ú‡∏ô‡∏Å</option>';
        return;
    }

    departments.forEach(dept => {
        const option = document.createElement('option');
        option.value = dept.unit_id;
        option.textContent = dept.unit_name_th || dept.unit_name_en || dept.unit_code;
        option.dataset.levelId = dept.level_id || '';
        select.appendChild(option);
    });
}

function populatePositionsSelect(positions, filterByDepts = []) {
    const select = document.getElementById('target_positions');
    if (!select) return;

    // Update persistent selection with current selections before clearing
    Array.from(select.selectedOptions).forEach(opt => {
        persistentSelectedPositions.add(opt.value);
    });
    // Remove deselected ones from current view
    Array.from(select.options).forEach(opt => {
        if (!opt.selected) {
            persistentSelectedPositions.delete(opt.value);
        }
    });

    select.innerHTML = '';

    // Filter by selected departments if any
    let filteredPositions = positions;
    if (filterByDepts.length > 0) {
        filteredPositions = positions.filter(pos => {
            const posUnitId = pos.unit_id;
            return filterByDepts.includes(String(posUnitId));
        });
    }

    // Also include previously selected positions that might be from other departments
    const selectedFromOtherDepts = positions.filter(pos => {
        const isSelected = persistentSelectedPositions.has(String(pos.position_id));
        const isInCurrentFilter = filteredPositions.some(fp => fp.position_id === pos.position_id);
        return isSelected && !isInCurrentFilter;
    });

    // Combine: selected from other depts first, then filtered
    const combinedPositions = [...selectedFromOtherDepts, ...filteredPositions];

    if (combinedPositions.length === 0) {
        if (filterByDepts.length > 0) {
            select.innerHTML = '<option value="" disabled>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏ô‡πÅ‡∏ú‡∏ô‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</option>';
        } else {
            select.innerHTML = '<option value="" disabled>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</option>';
        }
        return;
    }

    // Add selected from other departments first (with marker)
    selectedFromOtherDepts.forEach(pos => {
        const option = document.createElement('option');
        option.value = pos.position_id;
        option.textContent = `‚òÖ ${pos.position_name} (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß)`;
        option.dataset.unitId = pos.unit_id || '';
        option.dataset.level = pos.level || '';
        option.selected = true;
        option.style.backgroundColor = '#e8f5e9';
        select.appendChild(option);
    });

    // Add filtered positions
    filteredPositions.forEach(pos => {
        const option = document.createElement('option');
        option.value = pos.position_id;
        option.textContent = pos.position_name;
        option.dataset.unitId = pos.unit_id || '';
        option.dataset.level = pos.level || '';
        // Re-select if was selected before
        if (persistentSelectedPositions.has(String(pos.position_id))) {
            option.selected = true;
        }
        select.appendChild(option);
    });

    updatePositionCount();
}

function filterPositionsByDepartments() {
    const deptSelect = document.getElementById('target_departments');
    const selectedDepts = Array.from(deptSelect.selectedOptions).map(opt => opt.value);

    populatePositionsSelect(allPositionsData, selectedDepts);
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    const deptSelect = document.getElementById('target_departments');
    const posSelect = document.getElementById('target_positions');

    if (deptSelect) {
        deptSelect.addEventListener('change', filterPositionsByDepartments);
        document.getElementById('clear-departments-btn')?.addEventListener('click', clearAllDepartments);
    }

    if (posSelect) {
        posSelect.addEventListener('change', updatePositionCount);
        document.getElementById('clear-positions-btn')?.addEventListener('click', clearAllPositions);
    }

    // Load data when position selection is shown
    loadDepartmentsAndPositions();
});

// Image handling functions
// Store uploaded image URL for current question being edited
let currentQuestionImageUrl = null;
let optionImageUrls = {}; // Store option image URLs by index

async function previewQuestionImage(input) {
    const file = input.files[0];
    if (file) {
        // Validate file size (5MB)
        if (file.size > 5 * 1024 * 1024) {
            showError(i18n.imageSizeLimit);
            input.value = '';
            return;
        }

        // Validate file type
        if (!file.type.startsWith('image/')) {
            showError(i18n.selectImageOnly);
            input.value = '';
            return;
        }

        // Show preview immediately
        const reader = new FileReader();
        reader.onload = function(e) {
            const preview = document.getElementById('question-image-preview');
            const img = preview.querySelector('img');
            img.src = e.target.result;
            preview.classList.remove('hidden');
        };
        reader.readAsDataURL(file);

        // Update file name
        document.getElementById('question-image-name').textContent = file.name;

        // Upload the image to server immediately
        try {
            const formData = new FormData();
            formData.append('image', file);

            const response = await fetch('/tests/api/questions/upload-image', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();
            if (result.success) {
                currentQuestionImageUrl = result.data.url;
                console.log('Image uploaded:', currentQuestionImageUrl);
            } else {
                showError(result.message || 'Failed to upload image');
                currentQuestionImageUrl = null;
            }
        } catch (error) {
            console.error('Error uploading image:', error);
            showError('Failed to upload image');
            currentQuestionImageUrl = null;
        }
    }
}

function removeQuestionImage() {
    document.getElementById('question-image').value = '';
    document.getElementById('question-image-name').textContent = i18n.noImage;
    document.getElementById('question-image-preview').classList.add('hidden');
    currentQuestionImageUrl = null;
}

async function previewOptionImage(input, optionIndex) {
    const file = input.files[0];
    if (file) {
        // Validate file size (5MB)
        if (file.size > 5 * 1024 * 1024) {
            showError(i18n.imageSizeLimit);
            input.value = '';
            return;
        }

        // Validate file type
        if (!file.type.startsWith('image/')) {
            showError(i18n.selectImageOnly);
            input.value = '';
            return;
        }

        // Show preview immediately
        const reader = new FileReader();
        reader.onload = function(e) {
            const preview = document.getElementById(`option_image_preview_${optionIndex}`);
            const img = preview.querySelector('img');
            img.src = e.target.result;
            preview.classList.remove('hidden');
        };
        reader.readAsDataURL(file);

        // Update file name with uploading status
        const nameSpan = document.getElementById(`option_image_name_${optionIndex}`);
        nameSpan.textContent = file.name + ' (uploading...)';

        // Upload the image to server
        try {
            const formData = new FormData();
            formData.append('image', file);

            const response = await fetch('/tests/api/questions/upload-image', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();

            if (result.success) {
                optionImageUrls[optionIndex] = result.data.url;
                nameSpan.textContent = file.name;
                console.log('Option image uploaded:', optionIndex, result.data.url);
            } else {
                showError(result.message || 'Failed to upload option image');
                delete optionImageUrls[optionIndex];
                removeOptionImage(optionIndex);
            }
        } catch (error) {
            console.error('Error uploading option image:', error);
            showError(i18n.connectionError);
            delete optionImageUrls[optionIndex];
            removeOptionImage(optionIndex);
        }
    }
}

function removeOptionImage(optionIndex) {
    const input = document.getElementById(`option_image_${optionIndex}`);
    if (input) input.value = '';

    const nameSpan = document.getElementById(`option_image_name_${optionIndex}`);
    if (nameSpan) nameSpan.textContent = '';

    const preview = document.getElementById(`option_image_preview_${optionIndex}`);
    if (preview) preview.classList.add('hidden');

    // Clear the stored URL
    delete optionImageUrls[optionIndex];
}

function showSuccess(message) {
    const toast = document.createElement('div');
    toast.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
    toast.innerHTML = `
        <div class="flex items-center">
            <i class="fas fa-check-circle mr-2"></i>
            <span>${message}</span>
        </div>
    `;
    document.body.appendChild(toast);

    setTimeout(() => {
        toast.remove();
    }, 3000);
}

function showError(message) {
    const toast = document.createElement('div');
    toast.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
    toast.innerHTML = `
        <div class="flex items-center">
            <i class="fas fa-exclamation-circle mr-2"></i>
            <span>${message}</span>
            <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-white hover:text-gray-200">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `;
    document.body.appendChild(toast);

    setTimeout(() => {
        toast.remove();
    }, 5000);
}

// Recurring test settings toggle functions
function toggleRecurringTestSettings() {
    const isRecurring = document.getElementById('is_recurring').checked;
    const settingsDiv = document.getElementById('recurring-test-settings');
    if (settingsDiv) {
        settingsDiv.style.display = isRecurring ? 'block' : 'none';
        if (isRecurring) {
            toggleTestRecurrenceType();
        }
    }
}

function toggleTestRecurrenceType() {
    const recurrenceType = document.querySelector('input[name="recurrence_type"]:checked');
    const monthsContainer = document.getElementById('test-recurrence-months-container');
    if (monthsContainer && recurrenceType) {
        monthsContainer.style.display = recurrenceType.value === 'custom_months' ? 'block' : 'none';
    }
}
</script>