<div class="min-h-screen bg-gray-50">
    <!-- Test Header (Fixed) -->
    <div class="fixed top-0 left-0 right-0 bg-white shadow-sm border-b z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-4">
                    <h1 id="test-title" class="text-xl font-semibold text-gray-900"><%= t('testTitle') %></h1>
                    <span id="question-counter" class="text-sm text-gray-500"><%= t('questionCounter').replace('{current}', '1').replace('{total}', '10') %></span>
                </div>

                <div class="flex items-center space-x-6">
                    <!-- Timer -->
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-clock text-gray-400"></i>
                        <span id="timer" class="font-mono text-lg font-semibold text-ruxchai-primary">
                            60:00
                        </span>
                    </div>

                    <!-- Submit Button -->
                    <button id="submit-test" class="btn-ruxchai-secondary" onclick="showSubmitConfirmation()">
                        <i class="fas fa-paper-plane mr-2"></i><%= t('submitAnswer') %>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="pt-16">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
                <!-- Question Content -->
                <div class="lg:col-span-3">
                    <div class="bg-white rounded-lg shadow-sm p-8 mb-6">
                        <!-- Question -->
                        <div id="question-content">
                            <!-- Question will be loaded here -->
                        </div>

                        <!-- Navigation -->
                        <div class="flex justify-between items-center mt-8 pt-6 border-t border-gray-200">
                            <button id="prev-question" class="btn-ruxchai-outline opacity-50 cursor-not-allowed" onclick="previousQuestion()" disabled>
                                <i class="fas fa-chevron-left mr-2"></i><%= t('previousQuestion') %>
                            </button>

                            <button id="flag-question" class="btn-ruxchai-outline" onclick="toggleFlag()">
                                <i class="fas fa-flag mr-1"></i>
                                <span id="flag-text"><%= t('markQuestion') %></span>
                            </button>

                            <button id="next-question" class="btn-ruxchai-primary" onclick="nextQuestion()">
                                <%= t('nextQuestion') %><i class="fas fa-chevron-right ml-2"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Question Navigator Sidebar -->
                <div class="lg:col-span-1">
                    <div class="bg-white rounded-lg shadow-sm p-6 sticky top-24">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4"><%= t('questionOverview') %></h3>

                        <!-- Progress -->
                        <div class="mb-6">
                            <div class="flex justify-between text-sm text-gray-600 mb-2">
                                <span><%= t('progress') %></span>
                                <span id="progress-text">0/10</span>
                            </div>
                            <div class="progress-bar">
                                <div id="progress-fill" class="progress-fill" style="width: 0%"></div>
                            </div>
                        </div>

                        <!-- Question Grid -->
                        <div id="question-grid" class="grid grid-cols-5 gap-2 mb-6">
                            <!-- Question numbers will be generated here -->
                        </div>

                        <!-- Legend -->
                        <div class="space-y-2 text-sm">
                            <div class="flex items-center space-x-2">
                                <div class="w-4 h-4 bg-ruxchai-primary rounded"></div>
                                <span><%= t('currentQuestion') %></span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <div class="w-4 h-4 bg-green-500 rounded"></div>
                                <span><%= t('answeredQuestion') %></span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <div class="w-4 h-4 bg-yellow-500 rounded"></div>
                                <span><%= t('markedQuestion') %></span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <div class="w-4 h-4 bg-gray-300 rounded"></div>
                                <span><%= t('unansweredQuestion') %></span>
                            </div>
                        </div>

                        <!-- Summary -->
                        <div class="border-t border-gray-200 pt-4 space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span><%= t('answeredCount') %></span>
                                <span id="answered-count" class="font-semibold text-green-600">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span><%= t('markedCount') %></span>
                                <span id="flagged-count" class="font-semibold text-yellow-600">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span><%= t('unansweredCount') %></span>
                                <span id="unanswered-count" class="font-semibold text-gray-600">10</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Submit Confirmation Modal -->
<div id="submit-modal" class="hidden fixed inset-0 z-50 overflow-y-auto">
    <div class="flex items-center justify-center min-h-screen px-4">
        <div class="modal-overlay"></div>
        <div class="modal-content max-w-lg w-full p-6">
            <div class="text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-yellow-100 mb-4">
                    <i class="fas fa-exclamation-triangle text-yellow-600"></i>
                </div>
                <h3 class="text-lg font-medium text-gray-900 mb-2"><%= t('confirmSubmit') %></h3>

                <div id="submit-summary" class="bg-gray-50 rounded-lg p-4 mb-6 text-left">
                    <!-- Submit summary will be shown here -->
                </div>

                <p class="text-sm text-gray-500 mb-6">
                    <%= t('cannotEditAfterSubmit') %>
                </p>

                <div class="flex space-x-3">
                    <button id="confirm-submit" class="flex-1 btn-ruxchai-primary" onclick="submitTest()"><%= t('confirmSubmitButton') %></button>
                    <button id="cancel-submit" class="flex-1 btn-ruxchai-outline" onclick="closeSubmitModal()"><%= t('cancel') %></button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Time Warning Modal -->
<div id="time-warning-modal" class="hidden fixed inset-0 z-50 overflow-y-auto">
    <div class="flex items-center justify-center min-h-screen px-4">
        <div class="modal-overlay"></div>
        <div class="modal-content max-w-md w-full p-6">
            <div class="text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                    <i class="fas fa-clock text-red-600"></i>
                </div>
                <h3 class="text-lg font-medium text-gray-900 mb-2"><%= t('timeWarning') %></h3>
                <p class="text-sm text-gray-500 mb-6">
                    <%= t('timeRemainingWarning').replace('{time}', '<span id="warning-time" class="font-semibold text-red-600">5</span>') %>
                    <%= t('checkAndSubmit') %>
                </p>
                <button id="close-warning" class="btn-ruxchai-primary w-full"><%= t('acknowledge') %></button>
            </div>
        </div>
    </div>
</div>

<!-- Auto-save notification -->
<div id="auto-save-notification" class="hidden fixed bottom-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50">
    <i class="fas fa-check mr-2"></i><%= t('autoSaved') %>
</div>

<script>
// i18n translations for test taking (renamed to avoid conflict with layout)
const testPageI18n = {
    testTitle: '<%= t("testTitle") %>',
    questionCounter: '<%= t("questionCounter") %>',
    submitAnswer: '<%= t("submitAnswer") %>',
    previousQuestion: '<%= t("previousQuestion") %>',
    markQuestion: '<%= t("markQuestion") %>',
    saveAnswer: '<%= t("saveAnswer") %>',
    nextQuestion: '<%= t("nextQuestion") %>',
    lastQuestion: '<%= t("nextQuestion") %>',
    unmarkQuestion: '<%= t("markQuestion") %>',
    questionOverview: '<%= t("questionOverview") %>',
    progress: '<%= t("progress") %>',
    currentQuestion: '<%= t("currentQuestion") %>',
    answeredQuestion: '<%= t("answeredQuestion") %>',
    markedQuestion: '<%= t("markedQuestion") %>',
    unansweredQuestion: '<%= t("unansweredQuestion") %>',
    answeredCount: '<%= t("answeredCount") %>',
    markedCount: '<%= t("markedCount") %>',
    unansweredCount: '<%= t("unansweredCount") %>',
    confirmSubmit: '<%= t("confirmSubmit") %>',
    cannotEditAfterSubmit: '<%= t("cannotEditAfterSubmit") %>',
    confirmSubmitButton: '<%= t("confirmSubmitButton") %>',
    cancel: '<%= t("cancel") %>',
    timeWarning: '<%= t("timeWarning") %>',
    timeRemainingWarning: '<%= t("timeRemainingWarning") %>',
    checkAndSubmit: '<%= t("checkAndSubmit") %>',
    acknowledge: '<%= t("acknowledge") %>',
    autoSaved: '<%= t("autoSaved") %>',
    errorLoadingTestAttempt: '<%= t("errorLoadingTestAttempt") %>',
    cannotLoadTest: '<%= t("cannotLoadTest") %>',
    errorLoadingTest: '<%= t("errorLoadingTest") %>',
    confirmExit: '<%= t("confirmExit") %>',
    question: '<%= t("question") %>',
    points: '<%= t("points") %>',
    easy: '<%= t("easy") %>',
    medium: '<%= t("medium") %>',
    hard: '<%= t("hard") %>',
    true: '<%= t("true") %>',
    false: '<%= t("false") %>',
    answer: '<%= t("answer") %>',
    enterAnswer: '<%= t("correctAnswerExample") %>',
    writeYourAnswer: '<%= t("sampleAnswerPlaceholder") %>',
    tip: '<%= t("additionalExplanation") %>',
    totalQuestions: '<%= t("totalQuestions") %>',
    answeredQuestions: '<%= t("answeredCount") %>',
    unansweredQuestions: '<%= t("unansweredCount") %>',
    timeExpired: '<%= t("timeWarning") %>',
    autoSubmitMessage: '<%= t("timeWarning") %>',
    errorSubmitting: '<%= t("errorLoadingTest") %>',
    tabSwitchWarning: '<%= t("confirmExit") %>'
};

// Server-rendered data
const serverTestData = <%- JSON.stringify(test || {}) %>;
const serverQuestions = <%- JSON.stringify(questions || []) %>;
const serverAttempt = <%- JSON.stringify(attempt || {}) %>;

let testData = null;
let questions = [];
let currentQuestionIndex = 0;
let answers = {};
let flaggedQuestions = new Set();
let timeRemaining = 0;
let timerInterval = null;
let autoSaveInterval = null;
let testAttemptId = '<%= locals.attemptId || "" %>';
let isSubmitted = false;
let testStartTime = Date.now(); // Track actual start time for elapsed time calculation

document.addEventListener('DOMContentLoaded', function() {
    if (testAttemptId && serverTestData && serverTestData.test_id) {
        initializeTestFromServer();
    } else {
        showError(testPageI18n.errorLoadingTestAttempt);
        window.location.href = '/tests';
    }

    setupEventListeners();
    preventCheating();
});

function setupEventListeners() {
    // Modal events
    document.getElementById('confirm-submit').addEventListener('click', submitTest);
    document.getElementById('cancel-submit').addEventListener('click', closeSubmitModal);
    document.getElementById('close-warning').addEventListener('click', closeTimeWarning);

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        if (e.key === 'ArrowLeft' && !document.getElementById('prev-question').disabled) {
            previousQuestion();
        } else if (e.key === 'ArrowRight') {
            nextQuestion();
        } else if (e.key === 'Enter' && e.ctrlKey) {
            saveAnswer();
        } else if (e.key === 'f' && e.ctrlKey) {
            e.preventDefault();
            toggleFlag();
        }
    });

    // Prevent refresh/close without confirmation
    window.addEventListener('beforeunload', function(e) {
        if (!isSubmitted) {
            e.preventDefault();
            e.returnValue = testPageI18n.confirmExit;
        }
    });
}

// Initialize test from server-rendered data (no API call needed)
function initializeTestFromServer() {
    try {
        // Use server-rendered data directly
        testData = {
            test_id: serverTestData.test_id,
            test_title: serverTestData.title,
            time_limit: serverTestData.time_limit || 60,
            time_remaining: serverTestData.time_limit || 60,
            questions: serverQuestions,
            answers: {},
            total_marks: serverTestData.total_marks,
            passing_marks: serverTestData.passing_marks
        };

        questions = serverQuestions;
        answers = {};
        timeRemaining = (serverTestData.time_limit || 60) * 60; // Convert to seconds

        setupTestInterface();
        loadQuestion(0);
        startTimer();
        startAutoSave();

        // Disable aggressive security monitoring for now (causes false positives)
        // Security features can be enabled per-test if proctoring is required
        // if (typeof initializeTestSecurity === 'function') {
        //     initializeTestSecurity();
        // }
    } catch (error) {
        console.error('Error initializing test from server data:', error);
        showError(testPageI18n.errorLoadingTest);
    }
}

// Original async function kept for potential API usage
async function initializeTest() {
    try {
        const response = await fetch(`/tests/api/attempts/${testAttemptId}`);
        const data = await response.json();

        if (data.success) {
            testData = data.data;
            questions = testData.questions;
            answers = testData.answers || {};
            timeRemaining = testData.time_remaining * 60; // Convert to seconds

            setupTestInterface();
            loadQuestion(0);
            startTimer();
            startAutoSave();
        } else {
            showError(testPageI18n.cannotLoadTest);
        }
    } catch (error) {
        console.error('Error initializing test:', error);
        showError(testPageI18n.errorLoadingTest);
    }
}

function setupTestInterface() {
    // Set test title
    document.getElementById('test-title').textContent = testData.test_title;

    // Generate question grid
    generateQuestionGrid();

    // Update counters
    updateCounters();
}

function generateQuestionGrid() {
    const grid = document.getElementById('question-grid');
    grid.innerHTML = '';

    questions.forEach((question, index) => {
        const button = document.createElement('button');
        button.className = 'w-8 h-8 rounded text-sm font-medium transition-colors';
        button.textContent = index + 1;
        button.onclick = () => loadQuestion(index);

        updateQuestionButtonStyle(button, index);
        grid.appendChild(button);
    });
}

function updateQuestionButtonStyle(button, index) {
    // Remove all status classes
    button.className = 'w-8 h-8 rounded text-sm font-medium transition-colors';

    if (index === currentQuestionIndex) {
        button.classList.add('bg-ruxchai-primary', 'text-white');
    } else if (answers[questions[index].question_id]) {
        button.classList.add('bg-green-500', 'text-white');
    } else if (flaggedQuestions.has(questions[index].question_id)) {
        button.classList.add('bg-yellow-500', 'text-white');
    } else {
        button.classList.add('bg-gray-300', 'text-gray-700', 'hover:bg-gray-400');
    }
}

function loadQuestion(index) {
    if (index < 0 || index >= questions.length) return;

    currentQuestionIndex = index;
    const question = questions[index];

    // Update question counter
    document.getElementById('question-counter').textContent = testPageI18n.questionCounter.replace('{current}', index + 1).replace('{total}', questions.length);

    // Update navigation buttons - disable prev button on first question
    const prevBtn = document.getElementById('prev-question');
    if (index === 0) {
        prevBtn.disabled = true;
        prevBtn.classList.add('opacity-50', 'cursor-not-allowed');
    } else {
        prevBtn.disabled = false;
        prevBtn.classList.remove('opacity-50', 'cursor-not-allowed');
    }

    const nextBtn = document.getElementById('next-question');
    const isLastQuestion = index === questions.length - 1;

    if (isLastQuestion) {
        nextBtn.innerHTML = '<i class="fas fa-save mr-2"></i>' + testPageI18n.saveAnswer;
        nextBtn.onclick = function() { saveAnswer(); };
        nextBtn.classList.remove('btn-ruxchai-primary');
        nextBtn.classList.add('btn-ruxchai-accent');
    } else {
        nextBtn.innerHTML = testPageI18n.nextQuestion + '<i class="fas fa-chevron-right ml-2"></i>';
        nextBtn.onclick = function() { nextQuestion(); };
        nextBtn.classList.remove('btn-ruxchai-accent');
        nextBtn.classList.add('btn-ruxchai-primary');
    }

    // Update flag button
    const flagBtn = document.getElementById('flag-question');
    const flagText = document.getElementById('flag-text');
    if (flaggedQuestions.has(question.question_id)) {
        flagBtn.classList.remove('btn-ruxchai-outline');
        flagBtn.classList.add('btn-ruxchai-secondary');
        flagText.textContent = testPageI18n.unmarkQuestion;
    } else {
        flagBtn.classList.remove('btn-ruxchai-secondary');
        flagBtn.classList.add('btn-ruxchai-outline');
        flagText.textContent = testPageI18n.markQuestion;
    }

    // Load question content
    renderQuestion(question);

    // Update question grid
    updateQuestionGrid();

    // Update counters
    updateCounters();
}

function renderQuestion(question) {
    const container = document.getElementById('question-content');

    let questionHtml = `
        <div class="mb-6">
            <div class="flex items-start justify-between mb-4">
                <h2 class="text-lg font-semibold text-gray-900">
                    ${testPageI18n.question} ${currentQuestionIndex + 1}. ${question.question_text}
                </h2>
                <div class="flex items-center space-x-2 text-sm text-gray-500">
                    <span>${testPageI18n.points}: ${question.points || 1}</span>
                    ${question.difficulty ? `<span class="badge-${getDifficultyColor(question.difficulty)}">${getDifficultyText(question.difficulty)}</span>` : ''}
                </div>
            </div>

            ${question.question_image ? `
                <div class="mb-4">
                    <img src="${question.question_image}" alt="Question Image"
                         class="max-w-full md:max-w-2xl h-auto rounded-lg shadow-sm border border-gray-200 cursor-pointer hover:shadow-md transition-shadow"
                         onclick="window.open(this.src, '_blank')" title="คลิกเพื่อดูภาพขนาดใหญ่">
                </div>
            ` : ''}

            ${question.question_description ? `
                <div class="mb-4 text-gray-600">
                    ${question.question_description}
                </div>
            ` : ''}
        </div>
    `;

    // Render based on question type
    switch (question.question_type) {
        case 'multiple_choice':
            questionHtml += renderMultipleChoice(question);
            break;
        case 'true_false':
            questionHtml += renderTrueFalse(question);
            break;
        case 'fill_blank':
            questionHtml += renderFillBlank(question);
            break;
        case 'essay':
            questionHtml += renderEssay(question);
            break;
        default:
            questionHtml += renderMultipleChoice(question);
    }

    container.innerHTML = questionHtml;

    // Restore saved answer
    restoreAnswer(question);
}

function renderMultipleChoice(question) {
    const options = question.options || [];

    return `
        <div class="space-y-3">
            ${options.map((option, index) => `
                <label class="flex items-start space-x-3 p-3 border rounded-lg hover:bg-gray-50 transition-colors cursor-pointer">
                    <input type="radio" name="answer" value="${option.option_id}"
                           class="mt-1 form-radio text-ruxchai-primary">
                    <div class="flex-1">
                        <span class="font-medium text-gray-900">${String.fromCharCode(65 + index)}.</span>
                        <span class="ml-2">${option.option_text}</span>
                        ${option.option_image ? `
                            <img src="${option.option_image}" alt="Option ${index + 1}"
                                 class="mt-3 max-w-full md:max-w-md h-auto rounded-lg shadow-sm border border-gray-200 cursor-pointer hover:shadow-md transition-shadow"
                                 onclick="event.stopPropagation(); window.open(this.src, '_blank')" title="คลิกเพื่อดูภาพขนาดใหญ่">
                        ` : ''}
                    </div>
                </label>
            `).join('')}
        </div>
    `;
}

function renderTrueFalse(question) {
    return `
        <div class="space-y-3">
            <label class="flex items-center space-x-3 p-3 border rounded-lg hover:bg-gray-50 transition-colors cursor-pointer">
                <input type="radio" name="answer" value="true" class="form-radio text-ruxchai-primary">
                <span>${testPageI18n.true}</span>
            </label>
            <label class="flex items-center space-x-3 p-3 border rounded-lg hover:bg-gray-50 transition-colors cursor-pointer">
                <input type="radio" name="answer" value="false" class="form-radio text-ruxchai-primary">
                <span>${testPageI18n.false}</span>
            </label>
        </div>
    `;
}

function renderFillBlank(question) {
    return `
        <div class="space-y-4">
            <div class="space-y-2">
                <label class="block text-sm font-medium text-gray-700">${testPageI18n.answer}:</label>
                <input type="text" name="answer"
                       class="form-input-ruxchai"
                       placeholder="${testPageI18n.enterAnswer}">
            </div>
        </div>
    `;
}

function renderEssay(question) {
    return `
        <div class="space-y-4">
            <div class="space-y-2">
                <label class="block text-sm font-medium text-gray-700">${testPageI18n.answer}:</label>
                <textarea name="answer" rows="8"
                          class="form-input-ruxchai"
                          placeholder="${testPageI18n.writeYourAnswer}"></textarea>
            </div>
            <div class="text-sm text-gray-500">
                ${testPageI18n.tip}
            </div>
        </div>
    `;
}

function restoreAnswer(question) {
    const savedAnswer = answers[question.question_id];
    if (!savedAnswer) return;

    switch (question.question_type) {
        case 'multiple_choice':
        case 'true_false':
            const radio = document.querySelector(`input[name="answer"][value="${savedAnswer}"]`);
            if (radio) radio.checked = true;
            break;
        case 'fill_blank':
        case 'essay':
            const input = document.querySelector('input[name="answer"], textarea[name="answer"]');
            if (input) input.value = savedAnswer;
            break;
    }
}

function saveAnswer() {
    const question = questions[currentQuestionIndex];
    let answer = null;

    switch (question.question_type) {
        case 'multiple_choice':
        case 'true_false':
            const checked = document.querySelector('input[name="answer"]:checked');
            answer = checked ? checked.value : null;
            break;
        case 'fill_blank':
        case 'essay':
            const input = document.querySelector('input[name="answer"], textarea[name="answer"]');
            answer = input ? input.value.trim() : null;
            break;
    }

    if (answer) {
        answers[question.question_id] = answer;
        showAutoSaveNotification();
    } else {
        delete answers[question.question_id];
    }

    updateQuestionGrid();
    updateCounters();
}

function toggleFlag() {
    const question = questions[currentQuestionIndex];

    if (flaggedQuestions.has(question.question_id)) {
        flaggedQuestions.delete(question.question_id);
    } else {
        flaggedQuestions.add(question.question_id);
    }

    loadQuestion(currentQuestionIndex); // Refresh to update flag button
    updateQuestionGrid();
    updateCounters();
}

function previousQuestion() {
    if (currentQuestionIndex > 0) {
        saveAnswer(); // Auto-save before moving
        loadQuestion(currentQuestionIndex - 1);
    }
}

function nextQuestion() {
    if (currentQuestionIndex < questions.length - 1) {
        saveAnswer(); // Auto-save before moving
        loadQuestion(currentQuestionIndex + 1);
    }
}

function updateQuestionGrid() {
    const buttons = document.querySelectorAll('#question-grid button');
    buttons.forEach((button, index) => {
        updateQuestionButtonStyle(button, index);
    });
}

function updateCounters() {
    const answeredCount = Object.keys(answers).length;
    const flaggedCount = flaggedQuestions.size;
    const unansweredCount = questions.length - answeredCount;

    document.getElementById('answered-count').textContent = answeredCount;
    document.getElementById('flagged-count').textContent = flaggedCount;
    document.getElementById('unanswered-count').textContent = unansweredCount;

    // Update progress
    const progressPercentage = (answeredCount / questions.length) * 100;
    document.getElementById('progress-text').textContent = `${answeredCount}/${questions.length}`;
    document.getElementById('progress-fill').style.width = `${progressPercentage}%`;
}

function startTimer() {
    updateTimerDisplay();

    timerInterval = setInterval(() => {
        timeRemaining--;
        updateTimerDisplay();

        // Show warning at 5 minutes
        if (timeRemaining === 300) {
            showTimeWarning();
        }

        // Auto-submit when time is up
        if (timeRemaining <= 0) {
            clearInterval(timerInterval);
            autoSubmitTest();
        }
    }, 1000);
}

function updateTimerDisplay() {
    const minutes = Math.floor(timeRemaining / 60);
    const seconds = timeRemaining % 60;
    const display = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

    const timerElement = document.getElementById('timer');
    timerElement.textContent = display;

    // Change color based on time remaining
    timerElement.className = 'font-mono text-lg font-semibold ';
    if (timeRemaining <= 300) { // Last 5 minutes
        timerElement.classList.add('text-red-600');
    } else if (timeRemaining <= 600) { // Last 10 minutes
        timerElement.classList.add('text-yellow-600');
    } else {
        timerElement.classList.add('text-ruxchai-primary');
    }
}

function startAutoSave() {
    autoSaveInterval = setInterval(async () => {
        await autoSave();
    }, 30000); // Auto-save every 30 seconds
}

async function autoSave() {
    try {
        await fetch(`/tests/api/attempts/${testAttemptId}/save-progress`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                answers: answers,
                flagged_questions: Array.from(flaggedQuestions),
                current_question: currentQuestionIndex
            })
        });
    } catch (error) {
        console.error('Auto-save failed:', error);
    }
}

function showAutoSaveNotification() {
    const notification = document.getElementById('auto-save-notification');
    notification.classList.remove('hidden');
    setTimeout(() => {
        notification.classList.add('hidden');
    }, 2000);
}

function showSubmitConfirmation() {
    const answeredCount = Object.keys(answers).length;
    const unansweredCount = questions.length - answeredCount;

    document.getElementById('submit-summary').innerHTML = `
        <div class="space-y-2">
            <div class="flex justify-between">
                <span>${testPageI18n.totalQuestions}:</span>
                <span class="font-medium">${questions.length}</span>
            </div>
            <div class="flex justify-between">
                <span>${testPageI18n.answeredQuestions}</span>
                <span class="font-medium text-green-600">${answeredCount}</span>
            </div>
            <div class="flex justify-between">
                <span>${testPageI18n.unansweredQuestions}</span>
                <span class="font-medium text-red-600">${unansweredCount}</span>
            </div>
        </div>
    `;

    document.getElementById('submit-modal').classList.remove('hidden');
}

function closeSubmitModal() {
    document.getElementById('submit-modal').classList.add('hidden');
}

function showTimeWarning() {
    document.getElementById('warning-time').textContent = '5';
    document.getElementById('time-warning-modal').classList.remove('hidden');
}

function closeTimeWarning() {
    document.getElementById('time-warning-modal').classList.add('hidden');
}

async function submitTest() {
    try {
        // Save current answer before submitting
        saveAnswer();

        // Calculate elapsed time in seconds
        const elapsedSeconds = Math.floor((Date.now() - testStartTime) / 1000);

        const response = await fetch(`/tests/api/${testData.test_id}/${testAttemptId}/submit`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                answers: answers,
                time_spent_seconds: elapsedSeconds
            })
        });

        const data = await response.json();

        if (data.success) {
            isSubmitted = true;
            clearInterval(timerInterval);
            clearInterval(autoSaveInterval);

            // Redirect to results page
            window.location.href = `/tests/${testData.test_id}/results?attempt_id=${testAttemptId}`;
        } else {
            showError(data.message || testPageI18n.errorSubmitting);
            closeSubmitModal();
        }
    } catch (error) {
        console.error('Error submitting test:', error);
        showError(testPageI18n.errorSubmitting);
        closeSubmitModal();
    }
}

async function autoSubmitTest() {
    try {
        saveAnswer();

        // Calculate elapsed time in seconds
        const elapsedSeconds = Math.floor((Date.now() - testStartTime) / 1000);

        await fetch(`/tests/api/${testData.test_id}/${testAttemptId}/submit`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                answers: answers,
                time_spent_seconds: elapsedSeconds,
                auto_submit: true
            })
        });

        isSubmitted = true;
        clearInterval(autoSaveInterval);

        // Show time up message and redirect
        alert(testPageI18n.autoSubmitMessage);
        window.location.href = `/tests/${testData.test_id}/results?attempt_id=${testAttemptId}`;
    } catch (error) {
        console.error('Error auto-submitting test:', error);
        showError(testPageI18n.errorSubmitting);
    }
}

function preventCheating() {
    // Disable right-click context menu
    document.addEventListener('contextmenu', function(e) {
        e.preventDefault();
    });

    // Disable common developer shortcuts
    document.addEventListener('keydown', function(e) {
        // F12, Ctrl+Shift+I, Ctrl+Shift+J, Ctrl+U
        if (e.key === 'F12' ||
            (e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'J')) ||
            (e.ctrlKey && e.key === 'u')) {
            e.preventDefault();
        }
    });

    // Window blur detection disabled - too many false positives
    // The test-layout.ejs already has more appropriate security monitoring
}

// Utility functions
function getDifficultyText(level) {
    const texts = {
        'easy': testPageI18n.easy,
        'medium': testPageI18n.medium,
        'hard': testPageI18n.hard
    };
    return texts[level] || testPageI18n.medium;
}

function getDifficultyColor(level) {
    const colors = {
        'easy': 'success',
        'medium': 'warning',
        'hard': 'danger'
    };
    return colors[level] || 'warning';
}

function showError(message) {
    const alert = document.createElement('div');
    alert.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 animate-fade-in';
    alert.innerHTML = `<i class="fas fa-exclamation-circle mr-2"></i>${message}`;
    document.body.appendChild(alert);
    setTimeout(() => alert.remove(), 5000);
}
</script>

<style>
/* Hide scrollbar when not needed to prevent cheating indicators */
::-webkit-scrollbar {
    width: 8px;
}

::-webkit-scrollbar-track {
    background: #f1f1f1;
}

::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
    background: #a1a1a1;
}

/* Prevent text selection to reduce cheating */
.question-content {
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
}

/* Form radio button styling */
.form-radio {
    width: 1rem;
    height: 1rem;
    color: #1e40af;
    border: 1px solid #d1d5db;
    border-radius: 50%;
}

.form-radio:checked {
    background-color: #1e40af;
    border-color: #1e40af;
}

.form-radio:focus {
    outline: none;
    box-shadow: 0 0 0 2px rgba(30, 64, 175, 0.2);
}

/* Modal overlay */
.modal-overlay {
    position: fixed;
    inset: 0;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: -1;
}

/* Modal content */
.modal-content {
    position: relative;
    background-color: white;
    border-radius: 0.5rem;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    z-index: 10;
}
</style>