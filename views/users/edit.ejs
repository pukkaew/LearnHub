<div class="container mx-auto px-4 py-8">
    <!-- Header -->
    <div class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-3xl font-bold text-gray-900"><%= t('editUser') %></h1>
            <p class="text-gray-600 mt-2"><%= t('editUserData') %></p>
        </div>
        <div class="flex space-x-3">
            <a href="/users/<%= userData.user_id %>/view" class="bg-gray-600 text-white px-4 py-2.5 rounded-lg hover:bg-gray-700 transition-all shadow-sm hover:shadow-md">
                <i class="fas fa-eye mr-2"></i><%= t('view') %>
            </a>
            <a href="/users" class="bg-gray-500 text-white px-4 py-2.5 rounded-lg hover:bg-gray-600 transition-all shadow-sm hover:shadow-md">
                <i class="fas fa-arrow-left mr-2"></i><%= t('backToUsers') %>
            </a>
        </div>
    </div>

    <!-- Main Content -->
    <div class="bg-white rounded-lg shadow-sm">
        <form id="edit-user-form" enctype="multipart/form-data" class="p-6 space-y-6">
            <input type="hidden" name="user_id" value="<%= userData.user_id %>">

            <!-- Profile Image Section -->
            <div class="flex flex-col items-center mb-6 pb-6 border-b border-gray-200">
                <div class="relative mb-4">
                    <img id="profilePreview" src="<%= userData.profile_image || '/images/default-avatar.png' %>" alt="Profile Preview" class="w-24 h-24 rounded-full object-cover border-4 border-gray-200 shadow-sm">
                    <label for="profileImageInput" class="absolute bottom-0 right-0 bg-ruxchai-primary text-white p-2 rounded-full cursor-pointer hover:bg-ruxchai-primary/90 transition-all shadow-md hover:shadow-lg">
                        <i class="fas fa-camera text-sm"></i>
                    </label>
                    <input type="file" id="profileImageInput" name="profile_image" accept="image/*" class="hidden">
                </div>
                <p class="text-xs text-gray-500"><%= t('uploadProfileImage') %></p>
            </div>

            <!-- Basic Information Section -->
            <div class="border-b border-gray-200 pb-6 mb-6">
                <h4 class="text-base font-semibold text-gray-800 mb-4 flex items-center">
                    <div class="w-8 h-8 bg-ruxchai-primary/10 rounded-lg flex items-center justify-center mr-3">
                        <i class="fas fa-user-circle text-ruxchai-primary"></i>
                    </div>
                    <%= t('personalInfo') %>
                </h4>

                <div class="space-y-4">
                    <!-- Employee ID -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-id-badge text-ruxchai-primary mr-1"></i>
                            <%= t('employeeId') %> <span class="text-red-500">*</span>
                        </label>
                        <input type="text" name="employee_id" id="employeeIdInput" value="<%= userData.employee_id || '' %>" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-ruxchai-primary focus:border-transparent transition-all" placeholder="<%= t('employeeId') %>">
                    </div>

                    <!-- Name Fields -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <%= t('firstName') %> <span class="text-red-500">*</span>
                            </label>
                            <input type="text" name="first_name" value="<%= userData.first_name || '' %>" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-ruxchai-primary focus:border-transparent transition-all" placeholder="<%= t('firstName') %>">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <%= t('lastName') %> <span class="text-red-500">*</span>
                            </label>
                            <input type="text" name="last_name" value="<%= userData.last_name || '' %>" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-ruxchai-primary focus:border-transparent transition-all" placeholder="<%= t('lastName') %>">
                        </div>
                    </div>

                    <!-- Contact Fields -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-envelope text-gray-400 mr-1"></i>
                                <%= t('emailAddress') %> <span class="text-red-500">*</span>
                            </label>
                            <input type="email" name="email" value="<%= userData.email || '' %>" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-ruxchai-primary focus:border-transparent transition-all" placeholder="example@email.com">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-phone text-gray-400 mr-1"></i>
                                <%= t('phoneNumber') %> <span class="text-red-500">*</span>
                            </label>
                            <input type="tel" name="phone" value="<%= userData.phone || '' %>" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-ruxchai-primary focus:border-transparent transition-all" placeholder="0812345678">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Organization Information Section -->
            <div class="border-b border-gray-200 pb-6 mb-6">
                <h4 class="text-base font-semibold text-gray-800 mb-4 flex items-center">
                    <div class="w-8 h-8 bg-blue-50 rounded-lg flex items-center justify-center mr-3">
                        <i class="fas fa-building text-blue-600"></i>
                    </div>
                    <%= t('organizationInfo') %>
                </h4>

                <div class="space-y-4">
                    <!-- Organization Units -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-code-branch text-gray-400 mr-1"></i>
                                <%= t('branches') %>
                            </label>
                            <select name="branch_id" id="branchSelect" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-ruxchai-primary focus:border-transparent transition-all">
                                <option value=""><%= t('selectBranch') %></option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-building text-gray-400 mr-1"></i>
                                <%= t('offices') %>
                            </label>
                            <select name="office_id" id="officeSelect" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-ruxchai-primary focus:border-transparent transition-all">
                                <option value=""><%= t('selectOffice') %></option>
                            </select>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-layer-group text-gray-400 mr-1"></i>
                                <%= t('divisions') %>
                            </label>
                            <select name="division_id" id="divisionSelect" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-ruxchai-primary focus:border-transparent transition-all">
                                <option value=""><%= t('selectDivision') %></option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-sitemap text-gray-400 mr-1"></i>
                                <%= t('departments') %>
                            </label>
                            <select name="department_id" id="departmentSelect" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-ruxchai-primary focus:border-transparent transition-all">
                                <option value=""><%= t('selectDepartment') %></option>
                            </select>
                        </div>
                    </div>

                    <!-- Position -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-briefcase text-gray-400 mr-1"></i>
                            <%= t('positionName') %> <span class="text-red-500">*</span>
                        </label>
                        <select name="position_id" id="positionSelect" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-ruxchai-primary focus:border-transparent transition-all">
                            <option value=""><%= t('selectPosition') %></option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- System Access Section -->
            <div class="border-b border-gray-200 pb-6 mb-6">
                <h4 class="text-base font-semibold text-gray-800 mb-4 flex items-center">
                    <div class="w-8 h-8 bg-purple-50 rounded-lg flex items-center justify-center mr-3">
                        <i class="fas fa-key text-purple-600"></i>
                    </div>
                    <%= t('systemAccess') %>
                </h4>

                <div class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-user-shield text-gray-400 mr-1"></i>
                                <%= t('role') %> <span class="text-red-500">*</span>
                            </label>
                            <select name="role" id="roleSelect" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-ruxchai-primary focus:border-transparent transition-all">
                                <option value=""><%= t('selectRole') %></option>
                                <option value="Student" <%= (userData.role_name === 'Student') ? 'selected' : '' %>>üë§ <%= t('roleEmployee') %></option>
                                <option value="Instructor" <%= (userData.role_name === 'Instructor') ? 'selected' : '' %>>üë®‚Äçüè´ Instructor</option>
                                <option value="HR" <%= (userData.role_name === 'HR') ? 'selected' : '' %>>üíº <%= t('roleHR') %></option>
                                <option value="Admin" <%= (userData.role_name === 'Admin') ? 'selected' : '' %>>‚öôÔ∏è <%= t('roleAdmin') %></option>
                                <option value="SuperAdmin" <%= (userData.role_name === 'SuperAdmin') ? 'selected' : '' %>>üîê Super Admin</option>
                                <option value="Viewer" <%= (userData.role_name === 'Viewer') ? 'selected' : '' %>>üëÅÔ∏è Viewer</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-toggle-on text-gray-400 mr-1"></i>
                                <%= t('status') %>
                            </label>
                            <select name="status" id="statusSelect" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-ruxchai-primary focus:border-transparent transition-all">
                                <option value="active">‚úÖ <%= t('statusActive') %></option>
                                <option value="pending">‚è≥ <%= t('statusPending') %></option>
                                <option value="inactive">‚ùå <%= t('statusInactive') %></option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex justify-end space-x-3 pt-6 border-t border-gray-200">
                <a href="/users" class="px-6 py-2.5 text-gray-700 font-medium bg-white border-2 border-gray-300 rounded-lg hover:bg-gray-50 hover:border-gray-400 transition-all shadow-sm hover:shadow">
                    <i class="fas fa-times mr-2"></i><%= t('cancel') %>
                </a>
                <button type="submit" class="px-6 py-2.5 bg-ruxchai-primary text-white font-medium rounded-lg hover:bg-ruxchai-primary/90 transition-all shadow-sm hover:shadow-md">
                    <i class="fas fa-save mr-2"></i><%= t('saveChanges') %>
                </button>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const userData = <%- JSON.stringify(userData) %>;

    // Profile image preview
    document.getElementById('profileImageInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('profilePreview').src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
    });

    // Debug role value
    console.log('userData.role_name:', userData.role_name);
    console.log('Current role select value:', document.getElementById('roleSelect').value);

    // Role value is already set by EJS template's selected attribute
    // No need to set it again with JavaScript
    console.log('Role already set by template:', document.getElementById('roleSelect').value);

    // Set status value
    if (userData.is_active) {
        document.getElementById('statusSelect').value = 'active';
    } else {
        document.getElementById('statusSelect').value = 'inactive';
    }

    // Load branches
    async function loadBranches() {
        try {
            const response = await fetch('/organization/api/branches');
            const data = await response.json();
            const select = document.getElementById('branchSelect');
            select.innerHTML = '<option value=""><%= t("selectBranch") %></option>';
            data.forEach(branch => {
                const option = document.createElement('option');
                option.value = branch.branch_id;
                option.textContent = branch.branch_name;
                option.selected = userData.branch_id == branch.branch_id;
                select.appendChild(option);
            });
        } catch (error) {
            console.error('Error loading branches:', error);
        }
    }

    // Load offices
    async function loadOffices() {
        try {
            const response = await fetch('/organization/api/offices');
            const data = await response.json();
            const select = document.getElementById('officeSelect');
            select.innerHTML = '<option value=""><%= t("selectOffice") %></option>';
            data.forEach(office => {
                const option = document.createElement('option');
                option.value = office.office_id;
                option.textContent = office.office_name;
                option.selected = userData.office_id == office.office_id;
                select.appendChild(option);
            });
        } catch (error) {
            console.error('Error loading offices:', error);
        }
    }

    // Load divisions
    async function loadDivisions() {
        try {
            const response = await fetch('/organization/api/divisions');
            const data = await response.json();
            const select = document.getElementById('divisionSelect');
            select.innerHTML = '<option value=""><%= t("selectDivision") %></option>';
            data.forEach(division => {
                const option = document.createElement('option');
                option.value = division.division_id;
                option.textContent = division.division_name;
                option.selected = userData.division_id == division.division_id;
                select.appendChild(option);
            });
        } catch (error) {
            console.error('Error loading divisions:', error);
        }
    }

    // Load departments
    async function loadDepartments() {
        try {
            const response = await fetch('/organization/api/departments');
            const data = await response.json();
            const select = document.getElementById('departmentSelect');
            select.innerHTML = '<option value=""><%= t("selectDepartment") %></option>';
            data.forEach(department => {
                const option = document.createElement('option');
                option.value = department.department_id;
                option.textContent = department.department_name;
                option.selected = userData.department_id == department.department_id;
                select.appendChild(option);
            });
        } catch (error) {
            console.error('Error loading departments:', error);
        }
    }

    async function loadPositions() {
        try {
            const response = await fetch('/organization/api/positions');
            const data = await response.json();
            const select = document.getElementById('positionSelect');
            select.innerHTML = '<option value=""><%= t("selectPosition") %></option>';
            data.forEach(position => {
                const option = document.createElement('option');
                option.value = position.position_id;
                option.textContent = position.position_name;
                option.selected = userData.position_id == position.position_id;
                select.appendChild(option);
            });
        } catch (error) {
            console.error('Error loading positions:', error);
        }
    }

    // Initialize dropdowns
    loadBranches();
    loadOffices();
    loadDivisions();
    loadDepartments();
    loadPositions();

    // Form submission
    document.getElementById('edit-user-form').addEventListener('submit', async function(e) {
        e.preventDefault();

        const formData = new FormData(this);

        try {
            const response = await fetch(`/users/api/${userData.user_id}`, {
                method: 'PUT',
                body: formData
            });

            const data = await response.json();

            if (data.success) {
                alert('<%= t("userEditedSuccess") %>');
                window.location.href = '/users';
            } else {
                alert(data.message || '<%= t("error") %>');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('<%= t("error") %>');
        }
    });
});
</script>
