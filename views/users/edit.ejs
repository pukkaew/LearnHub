<%- include('../partials/header') %>

<div class="container mx-auto px-4 py-8">
    <!-- Header -->
    <div class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-3xl font-bold text-gray-900">Edit User</h1>
            <p class="text-gray-600 mt-2">Modify user information and settings</p>
        </div>
        <div class="flex space-x-3">
            <button onclick="resetPassword()" class="bg-yellow-600 text-white px-4 py-2 rounded-lg hover:bg-yellow-700">
                <i class="fas fa-key mr-2"></i>Reset Password
            </button>
            <button onclick="previewUser()" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700">
                <i class="fas fa-eye mr-2"></i>Preview
            </button>
            <a href="/admin/users" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600">
                <i class="fas fa-arrow-left mr-2"></i>Back to Users
            </a>
        </div>
    </div>

    <!-- User Status Banner -->
    <div id="user-status-banner" class="mb-6 p-4 rounded-lg border">
        <!-- Will be populated based on user status -->
    </div>

    <!-- Main Content -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Left Column: User Info & Activity -->
        <div class="lg:col-span-1 space-y-6">
            <!-- User Card -->
            <div class="bg-white rounded-lg shadow-sm p-6">
                <div class="text-center">
                    <div class="relative inline-block">
                        <img id="current-avatar" src="/images/default-avatar.png"
                             alt="User Avatar" class="h-24 w-24 rounded-full object-cover mx-auto border-4 border-gray-200">
                        <div class="absolute bottom-0 right-0">
                            <span id="status-indicator" class="block h-6 w-6 rounded-full border-2 border-white"></span>
                        </div>
                    </div>
                    <h3 id="user-display-name" class="mt-4 text-lg font-semibold text-gray-900"></h3>
                    <p id="user-role-badge" class="text-sm text-gray-600"></p>
                    <div id="user-badges" class="mt-2 flex justify-center flex-wrap gap-2">
                        <!-- Dynamic badges will be added here -->
                    </div>
                </div>

                <div class="mt-6 space-y-4">
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600">Last Login:</span>
                        <span id="last-login" class="text-sm font-medium"></span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600">Member Since:</span>
                        <span id="created-date" class="text-sm font-medium"></span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600">Total Logins:</span>
                        <span id="login-count" class="text-sm font-medium"></span>
                    </div>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="bg-white rounded-lg shadow-sm p-6">
                <h4 class="text-lg font-semibold text-gray-900 mb-4">Recent Activity</h4>
                <div id="recent-activity" class="space-y-3">
                    <!-- Activity items will be populated here -->
                </div>
                <a href="#" class="text-sm text-blue-600 hover:text-blue-800 mt-4 inline-block">View all activity</a>
            </div>

            <!-- User Statistics -->
            <div class="bg-white rounded-lg shadow-sm p-6">
                <h4 class="text-lg font-semibold text-gray-900 mb-4">Statistics</h4>
                <div class="grid grid-cols-2 gap-4">
                    <div class="text-center">
                        <div id="courses-completed" class="text-2xl font-bold text-green-600">0</div>
                        <div class="text-sm text-gray-600">Courses Completed</div>
                    </div>
                    <div class="text-center">
                        <div id="tests-taken" class="text-2xl font-bold text-blue-600">0</div>
                        <div class="text-sm text-gray-600">Tests Taken</div>
                    </div>
                    <div class="text-center">
                        <div id="avg-score" class="text-2xl font-bold text-purple-600">0%</div>
                        <div class="text-sm text-gray-600">Average Score</div>
                    </div>
                    <div class="text-center">
                        <div id="certificates-earned" class="text-2xl font-bold text-yellow-600">0</div>
                        <div class="text-sm text-gray-600">Certificates</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column: Edit Form -->
        <div class="lg:col-span-2">
            <div class="bg-white rounded-lg shadow-sm">
                <!-- Tab Navigation -->
                <div class="border-b border-gray-200">
                    <nav class="-mb-px flex space-x-8 px-6" aria-label="Tabs">
                        <button onclick="showTab('basic')" class="tab-button active py-4 px-1 border-b-2 border-blue-500 text-blue-600 text-sm font-medium">
                            Basic Information
                        </button>
                        <button onclick="showTab('role')" class="tab-button py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 text-sm font-medium">
                            Role & Permissions
                        </button>
                        <button onclick="showTab('profile')" class="tab-button py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 text-sm font-medium">
                            Profile Details
                        </button>
                        <button onclick="showTab('settings')" class="tab-button py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 text-sm font-medium">
                            Account Settings
                        </button>
                    </nav>
                </div>

                <form id="edit-user-form" enctype="multipart/form-data">
                    <input type="hidden" id="user_id" name="user_id" value="<%= user?.user_id || '' %>">

                    <!-- Basic Information Tab -->
                    <div id="tab-basic" class="tab-content active p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Basic Information</h3>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Username -->
                            <div>
                                <label for="username" class="block text-sm font-medium text-gray-700 mb-2">
                                    Username <span class="text-red-500">*</span>
                                </label>
                                <input type="text" id="username" name="username" required
                                       class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                       placeholder="Enter unique username">
                                <div id="username-availability" class="mt-1 text-sm"></div>
                            </div>

                            <!-- Email -->
                            <div>
                                <label for="email" class="block text-sm font-medium text-gray-700 mb-2">
                                    Email Address <span class="text-red-500">*</span>
                                </label>
                                <input type="email" id="email" name="email" required
                                       class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                       placeholder="user@example.com">
                                <div id="email-availability" class="mt-1 text-sm"></div>
                            </div>

                            <!-- First Name -->
                            <div>
                                <label for="first_name" class="block text-sm font-medium text-gray-700 mb-2">
                                    First Name <span class="text-red-500">*</span>
                                </label>
                                <input type="text" id="first_name" name="first_name" required
                                       class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                       placeholder="Enter first name">
                            </div>

                            <!-- Last Name -->
                            <div>
                                <label for="last_name" class="block text-sm font-medium text-gray-700 mb-2">
                                    Last Name <span class="text-red-500">*</span>
                                </label>
                                <input type="text" id="last_name" name="last_name" required
                                       class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                       placeholder="Enter last name">
                            </div>

                            <!-- Phone -->
                            <div>
                                <label for="phone" class="block text-sm font-medium text-gray-700 mb-2">Phone Number</label>
                                <input type="tel" id="phone" name="phone"
                                       class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                       placeholder="+66 XX-XXX-XXXX">
                            </div>

                            <!-- Date of Birth -->
                            <div>
                                <label for="date_of_birth" class="block text-sm font-medium text-gray-700 mb-2">Date of Birth</label>
                                <input type="date" id="date_of_birth" name="date_of_birth"
                                       class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                        </div>

                        <!-- Bio -->
                        <div class="mt-6">
                            <label for="bio" class="block text-sm font-medium text-gray-700 mb-2">Bio/Description</label>
                            <textarea id="bio" name="bio" rows="4"
                                      class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                      placeholder="Brief description about the user"></textarea>
                            <div class="mt-1 text-sm text-gray-500">
                                <span id="bio-count">0</span>/500 characters
                            </div>
                        </div>
                    </div>

                    <!-- Role & Permissions Tab -->
                    <div id="tab-role" class="tab-content p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Role & Permissions</h3>

                        <!-- Current Role Display -->
                        <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h4 class="font-medium text-gray-900">Current Role</h4>
                                    <p id="current-role-desc" class="text-sm text-gray-600"></p>
                                </div>
                                <span id="current-role-badge" class="px-3 py-1 rounded-full text-sm font-medium"></span>
                            </div>
                        </div>

                        <!-- Role Selection -->
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Change Role <span class="text-red-500">*</span>
                            </label>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div class="role-card" data-role="student">
                                    <input type="radio" name="role" value="student" id="role-student" class="hidden">
                                    <label for="role-student" class="block cursor-pointer">
                                        <div class="border-2 border-gray-200 rounded-lg p-4 hover:border-blue-500 transition-colors">
                                            <div class="flex items-center mb-2">
                                                <i class="fas fa-user-graduate text-2xl text-blue-600 mr-3"></i>
                                                <h4 class="font-semibold">Student</h4>
                                            </div>
                                            <p class="text-sm text-gray-600">Can enroll in courses and take tests</p>
                                        </div>
                                    </label>
                                </div>

                                <div class="role-card" data-role="instructor">
                                    <input type="radio" name="role" value="instructor" id="role-instructor" class="hidden">
                                    <label for="role-instructor" class="block cursor-pointer">
                                        <div class="border-2 border-gray-200 rounded-lg p-4 hover:border-blue-500 transition-colors">
                                            <div class="flex items-center mb-2">
                                                <i class="fas fa-chalkboard-teacher text-2xl text-green-600 mr-3"></i>
                                                <h4 class="font-semibold">Instructor</h4>
                                            </div>
                                            <p class="text-sm text-gray-600">Can create and manage courses</p>
                                        </div>
                                    </label>
                                </div>

                                <div class="role-card" data-role="admin">
                                    <input type="radio" name="role" value="admin" id="role-admin" class="hidden">
                                    <label for="role-admin" class="block cursor-pointer">
                                        <div class="border-2 border-gray-200 rounded-lg p-4 hover:border-blue-500 transition-colors">
                                            <div class="flex items-center mb-2">
                                                <i class="fas fa-user-shield text-2xl text-red-600 mr-3"></i>
                                                <h4 class="font-semibold">Administrator</h4>
                                            </div>
                                            <p class="text-sm text-gray-600">Full system access and management</p>
                                        </div>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Department -->
                        <div class="mb-6">
                            <label for="department" class="block text-sm font-medium text-gray-700 mb-2">Department</label>
                            <select id="department" name="department"
                                    class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500">
                                <option value="">Select Department</option>
                                <option value="IT">Information Technology</option>
                                <option value="HR">Human Resources</option>
                                <option value="Finance">Finance</option>
                                <option value="Marketing">Marketing</option>
                                <option value="Operations">Operations</option>
                                <option value="Sales">Sales</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>

                        <!-- Manager -->
                        <div class="mb-6">
                            <label for="manager_id" class="block text-sm font-medium text-gray-700 mb-2">Manager</label>
                            <select id="manager_id" name="manager_id"
                                    class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500">
                                <option value="">Select Manager</option>
                                <!-- Will be populated dynamically -->
                            </select>
                        </div>

                        <!-- Role Change Warning -->
                        <div id="role-change-warning" class="hidden p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                            <div class="flex">
                                <i class="fas fa-exclamation-triangle text-yellow-600 mt-1"></i>
                                <div class="ml-3">
                                    <h4 class="text-sm font-medium text-yellow-800">Role Change Warning</h4>
                                    <p class="text-sm text-yellow-700 mt-1">
                                        Changing the user's role will affect their permissions and access to system features.
                                        This action cannot be undone automatically.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Profile Details Tab -->
                    <div id="tab-profile" class="tab-content p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Profile Details</h3>

                        <!-- Profile Picture -->
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Profile Picture</label>
                            <div class="flex items-center space-x-6">
                                <div class="shrink-0">
                                    <img id="profile-preview" class="h-20 w-20 object-cover rounded-full border-2 border-gray-300"
                                         src="/images/default-avatar.png" alt="Profile preview">
                                </div>
                                <div class="flex-1">
                                    <label for="profile_picture" class="cursor-pointer bg-white py-2 px-3 border border-gray-300 rounded-md shadow-sm text-sm leading-4 font-medium text-gray-700 hover:bg-gray-50">
                                        Change Picture
                                    </label>
                                    <input id="profile_picture" name="profile_picture" type="file" class="hidden" accept="image/*">
                                    <p class="mt-1 text-xs text-gray-500">PNG, JPG up to 2MB</p>
                                    <button type="button" onclick="removeProfilePicture()" class="text-sm text-red-600 hover:text-red-800 mt-2">
                                        Remove current picture
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Gender -->
                            <div>
                                <label for="gender" class="block text-sm font-medium text-gray-700 mb-2">Gender</label>
                                <select id="gender" name="gender"
                                        class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500">
                                    <option value="">Select Gender</option>
                                    <option value="male">Male</option>
                                    <option value="female">Female</option>
                                    <option value="other">Other</option>
                                    <option value="prefer_not_to_say">Prefer not to say</option>
                                </select>
                            </div>

                            <!-- Position/Title -->
                            <div>
                                <label for="position" class="block text-sm font-medium text-gray-700 mb-2">Position/Title</label>
                                <input type="text" id="position" name="position"
                                       class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                       placeholder="Job title or position">
                            </div>

                            <!-- Employee ID -->
                            <div>
                                <label for="employee_id" class="block text-sm font-medium text-gray-700 mb-2">Employee ID</label>
                                <input type="text" id="employee_id" name="employee_id"
                                       class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                       placeholder="Employee ID (if applicable)">
                            </div>

                            <!-- Timezone -->
                            <div>
                                <label for="timezone" class="block text-sm font-medium text-gray-700 mb-2">Timezone</label>
                                <select id="timezone" name="timezone"
                                        class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500">
                                    <option value="Asia/Bangkok">Bangkok (GMT+7)</option>
                                    <option value="Asia/Tokyo">Tokyo (GMT+9)</option>
                                    <option value="America/New_York">New York (GMT-5)</option>
                                    <option value="Europe/London">London (GMT+0)</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Account Settings Tab -->
                    <div id="tab-settings" class="tab-content p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Account Settings</h3>

                        <!-- Account Status -->
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-3">Account Status</label>
                            <div class="space-y-3">
                                <label class="flex items-center">
                                    <input type="checkbox" id="is_active" name="is_active" class="mr-2">
                                    <span class="text-sm">Account is active</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="email_verified" name="email_verified" class="mr-2">
                                    <span class="text-sm">Email is verified</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="is_locked" name="is_locked" class="mr-2">
                                    <span class="text-sm">Account is locked</span>
                                </label>
                            </div>
                        </div>

                        <!-- Password Settings -->
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-3">Password Settings</label>
                            <div class="space-y-3">
                                <label class="flex items-center">
                                    <input type="checkbox" id="require_password_change" name="require_password_change" class="mr-2">
                                    <span class="text-sm">Require password change on next login</span>
                                </label>
                                <div class="flex items-center space-x-3">
                                    <span class="text-sm text-gray-600">Last password change:</span>
                                    <span id="last-password-change" class="text-sm font-medium">Never</span>
                                    <button type="button" onclick="resetPassword()" class="text-sm text-blue-600 hover:text-blue-800">
                                        Reset now
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Login Attempts -->
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-3">Login Security</label>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                <div>
                                    <span class="text-gray-600">Failed login attempts:</span>
                                    <span id="failed-attempts" class="font-medium ml-2">0</span>
                                </div>
                                <div>
                                    <span class="text-gray-600">Last failed attempt:</span>
                                    <span id="last-failed-attempt" class="font-medium ml-2">Never</span>
                                </div>
                            </div>
                            <button type="button" onclick="clearLoginAttempts()"
                                    class="mt-2 text-sm text-blue-600 hover:text-blue-800">
                                Clear failed attempts
                            </button>
                        </div>

                        <!-- Notification Preferences -->
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-3">Email Notifications</label>
                            <div class="space-y-3">
                                <label class="flex items-center">
                                    <input type="checkbox" id="email_notifications" name="email_notifications" class="mr-2" checked>
                                    <span class="text-sm">Receive email notifications</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="course_notifications" name="course_notifications" class="mr-2" checked>
                                    <span class="text-sm">Course enrollment notifications</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="test_notifications" name="test_notifications" class="mr-2" checked>
                                    <span class="text-sm">Test and assessment notifications</span>
                                </label>
                            </div>
                        </div>

                        <!-- Danger Zone -->
                        <div class="border border-red-200 rounded-lg p-4 bg-red-50">
                            <h4 class="text-sm font-medium text-red-800 mb-2">Danger Zone</h4>
                            <div class="space-y-3">
                                <button type="button" onclick="suspendUser()"
                                        class="text-sm text-red-600 hover:text-red-800 block">
                                    Suspend this user account
                                </button>
                                <button type="button" onclick="deleteUser()"
                                        class="text-sm text-red-600 hover:text-red-800 block">
                                    Permanently delete this user
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Form Actions -->
                    <div class="border-t border-gray-200 px-6 py-4">
                        <div class="flex justify-between items-center">
                            <div class="text-sm text-gray-500">
                                Last updated: <span id="last-updated">Never</span>
                            </div>
                            <div class="flex space-x-3">
                                <button type="button" onclick="discardChanges()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600">
                                    Discard Changes
                                </button>
                                <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                                    <i class="fas fa-save mr-2"></i>Save Changes
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Preview Modal -->
<div id="preview-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg font-semibold text-gray-900">User Preview</h3>
                    <button onclick="closePreview()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div class="p-6">
                <div id="modal-preview-content">
                    <!-- Preview content will be populated here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Confirm Dialogs -->
<div id="confirm-dialog" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg max-w-md w-full">
            <div class="p-6">
                <div class="flex items-center mb-4">
                    <div id="confirm-icon" class="mr-4">
                        <i class="fas fa-exclamation-triangle text-yellow-500 text-2xl"></i>
                    </div>
                    <div>
                        <h3 id="confirm-title" class="text-lg font-semibold text-gray-900">Confirm Action</h3>
                    </div>
                </div>
                <p id="confirm-message" class="text-gray-600 mb-6"></p>
                <div class="flex justify-end space-x-3">
                    <button onclick="closeConfirmDialog()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600">
                        Cancel
                    </button>
                    <button id="confirm-action-btn" onclick="confirmAction()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">
                        Confirm
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg p-6">
        <div class="flex items-center">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
            <span class="ml-3">Updating user...</span>
        </div>
    </div>
</div>

<style>
.tab-button.active {
    border-color: #3B82F6;
    color: #3B82F6;
}

.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
}

.role-card input[type="radio"]:checked + label > div {
    border-color: #3B82F6;
    background-color: #EFF6FF;
}

.status-indicator.online {
    background-color: #10B981;
}

.status-indicator.offline {
    background-color: #6B7280;
}

.status-indicator.away {
    background-color: #F59E0B;
}
</style>

<script>
let originalData = {};
let currentUserId = null;
let confirmCallback = null;

document.addEventListener('DOMContentLoaded', function() {
    // Get user ID from URL or form
    currentUserId = document.getElementById('user_id').value || getUrlParameter('id');

    if (currentUserId) {
        loadUserData();
    }

    // Event listeners
    document.getElementById('username').addEventListener('blur', checkUsernameAvailability);
    document.getElementById('email').addEventListener('blur', checkEmailAvailability);
    document.getElementById('profile_picture').addEventListener('change', previewProfilePicture);
    document.getElementById('bio').addEventListener('input', updateBioCount);
    document.getElementById('edit-user-form').addEventListener('submit', submitForm);

    // Role change handler
    document.querySelectorAll('input[name="role"]').forEach(radio => {
        radio.addEventListener('change', handleRoleChange);
    });

    // Load managers
    loadManagers();
});

function getUrlParameter(name) {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(name);
}

async function loadUserData() {
    showLoading(true);

    try {
        const response = await fetch(`/users/api/${currentUserId}`);
        const data = await response.json();

        if (data.success) {
            const user = data.user;
            originalData = { ...user };
            populateForm(user);
            populateUserInfo(user);
            loadUserActivity(currentUserId);
            loadUserStats(currentUserId);
        } else {
            showError('Failed to load user data');
        }
    } catch (error) {
        console.error('Error loading user:', error);
        showError('Error loading user data');
    } finally {
        showLoading(false);
    }
}

function populateForm(user) {
    // Basic information
    document.getElementById('username').value = user.username || '';
    document.getElementById('email').value = user.email || '';
    document.getElementById('first_name').value = user.first_name || '';
    document.getElementById('last_name').value = user.last_name || '';
    document.getElementById('phone').value = user.phone || '';
    document.getElementById('date_of_birth').value = user.date_of_birth ? user.date_of_birth.split('T')[0] : '';
    document.getElementById('bio').value = user.bio || '';

    // Role and permissions
    if (user.role) {
        document.getElementById(`role-${user.role}`).checked = true;
        updateRoleSelection(user.role);
    }
    document.getElementById('department').value = user.department || '';
    document.getElementById('manager_id').value = user.manager_id || '';

    // Profile details
    document.getElementById('gender').value = user.gender || '';
    document.getElementById('position').value = user.position || '';
    document.getElementById('employee_id').value = user.employee_id || '';
    document.getElementById('timezone').value = user.timezone || 'Asia/Bangkok';

    // Profile picture
    if (user.profile_picture) {
        document.getElementById('profile-preview').src = user.profile_picture;
        document.getElementById('current-avatar').src = user.profile_picture;
    }

    // Account settings
    document.getElementById('is_active').checked = user.is_active;
    document.getElementById('email_verified').checked = user.email_verified;
    document.getElementById('is_locked').checked = user.is_locked;
    document.getElementById('require_password_change').checked = user.require_password_change;
    document.getElementById('email_notifications').checked = user.email_notifications ?? true;
    document.getElementById('course_notifications').checked = user.course_notifications ?? true;
    document.getElementById('test_notifications').checked = user.test_notifications ?? true;

    // Update character count
    updateBioCount();

    // Update last updated
    if (user.updated_at) {
        document.getElementById('last-updated').textContent = new Date(user.updated_at).toLocaleString();
    }
}

function populateUserInfo(user) {
    // User card
    document.getElementById('user-display-name').textContent = `${user.first_name} ${user.last_name}`;
    document.getElementById('user-role-badge').textContent = `@${user.username} • ${user.role?.charAt(0).toUpperCase() + user.role?.slice(1)}`;

    // Status indicator
    const statusIndicator = document.getElementById('status-indicator');
    statusIndicator.className = `block h-6 w-6 rounded-full border-2 border-white ${user.is_active ? 'bg-green-500' : 'bg-gray-500'}`;

    // User badges
    const badgesContainer = document.getElementById('user-badges');
    badgesContainer.innerHTML = '';

    if (user.email_verified) {
        badgesContainer.innerHTML += '<span class="px-2 py-1 text-xs bg-green-100 text-green-800 rounded-full">Verified</span>';
    }

    if (user.is_locked) {
        badgesContainer.innerHTML += '<span class="px-2 py-1 text-xs bg-red-100 text-red-800 rounded-full">Locked</span>';
    }

    if (!user.is_active) {
        badgesContainer.innerHTML += '<span class="px-2 py-1 text-xs bg-gray-100 text-gray-800 rounded-full">Inactive</span>';
    }

    // Dates
    if (user.last_login) {
        document.getElementById('last-login').textContent = new Date(user.last_login).toLocaleDateString();
    } else {
        document.getElementById('last-login').textContent = 'Never';
    }

    document.getElementById('created-date').textContent = new Date(user.created_at).toLocaleDateString();
    document.getElementById('login-count').textContent = user.login_count || 0;

    // Account settings details
    document.getElementById('failed-attempts').textContent = user.failed_login_attempts || 0;

    if (user.last_failed_login) {
        document.getElementById('last-failed-attempt').textContent = new Date(user.last_failed_login).toLocaleString();
    } else {
        document.getElementById('last-failed-attempt').textContent = 'Never';
    }

    if (user.password_changed_at) {
        document.getElementById('last-password-change').textContent = new Date(user.password_changed_at).toLocaleDateString();
    }

    // Update status banner
    updateStatusBanner(user);

    // Update current role display
    updateCurrentRoleDisplay(user.role);
}

function updateStatusBanner(user) {
    const banner = document.getElementById('user-status-banner');

    if (!user.is_active) {
        banner.className = 'mb-6 p-4 rounded-lg border border-red-200 bg-red-50';
        banner.innerHTML = `
            <div class="flex items-center">
                <i class="fas fa-exclamation-triangle text-red-600 mr-3"></i>
                <div>
                    <h4 class="text-red-800 font-medium">Account Inactive</h4>
                    <p class="text-red-700 text-sm">This user account is currently inactive and cannot access the system.</p>
                </div>
            </div>
        `;
    } else if (user.is_locked) {
        banner.className = 'mb-6 p-4 rounded-lg border border-orange-200 bg-orange-50';
        banner.innerHTML = `
            <div class="flex items-center">
                <i class="fas fa-lock text-orange-600 mr-3"></i>
                <div>
                    <h4 class="text-orange-800 font-medium">Account Locked</h4>
                    <p class="text-orange-700 text-sm">This account is locked due to failed login attempts or security reasons.</p>
                </div>
            </div>
        `;
    } else if (!user.email_verified) {
        banner.className = 'mb-6 p-4 rounded-lg border border-yellow-200 bg-yellow-50';
        banner.innerHTML = `
            <div class="flex items-center">
                <i class="fas fa-envelope text-yellow-600 mr-3"></i>
                <div>
                    <h4 class="text-yellow-800 font-medium">Email Not Verified</h4>
                    <p class="text-yellow-700 text-sm">This user hasn't verified their email address yet.</p>
                </div>
            </div>
        `;
    } else {
        banner.className = 'mb-6 p-4 rounded-lg border border-green-200 bg-green-50';
        banner.innerHTML = `
            <div class="flex items-center">
                <i class="fas fa-check-circle text-green-600 mr-3"></i>
                <div>
                    <h4 class="text-green-800 font-medium">Account Active</h4>
                    <p class="text-green-700 text-sm">This user account is active and functioning normally.</p>
                </div>
            </div>
        `;
    }
}

function updateCurrentRoleDisplay(role) {
    const roleNames = {
        student: 'Student',
        instructor: 'Instructor',
        admin: 'Administrator'
    };

    const roleDescriptions = {
        student: 'Can enroll in courses, take tests, and view progress',
        instructor: 'Can create and manage courses, tests, and view student progress',
        admin: 'Has full system access including user management and system settings'
    };

    const roleColors = {
        student: 'bg-blue-100 text-blue-800',
        instructor: 'bg-green-100 text-green-800',
        admin: 'bg-red-100 text-red-800'
    };

    document.getElementById('current-role-badge').textContent = roleNames[role] || role;
    document.getElementById('current-role-badge').className = `px-3 py-1 rounded-full text-sm font-medium ${roleColors[role] || 'bg-gray-100 text-gray-800'}`;
    document.getElementById('current-role-desc').textContent = roleDescriptions[role] || '';
}

async function loadUserActivity(userId) {
    try {
        const response = await fetch(`/users/api/${userId}/activity`);
        const data = await response.json();

        if (data.success) {
            const activityContainer = document.getElementById('recent-activity');
            activityContainer.innerHTML = '';

            data.activities.forEach(activity => {
                const item = document.createElement('div');
                item.className = 'flex items-center space-x-3 py-2';
                item.innerHTML = `
                    <div class="w-2 h-2 bg-blue-500 rounded-full"></div>
                    <div class="flex-1">
                        <p class="text-sm text-gray-900">${activity.description}</p>
                        <p class="text-xs text-gray-500">${new Date(activity.created_at).toLocaleString()}</p>
                    </div>
                `;
                activityContainer.appendChild(item);
            });

            if (data.activities.length === 0) {
                activityContainer.innerHTML = '<p class="text-sm text-gray-500">No recent activity</p>';
            }
        }
    } catch (error) {
        console.error('Error loading activity:', error);
    }
}

async function loadUserStats(userId) {
    try {
        const response = await fetch(`/users/api/${userId}/stats`);
        const data = await response.json();

        if (data.success) {
            document.getElementById('courses-completed').textContent = data.stats.coursesCompleted || 0;
            document.getElementById('tests-taken').textContent = data.stats.testsTaken || 0;
            document.getElementById('avg-score').textContent = (data.stats.averageScore || 0) + '%';
            document.getElementById('certificates-earned').textContent = data.stats.certificatesEarned || 0;
        }
    } catch (error) {
        console.error('Error loading stats:', error);
    }
}

async function loadManagers() {
    try {
        const response = await fetch('/users/api/managers');
        const data = await response.json();

        if (data.success) {
            const managerSelect = document.getElementById('manager_id');
            const currentValue = managerSelect.value;

            managerSelect.innerHTML = '<option value="">Select Manager</option>';

            data.managers.forEach(manager => {
                if (manager.user_id !== currentUserId) { // Don't allow user to be their own manager
                    const option = document.createElement('option');
                    option.value = manager.user_id;
                    option.textContent = `${manager.first_name} ${manager.last_name} (${manager.username})`;
                    managerSelect.appendChild(option);
                }
            });

            managerSelect.value = currentValue;
        }
    } catch (error) {
        console.error('Error loading managers:', error);
    }
}

function showTab(tabName) {
    // Hide all tab contents
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
    });

    // Show selected tab content
    document.getElementById(`tab-${tabName}`).classList.add('active');

    // Update tab buttons
    document.querySelectorAll('.tab-button').forEach(button => {
        button.classList.remove('active');
        button.classList.add('border-transparent', 'text-gray-500');
        button.classList.remove('border-blue-500', 'text-blue-600');
    });

    // Activate current tab button
    event.target.classList.add('active');
    event.target.classList.add('border-blue-500', 'text-blue-600');
    event.target.classList.remove('border-transparent', 'text-gray-500');
}

function handleRoleChange() {
    const selectedRole = document.querySelector('input[name="role"]:checked').value;
    const originalRole = originalData.role;

    // Show warning if role is changing
    const warning = document.getElementById('role-change-warning');
    if (selectedRole !== originalRole) {
        warning.classList.remove('hidden');
    } else {
        warning.classList.add('hidden');
    }

    updateRoleSelection(selectedRole);
}

function updateRoleSelection(role) {
    // Update role card styling
    document.querySelectorAll('.role-card').forEach(card => {
        card.querySelector('div').classList.remove('border-blue-500', 'bg-blue-50');
        card.querySelector('div').classList.add('border-gray-200');
    });

    const selectedCard = document.querySelector(`[data-role="${role}"]`);
    if (selectedCard) {
        selectedCard.querySelector('div').classList.add('border-blue-500', 'bg-blue-50');
        selectedCard.querySelector('div').classList.remove('border-gray-200');
    }
}

async function checkUsernameAvailability() {
    const username = document.getElementById('username').value.trim();
    const indicator = document.getElementById('username-availability');

    if (!username || username === originalData.username) {
        indicator.innerHTML = '';
        return;
    }

    try {
        const response = await fetch(`/users/api/check-username?username=${encodeURIComponent(username)}&exclude=${currentUserId}`);
        const data = await response.json();

        if (data.available) {
            indicator.innerHTML = '<i class="fas fa-check text-green-500"></i> <span class="text-green-500">Username available</span>';
        } else {
            indicator.innerHTML = '<i class="fas fa-times text-red-500"></i> <span class="text-red-500">Username already taken</span>';
        }
    } catch (error) {
        console.error('Error checking username:', error);
    }
}

async function checkEmailAvailability() {
    const email = document.getElementById('email').value.trim();
    const indicator = document.getElementById('email-availability');

    if (!email || email === originalData.email) {
        indicator.innerHTML = '';
        return;
    }

    try {
        const response = await fetch(`/users/api/check-email?email=${encodeURIComponent(email)}&exclude=${currentUserId}`);
        const data = await response.json();

        if (data.available) {
            indicator.innerHTML = '<i class="fas fa-check text-green-500"></i> <span class="text-green-500">Email available</span>';
        } else {
            indicator.innerHTML = '<i class="fas fa-times text-red-500"></i> <span class="text-red-500">Email already registered</span>';
        }
    } catch (error) {
        console.error('Error checking email:', error);
    }
}

function previewProfilePicture() {
    const file = document.getElementById('profile_picture').files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('profile-preview').src = e.target.result;
        };
        reader.readAsDataURL(file);
    }
}

function removeProfilePicture() {
    document.getElementById('profile-preview').src = '/images/default-avatar.png';
    document.getElementById('profile_picture').value = '';
}

function updateBioCount() {
    const bio = document.getElementById('bio').value;
    const count = document.getElementById('bio-count');
    count.textContent = bio.length;

    if (bio.length > 500) {
        count.parentElement.classList.add('text-red-500');
    } else {
        count.parentElement.classList.remove('text-red-500');
    }
}

async function submitForm(event) {
    event.preventDefault();

    showLoading(true);

    try {
        const formData = new FormData(document.getElementById('edit-user-form'));

        const response = await fetch(`/users/api/${currentUserId}`, {
            method: 'PUT',
            body: formData
        });

        const data = await response.json();

        if (data.success) {
            showSuccess('User updated successfully!');
            // Reload user data to show updated information
            await loadUserData();
        } else {
            showError(data.message || 'Failed to update user');
        }
    } catch (error) {
        console.error('Error updating user:', error);
        showError('Error updating user');
    } finally {
        showLoading(false);
    }
}

function discardChanges() {
    if (confirm('Are you sure you want to discard all changes?')) {
        populateForm(originalData);
        showSuccess('Changes discarded');
    }
}

function previewUser() {
    const formData = new FormData(document.getElementById('edit-user-form'));
    const modalContent = document.getElementById('modal-preview-content');

    const firstName = formData.get('first_name');
    const lastName = formData.get('last_name');
    const username = formData.get('username');
    const email = formData.get('email');
    const role = formData.get('role');
    const department = formData.get('department');
    const bio = formData.get('bio');

    modalContent.innerHTML = `
        <div class="border border-gray-200 rounded-lg p-4">
            <div class="flex items-start space-x-4">
                <img src="${document.getElementById('profile-preview').src}"
                     alt="Profile" class="h-16 w-16 rounded-full object-cover border-2 border-gray-300">
                <div class="flex-1">
                    <h4 class="text-lg font-semibold text-gray-900">${firstName} ${lastName}</h4>
                    <p class="text-gray-600">@${username}</p>
                    <p class="text-sm text-gray-500">${email}</p>
                    <div class="mt-2">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                            ${role?.charAt(0).toUpperCase() + role?.slice(1)}
                        </span>
                        ${department ? `
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 ml-2">
                                ${department}
                            </span>
                        ` : ''}
                    </div>
                </div>
            </div>

            ${bio ? `
                <div class="mt-4 pt-4 border-t border-gray-200">
                    <p class="text-sm text-gray-600">${bio}</p>
                </div>
            ` : ''}
        </div>
    `;

    document.getElementById('preview-modal').classList.remove('hidden');
}

function closePreview() {
    document.getElementById('preview-modal').classList.add('hidden');
}

function resetPassword() {
    showConfirmDialog(
        'Reset Password',
        'Are you sure you want to reset this user\'s password? A new temporary password will be generated and sent to their email.',
        'Reset Password',
        async () => {
            try {
                const response = await fetch(`/users/api/${currentUserId}/reset-password`, {
                    method: 'POST'
                });

                const data = await response.json();

                if (data.success) {
                    showSuccess('Password reset successfully. New password sent to user\'s email.');
                } else {
                    showError(data.message || 'Failed to reset password');
                }
            } catch (error) {
                console.error('Error resetting password:', error);
                showError('Error resetting password');
            }
        }
    );
}

function clearLoginAttempts() {
    showConfirmDialog(
        'Clear Failed Attempts',
        'This will reset the failed login attempt counter to zero.',
        'Clear Attempts',
        async () => {
            try {
                const response = await fetch(`/users/api/${currentUserId}/clear-attempts`, {
                    method: 'POST'
                });

                const data = await response.json();

                if (data.success) {
                    showSuccess('Failed login attempts cleared');
                    document.getElementById('failed-attempts').textContent = '0';
                } else {
                    showError(data.message || 'Failed to clear attempts');
                }
            } catch (error) {
                console.error('Error clearing attempts:', error);
                showError('Error clearing attempts');
            }
        }
    );
}

function suspendUser() {
    showConfirmDialog(
        'Suspend User Account',
        'This will temporarily suspend the user account. The user will not be able to log in until the account is reactivated.',
        'Suspend Account',
        async () => {
            try {
                const response = await fetch(`/users/api/${currentUserId}/suspend`, {
                    method: 'POST'
                });

                const data = await response.json();

                if (data.success) {
                    showSuccess('User account suspended');
                    await loadUserData();
                } else {
                    showError(data.message || 'Failed to suspend account');
                }
            } catch (error) {
                console.error('Error suspending user:', error);
                showError('Error suspending user');
            }
        }
    );
}

function deleteUser() {
    showConfirmDialog(
        'Delete User Account',
        'This action cannot be undone. All user data, progress, and associated records will be permanently deleted.',
        'Delete User',
        async () => {
            try {
                const response = await fetch(`/users/api/${currentUserId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    showSuccess('User deleted successfully');
                    setTimeout(() => {
                        window.location.href = '/admin/users';
                    }, 2000);
                } else {
                    showError(data.message || 'Failed to delete user');
                }
            } catch (error) {
                console.error('Error deleting user:', error);
                showError('Error deleting user');
            }
        },
        'bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700'
    );
}

function showConfirmDialog(title, message, actionText, callback, actionButtonClass = 'bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700') {
    document.getElementById('confirm-title').textContent = title;
    document.getElementById('confirm-message').textContent = message;
    document.getElementById('confirm-action-btn').textContent = actionText;
    document.getElementById('confirm-action-btn').className = actionButtonClass;
    document.getElementById('confirm-dialog').classList.remove('hidden');
    confirmCallback = callback;
}

function closeConfirmDialog() {
    document.getElementById('confirm-dialog').classList.add('hidden');
    confirmCallback = null;
}

async function confirmAction() {
    if (confirmCallback) {
        closeConfirmDialog();
        await confirmCallback();
    }
}

function showLoading(show) {
    const overlay = document.getElementById('loading-overlay');
    overlay.classList.toggle('hidden', !show);
}

function showSuccess(message) {
    // You can implement a toast notification system here
    alert(message);
}

function showError(message) {
    // You can implement a toast notification system here
    alert('Error: ' + message);
}
</script>

<%- include('../partials/footer') %>